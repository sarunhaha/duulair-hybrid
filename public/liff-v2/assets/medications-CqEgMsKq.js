import{r as b,j as e}from"./vendor-query-CmnYLxAr.js";import{c as Y,u as H,m as J,w as Q,g as d,z as M,e as h,f as p,P as I,N as K,L as D,a as k,x as O,O as W,Q as X,R as Z,V as $,W as G,Y as ee,X as se,p as u,I as ae,j as C,r as te,Z as ne,K as le}from"./index-BrRdf3uS.js";import{S as g,a as j,b as f,c as v,d as r}from"./select-Bf1XW5nh.js";import{g as re,h as ie,i as oe,j as ce}from"./use-profile-LVwbSIOg.js";import{C as de}from"./calendar-Bwk-1fjo.js";import{P as ue}from"./pen-REnZ7TD6.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-pdf-IriBjpIe.js";import"./vendor-charts-CeI395eV.js";import"./vendor-ui-BZ8NMy8G.js";import"./chevron-down-gC4Cgr-u.js";import"./chevron-up-DcEToq_C.js";const xe=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M17 17H4a1 1 0 0 1-.74-1.673C4.59 13.956 6 12.499 6 8a6 6 0 0 1 .258-1.742",key:"178tsu"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M8.668 3.01A6 6 0 0 1 18 8c0 2.687.77 4.653 1.707 6.05",key:"1hqiys"}]],A=Y("bell-off",xe);function me(){const{context:c,user:l}=H();return b.useMemo(()=>{if(console.log("[usePatientId] Auth state:",{"context.patientId":c.patientId,"user.role":l.role,"user.profileId":l.profileId}),c.patientId)return console.log("[usePatientId] Using context.patientId:",c.patientId),{patientId:c.patientId,source:"context"};if(l.role==="patient"&&l.profileId)return console.log("[usePatientId] Using user.profileId:",l.profileId),{patientId:l.profileId,source:"user.profileId"};try{const i=localStorage.getItem("oonjai_user");if(i){const t=JSON.parse(i);if(console.log("[usePatientId] localStorage oonjai_user:",t),t.role==="patient"&&t.profile_id)return console.log("[usePatientId] Using oonjai_user.profile_id:",t.profile_id),{patientId:t.profile_id,source:"localStorage:oonjai_user"}}}catch(i){console.warn("[usePatientId] Failed to parse oonjai_user:",i)}try{const i=localStorage.getItem("oonjai_auth");if(i){const t=JSON.parse(i);if(console.log("[usePatientId] localStorage oonjai_auth:",t),t.state?.context?.patientId)return console.log("[usePatientId] Using oonjai_auth context.patientId:",t.state.context.patientId),{patientId:t.state.context.patientId,source:"localStorage:oonjai_auth.context"};if(t.state?.user?.role==="patient"&&t.state?.user?.profileId)return console.log("[usePatientId] Using oonjai_auth user.profileId:",t.state.user.profileId),{patientId:t.state.user.profileId,source:"localStorage:oonjai_auth.user"}}}catch(i){console.warn("[usePatientId] Failed to parse oonjai_auth:",i)}return console.log("[usePatientId] No patientId found from any source"),{patientId:null,source:"none"}},[c.patientId,l.role,l.profileId])}const he=[{value:"morning",label:"เช้า (08:00)"},{value:"afternoon",label:"กลางวัน (12:00)"},{value:"evening",label:"เย็น (18:00)"},{value:"night",label:"ก่อนนอน (21:00)"}],pe={morning:"เช้า",afternoon:"กลางวัน",evening:"เย็น",night:"ก่อนนอน"},ge=[{value:"daily",label:"ทุกวัน"},{value:"specific_days",label:"เลือกวัน"},{value:"as_needed",label:"เมื่อจำเป็น"}],je=[{value:"monday",label:"จันทร์"},{value:"tuesday",label:"อังคาร"},{value:"wednesday",label:"พุธ"},{value:"thursday",label:"พฤหัสบดี"},{value:"friday",label:"ศุกร์"},{value:"saturday",label:"เสาร์"},{value:"sunday",label:"อาทิตย์"}],q={name:"",dosage_amount:1,dosage_unit:"tablet",dosage_form:"tablet",frequency:"daily",days_of_week:[],times:[],instructions:"",note:"",reminder_enabled:!0};function Me(){const[,c]=J(),{patientId:l,source:i}=me(),{toast:t}=Q();console.log("[MedicationsPage] patientId:",l,"source:",i);const{data:x,isLoading:P}=re(l),N=ie(),y=oe(),T=ce(),[z,m]=b.useState(!1),[_,S]=b.useState(null),[n,o]=b.useState(q),E=()=>{S(null),o(q),m(!0)},L=s=>{S(s.id),o({name:s.name,dosage_amount:s.dosage_amount||1,dosage_unit:s.dosage_unit||"tablet",dosage_form:s.dosage_form||"tablet",frequency:s.frequency||"daily",days_of_week:s.days_of_week||[],times:s.times||[],instructions:s.instructions||"",note:s.note||"",reminder_enabled:s.reminder_enabled!==!1}),m(!0)},F=async s=>{if(l&&confirm("ต้องการลบรายการยานี้หรือไม่?"))try{await T.mutateAsync({id:s,patientId:l}),t({title:"ลบรายการยาเรียบร้อยแล้ว"})}catch{t({title:"ไม่สามารถลบรายการยาได้",variant:"destructive"})}},U=async()=>{if(console.log("[MedicationsPage] handleSubmit called, patientId:",l),!l){t({title:"ไม่พบข้อมูลผู้ป่วย กรุณาลงทะเบียนก่อน",variant:"destructive"});return}if(!n.name.trim()){t({title:"กรุณาระบุชื่อยา",variant:"destructive"});return}if(n.times.length===0&&n.frequency!=="as_needed"){t({title:"กรุณาเลือกเวลาทานยา",variant:"destructive"});return}try{console.log("[MedicationsPage] Submitting medication:",n),_?(await y.mutateAsync({id:_,data:{...n,patient_id:l}}),t({title:"แก้ไขรายการยาเรียบร้อยแล้ว"})):(await N.mutateAsync({...n,patient_id:l,active:!0}),t({title:"เพิ่มรายการยาเรียบร้อยแล้ว"})),m(!1)}catch(s){console.error("[MedicationsPage] Error saving medication:",s),t({title:"ไม่สามารถบันทึกรายการยาได้",variant:"destructive"})}},V=s=>{o(a=>({...a,times:a.times.includes(s)?a.times.filter(w=>w!==s):[...a.times,s]}))},B=s=>{o(a=>({...a,days_of_week:a.days_of_week.includes(s)?a.days_of_week.filter(w=>w!==s):[...a.days_of_week,s]}))},R=s=>{const a=s.dosage_amount||1;return a===.25?"1/4 เม็ด":a===.5?"1/2 เม็ด":a===.75?"3/4 เม็ด":`${a} เม็ด`};return l?e.jsxs("div",{className:"min-h-screen pb-8 font-sans bg-background",children:[e.jsxs("header",{className:"bg-card pt-12 pb-4 px-6 sticky top-0 z-20 flex items-center gap-4 border-b border-border",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>c("/settings"),children:e.jsx(M,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold text-foreground flex-1",children:"รายการยา"})]}),e.jsxs("main",{className:"max-w-md mx-auto px-4 py-6 space-y-4",children:[e.jsx(h,{className:"border-none shadow-lg bg-gradient-to-br from-purple-500 to-purple-600 text-white overflow-hidden",children:e.jsxs(p,{className:"p-6 relative",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("p",{className:"text-sm text-white/80",children:"รายการยาทั้งหมด"}),e.jsxs("p",{className:"text-4xl font-bold mt-1",children:[x?.length||0," ",e.jsx("span",{className:"text-lg font-normal",children:"รายการ"})]})]})]})}),e.jsxs(d,{className:"w-full gap-2",size:"lg",onClick:E,children:[e.jsx(K,{className:"w-5 h-5"}),"เพิ่มรายการยา"]}),P&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(D,{className:"w-8 h-8 animate-spin text-primary"})}),!P&&(!x||x.length===0)&&e.jsx(h,{className:"border-none shadow-sm bg-card",children:e.jsxs(p,{className:"p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-muted rounded-full flex items-center justify-center",children:e.jsx(I,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("p",{className:"font-bold text-foreground",children:"ยังไม่มีรายการยา"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"กดปุ่มด้านบนเพื่อเพิ่มยา"})]})}),x&&x.length>0&&e.jsx("div",{className:"space-y-3",children:x.map(s=>e.jsx(h,{className:"border-none shadow-sm bg-card overflow-hidden",children:e.jsxs(p,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-foreground",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:R(s)})]}),e.jsx("div",{className:k("p-1.5 rounded-full",s.reminder_enabled?"bg-green-100 dark:bg-green-950/30":"bg-muted"),children:s.reminder_enabled?e.jsx(O,{className:"w-4 h-4 text-green-600 dark:text-green-400"}):e.jsx(A,{className:"w-4 h-4 text-muted-foreground"})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-3",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{children:s.frequency==="daily"?"ทุกวัน":s.frequency==="as_needed"?"เมื่อจำเป็น":s.days_of_week?.join(", ")||"ตามแพทย์สั่ง"})]}),s.times&&s.times.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:s.times.map(a=>e.jsx("span",{className:"px-2 py-1 bg-muted rounded-md text-xs font-medium text-muted-foreground",children:pe[a]||a},a))}),s.instructions&&e.jsxs("p",{className:"text-xs text-muted-foreground mb-3",children:[e.jsx(W,{className:"w-3 h-3 inline mr-1"}),s.instructions]}),s.note&&e.jsx("div",{className:"p-2 bg-accent/10 border-l-2 border-accent rounded text-xs text-muted-foreground mb-3",children:s.note}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{variant:"default",size:"sm",className:"flex-1 gap-1",onClick:()=>L(s),children:[e.jsx(ue,{className:"w-4 h-4"}),"แก้ไข"]}),e.jsxs(d,{variant:"destructive",size:"sm",className:"flex-1 gap-1",onClick:()=>F(s.id),children:[e.jsx(X,{className:"w-4 h-4"}),"ลบ"]})]})]})},s.id))})]}),e.jsx(Z,{open:z,onOpenChange:m,children:e.jsxs($,{className:"max-h-[90vh]",children:[e.jsx(G,{className:"border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-primary"}),_?"แก้ไขรายการยา":"เพิ่มรายการยา"]}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>m(!1),children:e.jsx(se,{className:"w-5 h-5"})})]})}),e.jsxs("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[60vh]",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"med_name",children:"ชื่อยา *"}),e.jsx(ae,{id:"med_name",value:n.name,onChange:s=>o(a=>({...a,name:s.target.value})),placeholder:"เช่น ยาลดความดัน"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"จำนวน"}),e.jsxs(g,{value:String(n.dosage_amount),onValueChange:s=>o(a=>({...a,dosage_amount:parseFloat(s)})),children:[e.jsx(j,{children:e.jsx(f,{})}),e.jsxs(v,{children:[e.jsx(r,{value:"0.25",children:"1/4 เม็ด"}),e.jsx(r,{value:"0.5",children:"1/2 เม็ด"}),e.jsx(r,{value:"0.75",children:"3/4 เม็ด"}),e.jsx(r,{value:"1",children:"1 เม็ด"}),e.jsx(r,{value:"1.5",children:"1.5 เม็ด"}),e.jsx(r,{value:"2",children:"2 เม็ด"}),e.jsx(r,{value:"3",children:"3 เม็ด"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"รูปแบบยา"}),e.jsxs(g,{value:n.dosage_form,onValueChange:s=>o(a=>({...a,dosage_form:s})),children:[e.jsx(j,{children:e.jsx(f,{})}),e.jsxs(v,{children:[e.jsx(r,{value:"tablet",children:"เม็ด"}),e.jsx(r,{value:"capsule",children:"แคปซูล"}),e.jsx(r,{value:"liquid",children:"น้ำ"}),e.jsx(r,{value:"injection",children:"ฉีด"}),e.jsx(r,{value:"topical",children:"ทา"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"ความถี่"}),e.jsxs(g,{value:n.frequency,onValueChange:s=>o(a=>({...a,frequency:s})),children:[e.jsx(j,{children:e.jsx(f,{})}),e.jsx(v,{children:ge.map(s=>e.jsx(r,{value:s.value,children:s.label},s.value))})]})]}),n.frequency==="specific_days"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"เลือกวัน"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:je.map(s=>e.jsxs("label",{className:k("flex items-center gap-2 p-2 border rounded-lg cursor-pointer transition-colors",n.days_of_week.includes(s.value)?"bg-primary/10 border-primary":"border-border"),children:[e.jsx(C,{checked:n.days_of_week.includes(s.value),onCheckedChange:()=>B(s.value)}),e.jsx("span",{className:"text-sm",children:s.label})]},s.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"เวลาทานยา *"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:he.map(s=>e.jsxs("label",{className:k("flex items-center gap-2 p-2 border rounded-lg cursor-pointer transition-colors",n.times.includes(s.value)?"bg-primary/10 border-primary":"border-border"),children:[e.jsx(C,{checked:n.times.includes(s.value),onCheckedChange:()=>V(s.value)}),e.jsx("span",{className:"text-sm",children:s.label})]},s.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"วิธีรับประทาน"}),e.jsxs(g,{value:n.instructions,onValueChange:s=>o(a=>({...a,instructions:s})),children:[e.jsx(j,{children:e.jsx(f,{placeholder:"เลือกวิธีรับประทาน"})}),e.jsxs(v,{children:[e.jsx(r,{value:"ก่อนอาหาร",children:"ก่อนอาหาร"}),e.jsx(r,{value:"หลังอาหาร",children:"หลังอาหาร"}),e.jsx(r,{value:"ระหว่างอาหาร",children:"ระหว่างอาหาร"}),e.jsx(r,{value:"ห่างอาหาร",children:"ห่างอาหาร"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"หมายเหตุ"}),e.jsx(te,{value:n.note,onChange:s=>o(a=>({...a,note:s.target.value})),placeholder:"เช่น ทานพร้อมน้ำมากๆ",rows:2})]}),e.jsxs("label",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg cursor-pointer",children:[e.jsx(C,{checked:n.reminder_enabled,onCheckedChange:s=>o(a=>({...a,reminder_enabled:s===!0}))}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:"เปิดการเตือน"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"รับการแจ้งเตือนเมื่อถึงเวลาทานยา"})]}),n.reminder_enabled?e.jsx(O,{className:"w-5 h-5 text-green-500"}):e.jsx(A,{className:"w-5 h-5 text-muted-foreground"})]})]}),e.jsx(ne,{className:"border-t border-border",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:"ยกเลิก"}),e.jsxs(d,{className:"flex-1 gap-2",onClick:U,disabled:N.isPending||y.isPending,children:[(N.isPending||y.isPending)&&e.jsx(D,{className:"w-4 h-4 animate-spin"}),e.jsx(le,{className:"w-4 h-4"}),"บันทึก"]})]})})]})})]}):e.jsxs("div",{className:"min-h-screen pb-8 font-sans bg-background",children:[e.jsxs("header",{className:"bg-card pt-12 pb-4 px-6 sticky top-0 z-20 flex items-center gap-4 border-b border-border",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>c("/settings"),children:e.jsx(M,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold text-foreground flex-1",children:"รายการยา"})]}),e.jsx("main",{className:"max-w-md mx-auto px-4 py-6",children:e.jsx(h,{className:"border-destructive/20",children:e.jsxs(p,{className:"p-6 text-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 mx-auto rounded-full bg-destructive/10 flex items-center justify-center",children:e.jsx(I,{className:"w-8 h-8 text-destructive"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg text-foreground",children:"ไม่พบข้อมูลผู้ป่วย"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"กรุณากลับไปหน้าแรกเพื่อตรวจสอบการลงทะเบียน"})]}),e.jsxs("div",{className:"pt-2 space-y-2",children:[e.jsx(d,{className:"w-full",onClick:()=>{localStorage.removeItem("oonjai_auth"),localStorage.removeItem("oonjai_user"),c("/")},children:"ไปหน้าแรก (ล้างข้อมูล)"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Debug: source=",i]})]})]})})})]})}export{Me as default};
