import{r,j as e}from"./vendor-query-OvJu5Khy.js";import{c as X,G as ge,a0 as ve,W as je,a1 as ye,g as o,_ as H,L as S,P as D,p as be,H as Ne,a5 as we,a6 as _e,a as x,e as ke,f as Ce,a4 as Se,h as Te,K as M,a7 as Pe,a3 as F,a8 as V,X as $,t as Ae,v as Le,w as Me,x as Ie,Y as De,J as y,O as qe,a9 as Ee,a2 as Re}from"./index-tEBa2Yi-.js";import{S as ze}from"./switch-xcfwhQ2W.js";import{S as Y,a as B,b as G,c as U,d as I}from"./select-DqW61qmP.js";import{j as Oe,g as He,k as Fe,l as Ve,m as $e}from"./use-profile-4hQw1HTv.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-ui-CYcp45lG.js";const Ye=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],J=X("pen",Ye);const Be=[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"j28e5"}]],Ge=X("utensils",Be),T=[{value:"medication",label:"กินยา",icon:D,color:"bg-purple-500/10 text-purple-500"},{value:"water",label:"ดื่มน้ำ",icon:be,color:"bg-blue-500/10 text-blue-500"},{value:"vitals",label:"วัดความดัน",icon:Ne,color:"bg-red-500/10 text-red-500"},{value:"food",label:"ทานอาหาร",icon:Ge,color:"bg-orange-500/10 text-orange-500"},{value:"exercise",label:"ออกกำลังกาย",icon:we,color:"bg-green-500/10 text-green-500"},{value:"glucose",label:"วัดน้ำตาล",icon:_e,color:"bg-amber-500/10 text-amber-500"}],Ue=T.map(d=>({value:d.value,label:d.label,icon:d.icon})),K=[{value:"monday",label:"จ",fullLabel:"จันทร์"},{value:"tuesday",label:"อ",fullLabel:"อังคาร"},{value:"wednesday",label:"พ",fullLabel:"พุธ"},{value:"thursday",label:"พฤ",fullLabel:"พฤหัสบดี"},{value:"friday",label:"ศ",fullLabel:"ศุกร์"},{value:"saturday",label:"ส",fullLabel:"เสาร์"},{value:"sunday",label:"อา",fullLabel:"อาทิตย์"}],Je=[{label:"เช้า",time:"08:00"},{label:"กลางวัน",time:"12:00"},{label:"เย็น",time:"18:00"},{label:"ก่อนนอน",time:"21:00"}],Ke={type:"medication",title:"",time:"08:00",note:"",frequency:"daily",days_of_week:[],is_active:!0},W=d=>{switch(d){case"medication":return"พิมพ์ชื่อยาอื่นๆ...";case"water":return"เช่น ดื่มน้ำ 1 แก้ว";case"vitals":return"เช่น วัดความดันเช้า";case"food":return"เช่น ทานอาหารเช้า";case"exercise":return"เช่น เดินออกกำลังกาย";case"glucose":return"เช่น วัดน้ำตาลเช้า";default:return"ชื่อกิจกรรม"}},We=d=>{switch(d){case"medication":return"ยังไม่มีเตือนกินยา";case"water":return"ยังไม่มีเตือนดื่มน้ำ";case"vitals":return"ยังไม่มีเตือนวัดความดัน";case"food":return"ยังไม่มีเตือนทานอาหาร";case"exercise":return"ยังไม่มีเตือนออกกำลังกาย";case"glucose":return"ยังไม่มีเตือนวัดระดับน้ำตาล";default:return"ยังไม่มีการเตือน"}};function nt(){const[,d]=ge(),q=ve(),{toast:c}=je(),_=ye(),u=_.patientId,[Z,Q]=r.useState(!1);!q.isLoading&&!_.isLoading&&!u&&!Z&&(Q(!0),_.ensurePatient());const{data:g,isLoading:E}=Oe(u),{data:P}=He(u),A=Fe(),k=Ve(),ee=$e(),[n,te]=r.useState("medication"),[h,b]=r.useState(""),[l,v]=r.useState(["08:00"]),[Xe,R]=r.useState(""),[C,L]=r.useState(!1),[se,N]=r.useState(!1),[z,ae]=r.useState(null),[a,m]=r.useState(Ke),j=r.useMemo(()=>g?g.filter(t=>t.type===n):[],[g,n]),le=r.useMemo(()=>{if(!g)return{};const t={};for(const s of g)t[s.type]||(t[s.type]={active:0,total:0}),t[s.type].total++,s.is_active&&t[s.type].active++;return t},[g]),f=r.useMemo(()=>P?P.filter(t=>t.active):[],[P]),ne=()=>{const t=l[l.length-1],[s]=t.split(":").map(Number),p=`${Math.min(s+4,23).toString().padStart(2,"0")}:00`;l.includes(p)||v([...l,p])},ie=t=>{l.length<=1||v(l.filter((s,i)=>i!==t))},re=t=>{b(t),R(""),L(!1)},ce=async()=>{if(!(!u||!h.trim()||l.length===0))try{for(const t of l)await A.mutateAsync({type:n,title:h.trim(),time:t,custom_time:t,patient_id:u,is_active:!0,frequency:"daily"});b(""),v(["08:00"]),R(""),c({title:l.length>1?`เพิ่ม ${l.length} การเตือนเรียบร้อยแล้ว`:"เพิ่มการเตือนเรียบร้อยแล้ว"})}catch{c({title:"ไม่สามารถเพิ่มการเตือนได้",variant:"destructive"})}},oe=t=>{ae(t.id),m({type:t.type,title:t.title,time:t.custom_time||t.time||"08:00",note:t.note||"",frequency:t.frequency==="specific_days"?"specific_days":"daily",days_of_week:t.days_of_week||[],is_active:t.is_active}),N(!0)},de=async t=>{if(u&&confirm("ต้องการลบการเตือนนี้หรือไม่?"))try{await ee.mutateAsync({id:t,patientId:u}),c({title:"ลบการเตือนเรียบร้อยแล้ว"})}catch{c({title:"ไม่สามารถลบการเตือนได้",variant:"destructive"})}},ue=async t=>{if(u)try{await k.mutateAsync({id:t.id,data:{is_active:!t.is_active,patient_id:u}})}catch{c({title:"ไม่สามารถเปลี่ยนสถานะได้",variant:"destructive"})}},me=async()=>{const t=u||await _.ensurePatient();if(!t){c({title:"เกิดข้อผิดพลาด กรุณาปิดแล้วเปิดแอปใหม่อีกครั้ง",variant:"destructive"});return}if(!a.title.trim()){c({title:"กรุณาระบุชื่อเตือน",variant:"destructive"});return}if(!a.time){c({title:"กรุณาระบุเวลาเตือน",variant:"destructive"});return}if(a.frequency==="specific_days"&&a.days_of_week.length===0){c({title:"กรุณาเลือกวันที่ต้องการเตือน",variant:"destructive"});return}try{z&&(await k.mutateAsync({id:z,data:{...a,custom_time:a.time,days_of_week:a.frequency==="specific_days"?a.days_of_week:void 0,patient_id:t}}),c({title:"แก้ไขการเตือนเรียบร้อยแล้ว"})),N(!1)}catch{c({title:"ไม่สามารถบันทึกการเตือนได้",variant:"destructive"})}},xe=t=>{m(s=>({...s,days_of_week:s.days_of_week.includes(t)?s.days_of_week.filter(i=>i!==t):[...s.days_of_week,t]}))},O=t=>T.find(s=>s.value===t)||T[0];if(q.isLoading)return e.jsxs("div",{className:"min-h-screen pb-8 font-sans bg-background",children:[e.jsxs("header",{className:"bg-card pt-4 pb-1 px-6 sticky top-0 z-20 flex items-center gap-4 border-b border-border",children:[e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>d("/settings"),children:e.jsx(H,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold text-foreground flex-1",children:"ตั้งเวลาเตือน"})]}),e.jsx("main",{className:"max-w-md mx-auto px-4 py-6",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-3",children:[e.jsx(S,{className:"w-8 h-8 animate-spin text-primary"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"กำลังโหลด..."})]})})]});const w=O(n);return e.jsxs("div",{className:"min-h-screen pb-8 font-sans bg-background",children:[e.jsxs("header",{className:"bg-card pt-4 pb-1 px-6 sticky top-0 z-20 flex items-center gap-4 border-b border-border",children:[e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>d("/settings"),children:e.jsx(H,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold text-foreground flex-1",children:"ตั้งเวลาเตือน"})]}),e.jsxs("main",{className:"max-w-md mx-auto px-4 py-6 space-y-4",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 no-scrollbar",children:Ue.map(t=>{const s=n===t.value,i=le[t.value];return e.jsxs("button",{onClick:()=>te(t.value),className:x("flex items-center gap-1.5 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all border",s?"bg-primary text-primary-foreground border-primary shadow-md shadow-primary/20":"bg-card text-muted-foreground border-border"),children:[e.jsx(t.icon,{className:"w-3.5 h-3.5"}),t.label,i&&i.total>0&&e.jsx("span",{className:x("ml-0.5 text-[10px] font-bold rounded-full px-1.5 py-0.5 leading-none",s?"bg-white/20":"bg-muted"),children:i.total})]},t.value)})}),e.jsx(ke,{className:"border-none shadow-sm",children:e.jsxs(Ce,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:x("w-10 h-10 rounded-xl flex items-center justify-center",w.color),children:e.jsx(w.icon,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-bold",children:["เตือน",w.label]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[n==="medication"&&"ตั้งเตือนเวลากินยา",n==="water"&&"ตั้งเตือนดื่มน้ำระหว่างวัน",n==="vitals"&&"ตั้งเตือนวัดความดัน ชีพจร",n==="food"&&"ตั้งเตือนเวลาทานอาหาร",n==="exercise"&&"ตั้งเตือนเวลาออกกำลังกาย",n==="glucose"&&"ตั้งเตือนวัดระดับน้ำตาล"]})]}),j.length>0&&e.jsxs("span",{className:"text-xs font-bold text-muted-foreground bg-muted/50 px-2 py-1 rounded-lg",children:[j.filter(t=>t.is_active).length,"/",j.length]})]}),E&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(S,{className:"w-6 h-6 animate-spin text-primary"})}),!E&&j.length===0&&e.jsxs("div",{className:"flex flex-col items-center py-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 mb-3 bg-muted/50 rounded-full flex items-center justify-center",children:e.jsx(w.icon,{className:"w-6 h-6 text-muted-foreground"})}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:We(n)}),e.jsx("p",{className:"text-xs text-muted-foreground/70 mt-0.5",children:"เพิ่มการเตือนด้านล่างได้เลย"})]}),j.length>0&&e.jsx("div",{className:"space-y-2",children:j.map(t=>{const s=O(t.type),i=s.icon,p=t.custom_time||t.time,he=t.frequency==="daily"?"ทุกวัน":t.frequency==="specific_days"&&t.days_of_week?t.days_of_week.map(fe=>K.find(pe=>pe.value===fe)?.label).join(" "):"ตามกำหนด";return e.jsxs("div",{className:x("bg-muted/20 p-3 rounded-xl space-y-2 transition-opacity",!t.is_active&&"opacity-50"),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:x("p-1.5 rounded-lg shrink-0",s.color),children:e.jsx(i,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-bold text-foreground truncate",children:t.title}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsxs("span",{className:"text-xs font-semibold text-primary",children:[p," น."]}),e.jsx("span",{className:"text-muted-foreground/30",children:"·"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:he})]})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsx(ze,{checked:t.is_active,onCheckedChange:()=>ue(t),className:"scale-75"}),e.jsx(o,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-primary",onClick:()=>oe(t),children:e.jsx(J,{className:"w-3.5 h-3.5"})}),e.jsx(o,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-red-500",onClick:()=>de(t.id),children:e.jsx(Se,{className:"w-3.5 h-3.5"})})]})]}),t.note&&e.jsx("div",{className:"text-[11px] text-muted-foreground bg-accent/5 border-l-2 border-accent/30 px-2 py-1 rounded ml-9",children:t.note})]},t.id)})}),e.jsxs("div",{className:"border-t border-border pt-4 space-y-3",children:[n==="medication"&&e.jsxs("div",{className:"space-y-2",children:[f.length>0&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>L(!C),className:x("w-full h-10 px-3 rounded-xl border border-input bg-muted/20 text-left text-sm","flex items-center justify-between","hover:bg-muted/40 transition-colors",!h&&"text-muted-foreground"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{children:h||"เลือกยาจากรายการ..."})]}),e.jsx(Te,{className:x("w-4 h-4 text-muted-foreground transition-transform",C&&"rotate-180")})]}),C&&e.jsxs("div",{className:"absolute z-10 mt-1 w-full bg-card border border-border rounded-xl shadow-lg overflow-hidden",children:[e.jsx("div",{className:"max-h-[180px] overflow-y-auto",children:f.map(t=>e.jsxs("button",{type:"button",onClick:()=>re(t.name),className:x("w-full px-3 py-2.5 text-left text-sm hover:bg-muted/40 transition-colors flex items-center gap-2",h===t.name&&"bg-primary/5 text-primary font-bold"),children:[e.jsx(D,{className:"w-3.5 h-3.5 text-purple-400 shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"truncate",children:t.name}),t.dosage&&e.jsx("span",{className:"text-[11px] text-muted-foreground ml-1.5",children:t.dosage})]})]},t.id))}),e.jsx("div",{className:"border-t border-border",children:e.jsxs("button",{type:"button",onClick:()=>{b(""),L(!1)},className:"w-full px-3 py-2.5 text-left text-sm text-muted-foreground hover:bg-muted/40 transition-colors flex items-center gap-2",children:[e.jsx(J,{className:"w-3.5 h-3.5 shrink-0"}),"พิมพ์ชื่อยาอื่นๆ..."]})})]})]}),(f.length===0||!C&&!h)&&e.jsx(M,{value:h,onChange:t=>b(t.target.value),placeholder:W(n),className:"h-10 rounded-xl text-sm"})]}),n!=="medication"&&e.jsx(M,{value:h,onChange:t=>b(t.target.value),placeholder:W(n),className:"h-10 rounded-xl text-sm"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("p",{className:"text-xs font-bold text-muted-foreground flex items-center gap-1.5 whitespace-nowrap",children:[e.jsx(Pe,{className:"w-3.5 h-3.5 shrink-0"}),"เวลาเตือน (",l.length," รอบ/วัน)"]}),e.jsxs(o,{variant:"ghost",size:"sm",className:"h-7 text-xs text-primary hover:text-primary/80 px-2 shrink-0 whitespace-nowrap",onClick:ne,children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),"เพิ่มรอบ"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:l.map((t,s)=>e.jsxs("div",{className:"flex items-center bg-muted/30 rounded-xl pr-1.5",children:[e.jsx(V,{value:t,onChange:i=>{const p=[...l];p[s]=i,v(p)},className:"w-auto min-w-0 h-9 text-xs border-none bg-transparent px-2.5"}),l.length>1&&e.jsx("button",{type:"button",onClick:()=>ie(s),className:"w-5 h-5 rounded-full flex items-center justify-center text-muted-foreground hover:text-red-500 hover:bg-red-500/10 transition-colors shrink-0",children:e.jsx($,{className:"w-3 h-3"})})]},s))}),e.jsx("div",{className:"flex gap-1.5",children:Je.map(t=>{const s=l.includes(t.time);return e.jsxs("button",{type:"button",onClick:()=>{s?l.length>1&&v(l.filter(i=>i!==t.time)):v([...l,t.time].sort())},className:x("flex-1 py-1.5 rounded-lg text-[11px] font-bold transition-all border",s?"bg-primary/10 text-primary border-primary/20":"text-muted-foreground border-transparent hover:bg-muted/40"),children:[t.label,e.jsx("span",{className:"block text-[10px] font-normal opacity-70",children:t.time})]},t.time)})})]}),e.jsxs(o,{className:"w-full h-11 rounded-xl text-sm font-bold gap-2",onClick:ce,disabled:!h.trim()||l.length===0||A.isPending,children:[A.isPending?e.jsx(S,{className:"w-4 h-4 animate-spin"}):e.jsx(F,{className:"w-4 h-4"}),"เพิ่มเตือน",w.label,l.length>1&&` (${l.length} รอบ)`]})]})]})})]}),e.jsx(Ae,{open:se,onOpenChange:N,children:e.jsxs(Le,{className:"max-h-[90vh]",children:[e.jsx(Me,{className:"border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ie,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-primary"}),"แก้ไขการเตือน"]}),e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>N(!1),children:e.jsx($,{className:"w-5 h-5"})})]})}),e.jsxs("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[60vh]",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"ประเภท"}),e.jsxs(Y,{value:a.type,onValueChange:t=>m(s=>({...s,type:t})),children:[e.jsx(B,{children:e.jsx(G,{})}),e.jsx(U,{children:T.map(t=>e.jsx(I,{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"reminder_title",children:"ชื่อเตือน *"}),a.type==="medication"&&f.length>0&&e.jsxs(Y,{value:f.some(t=>t.name===a.title)?a.title:"__custom__",onValueChange:t=>{m(t==="__custom__"?s=>({...s,title:""}):s=>({...s,title:t}))},children:[e.jsx(B,{children:e.jsx(G,{placeholder:"เลือกยา"})}),e.jsxs(U,{children:[f.map(t=>e.jsxs(I,{value:t.name,children:[t.name," ",t.dosage?`(${t.dosage})`:""]},t.id)),e.jsx(I,{value:"__custom__",children:"อื่นๆ (พิมพ์เอง)"})]})]}),(a.type!=="medication"||f.length===0||!f.some(t=>t.name===a.title))&&e.jsx(M,{id:"reminder_title",value:a.title,onChange:t=>m(s=>({...s,title:t.target.value})),placeholder:a.type==="medication"?"พิมพ์ชื่อยา":"เช่น กินยาความดัน"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"เวลาเตือน *"}),e.jsx(V,{value:a.time,onChange:t=>m(s=>({...s,time:t})),placeholder:"เลือกเวลา"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"ความถี่"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{type:"button",variant:a.frequency==="daily"?"default":"outline",className:"flex-1",onClick:()=>m(t=>({...t,frequency:"daily"})),children:"ทุกวัน"}),e.jsx(o,{type:"button",variant:a.frequency==="specific_days"?"default":"outline",className:"flex-1",onClick:()=>m(t=>({...t,frequency:"specific_days"})),children:"เลือกวัน"})]})]}),a.frequency==="specific_days"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"เลือกวันที่ต้องการเตือน"}),e.jsx("div",{className:"flex gap-2 justify-center",children:K.map(t=>e.jsx("button",{type:"button",onClick:()=>xe(t.value),className:x("w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-colors",a.days_of_week.includes(t.value)?"bg-primary text-white":"bg-muted text-muted-foreground hover:bg-muted/80"),children:t.label},t.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"หมายเหตุ (ถ้ามี)"}),e.jsx(qe,{value:a.note,onChange:t=>m(s=>({...s,note:t.target.value})),placeholder:"เพิ่มรายละเอียดเพิ่มเติม",rows:2})]})]}),e.jsx(Ee,{className:"border-t border-border",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",className:"flex-1",onClick:()=>N(!1),children:"ยกเลิก"}),e.jsxs(o,{className:"flex-1 gap-2",onClick:me,disabled:k.isPending,children:[k.isPending&&e.jsx(S,{className:"w-4 h-4 animate-spin"}),e.jsx(Re,{className:"w-4 h-4"}),"บันทึก"]})]})})]})})]})}export{nt as default};
