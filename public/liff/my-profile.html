<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - Duulair</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="success-container">
      <div class="success-icon">üë§</div>
      <h1>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
      <p class="text-large" id="welcomeMessage">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
    </div>

    <!-- Registration Status Card -->
    <div class="card mb-2">
      <div class="status-badge success">
        ‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
      </div>

      <div class="profile-info">
        <div class="info-row">
          <span class="info-label">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</span>
          <span class="info-value" id="userRole">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£:</span>
          <span class="info-value" id="registeredDate">-</span>
        </div>
      </div>
    </div>

    <!-- Patient View -->
    <div id="patientDashboard" class="hidden">
      <!-- Personal Info Card -->
      <div class="card mb-2">
        <div class="card-header">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>

        <div class="profile-info">
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
            <span class="info-value" id="patientFullName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏≠‡∏≤‡∏¢‡∏∏:</span>
            <span class="info-value" id="patientAge">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏û‡∏®:</span>
            <span class="info-value" id="patientGender">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å / ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</span>
            <span class="info-value" id="patientWeightHeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</span>
            <span class="info-value" id="patientDiseases">‡πÑ‡∏°‡πà‡∏°‡∏µ</span>
          </div>
        </div>
      </div>

      <!-- Link Code Card -->
      <div class="card mb-2">
        <div class="card-header">üîó ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>

        <p class="text-center mb-2">
          ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        </p>

        <div class="link-code" id="linkCodeDisplay">
          ------
        </div>

        <div class="qr-code">
          <div id="qrCodeContainer" style="display: flex; justify-content: center; align-items: center;"></div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary btn-sm" onclick="shareCode()">
            üì§ ‡πÅ‡∏ä‡∏£‡πå
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="copyCode()">
            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
          </button>
        </div>

        <div class="alert alert-info">
          üí° ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </div>
      </div>

      <!-- Caregivers List Card -->
      <div class="card mb-2">
        <div class="card-header">üë• ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>

        <div id="caregiversList">
          <div class="empty-state">
            <p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
            <p class="text-center text-small">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Caregiver View -->
    <div id="caregiverDashboard" class="hidden">
      <!-- Personal Info Card -->
      <div class="card mb-2">
        <div class="card-header">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>

        <div class="profile-info">
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
            <span class="info-value" id="caregiverFullName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
            <span class="info-value" id="caregiverPhone">-</span>
          </div>
        </div>
      </div>

      <!-- Patients List Card -->
      <div class="card mb-2">
        <div class="card-header">üë• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡πÅ‡∏•</div>

        <div id="patientsList">
          <div class="empty-state">
            <p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
            <p class="text-center text-small">‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤</p>
          </div>
        </div>

        <button type="button" class="btn btn-block mt-2" onclick="addPatient()">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-2">
      <button type="button" class="btn btn-secondary btn-block" onclick="closeLiff()">
        ‡∏õ‡∏¥‡∏î
      </button>
    </div>

    <p class="text-center text-small mt-2" style="color: #666;">
      ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠? ‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠" ‡πÉ‡∏ô LINE Chat
    </p>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>

  <!-- App JavaScript -->

  <script>
    // ========================================
    // Dashboard Page Logic
    // ========================================

    let linkCode = null;
    let userData = null;

    async function init() {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        // Initialize LIFF
        liffProfile = await initLiff();
        if (!liffProfile) return;

        // Fetch user dashboard data
        const result = await api.checkRegistration(liffProfile.userId);

        if (!result.exists) {
          // Not registered - redirect to registration
          window.location.href = '/liff/role-selection.html';
          return;
        }

        userData = result;
        console.log('üìä User data:', userData);

        hideLoading();

        // Show appropriate dashboard
        if (result.role === 'patient') {
          await showPatientDashboard();
        } else if (result.role === 'caregiver') {
          await showCaregiverDashboard();
        }

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        hideLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }

    /**
     * Show patient dashboard
     */
    async function showPatientDashboard() {
      try {
        const profile = userData.profile;

        // Update header
        document.getElementById('welcomeMessage').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.first_name}`;
        document.getElementById('userRole').textContent = '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';

        // Format date
        const createdDate = new Date(profile.created_at);
        document.getElementById('registeredDate').textContent = formatThaiDate(createdDate);

        // Personal info
        document.getElementById('patientFullName').textContent =
          `${profile.first_name} ${profile.last_name}`;

        // Calculate age
        const birthDate = new Date(profile.birth_date);
        const age = calculateAge(birthDate);
        document.getElementById('patientAge').textContent = `${age} ‡∏õ‡∏µ`;

        // Gender
        const genderText = {
          'male': '‡∏ä‡∏≤‡∏¢',
          'female': '‡∏´‡∏ç‡∏¥‡∏á',
          'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        };
        document.getElementById('patientGender').textContent =
          genderText[profile.gender] || profile.gender;

        // Weight/Height
        if (profile.weight_kg && profile.height_cm) {
          const bmi = (profile.weight_kg / ((profile.height_cm / 100) ** 2)).toFixed(1);
          document.getElementById('patientWeightHeight').textContent =
            `${profile.weight_kg} kg / ${profile.height_cm} cm (BMI: ${bmi})`;
        } else {
          document.getElementById('patientWeightHeight').textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }

        // Chronic diseases
        if (profile.chronic_diseases && profile.chronic_diseases.length > 0) {
          document.getElementById('patientDiseases').textContent =
            profile.chronic_diseases.join(', ');
        }

        // Generate Link Code
        await loadLinkCode(profile.id);

        // Load caregivers list
        await loadCaregivers(profile.id);

        // Show patient dashboard
        document.getElementById('patientDashboard').classList.remove('hidden');

      } catch (error) {
        console.error('‚ùå Error loading patient dashboard:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
      }
    }

    /**
     * Show caregiver dashboard
     */
    async function showCaregiverDashboard() {
      try {
        const profile = userData.profile;

        // Update header
        document.getElementById('welcomeMessage').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.first_name}`;
        document.getElementById('userRole').textContent = '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•';

        // Format date
        const createdDate = new Date(profile.created_at);
        document.getElementById('registeredDate').textContent = formatThaiDate(createdDate);

        // Personal info
        document.getElementById('caregiverFullName').textContent =
          `${profile.first_name} ${profile.last_name}`;
        document.getElementById('caregiverPhone').textContent =
          profile.phone_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

        // Load patients list
        await loadPatients(profile.id);

        // Show caregiver dashboard
        document.getElementById('caregiverDashboard').classList.remove('hidden');

      } catch (error) {
        console.error('‚ùå Error loading caregiver dashboard:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
      }
    }

    /**
     * Load link code for patient
     */
    async function loadLinkCode(patientId) {
      try {
        const result = await api.generateLinkCode(patientId);
        linkCode = result.code;

        console.log('‚úÖ Link code:', linkCode);

        // Display link code
        document.getElementById('linkCodeDisplay').textContent = linkCode;

        // Generate QR code
        const qrContainer = document.getElementById('qrCodeContainer');
        qrContainer.innerHTML = '';

        if (typeof QRCode !== 'undefined') {
          new QRCode(qrContainer, {
            text: `DUULAIR:${linkCode}`,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
          console.log('‚úÖ QR Code generated');
        } else {
          console.error('‚ùå QRCode library not loaded');
          qrContainer.innerHTML = '<p style="color: #999;">QR Code ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ</p>';
        }

      } catch (error) {
        console.error('‚ùå Error loading link code:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ');
      }
    }

    /**
     * Load caregivers list for patient
     */
    async function loadCaregivers(patientId) {
      try {
        console.log('üìù Load caregivers for patient:', patientId);

        const result = await api.getPatientCaregivers(patientId);

        if (!result.success || !result.caregivers || result.caregivers.length === 0) {
          console.log('‚ÑπÔ∏è No caregivers found');
          return; // Show empty state (already in HTML)
        }

        const caregivers = result.caregivers;
        console.log('‚úÖ Caregivers loaded:', caregivers);

        // Create HTML for caregivers list
        const caregiversListHTML = caregivers.map(caregiver => `
          <div class="person-card">
            <div class="person-card-header">
              <span class="person-name">${caregiver.first_name} ${caregiver.last_name}</span>
              <span class="person-status ${caregiver.status === 'approved' ? 'approved' : 'pending'}">
                ${caregiver.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
              </span>
            </div>
            <div class="person-details">
              ${caregiver.relationship || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'} ‚Ä¢ ${caregiver.phone_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
            </div>
          </div>
        `).join('');

        // Update UI
        document.getElementById('caregiversList').innerHTML = caregiversListHTML;

      } catch (error) {
        console.error('‚ùå Error loading caregivers:', error);
      }
    }

    /**
     * Load patients list for caregiver
     */
    async function loadPatients(caregiverId) {
      try {
        console.log('üìù Load patients for caregiver:', caregiverId);

        const result = await api.getCaregiverPatients(caregiverId);

        if (!result.success || !result.patients || result.patients.length === 0) {
          console.log('‚ÑπÔ∏è No patients found');
          return; // Show empty state (already in HTML)
        }

        const patients = result.patients;
        console.log('‚úÖ Patients loaded:', patients);

        // Create HTML for patients list
        const patientsListHTML = patients.map(patient => {
          const age = calculateAge(new Date(patient.birth_date));
          return `
            <div class="person-card">
              <div class="person-card-header">
                <span class="person-name">${patient.first_name} ${patient.last_name}</span>
                <span class="person-status approved">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
              </div>
              <div class="person-details">
                ‡∏≠‡∏≤‡∏¢‡∏∏ ${age} ‡∏õ‡∏µ ‚Ä¢ ${patient.gender === 'male' ? '‡∏ä‡∏≤‡∏¢' : patient.gender === 'female' ? '‡∏´‡∏ç‡∏¥‡∏á' : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
              </div>
              ${patient.chronic_diseases && patient.chronic_diseases.length > 0 ? `
                <div class="person-details">
                  ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${patient.chronic_diseases.join(', ')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Update UI
        document.getElementById('patientsList').innerHTML = patientsListHTML;

      } catch (error) {
        console.error('‚ùå Error loading patients:', error);
      }
    }

    /**
     * Share link code via LINE
     */
    async function shareCode() {
      if (!linkCode) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        return;
      }

      const message = {
        type: 'text',
        text: `üîó ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Duulair\n\n‡∏£‡∏´‡∏±‡∏™: ${linkCode}\n\n‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô\n\nüì± ‡πÄ‡∏õ‡∏¥‡∏î LINE ‚Üí Duulair ‚Üí ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ`
      };

      const success = await shareWithTargetPicker(message);

      if (success) {
        showSuccess('‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } else {
        copyCode();
      }
    }

    /**
     * Copy link code to clipboard
     */
    function copyCode() {
      if (!linkCode) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        return;
      }

      const input = document.createElement('input');
      input.value = linkCode;
      document.body.appendChild(input);
      input.select();

      try {
        document.execCommand('copy');
        showSuccess('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } catch (error) {
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ');
      }

      document.body.removeChild(input);
    }

    /**
     * Add patient for caregiver
     */
    function addPatient() {
      // Redirect to caregiver registration page to add link code
      window.location.href = '/liff/caregiver-registration.html';
    }

    /**
     * Calculate age from birth date
     */
    function calculateAge(birthDate) {
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();

      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      return age;
    }

    /**
     * Format Thai date
     */
    function formatThaiDate(date) {
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      };

      return date.toLocaleDateString('th-TH', options);
    }

    // ========================================
    // Start
    // ========================================

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
