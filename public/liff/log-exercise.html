<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <!-- External Scripts -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Section Title */
    .section-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
    }

    /* Exercise Type Grid */
    .exercise-type-section {
      margin-bottom: 1.5rem;
    }

    .exercise-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .exercise-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 0.5rem;
      background: hsl(var(--card));
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .exercise-btn:active {
      transform: scale(0.97);
    }

    .exercise-btn.selected {
      background: hsl(263 70% 95% / 0.5);
      border-color: hsl(263 70% 50%);
    }

    .dark .exercise-btn.selected {
      background: hsl(263 50% 20% / 0.5);
      border-color: hsl(263 70% 65%);
    }

    .exercise-btn .icon-wrapper {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(263 70% 95%);
      color: hsl(263 70% 50%);
    }

    .dark .exercise-btn .icon-wrapper {
      background: hsl(263 50% 20%);
      color: hsl(263 70% 65%);
    }

    .exercise-btn .icon-wrapper svg {
      width: 24px;
      height: 24px;
    }

    .exercise-btn .label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
      text-align: center;
    }

    .exercise-btn.selected .label {
      color: hsl(263 70% 50%);
      font-weight: 600;
    }

    .dark .exercise-btn.selected .label {
      color: hsl(263 70% 65%);
    }

    /* Custom Exercise Input */
    .custom-exercise-input {
      margin-top: 0.75rem;
      display: none;
    }

    .custom-exercise-input.show {
      display: block;
    }

    .custom-exercise-input input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      font-size: 0.9375rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
    }

    .custom-exercise-input input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    /* Duration Section */
    .duration-section {
      margin-bottom: 1.5rem;
    }

    .duration-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .duration-input-wrapper input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      font-size: 1.125rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      text-align: center;
    }

    .duration-input-wrapper input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    .duration-input-wrapper .unit-label {
      font-size: 0.9375rem;
      color: hsl(var(--muted-foreground));
      white-space: nowrap;
    }

    /* Intensity Section */
    .intensity-section {
      margin-bottom: 1.5rem;
    }

    .intensity-selector {
      display: flex;
      gap: 0.5rem;
    }

    .intensity-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      background: hsl(var(--card));
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .intensity-btn:active {
      transform: scale(0.97);
    }

    .intensity-btn.selected {
      border-color: hsl(var(--primary));
    }

    .intensity-btn.selected.level-light {
      background: hsl(142 76% 90%);
    }

    .intensity-btn.selected.level-medium {
      background: hsl(48 96% 89%);
    }

    .intensity-btn.selected.level-intense {
      background: hsl(0 93% 90%);
    }

    .dark .intensity-btn.selected.level-light {
      background: hsl(142 50% 20%);
    }

    .dark .intensity-btn.selected.level-medium {
      background: hsl(48 50% 20%);
    }

    .dark .intensity-btn.selected.level-intense {
      background: hsl(0 50% 20%);
    }

    .intensity-btn .intensity-icon {
      font-size: 1.25rem;
    }

    .intensity-btn .label {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      text-align: center;
    }

    .intensity-btn.selected .label {
      color: hsl(var(--primary));
      font-weight: 600;
    }

    /* Time of Day Section */
    .timeofday-section {
      margin-bottom: 1.5rem;
    }

    .chip-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip {
      padding: 0.5rem 1rem;
      background: hsl(var(--card));
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: hsl(var(--muted-foreground));
    }

    .chip:active {
      transform: scale(0.97);
    }

    .chip.selected {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
      color: hsl(var(--primary));
      font-weight: 500;
    }

    /* Distance Section */
    .distance-section {
      margin-bottom: 1.5rem;
    }

    .distance-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .distance-input-wrapper input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      text-align: center;
    }

    .distance-input-wrapper input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    .distance-input-wrapper .unit-label {
      font-size: 0.9375rem;
      color: hsl(var(--muted-foreground));
      white-space: nowrap;
    }

    /* Note Section */
    .note-section {
      margin-bottom: 1.5rem;
    }

    .note-input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      font-size: 0.9375rem;
      font-family: var(--font-sans);
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      transition: all 0.2s ease;
      resize: none;
      min-height: 80px;
    }

    .note-input::placeholder {
      color: hsl(var(--muted-foreground));
    }

    .note-input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    /* Submit Section */
    .submit-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: hsl(var(--background));
      border-top: 1px solid hsl(var(--border));
      z-index: 100;
    }

    .submit-btn {
      width: 100%;
      padding: 0.875rem;
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(190 85% 25%) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .submit-btn:disabled {
      background: hsl(var(--muted-foreground));
      cursor: not-allowed;
    }

    .submit-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .submit-btn:not(:disabled):active {
      transform: scale(0.98);
    }

    .submit-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 0.875rem 1.5rem;
      border-radius: var(--radius-lg);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toast svg {
      width: 20px;
      height: 20px;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: linear-gradient(135deg, hsl(142 70% 45%) 0%, hsl(142 70% 35%) 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, hsl(0 70% 50%) 0%, hsl(0 70% 40%) 100%);
    }

    /* Tab Switcher */
    .tab-switcher {
      display: flex;
      background: hsl(var(--muted));
      border-radius: var(--radius-lg);
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .tab-btn {
      flex: 1;
      padding: 0.625rem;
      border: none;
      border-radius: var(--radius-md);
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      color: hsl(var(--muted-foreground));
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
    }

    .tab-btn.active {
      background: hsl(var(--card));
      color: hsl(var(--primary));
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .history-tab-content {
      display: none;
    }

    .history-tab-content.active {
      display: block;
    }

    .history-day-header {
      font-size: 0.8125rem;
      font-weight: 600;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.5rem;
      padding-bottom: 0.375rem;
      border-bottom: 1px solid hsl(var(--border));
      margin-top: 1rem;
    }

    .history-day-header:first-child {
      margin-top: 0;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: hsl(var(--muted) / 0.3);
      border-radius: var(--radius-lg);
      margin-bottom: 0.5rem;
    }

    .history-item-icon {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: hsl(263 70% 95%);
      color: hsl(263 70% 50%);
    }

    .dark .history-item-icon {
      background: hsl(263 50% 20%);
      color: hsl(263 70% 65%);
    }

    .history-item-icon svg {
      width: 18px;
      height: 18px;
    }

    .history-item-content {
      flex: 1;
      min-width: 0;
    }

    .history-item-text {
      font-size: 0.875rem;
      color: hsl(var(--foreground));
    }

    .history-item-time {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    .history-empty {
      text-align: center;
      padding: 2rem;
      color: hsl(var(--muted-foreground));
    }

    .history-empty svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
      margin-bottom: 0.5rem;
    }

    /* History Filter Controls */
    .history-filter {
      margin-bottom: 1rem;
    }

    .period-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .period-btn {
      flex: 1;
      padding: 0.5rem;
      border: 1.5px solid hsl(var(--border));
      border-radius: var(--radius-md);
      background: hsl(var(--card));
      font-size: 0.8125rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      color: hsl(var(--muted-foreground));
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .period-btn.active {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
      color: hsl(var(--primary));
      font-weight: 600;
    }

    .date-range-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .date-range-row input[type="date"] {
      flex: 1;
      padding: 0.5rem 0.625rem;
      border: 1.5px solid hsl(var(--border));
      border-radius: var(--radius-md);
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      font-size: 0.8125rem;
      font-family: 'Kanit', sans-serif;
    }

    .date-range-row input[type="date"]:focus {
      outline: none;
      border-color: hsl(var(--primary));
    }

    .date-range-row .date-sep {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      flex-shrink: 0;
    }

    .date-range-row .date-search-btn {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: var(--radius-md);
      background: hsl(var(--primary));
      color: white;
      font-size: 0.8125rem;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .date-range-row .date-search-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Container padding for fixed submit */
    .container {
      padding-bottom: 120px;
    }

    /* Hide fixed submit when keyboard is visible (viewport shrinks) */
    @media (max-height: 500px) {
      .submit-section {
        position: static !important;
        box-shadow: none !important;
      }
    }

    @media (max-width: 380px) {
      .exercise-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .intensity-selector {
        flex-wrap: wrap;
      }

      .intensity-btn {
        min-width: calc(50% - 0.25rem);
        flex: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="goBack()" aria-label="‡∏Å‡∏•‡∏±‡∏ö" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°" id="themeBtn"></button>
      </header>

      <!-- Tab Switcher -->
      <div class="tab-switcher">
        <button class="tab-btn active" onclick="switchTab('today')" id="tabToday">
          <span id="tabTodayIcon"></span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </button>
        <button class="tab-btn" onclick="switchTab('history')" id="tabHistory">
          <span id="tabHistoryIcon"></span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>

      <!-- Today Content -->
      <div id="todayContent">
        <!-- Exercise Type Grid -->
        <div class="exercise-type-section">
          <div class="section-title" id="exerciseTypeTitle"></div>
          <div class="exercise-grid" id="exerciseGrid">
            <!-- Exercise types rendered by JS -->
          </div>
          <div class="custom-exercise-input" id="customExerciseInput">
            <input type="text" id="customExerciseName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
          </div>
        </div>

        <!-- Duration Section -->
        <div class="duration-section">
          <div class="section-title" id="durationTitle"></div>
          <div class="duration-input-wrapper">
            <input type="number" id="durationInput" min="1" max="999" value="30" inputmode="numeric">
            <span class="unit-label">‡∏ô‡∏≤‡∏ó‡∏µ</span>
          </div>
        </div>

        <!-- Intensity Section -->
        <div class="intensity-section">
          <div class="section-title" id="intensityTitle"></div>
          <div class="intensity-selector" id="intensitySelector">
            <!-- Intensity buttons rendered by JS -->
          </div>
        </div>

        <!-- Time of Day Section -->
        <div class="timeofday-section">
          <div class="section-title" id="timeOfDayTitle"></div>
          <div class="chip-selector" id="timeOfDaySelector">
            <!-- Time of day chips rendered by JS -->
          </div>
        </div>

        <!-- Distance Section -->
        <div class="distance-section">
          <div class="section-title" id="distanceTitle"></div>
          <div class="distance-input-wrapper">
            <input type="number" id="distanceInput" min="0" max="99999" placeholder="‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö" inputmode="numeric">
            <span class="unit-label">‡πÄ‡∏°‡∏ï‡∏£</span>
          </div>
        </div>

        <!-- Note Section -->
        <div class="note-section">
          <div class="section-title" id="noteTitle"></div>
          <textarea id="noteInput" class="note-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏ô‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞, ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡∏°‡∏≤‡∏Å"></textarea>
        </div>
      </div><!-- /todayContent -->

      <!-- History Content -->
      <div id="historyContent" class="history-tab-content">
        <div class="history-filter">
          <div class="period-buttons">
            <button class="period-btn active" onclick="selectPeriodDays(7)">7 ‡∏ß‡∏±‡∏ô</button>
            <button class="period-btn" onclick="selectPeriodDays(14)">14 ‡∏ß‡∏±‡∏ô</button>
            <button class="period-btn" onclick="selectPeriodDays(30)">30 ‡∏ß‡∏±‡∏ô</button>
            <button class="period-btn" onclick="toggleDateRange()">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</button>
          </div>
          <div class="date-range-row" id="dateRangeRow" style="display:none;">
            <input type="date" id="dateFrom">
            <span class="date-sep">‡∏ñ‡∏∂‡∏á</span>
            <input type="date" id="dateTo">
            <button class="date-search-btn" onclick="searchByDateRange()" id="dateSearchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>
        </div>
        <div id="historyList">
          <div class="history-empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
      </div>
    </div>

    <!-- Submit Section -->
    <div id="submitSection" class="submit-section hidden">
      <button class="submit-btn" id="submitBtn" onclick="submitExercise()" disabled>
        <span id="submitIcon"></span>
        <span id="submitText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</span>
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <script>
    // API Base URL
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : 'https://duulair.vercel.app/api';

    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';

    let supabaseClient = null;
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let patientId = null;

    // Exercise type definitions
    const exerciseTypes = [
      { type: 'walk', typeTh: '‡πÄ‡∏î‡∏¥‡∏ô', icon: 'footprints' },
      { type: 'run', typeTh: '‡∏ß‡∏¥‡πà‡∏á', icon: 'zap' },
      { type: 'swim', typeTh: '‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥', icon: 'waves' },
      { type: 'bicycle', typeTh: '‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô', icon: 'bike' },
      { type: 'yoga', typeTh: '‡πÇ‡∏¢‡∏Ñ‡∏∞', icon: 'heart' },
      { type: 'custom', typeTh: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á', icon: 'edit' }
    ];

    // Intensity levels
    const intensityLevels = [
      { level: 'light', label: '‡πÄ‡∏ö‡∏≤', emoji: 'üü¢' },
      { level: 'medium', label: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', emoji: 'üü°' },
      { level: 'intense', label: '‡∏´‡∏ô‡∏±‡∏Å', emoji: 'üî¥' }
    ];

    // Time of day options
    const timeOfDayOptions = [
      { id: 'morning', label: '‡πÄ‡∏ä‡πâ‡∏≤' },
      { id: 'afternoon', label: '‡∏ö‡πà‡∏≤‡∏¢' },
      { id: 'evening', label: '‡πÄ‡∏¢‡πá‡∏ô' }
    ];

    // Selected state
    let selectedType = null;
    let selectedTypeTh = null;
    let selectedIntensity = null;
    let selectedTimeOfDay = null;

    // Initialize UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('arrowLeft');
      document.getElementById('headerTitle').innerHTML = icon('dumbbell', 'inline-icon') + ' ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢';
      document.getElementById('themeBtn').innerHTML = icon('sun');
      document.getElementById('exerciseTypeTitle').innerHTML = icon('dumbbell') + ' ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
      document.getElementById('durationTitle').innerHTML = icon('clock') + ' ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)';
      document.getElementById('intensityTitle').innerHTML = icon('zap') + ' ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô';
      document.getElementById('timeOfDayTitle').innerHTML = icon('clock') + ' ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
      document.getElementById('distanceTitle').innerHTML = icon('mapPin') + ' ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£) - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö';
      document.getElementById('noteTitle').innerHTML = icon('fileText') + ' ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)';
      document.getElementById('submitIcon').innerHTML = icon('check');
      document.getElementById('tabTodayIcon').innerHTML = icon('edit');
      document.getElementById('tabHistoryIcon').innerHTML = icon('clock');

      // Render static options immediately
      renderExerciseTypes();
      renderIntensity();
      renderTimeOfDay();

      // Determine current time of day and auto-select
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) {
        selectTimeOfDay('morning');
      } else if (hour >= 12 && hour < 17) {
        selectTimeOfDay('afternoon');
      } else {
        selectTimeOfDay('evening');
      }

      // Show UI immediately
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('submitSection').classList.remove('hidden');
    })();

    // Update theme icon
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };
    setTimeout(updateThemeIcon, 100);

    // Render exercise type buttons
    function renderExerciseTypes() {
      const grid = document.getElementById('exerciseGrid');
      grid.innerHTML = exerciseTypes.map(e => `
        <div class="exercise-btn ${selectedType === e.type ? 'selected' : ''}" data-type="${e.type}" onclick="selectExerciseType('${e.type}')">
          <div class="icon-wrapper">${icon(e.icon)}</div>
          <span class="label">${e.typeTh}</span>
        </div>
      `).join('');
    }

    // Render intensity buttons
    function renderIntensity() {
      const container = document.getElementById('intensitySelector');
      container.innerHTML = intensityLevels.map(i => `
        <div class="intensity-btn level-${i.level} ${selectedIntensity === i.level ? 'selected' : ''}" data-level="${i.level}" onclick="selectIntensity('${i.level}')">
          <span class="intensity-icon">${i.emoji}</span>
          <span class="label">${i.label}</span>
        </div>
      `).join('');
    }

    // Render time of day chips
    function renderTimeOfDay() {
      const container = document.getElementById('timeOfDaySelector');
      container.innerHTML = timeOfDayOptions.map(t => `
        <div class="chip ${selectedTimeOfDay === t.id ? 'selected' : ''}" onclick="selectTimeOfDay('${t.id}')">${t.label}</div>
      `).join('');
    }

    // Select exercise type
    function selectExerciseType(type) {
      const exerciseDef = exerciseTypes.find(e => e.type === type);
      if (!exerciseDef) return;

      selectedType = type;
      selectedTypeTh = exerciseDef.typeTh;

      // Show/hide custom input
      const customInput = document.getElementById('customExerciseInput');
      if (type === 'custom') {
        customInput.classList.add('show');
        document.getElementById('customExerciseName').focus();
      } else {
        customInput.classList.remove('show');
      }

      renderExerciseTypes();
      updateSubmitButton();
    }

    // Select intensity
    function selectIntensity(level) {
      selectedIntensity = level;
      renderIntensity();
      updateSubmitButton();
    }

    // Select time of day
    function selectTimeOfDay(period) {
      selectedTimeOfDay = selectedTimeOfDay === period ? null : period;
      renderTimeOfDay();
    }

    // Update submit button state
    function updateSubmitButton() {
      const btn = document.getElementById('submitBtn');
      const duration = document.getElementById('durationInput').value;
      const hasType = selectedType && (selectedType !== 'custom' || document.getElementById('customExerciseName').value.trim());
      const hasDuration = duration && parseInt(duration) > 0;

      btn.disabled = !hasType || !hasDuration;
    }

    // Listen for input changes to update submit button
    document.getElementById('durationInput').addEventListener('input', updateSubmitButton);
    document.getElementById('customExerciseName').addEventListener('input', function() {
      if (selectedType === 'custom') {
        selectedTypeTh = this.value.trim() || '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á';
        updateSubmitButton();
      }
    });

    // Submit exercise log
    async function submitExercise() {
      const btn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');

      // Validate
      const duration = document.getElementById('durationInput').value;
      if (!selectedType || !duration || parseInt(duration) <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', 'error');
        return;
      }

      // For custom type, validate name
      if (selectedType === 'custom') {
        const customName = document.getElementById('customExerciseName').value.trim();
        if (!customName) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
          return;
        }
        selectedTypeTh = customName;
      }

      btn.disabled = true;
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const distance = document.getElementById('distanceInput').value;
        const note = document.getElementById('noteInput').value.trim();

        const exerciseData = {
          patient_id: patientId,
          exercise_date: new Date().toISOString().split('T')[0],
          exercise_type: selectedType,
          exercise_type_th: selectedTypeTh,
          duration_minutes: parseInt(duration),
          intensity: selectedIntensity,
          time_of_day: selectedTimeOfDay,
          distance_meters: distance ? parseInt(distance) : null,
          notes: note || null
        };

        const { error } = await supabaseClient
          .from('exercise_logs')
          .insert(exerciseData);

        if (error) throw error;

        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${selectedTypeTh} ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');

        // Reset form
        resetForm();

      } catch (error) {
        console.error('Error submitting exercise:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      } finally {
        btn.disabled = false;
        submitText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢';
        updateSubmitButton();
      }
    }

    // Reset form
    function resetForm() {
      selectedType = null;
      selectedTypeTh = null;
      selectedIntensity = null;

      document.getElementById('durationInput').value = '30';
      document.getElementById('distanceInput').value = '';
      document.getElementById('noteInput').value = '';
      document.getElementById('customExerciseName').value = '';
      document.getElementById('customExerciseInput').classList.remove('show');

      renderExerciseTypes();
      renderIntensity();
      updateSubmitButton();

      // Re-auto-select time of day
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) {
        selectTimeOfDay('morning');
      } else if (hour >= 12 && hour < 17) {
        selectTimeOfDay('afternoon');
      } else {
        selectTimeOfDay('evening');
      }
    }

    // Cache LIFF profile
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Check registration
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await getCachedProfile();
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

        // Get context
        const context = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = context.patientId;

      } catch (error) {
        console.error('LIFF init error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function goBack() {
      const returnTo = sessionStorage.getItem('liff_return_to');
      if (returnTo) {
        sessionStorage.removeItem('liff_return_to');
        const basePath = window.location.pathname.replace(/[^/]*$/, '');
        window.location.href = basePath + returnTo;
      } else {
        window.location.href = 'health-log.html';
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const iconName = type === 'success' ? 'checkCircle' : 'alertCircle';
      toast.innerHTML = icon(iconName) + ' ' + message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- Tab switching & History ---
    let currentTab = 'today';
    let historyPeriodDays = 7;
    let historyFirstLoad = true;

    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tabToday').classList.toggle('active', tab === 'today');
      document.getElementById('tabHistory').classList.toggle('active', tab === 'history');
      document.getElementById('todayContent').style.display = tab === 'today' ? '' : 'none';
      document.getElementById('historyContent').classList.toggle('active', tab === 'history');
      const submitSection = document.getElementById('submitSection');
      if (submitSection) submitSection.style.display = tab === 'today' ? '' : 'none';
      if (tab === 'history' && historyFirstLoad) {
        historyFirstLoad = false;
        loadHistory();
      }
    }

    function selectPeriodDays(days) {
      historyPeriodDays = days;
      document.querySelectorAll('.period-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === [7,14,30].indexOf(days));
      });
      document.getElementById('dateRangeRow').style.display = 'none';
      loadHistory();
    }

    function toggleDateRange() {
      document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.period-btn')[3].classList.add('active');
      const row = document.getElementById('dateRangeRow');
      row.style.display = row.style.display === 'none' ? 'flex' : 'none';
      if (row.style.display === 'flex') {
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        document.getElementById('dateTo').value = today;
        document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
      }
    }

    function searchByDateRange() {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;
      if (!from || !to) return;
      loadHistory(new Date(from), new Date(to + 'T23:59:59'));
    }

    async function loadHistory(fromDate, toDate) {
      if (!supabaseClient || !patientId) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty">' + icon('alertCircle') + '<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p></div>';
        return;
      }

      document.getElementById('historyList').innerHTML = '<div class="history-empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

      if (!fromDate) {
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - historyPeriodDays);
      }
      if (!toDate) {
        toDate = new Date();
      }

      try {
        const { data, error } = await supabaseClient
          .from('exercise_logs')
          .select('*')
          .eq('patient_id', patientId)
          .gte('created_at', fromDate.toISOString())
          .lte('created_at', toDate.toISOString())
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        renderHistory(data || []);
      } catch (err) {
        console.error('Error loading history:', err);
        document.getElementById('historyList').innerHTML = '<div class="history-empty">' + icon('alertCircle') + '<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</p></div>';
      }
    }

    function renderHistory(records) {
      const container = document.getElementById('historyList');

      if (records.length === 0) {
        container.innerHTML = '<div class="history-empty">' + icon('dumbbell') + '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</p></div>';
        return;
      }

      const intensityTh = { light: '‡πÄ‡∏ö‡∏≤', medium: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', intense: '‡∏´‡∏ô‡∏±‡∏Å' };

      const grouped = {};
      records.forEach(r => {
        const date = new Date(r.created_at).toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(r);
      });

      let html = '';
      for (const [date, items] of Object.entries(grouped)) {
        html += `<div class="history-day-header">${date}</div>`;
        items.forEach(item => {
          const time = new Date(item.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const name = item.exercise_type_th || item.exercise_type || '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢';
          const duration = item.duration_minutes ? `${item.duration_minutes} ‡∏ô‡∏≤‡∏ó‡∏µ` : '';
          const intensity = item.intensity ? ` (${intensityTh[item.intensity] || item.intensity})` : '';
          html += `
            <div class="history-item">
              <div class="history-item-icon">${icon('dumbbell')}</div>
              <div class="history-item-content">
                <div class="history-item-text">${name} ${duration}${intensity}</div>
                <div class="history-item-time">${time}</div>
              </div>
            </div>`;
        });
      }

      container.innerHTML = html;
    }

    // Handle mobile keyboard overlay
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        const submitSection = document.getElementById('submitSection');
        if (!submitSection) return;
        const viewportHeight = window.visualViewport.height;
        const windowHeight = window.innerHeight;
        if (viewportHeight < windowHeight * 0.75) {
          submitSection.style.position = 'static';
          submitSection.style.boxShadow = 'none';
          document.querySelector('.container').style.paddingBottom = '1rem';
        } else {
          submitSection.style.position = '';
          submitSection.style.boxShadow = '';
          document.querySelector('.container').style.paddingBottom = '';
        }
      });
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
