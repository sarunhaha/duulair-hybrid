<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF Debug Console</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: monospace;
      font-size: 13px;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
    }
    #console {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .log { color: #d4d4d4; }
    .info { color: #4fc3f7; }
    .success { color: #81c784; }
    .warn { color: #ffb74d; }
    .error { color: #e57373; }
    .debug { color: #9575cd; }
    .timestamp { color: #757575; margin-right: 8px; }
    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      background: #333;
      color: white;
      z-index: 1000;
    }
    #status.loading { background: #ff9800; }
    #status.success { background: #4caf50; }
    #status.error { background: #f44336; }
  </style>
</head>
<body>
  <div id="status" class="loading">‚è≥ Initializing...</div>
  <div id="console"></div>

  <script>
    const consoleEl = document.getElementById('console');
    const statusEl = document.getElementById('status');

    function setStatus(text, type = 'loading') {
      statusEl.textContent = text;
      statusEl.className = type;
    }

    function log(message, type = 'log') {
      const timestamp = new Date().toLocaleTimeString('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        fractionalSecondDigits: 3
      });

      const line = document.createElement('div');
      line.className = type;
      line.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
      consoleEl.appendChild(line);
      consoleEl.scrollTop = consoleEl.scrollHeight;

      console.log(`[${type.toUpperCase()}]`, message);
    }

    function logObject(obj, label = 'Object') {
      log(`${label}:`, 'debug');
      log(JSON.stringify(obj, null, 2), 'debug');
    }

    // Override console methods
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = (...args) => {
      originalLog.apply(console, args);
      log(args.join(' '), 'log');
    };

    console.error = (...args) => {
      originalError.apply(console, args);
      log(args.join(' '), 'error');
    };

    console.warn = (...args) => {
      originalWarn.apply(console, args);
      log(args.join(' '), 'warn');
    };

    // Catch all errors
    window.addEventListener('error', (event) => {
      log(`‚ùå Uncaught Error: ${event.message}`, 'error');
      log(`   at ${event.filename}:${event.lineno}:${event.colno}`, 'error');
      setStatus('‚ùå Error', 'error');
    });

    window.addEventListener('unhandledrejection', (event) => {
      log(`‚ùå Unhandled Promise Rejection: ${event.reason}`, 'error');
      setStatus('‚ùå Promise Error', 'error');
    });

    // Start logging
    log('='.repeat(50), 'debug');
    log('üîç LIFF Debug Console Started', 'info');
    log('='.repeat(50), 'debug');
    log('');
    log(`URL: ${window.location.href}`, 'info');
    log(`User Agent: ${navigator.userAgent}`, 'info');
    log(`Platform: ${navigator.platform}`, 'info');
    log('');
  </script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    (async function() {
      try {
        const LIFF_ID = '2008278683-5k69jxNq';

        log('‚îÅ'.repeat(50), 'debug');
        log('STEP 1: Checking LIFF SDK', 'info');
        log('‚îÅ'.repeat(50), 'debug');

        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK not loaded');
        }
        log('‚úÖ LIFF SDK loaded successfully', 'success');
        log(`   liff version: ${liff.version || 'unknown'}`, 'debug');
        log('');

        log('‚îÅ'.repeat(50), 'debug');
        log('STEP 2: Initializing LIFF', 'info');
        log('‚îÅ'.repeat(50), 'debug');
        log(`LIFF ID: ${LIFF_ID}`, 'debug');

        setStatus('üîÑ Initializing LIFF...', 'loading');

        const startTime = Date.now();
        await liff.init({ liffId: LIFF_ID });
        const initTime = Date.now() - startTime;

        log(`‚úÖ LIFF initialized successfully in ${initTime}ms`, 'success');
        log('');

        log('‚îÅ'.repeat(50), 'debug');
        log('STEP 3: Checking LIFF Context', 'info');
        log('‚îÅ'.repeat(50), 'debug');

        const context = liff.getContext();
        logObject(context, 'Context');
        log('');

        log(`üì± LINE Version: ${liff.getLineVersion()}`, 'info');
        log(`üìç In Client: ${liff.isInClient()}`, 'info');
        log(`üîê Is Logged In: ${liff.isLoggedIn()}`, 'info');
        log(`üåê Language: ${liff.getLanguage()}`, 'info');
        log('');

        if (!liff.isLoggedIn()) {
          log('‚ö†Ô∏è  Not logged in - initiating login...', 'warn');
          setStatus('üîê Login Required', 'loading');

          setTimeout(() => {
            log('üîÄ Redirecting to LINE login...', 'info');
            liff.login();
          }, 2000);
          return;
        }

        log('‚îÅ'.repeat(50), 'debug');
        log('STEP 4: Getting Profile', 'info');
        log('‚îÅ'.repeat(50), 'debug');

        setStatus('üë§ Getting Profile...', 'loading');
        const profile = await liff.getProfile();

        log('‚úÖ Profile retrieved successfully', 'success');
        logObject(profile, 'Profile');
        log('');

        log('‚îÅ'.repeat(50), 'debug');
        log('STEP 5: Testing API', 'info');
        log('‚îÅ'.repeat(50), 'debug');

        const API_BASE = window.location.hostname === 'localhost'
          ? 'http://localhost:3000'
          : 'https://duulair.vercel.app';

        log(`API Base: ${API_BASE}`, 'debug');

        setStatus('üåê Testing API...', 'loading');

        const response = await fetch(`${API_BASE}/api/registration/check`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line_user_id: profile.userId })
        });

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        log('‚úÖ API responded successfully', 'success');
        logObject(data, 'API Response');
        log('');

        log('‚îÅ'.repeat(50), 'debug');
        log('‚úÖ ALL TESTS PASSED', 'success');
        log('‚îÅ'.repeat(50), 'debug');

        setStatus('‚úÖ All Good!', 'success');

        log('');
        log(`üìç Next Steps:`, 'info');
        if (data.exists) {
          log(`   User is registered (Role: ${data.role})`, 'info');
          log(`   Should redirect to: /liff/dashboard.html`, 'info');
        } else {
          log(`   User is NOT registered`, 'info');
          log(`   Should redirect to: /liff/role-selection.html`, 'info');
        }

      } catch (error) {
        log('‚îÅ'.repeat(50), 'debug');
        log('‚ùå ERROR OCCURRED', 'error');
        log('‚îÅ'.repeat(50), 'debug');
        log(`Error: ${error.message}`, 'error');
        log(`Stack:`, 'error');
        log(error.stack || 'No stack trace', 'error');

        setStatus('‚ùå Failed', 'error');
      }
    })();
  </script>
</body>
</html>
