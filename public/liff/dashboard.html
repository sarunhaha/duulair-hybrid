<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>บันทึกสุขภาพ - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <style>
    /* Hero Section */
    .hero-card {
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-dark)) 100%);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 200px;
      height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .hero-card::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -20%;
      width: 150px;
      height: 150px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
    }

    .hero-content {
      position: relative;
      z-index: 1;
    }

    .hero-greeting {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
    }

    .hero-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 0.875rem;
      opacity: 0.85;
    }

    .hero-icon {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    .hero-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    /* Section Title */
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title svg {
      width: 20px;
      height: 20px;
      color: hsl(var(--primary));
    }

    /* Quick Actions Grid */
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .action-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 130px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-card:active {
      transform: scale(0.98);
    }

    .action-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.75rem;
    }

    .action-icon svg {
      width: 28px;
      height: 28px;
    }

    .action-icon.water {
      background: linear-gradient(135deg, hsl(200 85% 92%) 0%, hsl(200 85% 85%) 100%);
    }
    .action-icon.water svg { color: hsl(200 85% 45%); }

    .action-icon.medication {
      background: linear-gradient(135deg, hsl(280 85% 92%) 0%, hsl(280 85% 85%) 100%);
    }
    .action-icon.medication svg { color: hsl(280 85% 45%); }

    .action-icon.vitals {
      background: linear-gradient(135deg, hsl(350 85% 92%) 0%, hsl(350 85% 85%) 100%);
    }
    .action-icon.vitals svg { color: hsl(350 85% 45%); }

    .action-icon.report {
      background: linear-gradient(135deg, hsl(var(--accent) / 0.2) 0%, hsl(var(--accent) / 0.3) 100%);
    }
    .action-icon.report svg { color: hsl(var(--accent)); }

    .action-label {
      font-size: 0.9375rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      text-align: center;
    }

    .action-sublabel {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      margin-top: 0.25rem;
    }

    /* Dark mode action icons */
    .dark .action-icon.water {
      background: linear-gradient(135deg, hsl(200 60% 25%) 0%, hsl(200 60% 20%) 100%);
    }
    .dark .action-icon.water svg { color: hsl(200 70% 60%); }

    .dark .action-icon.medication {
      background: linear-gradient(135deg, hsl(280 60% 25%) 0%, hsl(280 60% 20%) 100%);
    }
    .dark .action-icon.medication svg { color: hsl(280 70% 60%); }

    .dark .action-icon.vitals {
      background: linear-gradient(135deg, hsl(350 60% 25%) 0%, hsl(350 60% 20%) 100%);
    }
    .dark .action-icon.vitals svg { color: hsl(350 70% 60%); }

    /* Tips Card */
    .tips-card {
      background: hsl(var(--muted));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .tips-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .tips-header svg {
      width: 20px;
      height: 20px;
      color: hsl(var(--accent));
    }

    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tips-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
      border-bottom: 1px solid hsl(var(--border));
    }

    .tips-list li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .tips-list li svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
      flex-shrink: 0;
      margin-top: 2px;
    }

    /* Close Button */
    .close-section {
      padding-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="closeLiff()" aria-label="ปิด" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Hero Card -->
      <div class="hero-card">
        <div class="hero-content">
          <div class="hero-greeting">ยินดีต้อนรับ</div>
          <div class="hero-name" id="welcomeName">สวัสดี</div>
          <div class="hero-subtitle">เลือกเมนูด้านล่างเพื่อบันทึกข้อมูลสุขภาพ</div>
        </div>
        <div class="hero-icon" id="heroIcon"></div>
      </div>

      <!-- Quick Actions Section -->
      <div class="section-title" id="sectionIcon"></div>

      <div class="actions-grid">
        <!-- Water Tracking -->
        <a href="water-tracking.html" class="action-card">
          <div class="action-icon water" id="waterIcon"></div>
          <div class="action-label">บันทึกน้ำ</div>
          <div class="action-sublabel">Water</div>
        </a>

        <!-- Medications -->
        <a href="medications.html" class="action-card">
          <div class="action-icon medication" id="medicationIcon"></div>
          <div class="action-label">ยา</div>
          <div class="action-sublabel">Medications</div>
        </a>

        <!-- Vitals -->
        <a href="vitals-tracking.html" class="action-card">
          <div class="action-icon vitals" id="vitalsIcon"></div>
          <div class="action-label">วัดความดัน</div>
          <div class="action-sublabel">Vitals</div>
        </a>

        <!-- Report -->
        <a href="health-log.html" class="action-card">
          <div class="action-icon report" id="reportIcon"></div>
          <div class="action-label">สรุปสุขภาพ</div>
          <div class="action-sublabel">Health Log</div>
        </a>
      </div>

      <!-- Tips Section -->
      <div class="tips-card">
        <div class="tips-header" id="tipsHeader"></div>
        <ul class="tips-list" id="tipsList">
          <li id="tip1"></li>
          <li id="tip2"></li>
          <li id="tip3"></li>
        </ul>
      </div>

      <!-- Close Button -->
      <div class="close-section">
        <button class="btn btn-secondary btn-block" onclick="closeLiff()">ปิด</button>
      </div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // LIFF ID
    const LIFF_ID = '2008278683-5k69jxNq';

    // Initialize icons and UI
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('x');
      document.getElementById('headerTitle').innerHTML = icon('clipboardList', 'inline-icon') + ' บันทึกสุขภาพ';
      document.getElementById('themeBtn').innerHTML = icon('sun');
      document.getElementById('heroIcon').innerHTML = icon('heartPulse');
      document.getElementById('sectionIcon').innerHTML = icon('layoutGrid') + ' เมนูหลัก';
      document.getElementById('waterIcon').innerHTML = icon('droplet');
      document.getElementById('medicationIcon').innerHTML = icon('pill');
      document.getElementById('vitalsIcon').innerHTML = icon('heartPulse');
      document.getElementById('reportIcon').innerHTML = icon('fileText');
      document.getElementById('tipsHeader').innerHTML = icon('lightbulb') + ' คำแนะนำ';
      document.getElementById('tip1').innerHTML = icon('check') + ' คลิกที่กิจกรรมเพื่อบันทึกข้อมูล';
      document.getElementById('tip2').innerHTML = icon('check') + ' ข้อมูลจะถูกบันทึกอัตโนมัติ';
      document.getElementById('tip3').innerHTML = icon('check') + ' สามารถดูประวัติได้จากเมนูสรุปสุขภาพ';

      // Show cached name if available
      const cached = sessionStorage.getItem('liff_profile');
      if (cached) {
        const profile = JSON.parse(cached);
        document.getElementById('welcomeName').textContent = `สวัสดี ${profile.displayName}`;
      }

      // Show UI immediately!
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Update theme icon based on current mode
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    // Override dark mode toggle to update icon
    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };

    // Initial theme icon update
    setTimeout(updateThemeIcon, 100);

    // Cache LIFF profile in sessionStorage
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Check user registration with cache
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get cached profile
        const profile = await getCachedProfile();

        // Update UI with fresh profile
        document.getElementById('welcomeName').textContent = `สวัสดี ${profile.displayName}`;

        // Check registration in background
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

      } catch (error) {
        console.error('LIFF initialization failed:', error);
      }
    }

    // Close LIFF
    function closeLiff() {
      liff.closeWindow();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
