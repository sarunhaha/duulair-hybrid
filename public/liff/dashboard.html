<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#FAF9F6">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - OONJAI</title>

  <!-- Preconnect to speed up external resources -->
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="preload" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">

  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Header styles */
    .page-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .back-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      border: none;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-primary);
    }

    .back-btn:active {
      transform: scale(0.95);
      background: rgba(0,0,0,0.1);
    }

    .page-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    /* Dashboard-specific styles */
    .welcome-section {
      margin-bottom: var(--spacing-xl);
    }

    .welcome-message {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .action-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      text-align: center;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .action-card:active {
      transform: scale(0.97);
      box-shadow: var(--shadow-md);
    }

    .action-card .icon {
      font-size: 42px;
      margin-bottom: var(--spacing-sm);
      filter: grayscale(0.2);
    }

    .action-card .label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .action-card .sublabel {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .info-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .info-section strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      font-size: 14px;
    }

    .info-section ul {
      margin-left: var(--spacing-md);
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.8;
    }

    @media (max-width: 480px) {
      .actions-grid {
        gap: var(--spacing-sm);
      }

      .action-card {
        padding: var(--spacing-md);
        min-height: 100px;
      }

      .action-card .icon {
        font-size: 36px;
      }

      .action-card .label {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <div class="page-header">
        <button class="back-btn" onclick="closeLiff()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <h1 class="page-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
      </div>

      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-message" id="welcomeName">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</div>
        <div class="welcome-subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-grid">
        <!-- Water Tracking -->
        <a href="water-tracking.html" class="action-card">
          <div class="icon">üíß</div>
          <div class="label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥</div>
          <div class="sublabel">Water</div>
        </a>

        <!-- Medications -->
        <a href="medications.html" class="action-card">
          <div class="icon">üíä</div>
          <div class="label">‡∏¢‡∏≤</div>
          <div class="sublabel">Medications</div>
        </a>

        <!-- Vitals -->
        <a href="vitals-tracking.html" class="action-card">
          <div class="icon">ü©∫</div>
          <div class="label">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
          <div class="sublabel">Vitals</div>
        </a>
      </div>

      <!-- Info Section -->
      <div class="info-section">
        <strong>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</strong>
        <ul>
          <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
          <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</li>
        </ul>
      </div>

      <button class="btn btn-secondary btn-block" onclick="closeLiff()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // LIFF ID
    const LIFF_ID = '2008278683-5k69jxNq';

    // Phase 2.1: Show UI immediately
    (function showUIImmediately() {
      // Show cached name if available
      const cached = sessionStorage.getItem('liff_profile');
      if (cached) {
        const profile = JSON.parse(cached);
        document.getElementById('welcomeName').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;
      }

      // Show UI immediately!
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Phase 1.1: Cache LIFF profile in sessionStorage
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Phase 1.2: Check user registration with cache
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get cached profile
        const profile = await getCachedProfile();

        // Update UI with fresh profile
        document.getElementById('welcomeName').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;

        // Check registration in background
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

      } catch (error) {
        console.error('LIFF initialization failed:', error);
      }
    }

    // Close LIFF
    function closeLiff() {
      liff.closeWindow();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
