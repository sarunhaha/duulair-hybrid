<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#FAF9F6">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - Duulair</title>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Dashboard-specific styles */
    .welcome-section {
      margin-bottom: var(--spacing-xl);
    }

    .welcome-message {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .action-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      text-align: center;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .action-card:active {
      transform: scale(0.97);
      box-shadow: var(--shadow-md);
    }

    .action-card .icon {
      font-size: 42px;
      margin-bottom: var(--spacing-sm);
      filter: grayscale(0.2);
    }

    .action-card .label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .action-card .sublabel {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .info-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .info-section strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      font-size: 14px;
    }

    .info-section ul {
      margin-left: var(--spacing-md);
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.8;
    }

    @media (max-width: 480px) {
      .actions-grid {
        gap: var(--spacing-sm);
      }

      .action-card {
        padding: var(--spacing-md);
        min-height: 100px;
      }

      .action-card .icon {
        font-size: 36px;
      }

      .action-card .label {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <div class="header">
        <h1>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      </div>

      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-message" id="welcomeName">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</div>
        <div class="welcome-subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-grid">
        <!-- Water Tracking -->
        <a href="water-tracking.html" class="action-card">
          <div class="icon">üíß</div>
          <div class="label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥</div>
          <div class="sublabel">Water</div>
        </a>

        <!-- Medications -->
        <a href="medications.html" class="action-card">
          <div class="icon">üíä</div>
          <div class="label">‡∏¢‡∏≤</div>
          <div class="sublabel">Medications</div>
        </a>

        <!-- Vitals -->
        <div class="action-card" onclick="logVitals()">
          <div class="icon">ü©∫</div>
          <div class="label">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
          <div class="sublabel">Vitals</div>
        </div>

        <!-- Food -->
        <div class="action-card" onclick="logFood()">
          <div class="icon">üçö</div>
          <div class="label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
          <div class="sublabel">Food</div>
        </div>

        <!-- Exercise -->
        <div class="action-card" onclick="logExercise()">
          <div class="icon">üö∂</div>
          <div class="label">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div>
          <div class="sublabel">Exercise</div>
        </div>

        <!-- Sleep -->
        <div class="action-card" onclick="logSleep()">
          <div class="icon">üò¥</div>
          <div class="label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô</div>
          <div class="sublabel">Sleep</div>
        </div>
      </div>

      <!-- Info Section -->
      <div class="info-section">
        <strong>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</strong>
        <ul>
          <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
          <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</li>
        </ul>
      </div>

      <button class="btn btn-secondary btn-block" onclick="closeLiff()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // LIFF ID
    const LIFF_ID = '2008278683-5k69jxNq';

    // Check user registration (first-time detection)
    async function checkUserRegistration(lineUserId) {
      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        console.log('üìã Registration check:', result);

        if (!result.exists) {
          console.log('‚ùå Not registered, redirecting to registration...');
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        return true;
      } catch (error) {
        console.error('‚ùå Error checking registration:', error);
        return true; // Allow through on error to avoid blocking
      }
    }

    // Initialize with first-time user detection
    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get user profile
        const profile = await liff.getProfile();

        // Check if user is registered (first-time detection)
        const isRegistered = await checkUserRegistration(profile.userId);

        // If not registered, checkUserRegistration will redirect automatically
        // If registered, continue loading the page
        if (isRegistered) {
          document.getElementById('welcomeName').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;

          // Show content
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
        }

      } catch (error) {
        console.error('LIFF initialization failed:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    }

    // Log Vitals (Send message to bot)
    function logVitals() {
      if (liff.isApiAvailable('sendMessages')) {
        liff.sendMessages([{
          type: 'text',
          text: 'ü©∫ ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô'
        }]).then(() => {
          liff.closeWindow();
        }).catch(err => {
          console.error('Failed to send message:', err);
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        });
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô [‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ]" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô 120/80');
      }
    }

    // Log Food
    function logFood() {
      if (liff.isApiAvailable('sendMessages')) {
        liff.sendMessages([{
          type: 'text',
          text: 'üçö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£'
        }]).then(() => {
          liff.closeWindow();
        }).catch(err => {
          console.error('Failed to send message:', err);
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        });
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ [‡∏°‡∏∑‡πâ‡∏≠]" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤');
      }
    }

    // Log Exercise
    function logExercise() {
      if (liff.isApiAvailable('sendMessages')) {
        liff.sendMessages([{
          type: 'text',
          text: 'üö∂ ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢'
        }]).then(() => {
          liff.closeWindow();
        }).catch(err => {
          console.error('Failed to send message:', err);
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        });
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ [‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤]" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ');
      }
    }

    // Log Sleep
    function logSleep() {
      if (liff.isApiAvailable('sendMessages')) {
        liff.sendMessages([{
          type: 'text',
          text: 'üò¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô'
        }]).then(() => {
          liff.closeWindow();
        }).catch(err => {
          console.error('Failed to send message:', err);
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ô‡∏≠‡∏ô" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        });
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ô‡∏≠‡∏ô [‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á]" ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ô‡∏≠‡∏ô 8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á');
      }
    }

    // Close LIFF
    function closeLiff() {
      liff.closeWindow();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
