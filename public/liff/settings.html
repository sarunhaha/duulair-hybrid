<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>ตั้งค่า - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <style>
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      flex: 1;
      min-width: max-content;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .tab.active {
      color: hsl(var(--primary));
      border-bottom-color: hsl(var(--primary));
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Section Card */
    .section-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: hsl(var(--muted));
      border-bottom: 1px solid hsl(var(--border));
    }

    .section-header svg {
      width: 20px;
      height: 20px;
      color: hsl(var(--primary));
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .section-body {
      padding: 1.25rem;
    }

    /* Setting Row */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid hsl(var(--border));
      gap: 1rem;
    }

    .setting-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .setting-row:first-child {
      padding-top: 0;
    }

    .setting-info {
      flex: 1;
    }

    .setting-label {
      font-size: 0.9375rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
    }

    .setting-description {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: hsl(var(--muted-foreground) / 0.3);
      border-radius: 28px;
      cursor: pointer;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }

    .toggle-switch.active {
      background: hsl(var(--success));
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      top: 3px;
      left: 3px;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toggle-switch.active::after {
      transform: translateX(24px);
    }

    /* Link Code Display */
    .link-code-card {
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-dark)) 100%);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      color: white;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .link-code-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .link-code-value {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.25rem;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    /* Member List */
    .member-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .member-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-lg);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-dark)) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1rem;
    }

    .member-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: hsl(var(--foreground));
    }

    .member-role {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    .member-badge {
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .member-badge.primary {
      background: hsl(var(--primary) / 0.15);
      color: hsl(var(--primary));
    }

    .member-badge.member {
      background: hsl(var(--muted));
      color: hsl(var(--muted-foreground));
    }

    /* Pricing Cards */
    .pricing-card {
      background: hsl(var(--card));
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .pricing-card.recommended {
      border-color: hsl(var(--primary));
    }

    .pricing-card.enterprise {
      border-color: hsl(var(--accent));
    }

    .pricing-badge {
      position: absolute;
      top: -12px;
      right: 1rem;
      background: hsl(var(--primary));
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .pricing-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .pricing-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .pricing-card.recommended .pricing-name {
      color: hsl(var(--primary));
    }

    .pricing-card.enterprise .pricing-name {
      color: hsl(var(--accent));
    }

    .pricing-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: hsl(var(--primary));
    }

    .pricing-period {
      font-size: 0.875rem;
      font-weight: 400;
      color: hsl(var(--muted-foreground));
    }

    .pricing-description {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 1rem;
    }

    .pricing-features {
      border-top: 1px solid hsl(var(--border));
      padding-top: 1rem;
    }

    .pricing-feature {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
    }

    .pricing-feature svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--success));
    }

    .pricing-card.recommended .pricing-feature svg {
      color: hsl(var(--primary));
    }

    .pricing-card.enterprise .pricing-feature svg {
      color: hsl(var(--accent));
    }

    .current-plan-badge {
      background: hsl(var(--success));
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
      font-weight: 600;
    }

    /* FAQ */
    .faq-item {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
    }

    .faq-question {
      font-size: 0.9375rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .faq-question svg {
      width: 18px;
      height: 18px;
      color: hsl(var(--primary));
      flex-shrink: 0;
      margin-top: 2px;
    }

    .faq-answer {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      line-height: 1.6;
      padding-left: 1.625rem;
    }

    /* Contact Card */
    .contact-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.5rem;
    }

    .contact-item {
      margin-bottom: 1rem;
    }

    .contact-item:last-child {
      margin-bottom: 0;
    }

    .contact-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .contact-label svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
    }

    .contact-value {
      font-size: 0.875rem;
      color: hsl(var(--primary));
    }

    .contact-value a {
      color: hsl(var(--primary));
      text-decoration: none;
    }

    /* About Card */
    .about-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 2rem;
      text-align: center;
    }

    .about-icon {
      width: 64px;
      height: 64px;
      background: hsl(var(--primary) / 0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }

    .about-icon svg {
      width: 32px;
      height: 32px;
      color: hsl(var(--primary));
    }

    .about-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
    }

    .about-tagline {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 1rem;
    }

    .about-version {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
      display: block;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1.5px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    /* Info Box */
    .info-box {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      background: hsl(var(--primary) / 0.08);
      border: 1px solid hsl(var(--primary) / 0.2);
      border-radius: var(--radius-lg);
      margin-bottom: 1.5rem;
    }

    .info-box-icon {
      width: 32px;
      height: 32px;
      background: hsl(var(--primary) / 0.15);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .info-box-icon svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
    }

    .info-box-text {
      font-size: 0.8125rem;
      color: hsl(var(--foreground));
      line-height: 1.5;
    }

    .info-box-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="closeLiff()" aria-label="ปิด" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab" data-tab="group" id="groupTab" style="display: none;"></button>
        <button class="tab active" data-tab="reports" id="reportsTab"></button>
        <button class="tab" data-tab="packages" id="packagesTab"></button>
        <button class="tab" data-tab="help" id="helpTab"></button>
      </div>

      <!-- Group Tab -->
      <div id="group-tab" class="tab-content">
        <div class="link-code-card">
          <div class="link-code-label">รหัสกลุ่ม (Link Code)</div>
          <div class="link-code-value" id="linkCode">------</div>
        </div>

        <div class="info-box">
          <div class="info-box-icon" id="infoIcon1"></div>
          <div class="info-box-text">
            <div class="info-box-title">วิธีเชิญสมาชิกเข้ากลุ่ม</div>
            ให้สมาชิกใหม่พิมพ์รหัสกลุ่มด้านบนในแชทกับบอท แล้วบอทจะเชิญเข้ากลุ่มอัตโนมัติ
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <span id="membersIcon"></span>
            <span class="section-title">สมาชิกในกลุ่ม</span>
          </div>
          <div class="section-body">
            <div id="memberList" class="member-list"></div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <span id="editIcon"></span>
            <span class="section-title">ข้อมูลกลุ่ม</span>
          </div>
          <div class="section-body">
            <form id="groupForm">
              <div class="form-group">
                <label class="form-label">ชื่อกลุ่ม</label>
                <input type="text" class="form-input" id="groupName" required>
              </div>
              <button type="submit" class="btn btn-primary btn-block" id="saveGroupBtn"></button>
            </form>
          </div>
        </div>
      </div>

      <!-- Reports Tab -->
      <div id="reports-tab" class="tab-content active">
        <div class="section-card">
          <div class="section-header">
            <span id="chartIcon"></span>
            <span class="section-title">รายงานอัตโนมัติ</span>
          </div>
          <div class="section-body">
            <div class="setting-row">
              <div class="setting-info">
                <div class="setting-label">รายงานประจำวัน</div>
                <div class="setting-description">ส่งรายงานอัตโนมัติเวลา 20:00</div>
              </div>
              <div class="toggle-switch active" data-setting="daily_report"></div>
            </div>

            <div class="setting-row">
              <div class="setting-info">
                <div class="setting-label">รายงานสัปดาห์</div>
                <div class="setting-description">ส่งทุกวันอาทิตย์ เวลา 20:00</div>
              </div>
              <div class="toggle-switch active" data-setting="weekly_report"></div>
            </div>

            <div class="setting-row">
              <div class="setting-info">
                <div class="setting-label">รายงานเดือน</div>
                <div class="setting-description">ส่งวันที่ 1 ของทุกเดือน</div>
              </div>
              <div class="toggle-switch" data-setting="monthly_report"></div>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <span id="usersIcon"></span>
            <span class="section-title">ผู้รับรายงาน</span>
          </div>
          <div class="section-body">
            <div class="setting-row">
              <div class="setting-info">
                <div class="setting-label">ส่งในกลุ่ม</div>
                <div class="setting-description">ส่งรายงานในกลุ่ม LINE</div>
              </div>
              <div class="toggle-switch active" data-setting="send_to_group"></div>
            </div>

            <div class="setting-row">
              <div class="setting-info">
                <div class="setting-label">ส่งให้ผู้ดูแลหลัก</div>
                <div class="setting-description">ส่งทาง 1:1 chat</div>
              </div>
              <div class="toggle-switch active" data-setting="send_to_primary"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Packages Tab -->
      <div id="packages-tab" class="tab-content">
        <div class="section-card">
          <div class="section-header">
            <span id="diamondIcon"></span>
            <span class="section-title">แพ็คเกจ OONJAI</span>
          </div>
        </div>

        <!-- Free Plan -->
        <div class="pricing-card">
          <div class="pricing-header">
            <div>
              <div class="pricing-name">ฟรี</div>
              <div class="pricing-price">฿0<span class="pricing-period">/เดือน</span></div>
            </div>
            <span class="current-plan-badge">ใช้งานอยู่</span>
          </div>
          <div class="pricing-description">เหมาะสำหรับครอบครัวเล็ก</div>
          <div class="pricing-features">
            <div class="pricing-feature" id="freeFeature1"></div>
            <div class="pricing-feature" id="freeFeature2"></div>
            <div class="pricing-feature" id="freeFeature3"></div>
            <div class="pricing-feature" id="freeFeature4"></div>
            <div class="pricing-feature" id="freeFeature5"></div>
          </div>
        </div>

        <!-- Pro Plan -->
        <div class="pricing-card recommended">
          <span class="pricing-badge">แนะนำ</span>
          <div class="pricing-header">
            <div>
              <div class="pricing-name">Pro</div>
              <div class="pricing-price">฿299<span class="pricing-period">/เดือน</span></div>
            </div>
          </div>
          <div class="pricing-description">เหมาะสำหรับครอบครัวที่ต้องการฟีเจอร์เต็มรูปแบบ</div>
          <div class="pricing-features">
            <div class="pricing-feature" id="proFeature1"></div>
            <div class="pricing-feature" id="proFeature2"></div>
            <div class="pricing-feature" id="proFeature3"></div>
            <div class="pricing-feature" id="proFeature4"></div>
            <div class="pricing-feature" id="proFeature5"></div>
            <div class="pricing-feature" id="proFeature6"></div>
          </div>
          <button class="btn btn-primary btn-block" style="margin-top: 1rem;" disabled>เร็วๆ นี้</button>
        </div>

        <!-- Enterprise Plan -->
        <div class="pricing-card enterprise">
          <div class="pricing-header">
            <div>
              <div class="pricing-name">Enterprise</div>
              <div class="pricing-price" style="font-size: 1.125rem;">ติดต่อเรา</div>
            </div>
          </div>
          <div class="pricing-description">สำหรับโรงพยาบาล/สถานดูแลผู้สูงอายุ</div>
          <div class="pricing-features">
            <div class="pricing-feature" id="entFeature1"></div>
            <div class="pricing-feature" id="entFeature2"></div>
            <div class="pricing-feature" id="entFeature3"></div>
            <div class="pricing-feature" id="entFeature4"></div>
            <div class="pricing-feature" id="entFeature5"></div>
          </div>
          <button class="btn btn-block" style="margin-top: 1rem; background: hsl(var(--accent)); color: white;" disabled>ติดต่อฝ่ายขาย</button>
        </div>
      </div>

      <!-- Help Tab -->
      <div id="help-tab" class="tab-content">
        <div class="section-card">
          <div class="section-header">
            <span id="helpIcon"></span>
            <span class="section-title">คำถามที่พบบ่อย (FAQ)</span>
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" id="faq1q"></div>
          <div class="faq-answer">
            OONJAI คือระบบดูแลสุขภาพผู้สูงอายุผ่าน LINE ที่ช่วยให้ครอบครัวสามารถติดตามและบันทึกกิจกรรมสุขภาพของผู้สูงอายุได้ร่วมกัน
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" id="faq2q"></div>
          <div class="faq-answer">
            ทุกคนในกลุ่ม LINE สามารถบันทึกกิจกรรมและดูรายงานได้ เหมาะสำหรับครอบครัวที่มีสมาชิกหลายคนช่วยกันดูแลผู้สูงอายุ
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" id="faq3q"></div>
          <div class="faq-answer">
            1. เพิ่มบอท OONJAI เข้ากลุ่ม LINE<br>
            2. ลงทะเบียนข้อมูลสมาชิก<br>
            3. เริ่มบันทึกกิจกรรมผ่าน Rich Menu<br>
            4. ดูรายงานและรับการแจ้งเตือนอัตโนมัติ
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" id="faq4q"></div>
          <div class="faq-answer">
            แพ็คเกจ Free ใช้งานได้ฟรีตลอดชีพ! มีฟีเจอร์ครบสำหรับครอบครัวเล็ก หากต้องการฟีเจอร์เพิ่มเติม สามารถอัพเกรดเป็น Pro ได้
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" id="faq5q"></div>
          <div class="faq-answer">
            ข้อมูลทั้งหมดถูกเข้ารหัสและเก็บบน Supabase ที่มีมาตรฐานความปลอดภัยระดับสากล เราไม่แชร์ข้อมูลของคุณให้บุคคลที่สาม
          </div>
        </div>

        <div class="section-card" style="margin-top: 1.5rem;">
          <div class="section-header">
            <span id="phoneIcon"></span>
            <span class="section-title">ติดต่อเรา</span>
          </div>
          <div class="section-body">
            <div class="contact-item">
              <div class="contact-label" id="emailLabel"></div>
              <div class="contact-value"><a href="mailto:support@oonjai.com">support@oonjai.com</a></div>
            </div>
            <div class="contact-item">
              <div class="contact-label" id="lineLabel"></div>
              <div class="contact-value">@oonjai (กำลังเตรียมการ)</div>
            </div>
            <div class="contact-item">
              <div class="contact-label" id="webLabel"></div>
              <div class="contact-value"><a href="https://oonjai.com">www.oonjai.com</a></div>
            </div>
            <div class="contact-item">
              <div class="contact-label" id="hoursLabel"></div>
              <div class="contact-value" style="color: hsl(var(--muted-foreground));">จันทร์ - ศุกร์: 9:00 - 18:00 น.</div>
            </div>
          </div>
        </div>

        <div class="about-card" style="margin-top: 1.5rem;">
          <div class="about-icon" id="aboutIcon"></div>
          <div class="about-name">OONJAI</div>
          <div class="about-tagline">ระบบดูแลสุขภาพผู้สูงอายุแบบครอบครัว<br>ผ่าน LINE ที่ใช้งานง่าย</div>
          <div class="about-version">Version 1.0.0</div>
          <div class="about-version">© 2025 OONJAI. All rights reserved.</div>
        </div>
      </div>

      <!-- Close Button -->
      <div style="padding-top: 0.5rem;">
        <button class="btn btn-secondary btn-block" onclick="closeLiff()">ปิด</button>
      </div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const LIFF_ID = '2008278683-5k69jxNq';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let groupId = null;
    let groupData = null;
    let settings = {};
    let isGroupContext = false;

    // Initialize icons and UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('x');
      document.getElementById('headerTitle').innerHTML = icon('settings', 'inline-icon') + ' ตั้งค่า';
      document.getElementById('themeBtn').innerHTML = icon('sun');
      document.getElementById('groupTab').innerHTML = icon('users', 'inline-icon') + ' กลุ่ม';
      document.getElementById('reportsTab').innerHTML = icon('barChart2', 'inline-icon') + ' รายงาน';
      document.getElementById('packagesTab').innerHTML = icon('crown', 'inline-icon') + ' แพ็คเกจ';
      document.getElementById('helpTab').innerHTML = icon('helpCircle', 'inline-icon') + ' ช่วยเหลือ';

      document.getElementById('infoIcon1').innerHTML = icon('info');
      document.getElementById('membersIcon').innerHTML = icon('users');
      document.getElementById('editIcon').innerHTML = icon('edit');
      document.getElementById('saveGroupBtn').innerHTML = icon('save', 'inline-icon') + ' บันทึกข้อมูลกลุ่ม';
      document.getElementById('chartIcon').innerHTML = icon('barChart2');
      document.getElementById('usersIcon').innerHTML = icon('users');
      document.getElementById('diamondIcon').innerHTML = icon('crown');
      document.getElementById('helpIcon').innerHTML = icon('helpCircle');
      document.getElementById('phoneIcon').innerHTML = icon('phone');
      document.getElementById('aboutIcon').innerHTML = icon('heartPulse');

      // Free features
      document.getElementById('freeFeature1').innerHTML = icon('check') + ' 1 สมาชิก';
      document.getElementById('freeFeature2').innerHTML = icon('check') + ' สมาชิกกลุ่มไม่จำกัด';
      document.getElementById('freeFeature3').innerHTML = icon('check') + ' บันทึกกิจกรรมไม่จำกัด';
      document.getElementById('freeFeature4').innerHTML = icon('check') + ' รายงานวัน/สัปดาห์';
      document.getElementById('freeFeature5').innerHTML = icon('check') + ' การเตือนพื้นฐาน';

      // Pro features
      document.getElementById('proFeature1').innerHTML = icon('check') + ' ฟีเจอร์แบบ Free ทั้งหมด';
      document.getElementById('proFeature2').innerHTML = icon('check') + ' รายงานเดือน + แนวโน้ม';
      document.getElementById('proFeature3').innerHTML = icon('check') + ' Export ข้อมูล PDF/CSV';
      document.getElementById('proFeature4').innerHTML = icon('check') + ' การเตือนขั้นสูง (ปรับแต่งได้)';
      document.getElementById('proFeature5').innerHTML = icon('check') + ' AI Insights & คำแนะนำ';
      document.getElementById('proFeature6').innerHTML = icon('check') + ' Support ลำดับความสำคัญ';

      // Enterprise features
      document.getElementById('entFeature1').innerHTML = icon('check') + ' สมาชิกไม่จำกัด';
      document.getElementById('entFeature2').innerHTML = icon('check') + ' API Access';
      document.getElementById('entFeature3').innerHTML = icon('check') + ' Custom Integration';
      document.getElementById('entFeature4').innerHTML = icon('check') + ' Dedicated Support';
      document.getElementById('entFeature5').innerHTML = icon('check') + ' On-premise Option';

      // FAQ
      document.getElementById('faq1q').innerHTML = icon('search') + ' OONJAI คืออะไร?';
      document.getElementById('faq2q').innerHTML = icon('users') + ' ใครบ้างที่สามารถใช้งานได้?';
      document.getElementById('faq3q').innerHTML = icon('smartphone') + ' ใช้งานยังไง?';
      document.getElementById('faq4q').innerHTML = icon('dollarSign') + ' ค่าใช้จ่ายเท่าไหร่?';
      document.getElementById('faq5q').innerHTML = icon('shieldCheck') + ' ข้อมูลปลอดภัยหรือไม่?';

      // Contact
      document.getElementById('emailLabel').innerHTML = icon('mail') + ' อีเมล';
      document.getElementById('lineLabel').innerHTML = icon('messageCircle') + ' LINE Official';
      document.getElementById('webLabel').innerHTML = icon('globe') + ' เว็บไซต์';
      document.getElementById('hoursLabel').innerHTML = icon('clock') + ' เวลาทำการ';

      // Show content
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');

      console.log('UI initialized');
    })();

    // Update theme icon
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };
    setTimeout(updateThemeIcon, 100);

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Toggle switches
    document.querySelectorAll('.toggle-switch').forEach(toggle => {
      toggle.addEventListener('click', async () => {
        const settingKey = toggle.dataset.setting;
        const newValue = !toggle.classList.contains('active');
        toggle.classList.toggle('active');
        settings[settingKey] = newValue;
        await updateSettings();
      });
    });

    // Initialize LIFF
    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const context = liff.getContext();
        isGroupContext = context && context.type === 'group';

        if (isGroupContext) {
          groupId = context.groupId;
          document.getElementById('groupTab').style.display = 'flex';
          await loadGroupData();
        } else {
          await loadUserData();
        }

        initializeToggles();

      } catch (error) {
        console.error('Init error:', error);
      }
    }

    // Load group data
    async function loadGroupData() {
      try {
        const { data: group, error } = await supabaseClient
          .from('groups')
          .select('*, group_members(*), patient_profiles(*)')
          .eq('line_group_id', groupId)
          .single();

        if (error) throw error;
        if (!group) return;

        groupData = group;

        if (group.patient_id) {
          const { data: linkCode } = await supabaseClient
            .from('link_codes')
            .select('code')
            .eq('patient_id', group.patient_id)
            .eq('used', false)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

          document.getElementById('linkCode').textContent = linkCode?.code || '------';
        }

        document.getElementById('groupName').value = group.group_name || '';
        renderMembers(group.group_members || []);

      } catch (error) {
        console.error('Load group data error:', error);
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        const profile = await liff.getProfile();
        const response = await fetch(`${API_BASE_URL}/check-user/${profile.userId}`);
        const result = await response.json();

        if (result.exists && result.profile) {
          settings = result.profile.settings || {};
        }

      } catch (error) {
        console.error('Load user data error:', error);
      }
    }

    // Render members
    function renderMembers(members) {
      const container = document.getElementById('memberList');

      if (members.length === 0) {
        container.innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center;">ไม่มีสมาชิก</p>';
        return;
      }

      container.innerHTML = members.map(member => {
        const initial = (member.display_name || 'U')[0].toUpperCase();
        const isPrimary = member.role === 'primary_caregiver';
        const roleText = isPrimary ? 'ผู้ดูแลหลัก' : 'สมาชิก';

        return `
          <div class="member-card">
            <div class="member-info">
              <div class="member-avatar">${initial}</div>
              <div>
                <div class="member-name">${member.display_name || 'ไม่ระบุชื่อ'}</div>
                <div class="member-role">${roleText}</div>
              </div>
            </div>
            <span class="member-badge ${isPrimary ? 'primary' : 'member'}">${roleText}</span>
          </div>
        `;
      }).join('');
    }

    // Initialize toggles
    function initializeToggles() {
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        const settingKey = toggle.dataset.setting;
        if (settings[settingKey]) {
          toggle.classList.add('active');
        }
      });
    }

    // Update settings
    async function updateSettings() {
      console.log('Settings updated:', settings);
    }

    // Group form submit
    document.getElementById('groupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!groupData?.id) return;

      try {
        const { error } = await supabaseClient
          .from('groups')
          .update({ group_name: document.getElementById('groupName').value })
          .eq('id', groupData.id);

        if (error) throw error;
        alert('บันทึกข้อมูลกลุ่มเรียบร้อยแล้ว');
      } catch (error) {
        console.error('Update group error:', error);
        alert('ไม่สามารถบันทึกข้อมูลได้');
      }
    });

    // Close LIFF
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }

    // Activate tab from URL
    function activateTabFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');

      if (tab && ['group', 'reports', 'packages', 'help'].includes(tab)) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const targetTab = document.querySelector(`.tab[data-tab="${tab}"]`);
        if (targetTab) targetTab.classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        const targetContent = document.getElementById(`${tab}-tab`);
        if (targetContent) targetContent.classList.add('active');
      }
    }

    // Initialize
    activateTabFromUrl();
    init();
  </script>
</body>
</html>
