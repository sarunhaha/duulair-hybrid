<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>ข้อมูลของคุณ - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <style>
    /* Profile Header */
    .profile-header {
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-dark)) 100%);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1rem;
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .profile-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 200px;
      height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .profile-avatar {
      width: 72px;
      height: 72px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.75rem;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    .profile-avatar svg {
      width: 36px;
      height: 36px;
      color: white;
    }

    .profile-name {
      font-size: 1.375rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      position: relative;
      z-index: 1;
    }

    .profile-info {
      font-size: 0.875rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    /* Section Navigation */
    .section-nav {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .section-nav::-webkit-scrollbar {
      display: none;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 1rem;
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 72px;
      flex-shrink: 0;
    }

    .nav-item:active {
      transform: scale(0.95);
    }

    .nav-item.active {
      background: hsl(var(--primary));
      border-color: hsl(var(--primary));
      color: white;
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-icon svg {
      width: 20px;
      height: 20px;
    }

    .nav-item.active .nav-icon svg {
      color: white;
    }

    .nav-label {
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Info Card */
    .info-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid hsl(var(--border));
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      color: hsl(var(--primary));
    }

    .edit-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      background: hsl(var(--primary) / 0.1);
      color: hsl(var(--primary));
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .edit-btn:active {
      transform: scale(0.95);
      background: hsl(var(--primary) / 0.2);
    }

    .edit-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Info Row */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 0.75rem 0;
      border-bottom: 1px solid hsl(var(--border) / 0.5);
    }

    .info-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .info-label {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }

    .info-value {
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      text-align: right;
      max-width: 60%;
    }

    /* Subsection */
    .card-subsection {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid hsl(var(--border));
      font-size: 0.875rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .card-subsection svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
    }

    /* Tags */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      background: hsl(var(--muted));
      color: hsl(var(--muted-foreground));
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
      font-weight: 500;
    }

    .tag.warning {
      background: hsl(var(--warning) / 0.15);
      color: hsl(var(--warning));
    }

    .dark .tag.warning {
      background: hsl(var(--warning) / 0.2);
    }

    /* Tags Info Row */
    .info-row.vertical {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    /* Medication Item */
    .med-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid hsl(var(--border) / 0.5);
    }

    .med-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .med-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, hsl(280 60% 92%) 0%, hsl(280 60% 85%) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .dark .med-icon {
      background: linear-gradient(135deg, hsl(280 40% 25%) 0%, hsl(280 40% 20%) 100%);
    }

    .med-icon svg {
      width: 20px;
      height: 20px;
      color: hsl(280 60% 45%);
    }

    .dark .med-icon svg {
      color: hsl(280 60% 65%);
    }

    .med-info {
      flex: 1;
      min-width: 0;
    }

    .med-name {
      font-size: 0.9375rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.125rem;
    }

    .med-dosage {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.375rem;
    }

    .med-times {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .med-time {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    .med-instructions {
      margin-top: 0.375rem;
      font-size: 0.8125rem;
      color: hsl(var(--primary));
      font-style: italic;
    }

    /* Add Button */
    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.875rem;
      background: hsl(var(--primary) / 0.1);
      color: hsl(var(--primary));
      border: 2px dashed hsl(var(--primary) / 0.3);
      border-radius: var(--radius-lg);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-btn:active {
      transform: scale(0.98);
      background: hsl(var(--primary) / 0.2);
    }

    .add-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Alert Info */
    .alert-info {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      background: hsl(var(--info) / 0.1);
      border-radius: var(--radius-lg);
      margin-top: 1rem;
    }

    .alert-info-icon {
      width: 20px;
      height: 20px;
      color: hsl(var(--info));
      flex-shrink: 0;
      margin-top: 2px;
    }

    .alert-info-text {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      line-height: 1.5;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
    }

    .empty-state-icon {
      width: 56px;
      height: 56px;
      background: hsl(var(--muted));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }

    .empty-state-icon svg {
      width: 28px;
      height: 28px;
      color: hsl(var(--muted-foreground));
    }

    .empty-state-text {
      font-size: 0.9375rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 1rem;
    }

    /* Notes text */
    .notes-text {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
      <div class="alert alert-error" id="errorMessage"></div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="closeLiff()" aria-label="ปิด" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Profile Header Card -->
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar"></div>
        <div class="profile-name" id="profileName">กำลังโหลด...</div>
        <div class="profile-info" id="profileInfo">-</div>
      </div>

      <!-- Section Navigation -->
      <div class="section-nav">
        <div class="nav-item active" data-tab="personal">
          <span class="nav-icon" id="navPersonalIcon"></span>
          <span class="nav-label">ส่วนตัว</span>
        </div>
        <div class="nav-item" data-tab="medical">
          <span class="nav-icon" id="navMedicalIcon"></span>
          <span class="nav-label">การแพทย์</span>
        </div>
        <div class="nav-item" data-tab="medications">
          <span class="nav-icon" id="navMedicationsIcon"></span>
          <span class="nav-label">ยาประจำ</span>
        </div>
        <div class="nav-item" data-tab="hospital">
          <span class="nav-icon" id="navHospitalIcon"></span>
          <span class="nav-label">โรงพยาบาล</span>
        </div>
        <div class="nav-item" data-tab="emergency">
          <span class="nav-icon" id="navEmergencyIcon"></span>
          <span class="nav-label">ฉุกเฉิน</span>
        </div>
      </div>

      <!-- Tab Contents -->

      <!-- Personal Info Tab -->
      <div id="personal-tab" class="tab-content active">
        <div class="info-card">
          <div class="card-header">
            <div class="card-title" id="personalTitle"></div>
            <button class="edit-btn" onclick="editSection('personal')" id="editPersonalBtn"></button>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อ-นามสกุล</span>
            <span class="info-value" id="patientName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อเล่น</span>
            <span class="info-value" id="patientNickname">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">วันเกิด</span>
            <span class="info-value" id="patientBirthDate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">อายุ</span>
            <span class="info-value" id="patientAge">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เพศ</span>
            <span class="info-value" id="patientGender">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์โทร</span>
            <span class="info-value" id="patientPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ที่อยู่</span>
            <span class="info-value" id="patientAddress">-</span>
          </div>
          <div class="card-subsection" id="bodySubsection"></div>
          <div class="info-row">
            <span class="info-label">น้ำหนัก</span>
            <span class="info-value" id="patientWeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ส่วนสูง</span>
            <span class="info-value" id="patientHeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">กรุ๊ปเลือด</span>
            <span class="info-value" id="patientBloodType">-</span>
          </div>
        </div>
      </div>

      <!-- Medical Info Tab -->
      <div id="medical-tab" class="tab-content">
        <div class="info-card">
          <div class="card-header">
            <div class="card-title" id="medicalTitle"></div>
            <button class="edit-btn" onclick="editSection('medical')" id="editMedicalBtn"></button>
          </div>
          <div class="info-row vertical">
            <span class="info-label">โรคประจำตัว</span>
            <div class="tags" id="patientConditions">
              <span class="tag">-</span>
            </div>
          </div>
          <div class="info-row vertical">
            <span class="info-label">โรคเรื้อรัง</span>
            <div class="tags" id="patientChronicDiseases">
              <span class="tag">-</span>
            </div>
          </div>
          <div class="card-subsection" id="allergySubsection"></div>
          <div class="info-row vertical">
            <span class="info-label">แพ้ยา</span>
            <div class="tags" id="patientDrugAllergies">
              <span class="tag warning">-</span>
            </div>
          </div>
          <div class="info-row vertical">
            <span class="info-label">แพ้อาหาร</span>
            <div class="tags" id="patientFoodAllergies">
              <span class="tag warning">-</span>
            </div>
          </div>
          <div class="card-subsection" id="notesSubsection"></div>
          <p class="notes-text" id="patientMedicalNotes">-</p>
        </div>
      </div>

      <!-- Medications Tab -->
      <div id="medications-tab" class="tab-content">
        <div class="info-card">
          <div class="card-header">
            <div class="card-title" id="medicationsTitle"></div>
            <button class="edit-btn" onclick="goToMedications()" id="manageMedsBtn"></button>
          </div>
          <div id="medicationsList">
            <!-- Medications will be loaded here -->
            <div class="empty-state">
              <div class="empty-state-icon" id="medsLoadingIcon"></div>
              <p class="empty-state-text">กำลังโหลดรายการยา...</p>
            </div>
          </div>
        </div>

        <button class="add-btn" onclick="goToMedications()" id="addMedBtn"></button>
      </div>

      <!-- Hospital Info Tab -->
      <div id="hospital-tab" class="tab-content">
        <div class="info-card">
          <div class="card-header">
            <div class="card-title" id="hospitalTitle"></div>
            <button class="edit-btn" onclick="editSection('hospital')" id="editHospitalBtn"></button>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อโรงพยาบาล</span>
            <span class="info-value" id="hospitalName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์โทร</span>
            <span class="info-value" id="hospitalPhone">-</span>
          </div>
        </div>
      </div>

      <!-- Emergency Contact Tab -->
      <div id="emergency-tab" class="tab-content">
        <div class="info-card">
          <div class="card-header">
            <div class="card-title" id="emergencyTitle"></div>
            <button class="edit-btn" onclick="editSection('emergency')" id="editEmergencyBtn"></button>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อ</span>
            <span class="info-value" id="emergencyName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ความสัมพันธ์</span>
            <span class="info-value" id="emergencyRelation">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์โทร</span>
            <span class="info-value" id="emergencyPhone">-</span>
          </div>
        </div>

        <div class="alert-info">
          <span class="alert-info-icon" id="infoAlertIcon"></span>
          <span class="alert-info-text">ข้อมูลนี้จะใช้ในกรณีฉุกเฉิน ระบบจะส่งการแจ้งเตือนไปยังเบอร์โทรนี้โดยอัตโนมัติ</span>
        </div>
      </div>

      <!-- Close Button -->
      <div style="padding-top: 0.5rem;">
        <button class="btn btn-secondary btn-block" onclick="closeLiff()">ปิด</button>
      </div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // Configuration
    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Thai month names
    const thaiMonths = [
      'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
      'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
    ];

    // Global state
    let patientId = null;
    let patientData = null;

    // Initialize icons and UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set header icons
      document.getElementById('backBtn').innerHTML = icon('arrowLeft');
      document.getElementById('headerTitle').innerHTML = icon('user', 'inline-icon') + ' ข้อมูลของคุณ';
      document.getElementById('themeBtn').innerHTML = icon('sun');

      // Set profile avatar
      document.getElementById('profileAvatar').innerHTML = icon('user');

      // Set nav icons
      document.getElementById('navPersonalIcon').innerHTML = icon('fileText');
      document.getElementById('navMedicalIcon').innerHTML = icon('heartPulse');
      document.getElementById('navMedicationsIcon').innerHTML = icon('pill');
      document.getElementById('navHospitalIcon').innerHTML = icon('building');
      document.getElementById('navEmergencyIcon').innerHTML = icon('phone');

      // Set card titles
      document.getElementById('personalTitle').innerHTML = icon('fileText') + ' ข้อมูลส่วนตัว';
      document.getElementById('editPersonalBtn').innerHTML = icon('pencil') + ' แก้ไข';
      document.getElementById('bodySubsection').innerHTML = icon('ruler') + ' ข้อมูลร่างกาย';

      document.getElementById('medicalTitle').innerHTML = icon('heartPulse') + ' ข้อมูลทางการแพทย์';
      document.getElementById('editMedicalBtn').innerHTML = icon('pencil') + ' แก้ไข';
      document.getElementById('allergySubsection').innerHTML = icon('alertTriangle') + ' การแพ้';
      document.getElementById('notesSubsection').innerHTML = icon('clipboardList') + ' หมายเหตุ';

      document.getElementById('medicationsTitle').innerHTML = icon('pill') + ' รายการยาประจำ';
      document.getElementById('manageMedsBtn').innerHTML = icon('settings') + ' จัดการ';
      document.getElementById('medsLoadingIcon').innerHTML = icon('pill');
      document.getElementById('addMedBtn').innerHTML = icon('plus') + ' เพิ่มยาใหม่';

      document.getElementById('hospitalTitle').innerHTML = icon('building') + ' โรงพยาบาลประจำ';
      document.getElementById('editHospitalBtn').innerHTML = icon('pencil') + ' แก้ไข';

      document.getElementById('emergencyTitle').innerHTML = icon('phone') + ' ผู้ติดต่อฉุกเฉิน';
      document.getElementById('editEmergencyBtn').innerHTML = icon('pencil') + ' แก้ไข';
      document.getElementById('infoAlertIcon').innerHTML = icon('info');

      // Show UI immediately
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Update theme icon based on current mode
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    // Override dark mode toggle to update icon
    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };
    setTimeout(updateThemeIcon, 100);

    // Cache LIFF profile in sessionStorage
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Close LIFF
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.history.back();
      }
    }

    // Format date to Thai format
    function formatThaiDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    // Calculate age from birth date
    function calculateAge(birthDate) {
      if (!birthDate) return '-';
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return `${age} ปี`;
    }

    // Format gender to Thai
    function formatGender(gender) {
      if (!gender) return '-';
      const genderMap = { 'male': 'ชาย', 'female': 'หญิง', 'other': 'อื่นๆ' };
      return genderMap[gender] || gender;
    }

    // Edit section handler
    function editSection(section) {
      if (!patientId) {
        alert('กรุณารอโหลดข้อมูลก่อน');
        return;
      }
      window.location.href = `edit-profile.html?patient_id=${patientId}&section=${section}`;
    }

    // Go to medications page
    function goToMedications() {
      if (!patientId) {
        alert('กรุณารอโหลดข้อมูลก่อน');
        return;
      }
      window.location.href = `medications.html?patient_id=${patientId}`;
    }

    // Tab switching
    document.querySelectorAll('.nav-item').forEach(navItem => {
      navItem.addEventListener('click', () => {
        const tabName = navItem.dataset.tab;

        // Update nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Check user registration with cache
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();
        if (!result.exists) {
          setTimeout(() => { window.location.href = '/liff/index.html'; }, 1000);
          return false;
        }
        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await getCachedProfile();
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));
        loadUserData().catch(err => console.error('Load data error:', err));

      } catch (error) {
        console.error('LIFF init error:', error);
        showError('ไม่สามารถเชื่อมต่อ LINE ได้: ' + error.message);
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        const checkUserResponse = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        if (!checkUserResponse.ok) throw new Error(`check-user API failed: ${checkUserResponse.status}`);

        const checkUserResult = await checkUserResponse.json();
        if (!checkUserResult.exists) {
          showError('ไม่พบข้อมูลผู้ใช้');
          return;
        }

        if (checkUserResult.role === 'patient') {
          patientId = checkUserResult.profile.profile_id;
        } else if (checkUserResult.role === 'caregiver') {
          if (checkUserResult.profile.linked_patient_id) {
            patientId = checkUserResult.profile.linked_patient_id;
          } else {
            showError('คุณยังไม่ได้ลิงก์กับสมาชิก');
            return;
          }
        }

        const response = await fetch(`${API_BASE_URL}/patient/${patientId}`);
        if (!response.ok) throw new Error(`patient API failed: ${response.status}`);

        const result = await response.json();
        if (!result.success || !result.profile) {
          showError('ไม่พบข้อมูลสมาชิก');
          return;
        }

        patientData = result.profile;
        displayPatientData(result.profile);
        await loadMedications();

      } catch (error) {
        console.error('Error loading data:', error);
        showError('ไม่สามารถโหลดข้อมูลได้: ' + error.message);
      }
    }

    // Display patient data
    function displayPatientData(patient) {
      const fullName = `${patient.first_name || ''} ${patient.last_name || ''}`.trim() || 'ไม่ระบุชื่อ';
      const nickname = patient.nickname || '';
      const age = calculateAge(patient.birth_date);
      const gender = formatGender(patient.gender);

      document.getElementById('profileName').textContent = nickname || fullName;
      document.getElementById('profileInfo').textContent = `${age} • ${gender}`;

      // Update avatar based on gender
      const avatarIcon = patient.gender === 'male' ? 'userCircle' : patient.gender === 'female' ? 'userCircle2' : 'user';
      document.getElementById('profileAvatar').innerHTML = icon(avatarIcon);

      // Personal Info
      document.getElementById('patientName').textContent = fullName;
      document.getElementById('patientNickname').textContent = nickname || '-';
      document.getElementById('patientBirthDate').textContent = formatThaiDate(patient.birth_date);
      document.getElementById('patientAge').textContent = age;
      document.getElementById('patientGender').textContent = gender;
      document.getElementById('patientPhone').textContent = patient.phone_number || '-';
      document.getElementById('patientAddress').textContent = patient.address || '-';

      // Body Info
      document.getElementById('patientWeight').textContent = patient.weight_kg ? `${patient.weight_kg} กก.` : '-';
      document.getElementById('patientHeight').textContent = patient.height_cm ? `${patient.height_cm} ซม.` : '-';
      document.getElementById('patientBloodType').textContent = patient.blood_type || '-';

      // Medical Info - Conditions
      displayTags('patientConditions', patient.medical_condition, 'tag');
      displayTags('patientChronicDiseases', patient.chronic_diseases, 'tag');

      // Allergies
      displayTags('patientDrugAllergies', patient.drug_allergies, 'tag warning');
      displayTags('patientFoodAllergies', patient.food_allergies, 'tag warning');

      // Medical Notes
      document.getElementById('patientMedicalNotes').textContent = patient.medical_notes || 'ไม่มีหมายเหตุ';

      // Hospital Info
      document.getElementById('hospitalName').textContent = patient.hospital_name || '-';
      document.getElementById('hospitalPhone').textContent = patient.hospital_phone || '-';

      // Emergency Contact
      document.getElementById('emergencyName').textContent = patient.emergency_contact_name || '-';
      document.getElementById('emergencyRelation').textContent = patient.emergency_contact_relation || '-';
      document.getElementById('emergencyPhone').textContent = patient.emergency_contact_phone || '-';
    }

    // Display tags helper
    function displayTags(elementId, data, tagClass) {
      const container = document.getElementById(elementId);
      let items = [];

      if (Array.isArray(data)) {
        items = data;
      } else if (typeof data === 'string' && data.trim()) {
        items = data.split(',').map(s => s.trim()).filter(s => s);
      }

      if (items.length > 0) {
        container.innerHTML = items.map(item => `<span class="${tagClass}">${item}</span>`).join('');
      } else {
        container.innerHTML = `<span class="${tagClass}" style="opacity: 0.5;">ไม่มีข้อมูล</span>`;
      }
    }

    // Load medications
    async function loadMedications() {
      const container = document.getElementById('medicationsList');
      try {
        const { data, error } = await supabaseClient
          .from('medications')
          .select('*')
          .eq('patient_id', patientId)
          .eq('active', true)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const medications = (data || []).map(med => ({
          ...med,
          times: med.times ? (typeof med.times === 'string' ? JSON.parse(med.times) : med.times) : []
        }));

        if (medications.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">${icon('pill')}</div>
              <p class="empty-state-text">ยังไม่มีรายการยา</p>
              <button class="btn btn-sm btn-outline" onclick="goToMedications()">เพิ่มยา</button>
            </div>
          `;
          return;
        }

        const timeLabels = {
          morning: 'เช้า',
          afternoon: 'กลางวัน',
          evening: 'เย็น',
          night: 'ก่อนนอน'
        };

        const timeIcons = {
          morning: icon('sunrise', 'inline-icon'),
          afternoon: icon('sun', 'inline-icon'),
          evening: icon('sunset', 'inline-icon'),
          night: icon('moon', 'inline-icon')
        };

        container.innerHTML = medications.map(med => {
          const times = med.times || [];
          const timesHtml = times.map(t => `<span class="med-time">${timeIcons[t] || ''} ${timeLabels[t] || t}</span>`).join('');

          return `
            <div class="med-item">
              <div class="med-icon">${icon('pill')}</div>
              <div class="med-info">
                <div class="med-name">${med.name}</div>
                <div class="med-dosage">${med.dosage_amount || ''} ${med.dosage_unit || ''}</div>
                ${times.length > 0 ? `<div class="med-times">${timesHtml}</div>` : ''}
                ${med.instructions ? `<div class="med-instructions">${med.instructions}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading medications:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">${icon('alertCircle')}</div>
            <p class="empty-state-text">ไม่สามารถโหลดรายการยาได้</p>
          </div>
        `;
      }
    }

    // Show error
    function showError(message) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // Activate tab from URL parameter
    function activateTabFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');

      if (tab && ['personal', 'medical', 'medications', 'hospital', 'emergency'].includes(tab)) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tab}-tab`).classList.add('active');
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      activateTabFromUrl();
      initializeLiff();
    });
  </script>
</body>
</html>
