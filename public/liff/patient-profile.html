<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FAF9F6">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ข้อมูลผู้ป่วย - Duulair</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Patient Profile View Mode Styles */
    .tabs {
      display: flex;
      border-bottom: 2px solid rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-lg);
      gap: var(--spacing-sm);
    }

    .tab {
      flex: 1;
      padding: 14px 12px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-md);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .card-header h3 {
      font-size: 16px;
      color: var(--accent-primary);
      margin: 0;
      font-weight: 600;
    }

    .edit-btn {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .edit-btn:active {
      transform: scale(0.97);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-xs) 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .condition-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-xs);
    }

    .condition-tag {
      background: rgba(232, 180, 168, 0.2);
      color: var(--accent-primary);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 12px;
    }

    @media (max-width: 480px) {
      .tabs {
        gap: 0;
      }

      .tab {
        padding: 12px 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="alert alert-error" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="header">
        <h1>ข้อมูลผู้ป่วย</h1>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="profile">ข้อมูลทั่วไป</div>
        <div class="tab" data-tab="medical">การแพทย์</div>
        <div class="tab" data-tab="emergency">ฉุกเฉิน</div>
      </div>

      <!-- Profile Tab -->
      <div id="profile-tab" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <h3>ข้อมูลพื้นฐาน</h3>
            <button class="edit-btn" onclick="editSection('basic')">แก้ไข</button>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อ-นามสกุล:</span>
            <span class="info-value" id="patientName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อเล่น:</span>
            <span class="info-value" id="patientNickname">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">วันเกิด:</span>
            <span class="info-value" id="patientBirthDate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เพศ:</span>
            <span class="info-value" id="patientGender">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์โทร:</span>
            <span class="info-value" id="patientPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ที่อยู่:</span>
            <span class="info-value" id="patientAddress">-</span>
          </div>
        </div>
      </div>

      <!-- Medical Tab -->
      <div id="medical-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>ข้อมูลทางการแพทย์</h3>
            <button class="edit-btn" onclick="editSection('medical')">แก้ไข</button>
          </div>
          <div class="info-row">
            <span class="info-label">กรุ๊ปเลือด:</span>
            <span class="info-value" id="patientBloodType">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">น้ำหนัก:</span>
            <span class="info-value" id="patientWeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ส่วนสูง:</span>
            <span class="info-value" id="patientHeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">โรคประจำตัว:</span>
            <span class="info-value" id="patientMedicalCondition">-</span>
          </div>
          <div id="chronicDiseasesRow" class="info-row" style="flex-direction: column; align-items: flex-start;">
            <span class="info-label">โรคเรื้อรัง:</span>
            <div class="condition-tags" id="patientChronicDiseases"></div>
          </div>
          <div class="info-row">
            <span class="info-label">แพ้ยา:</span>
            <span class="info-value" id="patientDrugAllergies">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">แพ้อาหาร:</span>
            <span class="info-value" id="patientFoodAllergies">-</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>ข้อมูลโรงพยาบาล</h3>
            <button class="edit-btn" onclick="editSection('medical')">แก้ไข</button>
          </div>
          <div class="info-row">
            <span class="info-label">โรงพยาบาล:</span>
            <span class="info-value" id="patientHospital">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">แพทย์ผู้ดูแล:</span>
            <span class="info-value" id="patientDoctor">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์แพทย์:</span>
            <span class="info-value" id="patientDoctorPhone">-</span>
          </div>
        </div>
      </div>

      <!-- Emergency Tab -->
      <div id="emergency-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>ผู้ติดต่อฉุกเฉิน</h3>
            <button class="edit-btn" onclick="editSection('emergency')">แก้ไข</button>
          </div>
          <div class="info-row">
            <span class="info-label">ชื่อ:</span>
            <span class="info-value" id="emergencyName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ความสัมพันธ์:</span>
            <span class="info-value" id="emergencyRelation">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">เบอร์โทร:</span>
            <span class="info-value" id="emergencyPhone">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // LIFF ID
    const LIFF_ID = '2007014792-d3lYAgML';

    // API Base URL
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : 'https://duulair.vercel.app/api';

    // Thai month names
    const thaiMonths = [
      'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
      'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
    ];

    // Global state
    let patientId = null;

    // Format date to Thai format
    function formatThaiDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    // Format gender to Thai
    function formatGender(gender) {
      if (!gender) return '-';
      const genderMap = {
        'male': 'ชาย',
        'female': 'หญิง',
        'other': 'อื่นๆ'
      };
      return genderMap[gender] || gender;
    }

    // Edit section handler
    function editSection(section) {
      if (!patientId) {
        alert('กรุณารอโหลดข้อมูลก่อน');
        return;
      }
      window.location.href = `edit-profile.html?patient_id=${patientId}&section=${section}`;
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Check user registration
    async function checkUserRegistration(lineUserId) {
      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();

        // Check registration
        const isRegistered = await checkUserRegistration(profile.userId);
        if (!isRegistered) return;

        // Show UI first
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // Load data
        await loadUserData();

      } catch (error) {
        console.error('LIFF init error:', error);
        showError('ไม่สามารถเชื่อมต่อ LINE ได้: ' + error.message);
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        // Get user info
        const checkUserResponse = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const checkUserResult = await checkUserResponse.json();

        if (!checkUserResult.exists) {
          showError('ไม่พบข้อมูลผู้ใช้');
          return;
        }

        // Get patient ID based on role
        if (checkUserResult.role === 'patient') {
          // Patient - use own profile
          patientId = checkUserResult.profile.profile_id;
        } else if (checkUserResult.role === 'caregiver') {
          // Caregiver - check if linked_patient_id exists in the response
          if (checkUserResult.profile.linked_patient_id) {
            patientId = checkUserResult.profile.linked_patient_id;
          } else {
            // No patient linked yet
            showError('คุณยังไม่ได้ลิงก์กับผู้ป่วย กรุณาลิงก์ผู้ป่วยก่อน');
            return;
          }
        } else {
          showError('ไม่สามารถระบุประเภทผู้ใช้ได้');
          return;
        }

        // Load patient profile
        const response = await fetch(`${API_BASE_URL}/patient/${patientId}`);
        const result = await response.json();

        if (!result.success || !result.profile) {
          showError('ไม่พบข้อมูลผู้ป่วย');
          return;
        }

        displayPatientData(result.profile);

      } catch (error) {
        console.error('Error loading data:', error);
        showError('ไม่สามารถโหลดข้อมูลได้: ' + error.message);
      }
    }

    // Display patient data
    function displayPatientData(patient) {
      // Basic Info
      document.getElementById('patientName').textContent =
        `${patient.first_name || ''} ${patient.last_name || ''}`.trim() || '-';
      document.getElementById('patientNickname').textContent = patient.nickname || '-';
      document.getElementById('patientBirthDate').textContent = formatThaiDate(patient.birth_date);
      document.getElementById('patientGender').textContent = formatGender(patient.gender);
      document.getElementById('patientPhone').textContent = patient.phone_number || '-';
      document.getElementById('patientAddress').textContent = patient.address || '-';

      // Medical Info
      document.getElementById('patientBloodType').textContent = patient.blood_type || '-';
      document.getElementById('patientWeight').textContent = patient.weight_kg ? `${patient.weight_kg} กก.` : '-';
      document.getElementById('patientHeight').textContent = patient.height_cm ? `${patient.height_cm} ซม.` : '-';
      document.getElementById('patientMedicalCondition').textContent = patient.medical_condition || '-';
      document.getElementById('patientDrugAllergies').textContent = patient.drug_allergies || '-';
      document.getElementById('patientFoodAllergies').textContent = patient.food_allergies || '-';

      // Chronic diseases as tags
      const chronicContainer = document.getElementById('patientChronicDiseases');
      if (patient.chronic_diseases && Array.isArray(patient.chronic_diseases) && patient.chronic_diseases.length > 0) {
        chronicContainer.innerHTML = patient.chronic_diseases.map(disease =>
          `<span class="condition-tag">${disease}</span>`
        ).join('');
      } else {
        chronicContainer.innerHTML = '<span style="color: var(--text-secondary);">-</span>';
      }

      // Hospital Info
      document.getElementById('patientHospital').textContent = patient.hospital_name || '-';
      document.getElementById('patientDoctor').textContent = patient.doctor_name || '-';
      document.getElementById('patientDoctorPhone').textContent = patient.doctor_phone || '-';

      // Emergency Contact
      document.getElementById('emergencyName').textContent = patient.emergency_contact_name || '-';
      document.getElementById('emergencyRelation').textContent = patient.emergency_contact_relation || '-';
      document.getElementById('emergencyPhone').textContent = patient.emergency_contact_phone || '-';
    }

    // Show error
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>
