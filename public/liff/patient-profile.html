<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10B981">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - OONJAI</title>

  <!-- Preconnect to speed up external resources -->
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="preload" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="alert alert-error" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Header with Back Button -->
      <div class="header">
        <button class="header-back" onclick="closeLiff()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="header-content">
          <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
        </div>
      </div>

      <!-- Profile Header Card -->
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">üë§</div>
        <div class="profile-name" id="profileName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div class="profile-info" id="profileInfo">-</div>
      </div>

      <!-- Section Navigation -->
      <div class="section-nav">
        <div class="nav-item active" data-tab="personal">
          <span class="nav-icon">üìù</span>
          <span class="nav-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>
        </div>
        <div class="nav-item" data-tab="medical">
          <span class="nav-icon">üè•</span>
          <span class="nav-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</span>
        </div>
        <div class="nav-item" data-tab="medications">
          <span class="nav-icon">üíä</span>
          <span class="nav-label">‡∏¢‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span>
        </div>
        <div class="nav-item" data-tab="hospital">
          <span class="nav-icon">üè®</span>
          <span class="nav-label">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</span>
        </div>
        <div class="nav-item" data-tab="emergency">
          <span class="nav-icon">üìû</span>
          <span class="nav-label">‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</span>
        </div>
      </div>

      <!-- Tab Contents -->

      <!-- Personal Info Tab -->
      <div id="personal-tab" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìù</span>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </div>
            <button class="edit-btn" onclick="editSection('personal')">
              <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
            </button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
            <span class="info-value" id="patientName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
            <span class="info-value" id="patientNickname">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</span>
            <span class="info-value" id="patientBirthDate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏≠‡∏≤‡∏¢‡∏∏</span>
            <span class="info-value" id="patientAge">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏û‡∏®</span>
            <span class="info-value" id="patientGender">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span>
            <span class="info-value" id="patientPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</span>
            <span class="info-value" id="patientAddress">-</span>
          </div>
          <div class="divider"></div>
          <div class="card-subtitle">üìè ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</div>
          <div class="info-row">
            <span class="info-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</span>
            <span class="info-value" id="patientWeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</span>
            <span class="info-value" id="patientHeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</span>
            <span class="info-value" id="patientBloodType">-</span>
          </div>
        </div>
      </div>

      <!-- Medical Info Tab -->
      <div id="medical-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üè•</span>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
            </div>
            <button class="edit-btn" onclick="editSection('medical')">
              <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
            </button>
          </div>
          <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <span class="info-label">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</span>
            <div class="tags" id="patientConditions">
              <span class="tag">-</span>
            </div>
          </div>
          <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <span class="info-label">‡πÇ‡∏£‡∏Ñ‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á</span>
            <div class="tags" id="patientChronicDiseases">
              <span class="tag">-</span>
            </div>
          </div>
          <div class="divider"></div>
          <div class="card-subtitle">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ</div>
          <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <span class="info-label">‡πÅ‡∏û‡πâ‡∏¢‡∏≤</span>
            <div class="tags" id="patientDrugAllergies">
              <span class="tag warning">-</span>
            </div>
          </div>
          <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <span class="info-label">‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
            <div class="tags" id="patientFoodAllergies">
              <span class="tag warning">-</span>
            </div>
          </div>
          <div class="divider"></div>
          <div class="card-subtitle">üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <p id="patientMedicalNotes" style="color: var(--text-secondary); font-size: 14px; margin: 0;">-</p>
        </div>
      </div>

      <!-- Medications Tab -->
      <div id="medications-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üíä</span>
              ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥
            </div>
            <button class="edit-btn" onclick="goToMedications()">
              <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
            </button>
          </div>
          <div id="medicationsList">
            <!-- Medications will be loaded here -->
            <div class="empty-state">
              <div class="icon">üíä</div>
              <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤...</p>
            </div>
          </div>
        </div>

        <button class="add-btn" onclick="goToMedications()">
          <span>‚ûï</span>
          <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
        </button>
      </div>

      <!-- Hospital Info Tab -->
      <div id="hospital-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üè®</span>
              ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥
            </div>
            <button class="edit-btn" onclick="editSection('hospital')">
              <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
            </button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</span>
            <span class="info-value" id="hospitalName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span>
            <span class="info-value" id="hospitalPhone">-</span>
          </div>
        </div>
      </div>

      <!-- Emergency Contact Tab -->
      <div id="emergency-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìû</span>
              ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
            </div>
            <button class="edit-btn" onclick="editSection('emergency')">
              <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
            </button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠</span>
            <span class="info-value" id="emergencyName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span>
            <span class="info-value" id="emergencyRelation">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span>
            <span class="info-value" id="emergencyPhone">-</span>
          </div>
        </div>

        <div class="alert alert-info">
          <span class="alert-icon">‚ÑπÔ∏è</span>
          <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
        </div>
      </div>
    </div>
  </div>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // Configuration
    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Thai month names
    const thaiMonths = [
      '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
      '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
    ];

    // Global state
    let patientId = null;
    let patientData = null;

    // Phase 2.1: Show UI immediately
    (function showUIImmediately() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    })();

    // Phase 1.1: Cache LIFF profile in sessionStorage
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Close LIFF
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.history.back();
      }
    }

    // Format date to Thai format
    function formatThaiDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    // Calculate age from birth date
    function calculateAge(birthDate) {
      if (!birthDate) return '-';
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return `${age} ‡∏õ‡∏µ`;
    }

    // Format gender to Thai
    function formatGender(gender) {
      if (!gender) return '-';
      const genderMap = { 'male': '‡∏ä‡∏≤‡∏¢', 'female': '‡∏´‡∏ç‡∏¥‡∏á', 'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' };
      return genderMap[gender] || gender;
    }

    // Edit section handler - direct mapping to edit-profile.html sections
    function editSection(section) {
      if (!patientId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      // Section names now match directly: personal, medical, hospital, emergency
      window.location.href = `edit-profile.html?patient_id=${patientId}&section=${section}`;
    }

    // Go to medications page
    function goToMedications() {
      if (!patientId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      window.location.href = `medications.html?patient_id=${patientId}`;
    }

    // Tab switching
    document.querySelectorAll('.nav-item').forEach(navItem => {
      navItem.addEventListener('click', () => {
        const tabName = navItem.dataset.tab;

        // Update nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Phase 1.2: Check user registration with cache
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();
        if (!result.exists) {
          setTimeout(() => { window.location.href = '/liff/index.html'; }, 1000);
          return false;
        }
        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Phase 1.1: Get cached profile
        const profile = await getCachedProfile();

        // Phase 1.2: Check registration in background
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

        // Load data in background
        loadUserData().catch(err => console.error('Load data error:', err));

      } catch (error) {
        console.error('LIFF init error:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        // Get user info
        const checkUserResponse = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        if (!checkUserResponse.ok) throw new Error(`check-user API failed: ${checkUserResponse.status}`);

        const checkUserResult = await checkUserResponse.json();
        if (!checkUserResult.exists) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
          return;
        }

        // Get patient ID based on role
        if (checkUserResult.role === 'patient') {
          patientId = checkUserResult.profile.profile_id;
        } else if (checkUserResult.role === 'caregiver') {
          if (checkUserResult.profile.linked_patient_id) {
            patientId = checkUserResult.profile.linked_patient_id;
          } else {
            showError('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
            return;
          }
        }

        // Load patient profile
        const response = await fetch(`${API_BASE_URL}/patient/${patientId}`);
        if (!response.ok) throw new Error(`patient API failed: ${response.status}`);

        const result = await response.json();
        if (!result.success || !result.profile) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
          return;
        }

        patientData = result.profile;
        displayPatientData(result.profile);

        // Load medications
        await loadMedications();

      } catch (error) {
        console.error('Error loading data:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    // Display patient data
    function displayPatientData(patient) {
      // Profile Header
      const fullName = `${patient.first_name || ''} ${patient.last_name || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      const nickname = patient.nickname || '';
      const age = calculateAge(patient.birth_date);
      const gender = formatGender(patient.gender);

      document.getElementById('profileName').textContent = nickname || fullName;
      document.getElementById('profileInfo').textContent = `${age} ‚Ä¢ ${gender}`;
      document.getElementById('profileAvatar').textContent = patient.gender === 'male' ? 'üë®' : patient.gender === 'female' ? 'üë©' : 'üë§';

      // Personal Info
      document.getElementById('patientName').textContent = fullName;
      document.getElementById('patientNickname').textContent = nickname || '-';
      document.getElementById('patientBirthDate').textContent = formatThaiDate(patient.birth_date);
      document.getElementById('patientAge').textContent = age;
      document.getElementById('patientGender').textContent = gender;
      document.getElementById('patientPhone').textContent = patient.phone_number || '-';
      document.getElementById('patientAddress').textContent = patient.address || '-';

      // Body Info
      document.getElementById('patientWeight').textContent = patient.weight_kg ? `${patient.weight_kg} ‡∏Å‡∏Å.` : '-';
      document.getElementById('patientHeight').textContent = patient.height_cm ? `${patient.height_cm} ‡∏ã‡∏°.` : '-';
      document.getElementById('patientBloodType').textContent = patient.blood_type || '-';

      // Medical Info - Conditions
      displayTags('patientConditions', patient.medical_condition, 'tag');
      displayTags('patientChronicDiseases', patient.chronic_diseases, 'tag');

      // Allergies
      displayTags('patientDrugAllergies', patient.drug_allergies, 'tag warning');
      displayTags('patientFoodAllergies', patient.food_allergies, 'tag warning');

      // Medical Notes
      document.getElementById('patientMedicalNotes').textContent = patient.medical_notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏';

      // Hospital Info
      document.getElementById('hospitalName').textContent = patient.hospital_name || '-';
      document.getElementById('hospitalPhone').textContent = patient.hospital_phone || '-';

      // Emergency Contact
      document.getElementById('emergencyName').textContent = patient.emergency_contact_name || '-';
      document.getElementById('emergencyRelation').textContent = patient.emergency_contact_relation || '-';
      document.getElementById('emergencyPhone').textContent = patient.emergency_contact_phone || '-';
    }

    // Display tags helper
    function displayTags(elementId, data, tagClass) {
      const container = document.getElementById(elementId);
      let items = [];

      if (Array.isArray(data)) {
        items = data;
      } else if (typeof data === 'string' && data.trim()) {
        items = data.split(',').map(s => s.trim()).filter(s => s);
      }

      if (items.length > 0) {
        container.innerHTML = items.map(item => `<span class="${tagClass}">${item}</span>`).join('');
      } else {
        container.innerHTML = `<span class="${tagClass}" style="opacity: 0.5;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;
      }
    }

    // Load medications (using Supabase directly)
    async function loadMedications() {
      const container = document.getElementById('medicationsList');
      try {
        const { data, error } = await supabaseClient
          .from('medications')
          .select('*')
          .eq('patient_id', patientId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const medications = (data || []).map(med => ({
          ...med,
          times: med.times ? (typeof med.times === 'string' ? JSON.parse(med.times) : med.times) : []
        }));

        if (medications.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="icon">üíä</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</p><button class="btn btn-outline btn-sm" onclick="goToMedications()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button></div>';
          return;
        }

        const timeLabels = {
          morning: 'üåÖ ‡πÄ‡∏ä‡πâ‡∏≤',
          afternoon: '‚òÄÔ∏è ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
          evening: 'üåÜ ‡πÄ‡∏¢‡πá‡∏ô',
          night: 'üåô ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'
        };

        container.innerHTML = medications.map(med => {
          const times = med.times || [];
          const timesHtml = times.map(t => `<span class="med-time">${timeLabels[t] || t}</span>`).join('');

          return `
            <div class="med-item">
              <div class="med-icon">üíä</div>
              <div class="med-info">
                <div class="med-name">${med.name}</div>
                <div class="med-dosage">${med.dosage_amount || ''} ${med.dosage_unit || ''}</div>
                ${times.length > 0 ? `<div class="med-times">${timesHtml}</div>` : ''}
                ${med.instructions ? `<div class="med-instructions">${med.instructions}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading medications:', error);
        container.innerHTML = '<div class="empty-state"><div class="icon">üíä</div><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÑ‡∏î‡πâ</p></div>';
      }
    }

    // Show error
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'flex';
    }

    // Activate tab from URL parameter
    function activateTabFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');

      if (tab && ['personal', 'medical', 'medications', 'hospital', 'emergency'].includes(tab)) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tab}-tab`).classList.add('active');
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      activateTabFromUrl();
      initializeLiff();
    });
  </script>
</body>
</html>
