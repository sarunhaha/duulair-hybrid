<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FAF9F6">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ - OONJAI</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Patient Profile View Mode Styles */
    .tabs {
      display: flex;
      border-bottom: 2px solid rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-lg);
      gap: var(--spacing-sm);
    }

    .tab {
      flex: 1;
      padding: 14px 12px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-md);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .card-header h3 {
      font-size: 16px;
      color: var(--accent-primary);
      margin: 0;
      font-weight: 600;
    }

    .edit-btn {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .edit-btn:active {
      transform: scale(0.97);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-xs) 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .condition-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-xs);
    }

    .condition-tag {
      background: rgba(232, 180, 168, 0.2);
      color: var(--accent-primary);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 12px;
    }

    @media (max-width: 480px) {
      .tabs {
        gap: 0;
      }

      .tab {
        padding: 12px 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="alert alert-error" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="header">
        <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h1>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="profile">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
        <div class="tab" data-tab="medical">‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        <div class="tab" data-tab="emergency">‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
      </div>

      <!-- Profile Tab -->
      <div id="profile-tab" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
            <button class="edit-btn" onclick="editSection('basic')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
            <span class="info-value" id="patientName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</span>
            <span class="info-value" id="patientNickname">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span>
            <span class="info-value" id="patientBirthDate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏û‡∏®:</span>
            <span class="info-value" id="patientGender">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
            <span class="info-value" id="patientPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span>
            <span class="info-value" id="patientAddress">-</span>
          </div>
        </div>
      </div>

      <!-- Medical Tab -->
      <div id="medical-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
            <button class="edit-btn" onclick="editSection('medical')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î:</span>
            <span class="info-value" id="patientBloodType">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</span>
            <span class="info-value" id="patientWeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</span>
            <span class="info-value" id="patientHeight">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</span>
            <span class="info-value" id="patientMedicalCondition">-</span>
          </div>
          <div id="chronicDiseasesRow" class="info-row" style="flex-direction: column; align-items: flex-start;">
            <span class="info-label">‡πÇ‡∏£‡∏Ñ‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á:</span>
            <div class="condition-tags" id="patientChronicDiseases"></div>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</span>
            <span class="info-value" id="patientDrugAllergies">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</span>
            <span class="info-value" id="patientFoodAllergies">-</span>
          </div>
        </div>
      </div>

      <!-- Emergency Tab -->
      <div id="emergency-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3>
            <button class="edit-btn" onclick="editSection('emergency')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠:</span>
            <span class="info-value" id="emergencyName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå:</span>
            <span class="info-value" id="emergencyRelation">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
            <span class="info-value" id="emergencyPhone">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // LIFF ID
    const LIFF_ID = '2008278683-5k69jxNq';

    // Thai month names
    const thaiMonths = [
      '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];

    // Global state
    let patientId = null;

    // Format date to Thai format
    function formatThaiDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    // Format gender to Thai
    function formatGender(gender) {
      if (!gender) return '-';
      const genderMap = {
        'male': '‡∏ä‡∏≤‡∏¢',
        'female': '‡∏´‡∏ç‡∏¥‡∏á',
        'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      };
      return genderMap[gender] || gender;
    }

    // Edit section handler
    function editSection(section) {
      if (!patientId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      window.location.href = `edit-profile.html?patient_id=${patientId}&section=${section}`;
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Check user registration
    async function checkUserRegistration(lineUserId) {
      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();

        // Check registration
        const isRegistered = await checkUserRegistration(profile.userId);
        if (!isRegistered) return;

        // Show UI first
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // Load data
        await loadUserData();

      } catch (error) {
        console.error('LIFF init error:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ: ' + error.message);
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        console.log('üìã loadUserData: Starting...');
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;
        console.log('üìã LINE User ID:', lineUserId);

        // Get user info
        console.log('üìã Calling check-user API...');
        const checkUserResponse = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        console.log('üìã check-user response status:', checkUserResponse.status);

        if (!checkUserResponse.ok) {
          throw new Error(`check-user API failed: ${checkUserResponse.status}`);
        }

        const checkUserResult = await checkUserResponse.json();
        console.log('üìã check-user result:', checkUserResult);

        if (!checkUserResult.exists) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
          return;
        }

        // Get patient ID based on role
        console.log('üìã User role:', checkUserResult.role);
        if (checkUserResult.role === 'patient') {
          // Patient - use own profile
          patientId = checkUserResult.profile.profile_id;
          console.log('üìã Patient ID (own profile):', patientId);
        } else if (checkUserResult.role === 'caregiver') {
          // Caregiver - check if linked_patient_id exists in the response
          if (checkUserResult.profile.linked_patient_id) {
            patientId = checkUserResult.profile.linked_patient_id;
            console.log('üìã Patient ID (linked):', patientId);
          } else {
            // No patient linked yet
            showError('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡πà‡∏≠‡∏ô');
            return;
          }
        } else {
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
          return;
        }

        // Load patient profile
        console.log('üìã Calling patient API:', patientId);
        const response = await fetch(`${API_BASE_URL}/patient/${patientId}`);
        console.log('üìã patient response status:', response.status);

        if (!response.ok) {
          throw new Error(`patient API failed: ${response.status}`);
        }

        const result = await response.json();
        console.log('üìã patient result:', result);

        if (!result.success || !result.profile) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
          return;
        }

        displayPatientData(result.profile);
        console.log('‚úÖ Data loaded successfully');

      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }

    // Display patient data
    function displayPatientData(patient) {
      // Basic Info
      document.getElementById('patientName').textContent =
        `${patient.first_name || ''} ${patient.last_name || ''}`.trim() || '-';
      document.getElementById('patientNickname').textContent = patient.nickname || '-';
      document.getElementById('patientBirthDate').textContent = formatThaiDate(patient.birth_date);
      document.getElementById('patientGender').textContent = formatGender(patient.gender);
      document.getElementById('patientPhone').textContent = patient.phone_number || '-';
      document.getElementById('patientAddress').textContent = patient.address || '-';

      // Medical Info
      document.getElementById('patientBloodType').textContent = patient.blood_type || '-';
      document.getElementById('patientWeight').textContent = patient.weight_kg ? `${patient.weight_kg} ‡∏Å‡∏Å.` : '-';
      document.getElementById('patientHeight').textContent = patient.height_cm ? `${patient.height_cm} ‡∏ã‡∏°.` : '-';
      document.getElementById('patientMedicalCondition').textContent = patient.medical_condition || '-';
      document.getElementById('patientDrugAllergies').textContent = patient.drug_allergies || '-';
      document.getElementById('patientFoodAllergies').textContent = patient.food_allergies || '-';

      // Chronic diseases as tags
      const chronicContainer = document.getElementById('patientChronicDiseases');
      if (patient.chronic_diseases && Array.isArray(patient.chronic_diseases) && patient.chronic_diseases.length > 0) {
        chronicContainer.innerHTML = patient.chronic_diseases.map(disease =>
          `<span class="condition-tag">${disease}</span>`
        ).join('');
      } else {
        chronicContainer.innerHTML = '<span style="color: var(--text-secondary);">-</span>';
      }

      // Hospital Info - removed (fields not in database)

      // Emergency Contact
      document.getElementById('emergencyName').textContent = patient.emergency_contact_name || '-';
      document.getElementById('emergencyRelation').textContent = patient.emergency_contact_relation || '-';
      document.getElementById('emergencyPhone').textContent = patient.emergency_contact_phone || '-';
    }

    // Show error
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    // Activate tab from URL parameter
    function activateTabFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');

      if (tab && ['profile', 'medical', 'emergency'].includes(tab)) {
        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tab}-tab`).classList.add('active');
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      activateTabFromUrl();
      initializeLiff();
    });
  </script>
</body>
</html>
