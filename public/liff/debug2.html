<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF Debug v2</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
      font-size: 14px;
    }

    #currentStep {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
    }

    #currentStep.success {
      border-left-color: #4caf50;
      background: #1b5e20;
    }

    #currentStep.error {
      border-left-color: #f44336;
      background: #b71c1c;
    }

    #logs {
      margin-top: 80px;
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #3d3d3d;
      font-family: monospace;
      font-size: 12px;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #666;
      margin-right: 8px;
    }

    .log-success { color: #81c784; }
    .log-error { color: #e57373; }
    .log-warn { color: #ffb74d; }
    .log-info { color: #64b5f6; }

    .result-box {
      margin-top: 15px;
      padding: 15px;
      background: #1e1e1e;
      border-radius: 8px;
      border: 2px solid #4caf50;
    }

    .result-box h3 {
      margin-bottom: 10px;
      color: #4caf50;
    }

    .result-item {
      padding: 5px 0;
      font-family: monospace;
    }

    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px 0 0;
      font-size: 14px;
    }

    button:active {
      background: #1976D2;
    }
  </style>
</head>
<body>
  <div id="currentStep">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>

  <div id="logs"></div>

  <div id="results" style="display: none;"></div>

  <div>
    <button onclick="location.reload()">üîÑ Reload</button>
    <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    const MAX_LOGS = 30;
    const logs = [];
    const stepEl = document.getElementById('currentStep');
    const logsEl = document.getElementById('logs');
    const resultsEl = document.getElementById('results');

    function setStep(text, status = 'loading') {
      stepEl.textContent = text;
      stepEl.className = status;
    }

    function addLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString('th-TH');

      logs.push({ time, message, type });

      // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î MAX_LOGS ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
      if (logs.length > MAX_LOGS) {
        logs.shift();
      }

      renderLogs();
    }

    function renderLogs() {
      logsEl.innerHTML = logs.map(log =>
        `<div class="log-entry log-${log.type}">
          <span class="log-time">${log.time}</span>${log.message}
        </div>`
      ).join('');
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    function clearLogs() {
      logs.length = 0;
      renderLogs();
    }

    function showResults(data) {
      resultsEl.style.display = 'block';
      resultsEl.innerHTML = `
        <div class="result-box">
          <h3>‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
          ${Object.entries(data).map(([key, value]) =>
            `<div class="result-item"><strong>${key}:</strong> ${JSON.stringify(value)}</div>`
          ).join('')}
        </div>
      `;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    (async function() {
      try {
        const LIFF_ID = '2008278683-5k69jxNq';
        const API_BASE = window.location.hostname === 'localhost'
          ? 'http://localhost:3000'
          : 'https://duulair.vercel.app';

        // STEP 1
        setStep('üîç STEP 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF SDK', 'loading');
        addLog('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF SDK...', 'info');

        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î');
        }

        addLog('‚úÖ LIFF SDK ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await sleep(500);

        // STEP 2
        setStep('üîÑ STEP 2: Initialize LIFF', 'loading');
        addLog(`‡∏Å‡∏≥‡∏•‡∏±‡∏á initialize LIFF ID: ${LIFF_ID}`, 'info');

        const start = Date.now();
        await liff.init({ liffId: LIFF_ID });
        const duration = Date.now() - start;

        addLog(`‚úÖ Initialize ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${duration}ms)`, 'success');
        await sleep(500);

        // STEP 3
        setStep('üîê STEP 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login', 'loading');
        addLog(`In Client: ${liff.isInClient()}`, 'info');
        addLog(`Logged In: ${liff.isLoggedIn()}`, 'info');

        if (!liff.isLoggedIn()) {
          setStep('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô', 'error');
          addLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ login...', 'warn');
          await sleep(2000);
          liff.login();
          return;
        }

        addLog('‚úÖ Login ‡πÅ‡∏•‡πâ‡∏ß', 'success');
        await sleep(500);

        // STEP 4
        setStep('üë§ STEP 4: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile', 'loading');
        addLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á profile...', 'info');

        const profile = await liff.getProfile();

        addLog(`‚úÖ Profile: ${profile.displayName}`, 'success');
        addLog(`   User ID: ${profile.userId}`, 'info');
        await sleep(500);

        // STEP 5
        setStep('üåê STEP 5: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API', 'loading');
        addLog(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API: ${API_BASE}/api/registration/check`, 'info');

        const response = await fetch(`${API_BASE}/api/registration/check`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line_user_id: profile.userId })
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        addLog(`‚úÖ API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        addLog(`   Exists: ${data.exists}`, 'info');
        addLog(`   Role: ${data.role || 'N/A'}`, 'info');

        // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        setStep('‚úÖ ‡∏ó‡∏∏‡∏Å STEP ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î!', 'success');

        showResults({
          'Display Name': profile.displayName,
          'User ID': profile.userId,
          'Registered': data.exists,
          'Role': data.role || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
          'Next Action': data.exists ? '‡πÑ‡∏õ Dashboard' : '‡πÑ‡∏õ Role Selection'
        });

      } catch (error) {
        setStep(`‚ùå Error: ${error.message}`, 'error');
        addLog(`‚ùå ${error.message}`, 'error');
        console.error(error);
      }
    })();

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
