<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>วัดความดัน - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <!-- External Scripts -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Vitals Summary Cards */
    .vitals-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .vitals-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      text-align: center;
    }

    .vitals-label {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.5rem;
    }

    .vitals-value {
      font-size: 2.25rem;
      font-weight: 700;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
      font-family: var(--font-mono);
    }

    .vitals-unit {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    /* BP Status Badge */
    .status-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .bp-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .bp-status svg {
      width: 18px;
      height: 18px;
    }

    .bp-status.normal {
      background: linear-gradient(135deg, hsl(142 70% 90%) 0%, hsl(142 70% 85%) 100%);
      color: hsl(142 70% 30%);
    }
    .dark .bp-status.normal {
      background: linear-gradient(135deg, hsl(142 50% 20%) 0%, hsl(142 50% 15%) 100%);
      color: hsl(142 70% 60%);
    }

    .bp-status.elevated {
      background: linear-gradient(135deg, hsl(45 90% 88%) 0%, hsl(45 90% 80%) 100%);
      color: hsl(45 90% 25%);
    }
    .dark .bp-status.elevated {
      background: linear-gradient(135deg, hsl(45 60% 20%) 0%, hsl(45 60% 15%) 100%);
      color: hsl(45 80% 60%);
    }

    .bp-status.high-stage1 {
      background: linear-gradient(135deg, hsl(25 90% 90%) 0%, hsl(25 90% 82%) 100%);
      color: hsl(25 90% 30%);
    }
    .dark .bp-status.high-stage1 {
      background: linear-gradient(135deg, hsl(25 60% 20%) 0%, hsl(25 60% 15%) 100%);
      color: hsl(25 80% 60%);
    }

    .bp-status.high-stage2 {
      background: linear-gradient(135deg, hsl(0 85% 90%) 0%, hsl(0 85% 82%) 100%);
      color: hsl(0 85% 35%);
    }
    .dark .bp-status.high-stage2 {
      background: linear-gradient(135deg, hsl(0 60% 20%) 0%, hsl(0 60% 15%) 100%);
      color: hsl(0 70% 60%);
    }

    .bp-status.critical {
      background: linear-gradient(135deg, hsl(0 80% 45%) 0%, hsl(0 80% 35%) 100%);
      color: white;
      animation: pulse-critical 1.5s ease-in-out infinite;
    }

    @keyframes pulse-critical {
      0%, 100% { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
      50% { box-shadow: 0 2px 16px rgba(220, 38, 38, 0.5); }
    }

    .bp-status.low {
      background: linear-gradient(135deg, hsl(200 85% 90%) 0%, hsl(200 85% 82%) 100%);
      color: hsl(200 85% 30%);
    }
    .dark .bp-status.low {
      background: linear-gradient(135deg, hsl(200 60% 20%) 0%, hsl(200 60% 15%) 100%);
      color: hsl(200 70% 60%);
    }

    .bp-status.unknown {
      background: hsl(var(--muted));
      color: hsl(var(--muted-foreground));
    }

    /* Section Title */
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title svg {
      width: 20px;
      height: 20px;
      color: hsl(var(--primary));
    }

    /* Input Form */
    .form-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .ocr-section {
      margin-bottom: 1rem;
    }

    .ocr-btn {
      width: 100%;
      padding: 0.875rem;
      background: linear-gradient(135deg, hsl(200 60% 50%) 0%, hsl(200 60% 40%) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .ocr-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .ocr-btn:active {
      transform: scale(0.98);
    }

    .ocr-btn svg {
      width: 20px;
      height: 20px;
    }

    .ocr-status {
      text-align: center;
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-top: 0.75rem;
      display: none;
    }

    .divider {
      text-align: center;
      color: hsl(var(--muted-foreground));
      font-size: 0.8125rem;
      margin: 1rem 0;
      position: relative;
    }

    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 1px;
      background: hsl(var(--border));
    }

    .divider::before { left: 0; }
    .divider::after { right: 0; }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.5rem;
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      font-size: 1.125rem;
      font-weight: 600;
      text-align: center;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      transition: all 0.2s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    .input-group .unit {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      text-align: center;
      margin-top: 0.25rem;
    }

    .submit-btn {
      width: 100%;
      padding: 0.875rem;
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-dark)) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .submit-btn:active {
      transform: scale(0.98);
    }

    .submit-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Log List */
    .log-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .log-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-lg);
      margin-bottom: 0.75rem;
    }

    .log-item:last-child {
      margin-bottom: 0;
    }

    .log-item-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .log-item .time {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .log-item .time svg {
      width: 12px;
      height: 12px;
    }

    .log-item .reading {
      font-size: 1.125rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      font-family: var(--font-mono);
    }

    .log-item .pulse {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .log-item .pulse svg {
      width: 14px;
      height: 14px;
      color: hsl(0 70% 50%);
    }

    .log-item .item-status {
      margin-top: 0.5rem;
    }

    .delete-btn {
      background: hsl(0 70% 50%);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s ease;
    }

    .delete-btn:hover {
      background: hsl(0 70% 45%);
    }

    .delete-btn:active {
      transform: scale(0.95);
    }

    .delete-btn svg {
      width: 14px;
      height: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: hsl(var(--muted-foreground));
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 0.875rem 1.5rem;
      border-radius: var(--radius-lg);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toast svg {
      width: 20px;
      height: 20px;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: linear-gradient(135deg, hsl(142 70% 45%) 0%, hsl(142 70% 35%) 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, hsl(0 70% 50%) 0%, hsl(0 70% 40%) 100%);
    }

    /* Tab Switcher */
    .tab-switcher {
      display: flex;
      background: hsl(var(--muted));
      border-radius: var(--radius-lg);
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .tab-btn {
      flex: 1;
      padding: 0.625rem;
      border: none;
      border-radius: var(--radius-md);
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      color: hsl(var(--muted-foreground));
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
    }

    .tab-btn.active {
      background: hsl(var(--card));
      color: hsl(var(--primary));
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .history-tab-content {
      display: none;
    }

    .history-tab-content.active {
      display: block;
    }

    .history-day-header {
      font-size: 0.8125rem;
      font-weight: 600;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.5rem;
      padding-bottom: 0.375rem;
      border-bottom: 1px solid hsl(var(--border));
      margin-top: 1rem;
    }

    .history-day-header:first-child {
      margin-top: 0;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: hsl(var(--muted) / 0.3);
      border-radius: var(--radius-lg);
      margin-bottom: 0.5rem;
    }

    .history-item-icon {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: hsl(142 76% 94%);
      color: hsl(var(--success));
    }

    .dark .history-item-icon {
      background: hsl(142 50% 20%);
      color: hsl(142 70% 60%);
    }

    .history-item-icon svg {
      width: 18px;
      height: 18px;
    }

    .history-item-content {
      flex: 1;
      min-width: 0;
    }

    .history-item-text {
      font-size: 0.875rem;
      color: hsl(var(--foreground));
    }

    .history-item-time {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    .history-item-badge {
      font-size: 0.6875rem;
      font-weight: 500;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    .history-empty {
      text-align: center;
      padding: 2rem;
      color: hsl(var(--muted-foreground));
    }

    .history-empty svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
      margin-bottom: 0.5rem;
    }

    /* History Filter Controls */
    .history-filter {
      margin-bottom: 1rem;
    }

    .period-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .period-btn {
      flex: 1;
      padding: 0.5rem;
      border: 1.5px solid hsl(var(--border));
      border-radius: var(--radius-md);
      background: hsl(var(--card));
      font-size: 0.8125rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      color: hsl(var(--muted-foreground));
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .period-btn.active {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
      color: hsl(var(--primary));
      font-weight: 600;
    }

    .date-range-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .date-range-row input[type="date"] {
      flex: 1;
      padding: 0.5rem 0.625rem;
      border: 1.5px solid hsl(var(--border));
      border-radius: var(--radius-md);
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      font-size: 0.8125rem;
      font-family: 'Kanit', sans-serif;
    }

    .date-range-row input[type="date"]:focus {
      outline: none;
      border-color: hsl(var(--primary));
    }

    .date-range-row .date-sep {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      flex-shrink: 0;
    }

    .date-range-row .date-search-btn {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: var(--radius-md);
      background: hsl(var(--primary));
      color: white;
      font-size: 0.8125rem;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .date-range-row .date-search-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Close Section */
    .close-section {
      padding-top: 0.5rem;
    }

    @media (max-width: 480px) {
      .vitals-value {
        font-size: 1.875rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="goBack()" aria-label="กลับ" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Tab Switcher -->
      <div class="tab-switcher">
        <button class="tab-btn active" onclick="switchTab('today')" id="tabToday">
          <span id="tabTodayIcon"></span> บันทึกวันนี้
        </button>
        <button class="tab-btn" onclick="switchTab('history')" id="tabHistory">
          <span id="tabHistoryIcon"></span> ประวัติการบันทึก
        </button>
      </div>

      <!-- Today Content -->
      <div id="todayContent">
      <!-- Vitals Summary -->
      <div class="vitals-summary">
        <div class="vitals-card">
          <div class="vitals-label">ค่าบน (Systolic)</div>
          <div class="vitals-value" id="latestSystolic">--</div>
          <div class="vitals-unit">mmHg</div>
        </div>
        <div class="vitals-card">
          <div class="vitals-label">ค่าล่าง (Diastolic)</div>
          <div class="vitals-value" id="latestDiastolic">--</div>
          <div class="vitals-unit">mmHg</div>
        </div>
      </div>

      <!-- BP Status -->
      <div class="status-card">
        <div id="bpStatus" class="bp-status unknown">--</div>
      </div>

      <!-- Add New Reading -->
      <div class="section-title" id="formSectionTitle"></div>

      <div class="form-card">
        <!-- OCR Option -->
        <div class="ocr-section">
          <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
          <button class="ocr-btn" onclick="document.getElementById('imageInput').click()" id="ocrBtn"></button>
          <div id="ocrStatus" class="ocr-status"></div>
        </div>

        <div class="divider">หรือกรอกด้วยตัวเอง</div>

        <div class="input-row">
          <div class="input-group">
            <label for="systolic">ค่าบน</label>
            <input type="number" id="systolic" placeholder="120" min="50" max="250" inputmode="numeric">
            <div class="unit">mmHg</div>
          </div>
          <div class="input-group">
            <label for="diastolic">ค่าล่าง</label>
            <input type="number" id="diastolic" placeholder="80" min="30" max="150" inputmode="numeric">
            <div class="unit">mmHg</div>
          </div>
        </div>

        <div class="input-group" style="margin-bottom: 1rem;">
          <label for="pulse">ชีพจร (ไม่บังคับ)</label>
          <input type="number" id="pulse" placeholder="72" min="40" max="200" inputmode="numeric">
          <div class="unit">ครั้ง/นาที</div>
        </div>

        <button class="submit-btn" onclick="addReading()" id="submitBtn"></button>
      </div>

      <!-- Today's Log -->
      <div class="section-title" id="logSectionTitle"></div>

      <div class="log-card">
        <div id="logContainer">
          <div class="empty-state" id="emptyState"></div>
        </div>
      </div>

      </div><!-- /todayContent -->

      <!-- History Content -->
      <div id="historyContent" class="history-tab-content">
        <div class="history-filter">
          <div class="period-buttons">
            <button class="period-btn active" onclick="selectPeriodDays(7)">7 วัน</button>
            <button class="period-btn" onclick="selectPeriodDays(14)">14 วัน</button>
            <button class="period-btn" onclick="selectPeriodDays(30)">30 วัน</button>
            <button class="period-btn" onclick="toggleDateRange()">กำหนดเอง</button>
          </div>
          <div class="date-range-row" id="dateRangeRow" style="display:none;">
            <input type="date" id="dateFrom">
            <span class="date-sep">ถึง</span>
            <input type="date" id="dateTo">
            <button class="date-search-btn" onclick="searchByDateRange()">ค้นหา</button>
          </div>
        </div>
        <div id="historyList">
          <div class="history-empty">กำลังโหลด...</div>
        </div>
      </div>

      <!-- Close Button -->
      <div class="close-section">
        <button class="btn btn-secondary btn-block" onclick="goBack()">
          <span id="closeBtnText">ปิด</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <script>
    // API Base URL
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : 'https://duulair.vercel.app/api';

    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';

    let supabaseClient = null;
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let patientId = null;
    let groupId = null;
    let todayReadings = [];

    // Initialize UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('arrowLeft');
      document.getElementById('headerTitle').innerHTML = icon('heartPulse', 'inline-icon') + ' วัดความดัน';
      document.getElementById('themeBtn').innerHTML = icon('sun');
      document.getElementById('formSectionTitle').innerHTML = icon('edit') + ' บันทึกค่าใหม่';
      document.getElementById('ocrBtn').innerHTML = icon('camera') + ' ถ่ายรูป/อัพโหลด';
      document.getElementById('submitBtn').innerHTML = icon('save') + ' บันทึก';
      document.getElementById('logSectionTitle').innerHTML = icon('list') + ' บันทึกวันนี้';
      document.getElementById('emptyState').innerHTML = icon('clipboardList') + '<p>ยังไม่มีการบันทึก</p>';
      document.getElementById('tabTodayIcon').innerHTML = icon('edit');
      document.getElementById('tabHistoryIcon').innerHTML = icon('clock');

      // Check if we should show back button
      const returnTo = sessionStorage.getItem('liff_return_to');
      if (returnTo) {
        document.getElementById('closeBtnText').textContent = 'กลับ';
      }

      // Load cached vitals data
      const today = new Date().toISOString().split('T')[0];
      const savedData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
      todayReadings = savedData.readings || [];

      // Show UI immediately!
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');

      // Update UI with cached data
      updateUI();
    })();

    // Update theme icon
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };
    setTimeout(updateThemeIcon, 100);

    function goBack() {
      const returnTo = sessionStorage.getItem('liff_return_to');
      if (returnTo) {
        sessionStorage.removeItem('liff_return_to');
        const basePath = window.location.pathname.replace(/[^/]*$/, '');
        window.location.href = basePath + returnTo;
      } else {
        liff.closeWindow();
      }
    }

    // Cache LIFF profile
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Check registration
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await getCachedProfile();
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

        // Get user context
        const context = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = context.patientId;
        groupId = context.groupId;

        // Fallback: fetch patientId from server if not in localStorage
        if (!patientId) {
          try {
            const response = await fetch(`${API_BASE_URL}/check-user/${profile.userId}`);
            const result = await response.json();
            if (result.exists && result.profile?.linked_patient_id) {
              patientId = result.profile.linked_patient_id;
              context.patientId = patientId;
              localStorage.setItem('oonjai_context', JSON.stringify(context));
            }
          } catch (e) {
            console.error('Failed to fetch patientId from server:', e);
          }
        }

        // Load fresh data in background
        loadTodayData().catch(err => console.error('Load data error:', err));

      } catch (error) {
        console.error('LIFF init error:', error);
        showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
      }
    }

    async function loadTodayData() {
      if (!supabaseClient || !patientId) {
        const today = new Date().toISOString().split('T')[0];
        const savedData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
        todayReadings = savedData.readings || [];
        updateUI();
        return;
      }

      try {
        const today = new Date().toISOString().split('T')[0];

        const { data, error } = await supabaseClient
          .from('vitals_logs')
          .select('id, bp_systolic, bp_diastolic, heart_rate, measured_at')
          .eq('patient_id', patientId)
          .gte('measured_at', today + 'T00:00:00')
          .lt('measured_at', today + 'T23:59:59')
          .not('bp_systolic', 'is', null)
          .order('measured_at', { ascending: false });

        if (error) throw error;

        todayReadings = (data || []).map(row => ({
          id: row.id,
          time: new Date(row.measured_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
          systolic: row.bp_systolic,
          diastolic: row.bp_diastolic,
          pulse: row.heart_rate,
          timestamp: row.measured_at,
          fromDatabase: true
        }));

        updateUI();
      } catch (error) {
        console.error('Error loading vitals:', error);
        const today = new Date().toISOString().split('T')[0];
        const savedData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
        todayReadings = savedData.readings || [];
        updateUI();
      }
    }

    async function addReading() {
      const systolic = parseInt(document.getElementById('systolic').value);
      const diastolic = parseInt(document.getElementById('diastolic').value);
      const pulse = parseInt(document.getElementById('pulse').value) || null;

      // Validation
      if (!systolic || !diastolic) {
        showToast('กรุณากรอกค่าความดันให้ครบถ้วน', 'error');
        return;
      }

      if (systolic < 50 || systolic > 250) {
        showToast('ค่าบนควรอยู่ระหว่าง 50-250 mmHg', 'error');
        return;
      }

      if (diastolic < 30 || diastolic > 150) {
        showToast('ค่าล่างควรอยู่ระหว่าง 30-150 mmHg', 'error');
        return;
      }

      if (systolic <= diastolic) {
        showToast('ค่าบนต้องมากกว่าค่าล่าง', 'error');
        return;
      }

      if (pulse && (pulse < 40 || pulse > 200)) {
        showToast('ค่าชีพจรควรอยู่ระหว่าง 40-200 ครั้ง/นาที', 'error');
        return;
      }

      if (supabaseClient && patientId) {
        try {
          const vitalsData = {
            patient_id: patientId,
            bp_systolic: systolic,
            bp_diastolic: diastolic,
            heart_rate: pulse,
            source: 'manual',
            measured_at: new Date().toISOString()
          };

          const { error } = await supabaseClient
            .from('vitals_logs')
            .insert(vitalsData);

          if (error) throw error;

          await loadTodayData();

          document.getElementById('systolic').value = '';
          document.getElementById('diastolic').value = '';
          document.getElementById('pulse').value = '';

          showToast('บันทึกความดันเรียบร้อยแล้ว', 'success');
        } catch (error) {
          console.error('Error saving vitals:', error);
          showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
        }
      } else {
        const now = new Date();
        const reading = {
          id: Date.now(),
          time: now.toTimeString().slice(0, 5),
          systolic,
          diastolic,
          pulse,
          timestamp: now.toISOString()
        };

        todayReadings.unshift(reading);
        saveData();
        updateUI();

        document.getElementById('systolic').value = '';
        document.getElementById('diastolic').value = '';
        document.getElementById('pulse').value = '';

        showToast('บันทึกความดันเรียบร้อยแล้ว', 'success');
      }
    }

    async function deleteReading(readingId) {
      const isDbRecord = typeof readingId === 'string' && readingId.includes('-');

      if (isDbRecord && supabaseClient) {
        try {
          const { error } = await supabaseClient
            .from('vitals_logs')
            .delete()
            .eq('id', readingId);

          if (error) throw error;

          await loadTodayData();
          showToast('ลบรายการเรียบร้อยแล้ว', 'success');
        } catch (error) {
          console.error('Error deleting vitals:', error);
          showToast('เกิดข้อผิดพลาดในการลบ', 'error');
        }
      } else {
        todayReadings = todayReadings.filter(r => r.id !== readingId);
        saveData();
        updateUI();
        showToast('ลบรายการเรียบร้อยแล้ว', 'success');
      }
    }

    function saveData() {
      const today = new Date().toISOString().split('T')[0];
      localStorage.setItem(`vitals_${today}`, JSON.stringify({
        readings: todayReadings
      }));
    }

    function updateUI() {
      // Update latest reading
      if (todayReadings.length > 0) {
        const latest = todayReadings[0];
        document.getElementById('latestSystolic').textContent = latest.systolic;
        document.getElementById('latestDiastolic').textContent = latest.diastolic;

        const status = getBloodPressureStatus(latest.systolic, latest.diastolic);
        const statusEl = document.getElementById('bpStatus');
        statusEl.innerHTML = status.icon + ' ' + status.label;
        statusEl.className = `bp-status ${status.class}`;
      } else {
        document.getElementById('latestSystolic').textContent = '--';
        document.getElementById('latestDiastolic').textContent = '--';
        document.getElementById('bpStatus').innerHTML = '--';
        document.getElementById('bpStatus').className = 'bp-status unknown';
      }

      // Update logs
      const container = document.getElementById('logContainer');
      if (todayReadings.length === 0) {
        container.innerHTML = `<div class="empty-state">${icon('clipboardList')}<p>ยังไม่มีการบันทึก</p></div>`;
      } else {
        container.innerHTML = todayReadings.map(reading => {
          const status = getBloodPressureStatus(reading.systolic, reading.diastolic);
          return `
            <div class="log-item">
              <div class="log-item-info">
                <span class="time">${icon('clock')} ${reading.time}</span>
                <span class="reading">${reading.systolic}/${reading.diastolic} mmHg</span>
                ${reading.pulse ? `<span class="pulse">${icon('heart')} ${reading.pulse} ครั้ง/นาที</span>` : ''}
                <div class="item-status">
                  <span class="bp-status ${status.class}" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">${status.icon} ${status.label}</span>
                </div>
              </div>
              <button class="delete-btn" onclick="deleteReading('${reading.id}')">${icon('trash2')} ลบ</button>
            </div>
          `;
        }).join('');
      }
    }

    function getBloodPressureStatus(systolic, diastolic) {
      if (systolic >= 180 || diastolic >= 120) {
        return { label: 'วิกฤต', class: 'critical', icon: icon('alertTriangle') };
      } else if (systolic >= 140 || diastolic >= 90) {
        return { label: 'สูง ระยะ 2', class: 'high-stage2', icon: icon('trendingUp') };
      } else if (systolic >= 130 || diastolic >= 80) {
        return { label: 'สูง ระยะ 1', class: 'high-stage1', icon: icon('arrowUp') };
      } else if (systolic >= 120 && diastolic < 80) {
        return { label: 'สูงกว่าปกติ', class: 'elevated', icon: icon('minus') };
      } else if (systolic < 90 || diastolic < 60) {
        return { label: 'ต่ำ', class: 'low', icon: icon('arrowDown') };
      } else {
        return { label: 'ปกติ', class: 'normal', icon: icon('checkCircle') };
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const iconName = type === 'success' ? 'checkCircle' : 'alertCircle';
      toast.innerHTML = icon(iconName) + ' ' + message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const statusEl = document.getElementById('ocrStatus');
      statusEl.innerHTML = icon('loader') + ' กำลังอ่านค่าจากรูปภาพ...';
      statusEl.style.display = 'block';
      statusEl.style.color = 'hsl(var(--primary))';

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch(`${API_BASE_URL}/ocr/vitals`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success && result.data) {
          document.getElementById('systolic').value = result.data.systolic;
          document.getElementById('diastolic').value = result.data.diastolic;
          if (result.data.pulse) {
            document.getElementById('pulse').value = result.data.pulse;
          }

          statusEl.innerHTML = icon('checkCircle') + ' อ่านค่าสำเร็จ! กรุณาตรวจสอบความถูกต้อง';
          statusEl.style.color = 'hsl(142 70% 40%)';

          showToast('อ่านค่าความดันจากรูปภาพสำเร็จ', 'success');
        } else {
          statusEl.innerHTML = icon('xCircle') + ' ' + (result.error || 'ไม่สามารถอ่านค่าได้');
          statusEl.style.color = 'hsl(0 70% 50%)';

          showToast(result.error || 'ไม่สามารถอ่านค่าความดันจากรูปภาพนี้ได้', 'error');
        }

      } catch (error) {
        console.error('OCR error:', error);
        statusEl.innerHTML = icon('xCircle') + ' เกิดข้อผิดพลาด กรุณาลองใหม่';
        statusEl.style.color = 'hsl(0 70% 50%)';

        showToast('เกิดข้อผิดพลาดในการประมวลผลรูปภาพ', 'error');
      }

      event.target.value = '';
    }

    // --- Tab switching & History ---
    let currentTab = 'today';
    let historyPeriodDays = 7;
    let historyFirstLoad = true;

    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tabToday').classList.toggle('active', tab === 'today');
      document.getElementById('tabHistory').classList.toggle('active', tab === 'history');
      document.getElementById('todayContent').style.display = tab === 'today' ? '' : 'none';
      document.getElementById('historyContent').classList.toggle('active', tab === 'history');
      if (tab === 'history' && historyFirstLoad) {
        historyFirstLoad = false;
        loadHistory();
      }
    }

    function selectPeriodDays(days) {
      historyPeriodDays = days;
      document.querySelectorAll('.period-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === [7,14,30].indexOf(days));
      });
      document.getElementById('dateRangeRow').style.display = 'none';
      loadHistory();
    }

    function toggleDateRange() {
      document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.period-btn')[3].classList.add('active');
      const row = document.getElementById('dateRangeRow');
      row.style.display = row.style.display === 'none' ? 'flex' : 'none';
      if (row.style.display === 'flex') {
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
        document.getElementById('dateTo').value = today;
        document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
      }
    }

    function searchByDateRange() {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;
      if (!from || !to) return;
      loadHistory(new Date(from), new Date(to + 'T23:59:59'));
    }

    async function loadHistory(fromDate, toDate) {
      if (!supabaseClient || !patientId) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty">' + icon('alertCircle') + '<p>ไม่สามารถโหลดข้อมูลได้</p></div>';
        return;
      }

      document.getElementById('historyList').innerHTML = '<div class="history-empty">กำลังโหลด...</div>';

      if (!fromDate) {
        fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - historyPeriodDays);
      }
      if (!toDate) {
        toDate = new Date();
      }

      try {
        const { data, error } = await supabaseClient
          .from('vitals_logs')
          .select('*')
          .eq('patient_id', patientId)
          .gte('measured_at', fromDate.toISOString())
          .lte('measured_at', toDate.toISOString())
          .not('bp_systolic', 'is', null)
          .order('measured_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        renderHistory(data || []);
      } catch (err) {
        console.error('Error loading history:', err);
        document.getElementById('historyList').innerHTML = '<div class="history-empty">' + icon('alertCircle') + '<p>เกิดข้อผิดพลาดในการโหลด</p></div>';
      }
    }

    function renderHistory(records) {
      const container = document.getElementById('historyList');

      if (records.length === 0) {
        container.innerHTML = '<div class="history-empty">' + icon('heartPulse') + '<p>ไม่มีข้อมูลในช่วงเวลานี้</p></div>';
        return;
      }

      const grouped = {};
      records.forEach(r => {
        const date = new Date(r.measured_at).toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(r);
      });

      let html = '';
      for (const [date, items] of Object.entries(grouped)) {
        html += `<div class="history-day-header">${date}</div>`;
        items.forEach(item => {
          const time = new Date(item.measured_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const sys = item.bp_systolic;
          const dia = item.bp_diastolic;
          const pulse = item.heart_rate ? ` ชีพจร ${item.heart_rate}` : '';
          const status = getBloodPressureStatus(sys, dia);
          html += `
            <div class="history-item">
              <div class="history-item-icon">${icon('heartPulse')}</div>
              <div class="history-item-content">
                <div class="history-item-text">ความดัน ${sys}/${dia} mmHg${pulse}</div>
                <div class="history-item-time">${time} · <span class="bp-status ${status.class}" style="font-size:0.6875rem;padding:0.125rem 0.5rem;display:inline-flex;align-items:center;gap:0.25rem;">${status.icon} ${status.label}</span></div>
              </div>
            </div>`;
        });
      }

      container.innerHTML = html;
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
