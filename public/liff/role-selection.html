<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - Duulair</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö üëã</h1>
    <p class="text-center mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div class="role-cards" id="roleCards">
      <!-- Patient Card -->
      <div class="role-card" id="patientCard" style="cursor: pointer; opacity: 0.5;">
        <div class="icon">üë¥</div>
        <h2>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
        <p>‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p>
      </div>

      <!-- Caregiver Card -->
      <div class="role-card" id="caregiverCard" style="cursor: pointer; opacity: 0.5;">
        <div class="icon">üë®‚Äçüë©‚Äçüëß</div>
        <h2>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
        <p>‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p>
      </div>
    </div>

    <!-- Action Buttons (always visible and enabled) -->
    <div id="actionButtons" style="margin-top: 20px;">
      <button class="btn btn-primary btn-block" id="patientBtn">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
      </button>
      <button class="btn btn-secondary btn-block" id="caregiverBtn" style="margin-top: 10px;">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
      </button>
    </div>

    <div class="card mt-2">
      <h3>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
      <p style="margin-bottom: 8px;"><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥</p>
      <p><strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- App JavaScript -->
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/liff-init.js"></script>

  <script>
    // ========================================
    // Role Selection
    // ========================================

    let liffProfile = null;

    async function init() {
      try {
        console.log('üöÄ Starting LIFF initialization...');

        // Show loading
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...');

        // Initialize LIFF
        liffProfile = await initLiff();

        console.log('üì± LIFF init returned:', liffProfile);

        hideLoading();

        if (!liffProfile) {
          console.error('‚ùå LIFF Profile is null');
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ');
          // Still enable buttons for testing
          enableRoleSelection();
          return;
        }

        console.log('‚úÖ LIFF Profile loaded:', liffProfile);
        console.log('‚úÖ Ready to select role');

        // Enable cards and show buttons
        enableRoleSelection();

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        hideLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        // Still enable buttons for testing
        enableRoleSelection();
      }
    }

    /**
     * Enable role selection after LIFF is ready
     */
    function enableRoleSelection() {
      console.log('üé® Enabling role selection...');

      // Enable cards (visual feedback)
      const patientCard = document.getElementById('patientCard');
      const caregiverCard = document.getElementById('caregiverCard');

      console.log('üìã Patient card:', patientCard);
      console.log('üìã Caregiver card:', caregiverCard);

      if (patientCard) {
        patientCard.style.opacity = '1';
        console.log('‚úÖ Patient card visual enabled');
      }

      if (caregiverCard) {
        caregiverCard.style.opacity = '1';
        console.log('‚úÖ Caregiver card visual enabled');
      }

      // Attach event listeners to buttons
      const patientBtn = document.getElementById('patientBtn');
      const caregiverBtn = document.getElementById('caregiverBtn');

      console.log('üîò Patient button:', patientBtn);
      console.log('üîò Caregiver button:', caregiverBtn);

      if (patientBtn) {
        // Remove any existing listeners by cloning
        const newPatientBtn = patientBtn.cloneNode(true);
        patientBtn.parentNode.replaceChild(newPatientBtn, patientBtn);

        // Handler function to prevent double-triggering
        let patientHandled = false;
        const handlePatientClick = function(e) {
          e.preventDefault();
          if (patientHandled) {
            console.log('‚ö†Ô∏è Patient button already handled, ignoring');
            return;
          }
          patientHandled = true;
          console.log('üëÜ Patient button triggered');
          selectRole('patient');
        };

        // Add both click and touch listeners
        newPatientBtn.addEventListener('click', handlePatientClick, { passive: false });
        newPatientBtn.addEventListener('touchend', handlePatientClick, { passive: false });

        console.log('‚úÖ Patient button listeners attached');
      }

      if (caregiverBtn) {
        // Remove any existing listeners by cloning
        const newCaregiverBtn = caregiverBtn.cloneNode(true);
        caregiverBtn.parentNode.replaceChild(newCaregiverBtn, caregiverBtn);

        // Handler function to prevent double-triggering
        let caregiverHandled = false;
        const handleCaregiverClick = function(e) {
          e.preventDefault();
          if (caregiverHandled) {
            console.log('‚ö†Ô∏è Caregiver button already handled, ignoring');
            return;
          }
          caregiverHandled = true;
          console.log('üëÜ Caregiver button triggered');
          selectRole('caregiver');
        };

        // Add both click and touch listeners
        newCaregiverBtn.addEventListener('click', handleCaregiverClick, { passive: false });
        newCaregiverBtn.addEventListener('touchend', handleCaregiverClick, { passive: false });

        console.log('‚úÖ Caregiver button listeners attached');
      }

      console.log('‚úÖ Role selection enabled complete');
    }

    /**
     * Select role and navigate to registration form
     * @param {string} role - 'patient' or 'caregiver'
     */
    function selectRole(role) {
      console.log('üéØ selectRole function called with:', role);
      console.log('üë§ Current LIFF Profile:', liffProfile);
      console.log('üåê Current URL:', window.location.href);
      console.log('üîç LIFF available:', typeof liff !== 'undefined');
      console.log('üîç LIFF initialized:', typeof liff !== 'undefined' && liff.isInClient !== undefined);

      // Show loading immediately
      console.log('üîÑ Showing loading...');
      if (typeof showLoading === 'function') {
        showLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô${role === 'patient' ? '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}...`);
      }

      // Save role to sessionStorage
      try {
        sessionStorage.setItem('selectedRole', role);
        if (liffProfile) {
          sessionStorage.setItem('liffProfile', JSON.stringify(liffProfile));
        }
        console.log('‚úÖ Saved to sessionStorage:', {
          role: sessionStorage.getItem('selectedRole'),
          hasProfile: !!sessionStorage.getItem('liffProfile')
        });
      } catch (e) {
        console.error('‚ùå Failed to save to sessionStorage:', e);
      }

      // Build full URL for navigation
      const baseUrl = window.location.origin;
      const targetPath = role === 'patient'
        ? '/liff/patient-registration.html'
        : '/liff/caregiver-registration.html';
      const targetUrl = baseUrl + targetPath;

      console.log('üìç Target URL:', targetUrl);
      console.log('üöÄ Attempting navigation...');

      // Try multiple navigation methods
      try {
        // Method 1: Use liff.openWindow for LIFF-aware navigation
        if (typeof liff !== 'undefined' && liff.openWindow) {
          console.log('üîÑ Using liff.openWindow()');
          liff.openWindow({
            url: targetUrl,
            external: false
          });
          console.log('‚úÖ liff.openWindow() called');
          return;
        }
      } catch (e) {
        console.error('‚ùå liff.openWindow() failed:', e);
      }

      try {
        // Method 2: Use window.location.replace
        console.log('üîÑ Using window.location.replace()');
        window.location.replace(targetUrl);
        console.log('‚úÖ window.location.replace() called');
      } catch (e) {
        console.error('‚ùå window.location.replace() failed:', e);

        // Method 3: Fallback to window.location.href
        try {
          console.log('üîÑ Using window.location.href (fallback)');
          window.location.href = targetUrl;
          console.log('‚úÖ window.location.href set');
        } catch (e2) {
          console.error('‚ùå All navigation methods failed:', e2);
          hideLoading();
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
      }
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
