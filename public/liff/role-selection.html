<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - Duulair</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö üëã</h1>
    <p class="text-center mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div class="role-cards" id="roleCards">
      <!-- Patient Card -->
      <div class="role-card" id="patientCard" style="cursor: pointer; opacity: 0.5;">
        <div class="icon">üë¥</div>
        <h2>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
        <p>‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p>
      </div>

      <!-- Caregiver Card -->
      <div class="role-card" id="caregiverCard" style="cursor: pointer; opacity: 0.5;">
        <div class="icon">üë®‚Äçüë©‚Äçüëß</div>
        <h2>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
        <p>‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p>
      </div>
    </div>

    <!-- Action Buttons (shown after cards are enabled) -->
    <div id="actionButtons" style="display: none; margin-top: 20px;">
      <button class="btn btn-primary btn-block" onclick="selectRole('patient')" id="patientBtn">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
      </button>
      <button class="btn btn-secondary btn-block" onclick="selectRole('caregiver')" id="caregiverBtn" style="margin-top: 10px;">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
      </button>
    </div>

    <div class="card mt-2">
      <h3>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
      <p style="margin-bottom: 8px;"><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥</p>
      <p><strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- App JavaScript -->
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/liff-init.js"></script>

  <script>
    // ========================================
    // Role Selection
    // ========================================

    let liffProfile = null;

    async function init() {
      try {
        console.log('üöÄ Starting LIFF initialization...');

        // Show loading
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...');

        // Initialize LIFF
        liffProfile = await initLiff();

        console.log('üì± LIFF init returned:', liffProfile);

        hideLoading();

        if (!liffProfile) {
          console.error('‚ùå LIFF Profile is null');
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ');
          // Still enable buttons for testing
          enableRoleSelection();
          return;
        }

        console.log('‚úÖ LIFF Profile loaded:', liffProfile);
        console.log('‚úÖ Ready to select role');

        // Enable cards and show buttons
        enableRoleSelection();

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        hideLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        // Still enable buttons for testing
        enableRoleSelection();
      }
    }

    /**
     * Enable role selection after LIFF is ready
     */
    function enableRoleSelection() {
      console.log('üé® Enabling role selection...');

      // Enable cards
      const patientCard = document.getElementById('patientCard');
      const caregiverCard = document.getElementById('caregiverCard');

      console.log('üìã Patient card:', patientCard);
      console.log('üìã Caregiver card:', caregiverCard);

      if (patientCard) {
        patientCard.style.opacity = '1';
        patientCard.onclick = () => {
          console.log('üñ±Ô∏è Patient card clicked');
          selectRole('patient');
        };
        console.log('‚úÖ Patient card enabled');
      } else {
        console.error('‚ùå Patient card not found');
      }

      if (caregiverCard) {
        caregiverCard.style.opacity = '1';
        caregiverCard.onclick = () => {
          console.log('üñ±Ô∏è Caregiver card clicked');
          selectRole('caregiver');
        };
        console.log('‚úÖ Caregiver card enabled');
      } else {
        console.error('‚ùå Caregiver card not found');
      }

      // Show action buttons
      const actionButtons = document.getElementById('actionButtons');
      console.log('üîò Action buttons element:', actionButtons);

      if (actionButtons) {
        actionButtons.style.display = 'block';
        console.log('‚úÖ Action buttons displayed');
      } else {
        console.error('‚ùå Action buttons not found');
      }

      console.log('‚úÖ Role selection enabled complete');
    }

    /**
     * Select role and navigate to registration form
     * @param {string} role - 'patient' or 'caregiver'
     */
    function selectRole(role) {
      console.log('üéØ selectRole function called with:', role);
      console.log('üë§ Current LIFF Profile:', liffProfile);

      // Check if LIFF profile exists
      if (!liffProfile) {
        console.warn('‚ö†Ô∏è LIFF Profile not loaded - proceeding anyway for testing');
        const confirmProceed = confirm('LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)');
        if (!confirmProceed) {
          return;
        }
      }

      console.log('üíæ Saving to sessionStorage...');

      // Save role and profile to sessionStorage
      try {
        sessionStorage.setItem('selectedRole', role);
        if (liffProfile) {
          sessionStorage.setItem('liffProfile', JSON.stringify(liffProfile));
        }
        console.log('‚úÖ Saved to sessionStorage');
      } catch (e) {
        console.error('‚ùå Failed to save to sessionStorage:', e);
      }

      // Show loading immediately
      console.log('üîÑ Showing loading...');
      showLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô${role === 'patient' ? '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'}...`);

      // Disable buttons to prevent double click
      const patientBtn = document.getElementById('patientBtn');
      const caregiverBtn = document.getElementById('caregiverBtn');
      if (patientBtn) patientBtn.disabled = true;
      if (caregiverBtn) caregiverBtn.disabled = true;

      // Navigate to appropriate registration form (use absolute paths)
      const targetUrl = role === 'patient'
        ? '/liff/patient-registration.html'
        : '/liff/caregiver-registration.html';

      console.log(`‚úÖ Navigating to ${role} registration...`);
      console.log(`üìç Target URL: ${targetUrl}`);
      console.log(`üåê Current URL: ${window.location.href}`);

      // Small delay to show loading
      setTimeout(() => {
        console.log('üöÄ Executing redirect now...');
        try {
          window.location.href = targetUrl;
        } catch (e) {
          console.error('‚ùå Navigation failed:', e);
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ: ' + e.message);
        }
      }, 300);
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
