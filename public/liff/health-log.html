<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FAF9F6">
  <title>ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - OONJAI</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Dashboard Header */
    .dashboard-header {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      color: white;
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .dashboard-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }

    .dashboard-date {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Today's Summary */
    .summary-section {
      margin-bottom: var(--spacing-lg);
    }

    .summary-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .summary-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .summary-icon.medication {
      background: #FEE2E2;
    }

    .summary-icon.water {
      background: #DBEAFE;
    }

    .summary-icon.vitals {
      background: #D1FAE5;
    }

    .summary-icon.symptom {
      background: #FEF3C7;
    }

    .summary-info {
      flex: 1;
      min-width: 0;
    }

    .summary-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .summary-value.incomplete {
      color: var(--warning);
    }

    .summary-value.complete {
      color: var(--success);
    }

    /* Category Grid */
    .category-section {
      margin-bottom: var(--spacing-lg);
    }

    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .category-btn {
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      text-decoration: none;
      display: block;
    }

    .category-btn:active {
      transform: scale(0.97);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }

    .category-icon {
      font-size: 36px;
      margin-bottom: var(--spacing-sm);
      display: block;
    }

    .category-label {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      display: block;
      margin-bottom: 4px;
    }

    .category-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Quick Actions */
    .quick-actions {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .quick-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .quick-btn-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .quick-btn {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }

    .quick-btn:active {
      background: var(--accent-light);
    }

    .quick-btn-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      background: var(--bg-card);
    }

    .quick-btn-text {
      flex: 1;
    }

    .quick-btn-text .label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      display: block;
    }

    .quick-btn-text .desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .quick-btn-arrow {
      color: var(--text-muted);
      font-size: 18px;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 24px;
      border-radius: var(--radius-md);
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
    }

    @media (max-width: 380px) {
      .category-icon {
        font-size: 28px;
      }

      .category-label {
        font-size: 14px;
      }

      .summary-value {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      <p id="debugStatus" style="font-size: 12px; color: #666; margin-top: 10px;">Initializing...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h1>ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h1>
        <div class="dashboard-date" id="currentDate"></div>
      </div>

      <!-- Today's Summary -->
      <div class="summary-section">
        <div class="summary-title">
          üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </div>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-icon medication">üíä</div>
            <div class="summary-info">
              <div class="summary-label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</div>
              <div class="summary-value" id="medSummary">-/-</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon water">üíß</div>
            <div class="summary-info">
              <div class="summary-label">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</div>
              <div class="summary-value" id="waterSummary">0 ml</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon vitals">üíâ</div>
            <div class="summary-info">
              <div class="summary-label">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
              <div class="summary-value" id="vitalsSummary">-</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon symptom">ü§í</div>
            <div class="summary-info">
              <div class="summary-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div>
              <div class="summary-value" id="symptomSummary">‡∏õ‡∏Å‡∏ï‡∏¥</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Grid -->
      <div class="category-section">
        <div class="category-title">
          üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </div>
        <div class="category-grid">
          <a href="log-medication.html" class="category-btn">
            <span class="category-icon">üíä</span>
            <span class="category-label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</span>
            <span class="category-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</span>
          </a>
          <a href="vitals-tracking.html" class="category-btn">
            <span class="category-icon">üíâ</span>
            <span class="category-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</span>
            <span class="category-desc">‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</span>
          </a>
          <a href="water-tracking.html" class="category-btn">
            <span class="category-icon">üíß</span>
            <span class="category-label">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</span>
            <span class="category-desc">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</span>
          </a>
          <a href="log-symptom.html" class="category-btn">
            <span class="category-icon">ü§í</span>
            <span class="category-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</span>
            <span class="category-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>
          </a>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="quick-title">
          ‚ö° ‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î
        </div>
        <div class="quick-btn-group">
          <button class="quick-btn" onclick="quickLogMedication()">
            <div class="quick-btn-icon">‚úÖ</div>
            <div class="quick-btn-text">
              <span class="label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
              <span class="desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
            <span class="quick-btn-arrow">‚Ä∫</span>
          </button>
          <button class="quick-btn" onclick="openMedications()">
            <div class="quick-btn-icon">üìã</div>
            <div class="quick-btn-text">
              <span class="label">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</span>
              <span class="desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</span>
            </div>
            <span class="quick-btn-arrow">‚Ä∫</span>
          </button>
          <button class="quick-btn" onclick="viewReports()">
            <div class="quick-btn-icon">üìä</div>
            <div class="quick-btn-text">
              <span class="label">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
              <span class="desc">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
            </div>
            <span class="quick-btn-arrow">‚Ä∫</span>
          </button>
        </div>
      </div>

      <button class="btn btn-secondary btn-block" onclick="closeLiff()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // TEST: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ script ‡∏£‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    document.getElementById('debugStatus').textContent = 'Script started!';

    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';

    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let patientId = null;
    let groupId = null;
    let medications = [];
    let todaySummary = {
      medicationsTaken: 0,
      medicationsTotal: 0,
      waterAmount: 0,
      latestVitals: null,
      symptoms: []
    };

    // Format Thai date
    function formatThaiDate(date) {
      const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
      ];
      const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543; // Buddhist year
      const dayName = thaiDays[date.getDay()];

      return `‡∏ß‡∏±‡∏ô${dayName}‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;
    }

    // Check user registration
    async function checkUserRegistration(lineUserId) {
      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    function updateDebug(msg) {
      const el = document.getElementById('debugStatus');
      if (el) el.textContent = msg;
      console.log('[DEBUG]', msg);
    }

    async function initializeLIFF() {
      try {
        updateDebug('1. LIFF init...');
        await liff.init({ liffId: LIFF_ID });
        updateDebug('2. LIFF ready, checking login...');

        if (!liff.isLoggedIn()) {
          updateDebug('3. Not logged in, redirecting to login...');
          liff.login();
          return;
        }

        updateDebug('3. Logged in, getting profile...');
        const profile = await liff.getProfile();
        updateDebug(`4. Profile: ${profile.displayName}`);

        // Check registration (but don't block if it fails)
        try {
          updateDebug('5. Checking registration...');
          const isRegistered = await checkUserRegistration(profile.userId);
          if (!isRegistered) {
            updateDebug('5b. Not registered, will redirect...');
          } else {
            updateDebug('5b. Registered OK');
          }
        } catch (regError) {
          updateDebug(`5b. Reg check error: ${regError.message}`);
        }

        // Get context from localStorage
        updateDebug('6. Getting context from localStorage...');
        const context = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = context.patientId;
        groupId = context.groupId;
        updateDebug(`6b. Context: patientId=${patientId || 'none'}, groupId=${groupId || 'none'}`);

        // Set current date
        document.getElementById('currentDate').textContent = formatThaiDate(new Date());

        // Load data (don't fail if no patientId)
        try {
          updateDebug('7. Loading summary...');
          await loadTodaySummary();
          updateDebug('7b. Summary loaded');
        } catch (loadError) {
          updateDebug(`7b. Summary error: ${loadError.message}`);
        }

        // Always show content
        updateDebug('8. Showing content...');
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

      } catch (error) {
        updateDebug(`ERROR: ${error.message}`);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        // Still hide loading and show content with error state
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
      }
    }

    async function loadTodaySummary() {
      const today = new Date().toISOString().split('T')[0];

      // Load medications count
      if (patientId && supabase) {
        try {
          const { data: meds, error } = await supabase
            .from('medications')
            .select('id, times')
            .eq('patient_id', patientId)
            .eq('is_active', true);

          if (!error && meds) {
            // Count total expected medication doses for today
            let totalDoses = 0;
            meds.forEach(med => {
              const times = med.times || [];
              totalDoses += times.length;
            });
            todaySummary.medicationsTotal = totalDoses;
            medications = meds;
          }

          // Get today's medication logs
          const { data: logs, error: logsError } = await supabase
            .from('activity_logs')
            .select('*')
            .eq('patient_id', patientId)
            .eq('task_type', 'medication')
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59');

          if (!logsError && logs) {
            todaySummary.medicationsTaken = logs.length;
          }

        } catch (error) {
          console.error('Error loading medications:', error);
        }
      }

      // Load water data from localStorage
      const waterData = JSON.parse(localStorage.getItem(`water_${today}`) || '{"total": 0}');
      todaySummary.waterAmount = waterData.total || 0;

      // Load vitals data from localStorage
      const vitalsData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
      if (vitalsData.readings && vitalsData.readings.length > 0) {
        const latest = vitalsData.readings[0];
        todaySummary.latestVitals = `${latest.systolic}/${latest.diastolic}`;
      }

      // Update UI
      updateSummaryUI();
    }

    function updateSummaryUI() {
      // Medication summary
      const medEl = document.getElementById('medSummary');
      if (todaySummary.medicationsTotal > 0) {
        medEl.textContent = `${todaySummary.medicationsTaken}/${todaySummary.medicationsTotal}`;
        if (todaySummary.medicationsTaken >= todaySummary.medicationsTotal) {
          medEl.classList.add('complete');
          medEl.classList.remove('incomplete');
        } else {
          medEl.classList.add('incomplete');
          medEl.classList.remove('complete');
        }
      } else {
        medEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤';
        medEl.style.fontSize = '14px';
      }

      // Water summary
      const waterEl = document.getElementById('waterSummary');
      waterEl.textContent = `${todaySummary.waterAmount} ml`;
      if (todaySummary.waterAmount >= 2000) {
        waterEl.classList.add('complete');
      }

      // Vitals summary
      const vitalsEl = document.getElementById('vitalsSummary');
      if (todaySummary.latestVitals) {
        vitalsEl.textContent = todaySummary.latestVitals;
      } else {
        vitalsEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡∏±‡∏î';
        vitalsEl.style.fontSize = '14px';
      }

      // Symptom summary
      const symptomEl = document.getElementById('symptomSummary');
      if (todaySummary.symptoms && todaySummary.symptoms.length > 0) {
        symptomEl.textContent = `${todaySummary.symptoms.length} ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£`;
        symptomEl.classList.add('incomplete');
      } else {
        symptomEl.textContent = '‡∏õ‡∏Å‡∏ï‡∏¥';
        symptomEl.classList.add('complete');
      }
    }

    // Quick log all medications
    async function quickLogMedication() {
      if (!patientId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      if (medications.length === 0) {
        showToast('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤', 'error');
        return;
      }

      // Determine current time period
      const hour = new Date().getHours();
      let currentPeriod = 'morning';
      if (hour >= 11 && hour < 14) currentPeriod = 'afternoon';
      else if (hour >= 16 && hour < 20) currentPeriod = 'evening';
      else if (hour >= 20 || hour < 6) currentPeriod = 'night';

      try {
        const medsForPeriod = medications.filter(med => {
          const times = med.times || [];
          return times.includes(currentPeriod);
        });

        if (medsForPeriod.length === 0) {
          showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ', 'error');
          return;
        }

        // Log each medication
        const logs = medsForPeriod.map(med => ({
          patient_id: patientId,
          task_type: 'medication',
          metadata: {
            medication_id: med.id,
            time_period: currentPeriod,
            logged_at: new Date().toISOString()
          }
        }));

        const { error } = await supabase
          .from('activity_logs')
          .insert(logs);

        if (error) throw error;

        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ${medsForPeriod.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
        todaySummary.medicationsTaken += medsForPeriod.length;
        updateSummaryUI();

      } catch (error) {
        console.error('Error logging medications:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    function openMedications() {
      window.location.href = 'medications.html';
    }

    function viewReports() {
      // Send message to LINE chat to request report
      if (liff.isInClient()) {
        liff.sendMessages([{
          type: 'text',
          text: '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'
        }]).then(() => {
          liff.closeWindow();
        }).catch(err => {
          console.error('Error sending message:', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ', 'error');
        });
      } else {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE', 'error');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function closeLiff() {
      liff.closeWindow();
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
