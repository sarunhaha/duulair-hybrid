<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f8fafc">
  <title>บันทึกสุขภาพ - OONJAI</title>

  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <!-- External Scripts -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/lucide-icons.js"></script>

  <style>
    /* Page-specific styles */
    .hero-card {
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(190 85% 28%) 100%);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: var(--spacing-lg);
    }

    .hero-card::before {
      content: '';
      position: absolute;
      top: -4rem;
      right: -4rem;
      width: 10rem;
      height: 10rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-full);
      filter: blur(2rem);
    }

    .hero-card h1 {
      color: white;
      font-size: 1.5rem;
      margin-bottom: var(--spacing-xs);
      position: relative;
    }

    .hero-date {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    /* Summary Section */
    .summary-section {
      background: hsl(var(--muted) / 0.3);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .summary-label {
      font-size: 0.6875rem;
      font-weight: 700;
      color: hsl(var(--muted-foreground));
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .summary-card {
      background: hsl(var(--card));
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      border-left: 4px solid transparent;
    }

    .summary-card.medication { border-left-color: hsl(0 84% 60%); }
    .summary-card.water { border-left-color: hsl(217 91% 60%); }
    .summary-card.vitals { border-left-color: hsl(var(--success)); }
    .summary-card.symptom { border-left-color: hsl(var(--accent)); }

    .summary-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .summary-icon.medication { background: linear-gradient(135deg, hsl(0 93% 94%) 0%, hsl(0 96% 89%) 100%); color: hsl(0 72% 51%); }
    .summary-icon.water { background: linear-gradient(135deg, hsl(217 91% 95%) 0%, hsl(217 91% 90%) 100%); color: hsl(217 91% 60%); }
    .summary-icon.vitals { background: linear-gradient(135deg, hsl(142 76% 94%) 0%, hsl(142 76% 86%) 100%); color: hsl(var(--success)); }
    .summary-icon.symptom { background: linear-gradient(135deg, hsl(38 92% 95%) 0%, hsl(38 92% 87%) 100%); color: hsl(var(--accent)); }

    .summary-info .label {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      font-weight: 500;
    }

    .summary-info .value {
      font-size: 1.125rem;
      font-weight: 700;
      color: hsl(var(--foreground));
    }

    .summary-info .value.incomplete { color: hsl(var(--accent)); }
    .summary-info .value.complete { color: hsl(var(--success)); }

    /* Category Grid */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .category-btn {
      background: hsl(var(--card));
      border: 2px solid transparent;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .category-btn:active {
      transform: scale(0.97);
      border-color: hsl(var(--primary));
      box-shadow: var(--shadow-md);
    }

    .category-btn .cat-icon {
      width: 3rem;
      height: 3rem;
      margin: 0 auto var(--spacing-sm);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .category-btn .cat-icon.medication { background: hsl(0 93% 94%); color: hsl(0 72% 51%); }
    .category-btn .cat-icon.vitals { background: hsl(142 76% 94%); color: hsl(var(--success)); }
    .category-btn .cat-icon.water { background: hsl(217 91% 95%); color: hsl(217 91% 60%); }
    .category-btn .cat-icon.symptom { background: hsl(38 92% 95%); color: hsl(var(--accent)); }

    .category-btn .cat-label {
      font-size: 0.9375rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      display: block;
      margin-bottom: 0.125rem;
    }

    .category-btn .cat-desc {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    /* Quick Actions */
    .quick-actions {
      background: hsl(var(--card));
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .quick-btn {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: hsl(var(--muted) / 0.3);
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      text-align: left;
      margin-bottom: var(--spacing-sm);
    }

    .quick-btn:last-child {
      margin-bottom: 0;
    }

    .quick-btn:active {
      transform: scale(0.98);
      background: hsl(var(--secondary));
    }

    .quick-btn .q-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(var(--card));
      flex-shrink: 0;
      color: hsl(var(--success));
    }

    .quick-btn .q-text {
      flex: 1;
    }

    .quick-btn .q-text .label {
      font-size: 0.9375rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      display: block;
    }

    .quick-btn .q-text .desc {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    .quick-btn .q-arrow {
      color: hsl(var(--muted-foreground));
    }

    /* History Section */
    .history-section {
      background: hsl(var(--card));
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .history-title {
      font-size: 1rem;
      font-weight: 700;
      color: hsl(var(--foreground));
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .history-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: none;
      border: none;
      color: hsl(var(--accent));
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      transition: background 0.2s;
    }

    .history-toggle:active {
      background: hsl(var(--accent) / 0.1);
    }

    .history-toggle.expanded .toggle-arrow {
      transform: rotate(180deg);
    }

    .history-day-header {
      font-size: 0.8125rem;
      font-weight: 600;
      color: hsl(var(--muted-foreground));
      margin-bottom: var(--spacing-sm);
      padding-bottom: var(--spacing-xs);
      border-bottom: 1px solid hsl(var(--border));
    }

    .history-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: hsl(var(--muted) / 0.2);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xs);
    }

    .history-icon {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .history-icon.medication { background: hsl(0 93% 94%); color: hsl(0 72% 51%); }
    .history-icon.water { background: hsl(217 91% 95%); color: hsl(217 91% 60%); }
    .history-icon.vitals { background: hsl(142 76% 94%); color: hsl(var(--success)); }
    .history-icon.symptom { background: hsl(38 92% 95%); color: hsl(var(--accent)); }
    .history-icon.exercise { background: hsl(263 70% 95%); color: hsl(263 70% 50%); }
    .history-icon.sleep { background: hsl(230 70% 95%); color: hsl(230 70% 50%); }
    .history-icon.mood { background: hsl(45 93% 94%); color: hsl(45 93% 40%); }
    .history-icon.food { background: hsl(330 81% 95%); color: hsl(330 81% 60%); }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-text {
      font-size: 0.875rem;
      color: hsl(var(--foreground));
      margin-bottom: 0.125rem;
    }

    .history-time {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    .history-actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .history-action-btn {
      width: 2rem;
      height: 2rem;
      border: none;
      border-radius: var(--radius-md);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .history-action-btn.edit {
      color: hsl(var(--primary));
    }

    .history-action-btn.edit:active {
      background: hsl(var(--primary) / 0.1);
    }

    .history-action-btn.delete {
      color: hsl(var(--destructive));
    }

    .history-action-btn.delete:active {
      background: hsl(var(--destructive) / 0.1);
    }

    .history-expanded {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px dashed hsl(var(--border));
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: hsl(var(--card));
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid hsl(var(--border));
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      width: 2rem;
      height: 2rem;
      border: none;
      background: hsl(var(--muted));
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: hsl(var(--muted-foreground));
    }

    .modal-close:active {
      background: hsl(var(--muted-foreground) / 0.2);
    }

    .modal-body {
      padding: var(--spacing-lg);
    }

    .modal-footer {
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid hsl(var(--border));
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
    }

    /* Close button at bottom */
    .close-section {
      padding: var(--spacing-md) 0 var(--spacing-xl);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden animate-fadeIn">
      <!-- Hero Header -->
      <div class="hero-card">
        <h1>
          <span id="heroIcon"></span>
          บันทึกสุขภาพวันนี้
        </h1>
        <div class="hero-date" id="currentDate"></div>
      </div>

      <!-- Today's Summary -->
      <div class="summary-section">
        <div class="summary-label">
          <span id="chartIcon"></span>
          สรุปวันนี้
        </div>
        <div class="summary-grid">
          <div class="summary-card medication">
            <div class="summary-icon medication" id="medIcon"></div>
            <div class="summary-info">
              <div class="label">กินยา</div>
              <div class="value" id="medSummary">-/-</div>
            </div>
          </div>
          <div class="summary-card water">
            <div class="summary-icon water" id="waterIcon"></div>
            <div class="summary-info">
              <div class="label">ดื่มน้ำ</div>
              <div class="value" id="waterSummary">0 ml</div>
            </div>
          </div>
          <div class="summary-card vitals">
            <div class="summary-icon vitals" id="vitalsIcon"></div>
            <div class="summary-info">
              <div class="label">วัดความดัน</div>
              <div class="value" id="vitalsSummary">-</div>
            </div>
          </div>
          <div class="summary-card symptom">
            <div class="summary-icon symptom" id="symptomIcon"></div>
            <div class="summary-info">
              <div class="label">อาการ</div>
              <div class="value" id="symptomSummary">ปกติ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Section -->
      <div class="section-header">
        <h3 class="section-title">เลือกหมวดที่ต้องการบันทึก</h3>
      </div>
      <div class="category-grid">
        <button class="category-btn" onclick="navigateTo('log-medication.html')">
          <div class="cat-icon medication" id="catMedIcon"></div>
          <span class="cat-label">กินยา</span>
          <span class="cat-desc">บันทึกการกินยา</span>
        </button>
        <button class="category-btn" onclick="navigateTo('vitals-tracking.html')">
          <div class="cat-icon vitals" id="catVitalsIcon"></div>
          <span class="cat-label">ความดัน</span>
          <span class="cat-desc">วัดค่าความดันโลหิต</span>
        </button>
        <button class="category-btn" onclick="navigateTo('water-tracking.html')">
          <div class="cat-icon water" id="catWaterIcon"></div>
          <span class="cat-label">ดื่มน้ำ</span>
          <span class="cat-desc">ติดตามการดื่มน้ำ</span>
        </button>
        <button class="category-btn" onclick="navigateTo('log-symptom.html')">
          <div class="cat-icon symptom" id="catSymptomIcon"></div>
          <span class="cat-label">อาการ</span>
          <span class="cat-desc">บันทึกอาการผิดปกติ</span>
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="section-header mb-4">
          <h3 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="zapIcon"></span>
            ทางลัด
          </h3>
        </div>
        <button class="quick-btn" onclick="quickLogMedication()">
          <div class="q-icon" id="checkIcon"></div>
          <div class="q-text">
            <span class="label">กินยาครบแล้ว</span>
            <span class="desc">บันทึกว่ากินยาตามที่กำหนดทั้งหมดแล้ว</span>
          </div>
          <div class="q-arrow" id="chevronRight1"></div>
        </button>
        <button class="quick-btn" onclick="openMedications()">
          <div class="q-icon" id="listIcon" style="color: hsl(var(--primary))"></div>
          <div class="q-text">
            <span class="label">จัดการรายการยา</span>
            <span class="desc">เพิ่ม แก้ไข หรือลบรายการยา</span>
          </div>
          <div class="q-arrow" id="chevronRight2"></div>
        </button>
      </div>

      <!-- Activity History -->
      <div class="history-section">
        <div class="history-header">
          <div class="history-title">
            <span id="historyIcon"></span>
            ประวัติกิจกรรม
          </div>
          <button class="history-toggle" onclick="toggleHistory()">
            <span id="historyToggleText">ดูเพิ่มเติม</span>
            <span class="toggle-arrow" id="historyArrow"></span>
          </button>
        </div>
        <div id="historyList" class="space-y-3">
          <div class="text-center text-muted p-4">กำลังโหลด...</div>
        </div>
        <div id="historyExpanded" class="history-expanded hidden">
          <!-- More history items will be loaded here -->
        </div>
      </div>

      <!-- Close Button -->
      <div class="close-section">
        <button class="btn btn-secondary btn-block" onclick="closeLiff()">
          <span id="closeIcon"></span>
          ปิด
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Edit Activity Modal -->
  <div id="editModal" class="modal-overlay" onclick="closeEditModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span id="editModalTitle">แก้ไขกิจกรรม</span>
        <button class="modal-close" onclick="closeEditModal()">
          <span id="modalCloseIcon"></span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editActivityId">
        <input type="hidden" id="editActivityTable">
        <input type="hidden" id="editActivityType">

        <!-- Medication Form -->
        <div id="editFormMedication" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label class="form-label">ชื่อยา</label>
            <input type="text" class="form-input" id="editMedName" placeholder="ชื่อยา">
          </div>
          <div class="form-group">
            <label class="form-label">เวลากิน</label>
            <select class="form-select" id="editMedTime">
              <option value="morning">เช้า</option>
              <option value="noon">กลางวัน</option>
              <option value="evening">เย็น</option>
              <option value="night">ก่อนนอน</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-textarea" id="editMedNotes" rows="2" placeholder="หมายเหตุเพิ่มเติม"></textarea>
          </div>
        </div>

        <!-- Vitals Form -->
        <div id="editFormVitals" class="edit-form-section" style="display: none;">
          <div id="editVitalsBP" style="display: none;">
            <div style="display: flex; gap: 0.625rem;">
              <div class="form-group" style="flex: 1;">
                <label class="form-label">ค่าบน (Systolic)</label>
                <input type="number" class="form-input" id="editBpSystolic" placeholder="120">
              </div>
              <div class="form-group" style="flex: 1;">
                <label class="form-label">ค่าล่าง (Diastolic)</label>
                <input type="number" class="form-input" id="editBpDiastolic" placeholder="80">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ชีพจร (ครั้ง/นาที)</label>
              <input type="number" class="form-input" id="editPulse" placeholder="72">
            </div>
          </div>
          <div id="editVitalsOther" style="display: none;">
            <div class="form-group">
              <label class="form-label" id="editVitalsOtherLabel">ค่า</label>
              <input type="number" class="form-input" id="editVitalsOtherValue" step="0.1">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-textarea" id="editVitalsNotes" rows="2" placeholder="หมายเหตุเพิ่มเติม"></textarea>
          </div>
        </div>

        <!-- Water Form -->
        <div id="editFormWater" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label class="form-label">ปริมาณน้ำ</label>
            <div style="display: flex; gap: 0.625rem; align-items: center;">
              <input type="number" class="form-input" id="editWaterAmount" placeholder="250" style="flex: 1;">
              <select class="form-select" id="editWaterUnit" style="width: 5rem;">
                <option value="ml">ml</option>
                <option value="glass">แก้ว</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-textarea" id="editWaterNotes" rows="2" placeholder="หมายเหตุเพิ่มเติม"></textarea>
          </div>
        </div>

        <!-- Symptom Form -->
        <div id="editFormSymptom" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label class="form-label">อาการ</label>
            <input type="text" class="form-input" id="editSymptomName" placeholder="ชื่ออาการ">
          </div>
          <div class="form-group">
            <label class="form-label">ระดับความรุนแรง</label>
            <select class="form-select" id="editSymptomSeverity">
              <option value="1">1 - เล็กน้อย</option>
              <option value="2">2 - เล็กน้อย-ปานกลาง</option>
              <option value="3">3 - ปานกลาง</option>
              <option value="4">4 - ปานกลาง-รุนแรง</option>
              <option value="5">5 - รุนแรง</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ตำแหน่ง/บริเวณ</label>
            <input type="text" class="form-input" id="editSymptomLocation" placeholder="เช่น ท้อง, หัว, หน้าอก">
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-textarea" id="editSymptomNotes" rows="2" placeholder="รายละเอียดเพิ่มเติม"></textarea>
          </div>
        </div>

        <!-- Generic Form -->
        <div id="editFormGeneric" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label class="form-label">ประเภท</label>
            <input type="text" class="form-input" id="editTypeDisplay" readonly style="background: hsl(var(--muted));">
          </div>
          <div class="form-group">
            <label class="form-label" id="editGenericLabel">ค่า</label>
            <input type="text" class="form-input" id="editGenericValue" placeholder="กรอกค่า">
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-textarea" id="editGenericNotes" rows="2" placeholder="หมายเหตุเพิ่มเติม"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" onclick="closeEditModal()">ยกเลิก</button>
        <button class="btn btn-teal btn-sm" onclick="saveActivityEdit()">บันทึก</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay" onclick="closeDeleteModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span>ยืนยันการลบ</span>
        <button class="modal-close" onclick="closeDeleteModal()">
          <span id="deleteCloseIcon"></span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteActivityId">
        <input type="hidden" id="deleteActivityTable">
        <p class="text-center mb-4">คุณต้องการลบรายการนี้หรือไม่?</p>
        <div id="deleteActivityPreview" style="background: hsl(var(--muted)); padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" onclick="closeDeleteModal()">ยกเลิก</button>
        <button class="btn btn-sm" style="background: hsl(var(--destructive)); color: white;" onclick="confirmDelete()">ลบ</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // ICON INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Hero & Summary icons
      document.getElementById('heroIcon').innerHTML = icon('stethoscope', 'lucide-lg');
      document.getElementById('chartIcon').innerHTML = icon('barChart', 'lucide-sm');
      document.getElementById('medIcon').innerHTML = icon('pill');
      document.getElementById('waterIcon').innerHTML = icon('droplet');
      document.getElementById('vitalsIcon').innerHTML = icon('heartPulse');
      document.getElementById('symptomIcon').innerHTML = icon('thermometer');

      // Category icons
      document.getElementById('catMedIcon').innerHTML = icon('pill', 'lucide-lg');
      document.getElementById('catVitalsIcon').innerHTML = icon('heartPulse', 'lucide-lg');
      document.getElementById('catWaterIcon').innerHTML = icon('droplet', 'lucide-lg');
      document.getElementById('catSymptomIcon').innerHTML = icon('thermometer', 'lucide-lg');

      // Quick action icons
      document.getElementById('zapIcon').innerHTML = icon('zap');
      document.getElementById('checkIcon').innerHTML = icon('checkCircle');
      document.getElementById('listIcon').innerHTML = icon('fileText');
      document.getElementById('chevronRight1').innerHTML = icon('chevronRight');
      document.getElementById('chevronRight2').innerHTML = icon('chevronRight');

      // History icons
      document.getElementById('historyIcon').innerHTML = icon('clock');
      document.getElementById('historyArrow').innerHTML = icon('chevronRight', 'lucide-sm');

      // Close icon
      document.getElementById('closeIcon').innerHTML = icon('x', 'lucide-sm');

      // Modal close icons
      document.getElementById('modalCloseIcon').innerHTML = icon('x', 'lucide-sm');
      document.getElementById('deleteCloseIcon').innerHTML = icon('x', 'lucide-sm');
    });

    // ============================================
    // CONFIGURATION
    // ============================================
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : 'https://duulair.vercel.app/api';

    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';

    let supabaseClient = null;
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let patientId = null;
    let groupId = null;
    let medications = [];
    let todaySummary = {
      medicationsTaken: 0,
      medicationsTotal: 0,
      waterAmount: 0,
      latestVitals: null,
      symptoms: []
    };

    // ============================================
    // SHOW UI IMMEDIATELY WITH CACHED DATA
    // ============================================
    (function showUIImmediately() {
      document.getElementById('currentDate').textContent = formatThaiDate(new Date());

      const today = new Date().toISOString().split('T')[0];
      const cachedSummary = localStorage.getItem(`health_summary_${today}`);
      if (cachedSummary) {
        try {
          todaySummary = JSON.parse(cachedSummary);
          updateSummaryUI();
        } catch (e) {}
      }

      const waterData = JSON.parse(localStorage.getItem(`water_${today}`) || '{"total": 0}');
      todaySummary.waterAmount = waterData.total || 0;

      const vitalsData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
      if (vitalsData.readings && vitalsData.readings.length > 0) {
        const latest = vitalsData.readings[0];
        todaySummary.latestVitals = `${latest.systolic}/${latest.diastolic}`;
      }

      updateSummaryUI();

      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    function formatThaiDate(date) {
      const thaiMonths = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      const thaiDays = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];

      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      const dayName = thaiDays[date.getDay()];

      return `วัน${dayName}ที่ ${day} ${month} ${year}`;
    }

    // ============================================
    // LIFF INITIALIZATION
    // ============================================
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    async function checkUserRegistration(lineUserId) {
      const cached = sessionStorage.getItem('user_registered');
      if (cached === 'true') return true;

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (result.exists) {
          sessionStorage.setItem('user_registered', 'true');
          return true;
        } else {
          window.location.href = '/liff/index.html';
          return false;
        }
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const context = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = context.patientId;
        groupId = context.groupId;

        const profile = await getCachedProfile();

        if (!patientId && profile?.userId) {
          console.log('Fetching patientId from server...');
          try {
            const response = await fetch(`${API_BASE_URL}/check-user/${profile.userId}`);
            const result = await response.json();
            if (result.exists && result.profile?.linked_patient_id) {
              patientId = result.profile.linked_patient_id;
              context.patientId = patientId;
              localStorage.setItem('oonjai_context', JSON.stringify(context));
            }
          } catch (e) {
            console.error('Failed to fetch patientId:', e);
          }
        }

        await Promise.all([
          loadTodaySummary(),
          loadActivityHistory()
        ]);

        checkUserRegistration(profile.userId).catch(e => console.error('Reg check:', e));

        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(`health_summary_${today}`, JSON.stringify(todaySummary));

      } catch (error) {
        console.error('LIFF init error:', error);
      }
    }

    // ============================================
    // DATA LOADING
    // ============================================
    async function loadTodaySummary() {
      const today = new Date().toISOString().split('T')[0];

      if (patientId && supabaseClient) {
        try {
          // Load medications
          const { data: meds, error } = await supabaseClient
            .from('medications')
            .select('id, medication_name, times')
            .eq('patient_id', patientId)
            .eq('active', true);

          if (!error && meds) {
            let totalDoses = 0;
            meds.forEach(med => {
              const times = med.times || [];
              totalDoses += times.length;
            });
            todaySummary.medicationsTotal = totalDoses;
            medications = meds;
          }

          // Get today's medication logs from medication_logs table
          const { data: medLogs, error: medLogsError } = await supabaseClient
            .from('medication_logs')
            .select('id')
            .eq('patient_id', patientId)
            .gte('taken_at', today + 'T00:00:00')
            .lt('taken_at', today + 'T23:59:59');

          if (!medLogsError && medLogs) {
            todaySummary.medicationsTaken = medLogs.length;
          }

        } catch (error) {
          console.error('Error loading medications:', error);
        }
      }

      // Water data
      const waterData = JSON.parse(localStorage.getItem(`water_${today}`) || '{"total": 0}');
      todaySummary.waterAmount = waterData.total || 0;

      if (patientId && supabaseClient) {
        try {
          const { data: waterLogs, error: waterError } = await supabaseClient
            .from('water_logs')
            .select('amount_ml')
            .eq('patient_id', patientId)
            .eq('log_date', today);

          if (!waterError && waterLogs && waterLogs.length > 0) {
            let totalWater = 0;
            waterLogs.forEach(log => {
              totalWater += (log.amount_ml || 0);
            });
            if (totalWater > todaySummary.waterAmount) {
              todaySummary.waterAmount = totalWater;
            }
          }
        } catch (e) {
          console.error('Error loading water:', e);
        }
      }

      // Vitals data
      if (patientId && supabaseClient) {
        try {
          const { data: vitals, error: vitalsError } = await supabaseClient
            .from('vitals_logs')
            .select('bp_systolic, bp_diastolic, heart_rate, glucose, temperature, measured_at')
            .eq('patient_id', patientId)
            .gte('measured_at', today + 'T00:00:00')
            .lt('measured_at', today + 'T23:59:59')
            .order('measured_at', { ascending: false })
            .limit(1);

          if (!vitalsError && vitals && vitals.length > 0) {
            const latest = vitals[0];
            if (latest.bp_systolic && latest.bp_diastolic) {
              todaySummary.latestVitals = `${latest.bp_systolic}/${latest.bp_diastolic}`;
            } else if (latest.glucose) {
              todaySummary.latestVitals = `${latest.glucose} mg/dL`;
            } else if (latest.temperature) {
              todaySummary.latestVitals = `${latest.temperature}°C`;
            }
          }
        } catch (e) {
          console.error('Error loading vitals:', e);
        }
      }

      if (!todaySummary.latestVitals) {
        const vitalsData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
        if (vitalsData.readings && vitalsData.readings.length > 0) {
          const latest = vitalsData.readings[0];
          todaySummary.latestVitals = `${latest.systolic}/${latest.diastolic}`;
        }
      }

      // Symptoms
      if (patientId && supabaseClient) {
        try {
          const { data: symptoms, error: symptomsError } = await supabaseClient
            .from('symptoms')
            .select('id, symptom_name')
            .eq('patient_id', patientId)
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59');

          if (!symptomsError && symptoms) {
            todaySummary.symptoms = symptoms;
          }
        } catch (e) {
          console.error('Error loading symptoms:', e);
        }
      }

      updateSummaryUI();
    }

    function updateSummaryUI() {
      const medEl = document.getElementById('medSummary');
      if (todaySummary.medicationsTotal > 0) {
        medEl.textContent = `${todaySummary.medicationsTaken}/${todaySummary.medicationsTotal}`;
        if (todaySummary.medicationsTaken >= todaySummary.medicationsTotal) {
          medEl.classList.add('complete');
          medEl.classList.remove('incomplete');
        } else {
          medEl.classList.add('incomplete');
          medEl.classList.remove('complete');
        }
      } else {
        medEl.textContent = 'ไม่มียา';
        medEl.style.fontSize = '0.875rem';
      }

      const waterEl = document.getElementById('waterSummary');
      waterEl.textContent = `${todaySummary.waterAmount} ml`;
      if (todaySummary.waterAmount >= 2000) {
        waterEl.classList.add('complete');
      }

      const vitalsEl = document.getElementById('vitalsSummary');
      if (todaySummary.latestVitals) {
        vitalsEl.textContent = todaySummary.latestVitals;
      } else {
        vitalsEl.textContent = 'ยังไม่วัด';
        vitalsEl.style.fontSize = '0.875rem';
      }

      const symptomEl = document.getElementById('symptomSummary');
      if (todaySummary.symptoms && todaySummary.symptoms.length > 0) {
        symptomEl.textContent = `${todaySummary.symptoms.length} อาการ`;
        symptomEl.classList.add('incomplete');
      } else {
        symptomEl.textContent = 'ปกติ';
        symptomEl.classList.add('complete');
      }
    }

    // ============================================
    // QUICK ACTIONS
    // ============================================
    async function quickLogMedication() {
      if (!patientId) {
        showToast('กรุณาลงทะเบียนก่อน', 'error');
        return;
      }

      if (medications.length === 0) {
        showToast('คุณยังไม่มีรายการยา', 'error');
        return;
      }

      const hour = new Date().getHours();
      let currentPeriod = 'morning';
      if (hour >= 11 && hour < 14) currentPeriod = 'afternoon';
      else if (hour >= 16 && hour < 20) currentPeriod = 'evening';
      else if (hour >= 20 || hour < 6) currentPeriod = 'night';

      try {
        const medsForPeriod = medications.filter(med => {
          const times = med.times || [];
          return times.includes(currentPeriod);
        });

        if (medsForPeriod.length === 0) {
          showToast('ไม่มียาที่ต้องกินในช่วงนี้', 'error');
          return;
        }

        const now = new Date().toISOString();
        const medLogs = medsForPeriod.map(med => ({
          patient_id: patientId,
          medication_id: med.id,
          medication_name: med.medication_name || null,
          taken_at: now,
          status: 'taken'
        }));

        const { error } = await supabaseClient.from('medication_logs').insert(medLogs);

        if (error) throw error;

        showToast(`บันทึกกินยา ${medsForPeriod.length} รายการเรียบร้อย`, 'success');
        todaySummary.medicationsTaken += medsForPeriod.length;
        updateSummaryUI();

      } catch (error) {
        console.error('Error logging medications:', error);
        showToast('เกิดข้อผิดพลาด', 'error');
      }
    }

    function navigateTo(page) {
      sessionStorage.setItem('liff_return_to', 'health-log.html');
      const basePath = window.location.pathname.replace(/[^/]*$/, '');
      window.location.href = basePath + page;
    }

    function openMedications() {
      navigateTo('medications.html');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function closeLiff() {
      liff.closeWindow();
    }

    // ============================================
    // ACTIVITY HISTORY
    // ============================================
    let activityHistory = [];
    let historyExpanded = false;

    async function loadActivityHistory() {
      if (!patientId || !supabaseClient) {
        document.getElementById('historyList').innerHTML = '<div class="empty-state"><p class="empty-description">ไม่พบข้อมูล</p></div>';
        return;
      }

      try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const startDate = sevenDaysAgo.toISOString();
        const startDateOnly = startDate.split('T')[0];

        // Query all dedicated tables in parallel
        const [
          medResult,
          waterResult,
          vitalsResult,
          symptomsResult,
          exerciseResult,
          sleepResult,
          moodResult,
          activityResult
        ] = await Promise.all([
          // Medication logs
          supabaseClient
            .from('medication_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('taken_at', startDate)
            .order('taken_at', { ascending: false })
            .limit(20),
          // Water logs
          supabaseClient
            .from('water_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('log_date', startDateOnly)
            .order('created_at', { ascending: false })
            .limit(20),
          // Vitals logs
          supabaseClient
            .from('vitals_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('measured_at', startDate)
            .order('measured_at', { ascending: false })
            .limit(20),
          // Symptoms
          supabaseClient
            .from('symptoms')
            .select('*')
            .eq('patient_id', patientId)
            .gte('created_at', startDate)
            .order('created_at', { ascending: false })
            .limit(20),
          // Exercise logs
          supabaseClient
            .from('exercise_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('exercise_date', startDateOnly)
            .order('created_at', { ascending: false })
            .limit(20),
          // Sleep logs
          supabaseClient
            .from('sleep_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('sleep_date', startDateOnly)
            .order('created_at', { ascending: false })
            .limit(20),
          // Mood logs
          supabaseClient
            .from('mood_logs')
            .select('*')
            .eq('patient_id', patientId)
            .gte('timestamp', startDate)
            .order('timestamp', { ascending: false })
            .limit(20),
          // Activity logs (only for types without dedicated tables: exercise/walk/food)
          supabaseClient
            .from('activity_logs')
            .select('*')
            .eq('patient_id', patientId)
            .in('task_type', ['exercise', 'walk', 'food'])
            .gte('created_at', startDate)
            .order('created_at', { ascending: false })
            .limit(20)
        ]);

        activityHistory = [];

        // Medication logs
        if (medResult.data) {
          medResult.data.forEach(log => {
            const name = log.medication_name || 'ยา';
            const status = log.status === 'skipped' ? 'ข้าม' : 'ทานแล้ว';
            activityHistory.push({
              id: log.id,
              table: 'medication_logs',
              type: 'medication',
              text: `กินยา ${name} (${status})`,
              timestamp: new Date(log.taken_at || log.created_at),
              iconName: 'pill',
              rawData: log
            });
          });
        }

        // Water logs
        if (waterResult.data) {
          waterResult.data.forEach(log => {
            activityHistory.push({
              id: log.id,
              table: 'water_logs',
              type: 'water',
              text: `ดื่มน้ำ ${log.amount_ml} ml`,
              timestamp: new Date(log.created_at || log.logged_at),
              iconName: 'droplet',
              rawData: log
            });
          });
        }

        // Vitals logs
        if (vitalsResult.data) {
          vitalsResult.data.forEach(v => {
            let text = '';
            const systolic = v.bp_systolic || v.systolic;
            const diastolic = v.bp_diastolic || v.diastolic;
            const pulse = v.heart_rate || v.pulse;
            const bloodSugar = v.glucose || v.blood_sugar;
            const temp = v.temperature;
            const timestamp = v.created_at || v.measured_at;

            if (systolic && diastolic) {
              text = `วัดความดัน ${systolic}/${diastolic} mmHg`;
              if (pulse) text += ` ชีพจร ${pulse}`;
            } else if (pulse && !systolic) {
              text = `ชีพจร ${pulse} bpm`;
            } else if (bloodSugar) {
              text = `น้ำตาล ${bloodSugar} mg/dL`;
            } else if (temp) {
              text = `อุณหภูมิ ${temp}°C`;
            }

            if (text) {
              activityHistory.push({
                id: v.id,
                table: 'vitals_logs',
                type: 'vitals',
                text,
                timestamp: new Date(timestamp),
                iconName: 'heartPulse',
                rawData: v
              });
            }
          });
        }

        // Symptoms
        if (symptomsResult.data) {
          symptomsResult.data.forEach(s => {
            const severityText = s.severity_1to5 ?
              (s.severity_1to5 <= 2 ? 'เล็กน้อย' : s.severity_1to5 <= 3 ? 'ปานกลาง' : 'รุนแรง') : '';
            const symptomName = s.symptom_name || s.symptom || 'อาการ';
            activityHistory.push({
              id: s.id,
              table: 'symptoms',
              type: 'symptom',
              text: severityText ? `${symptomName} (${severityText})` : symptomName,
              timestamp: new Date(s.created_at),
              iconName: 'thermometer',
              rawData: s
            });
          });
        }

        // Exercise logs
        if (exerciseResult.data) {
          exerciseResult.data.forEach(e => {
            const exerciseType = e.exercise_type || 'ออกกำลังกาย';
            const duration = e.duration_minutes ? ` ${e.duration_minutes} นาที` : '';
            activityHistory.push({
              id: e.id,
              table: 'exercise_logs',
              type: 'exercise',
              text: `${exerciseType}${duration}`,
              timestamp: new Date(e.created_at),
              iconName: 'dumbbell',
              rawData: e
            });
          });
        }

        // Sleep logs
        if (sleepResult.data) {
          sleepResult.data.forEach(s => {
            const hours = s.sleep_hours ? `${s.sleep_hours} ชม.` : '';
            const quality = s.sleep_quality ? ` (${s.sleep_quality})` : '';
            activityHistory.push({
              id: s.id,
              table: 'sleep_logs',
              type: 'sleep',
              text: `นอน ${hours}${quality}`,
              timestamp: new Date(s.created_at),
              iconName: 'moon',
              rawData: s
            });
          });
        }

        // Mood logs
        if (moodResult.data) {
          moodResult.data.forEach(m => {
            const moodLabels = {
              happy: 'มีความสุข', neutral: 'ปกติ', tired: 'เหนื่อย',
              sad: 'เศร้า', anxious: 'กังวล', exhausted: 'อ่อนเพลีย',
              stressed: 'เครียด', calm: 'สงบ', excited: 'ตื่นเต้น'
            };
            const moodText = moodLabels[m.mood] || m.mood || 'อารมณ์';
            activityHistory.push({
              id: m.id,
              table: 'mood_logs',
              type: 'mood',
              text: `อารมณ์: ${moodText}`,
              timestamp: new Date(m.timestamp || m.created_at),
              iconName: 'smile',
              rawData: m
            });
          });
        }

        // Activity logs (only exercise/walk/food that don't have dedicated tables yet)
        if (activityResult.data) {
          activityResult.data.forEach(log => {
            activityHistory.push({
              id: log.id,
              table: 'activity_logs',
              type: log.task_type || 'activity',
              text: formatActivityText(log),
              timestamp: new Date(log.created_at),
              iconName: getActivityIconName(log.task_type),
              rawData: log
            });
          });
        }

        activityHistory.sort((a, b) => b.timestamp - a.timestamp);
        renderActivityHistory();

      } catch (error) {
        console.error('Error loading activity history:', error);
        document.getElementById('historyList').innerHTML = '<div class="empty-state"><p class="empty-description">ไม่สามารถโหลดข้อมูลได้</p></div>';
      }
    }

    function formatActivityText(log) {
      const type = log.task_type;
      const meta = log.metadata || {};

      switch (type) {
        case 'medication':
          return meta.medication_name ? `กินยา ${meta.medication_name}` : 'กินยาแล้ว';
        case 'water':
          const amount = meta.amount || log.value || 0;
          return `ดื่มน้ำ ${amount} ml`;
        case 'exercise':
        case 'walk':
          const duration = meta.duration || log.value || 0;
          return `ออกกำลังกาย ${duration} นาที`;
        case 'food':
          return meta.meal || 'กินอาหาร';
        default:
          return log.notes || type || 'กิจกรรม';
      }
    }

    function getActivityIconName(type) {
      const icons = {
        medication: 'pill',
        water: 'droplet',
        vitals: 'heartPulse',
        symptom: 'thermometer',
        exercise: 'dumbbell',
        walk: 'footprints',
        food: 'utensils',
        sleep: 'moon',
        mood: 'smile'
      };
      return icons[type] || 'fileText';
    }

    function renderActivityHistory() {
      const historyList = document.getElementById('historyList');
      const historyExpandedEl = document.getElementById('historyExpanded');

      if (activityHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-state"><p class="empty-description">ยังไม่มีประวัติกิจกรรม</p></div>';
        return;
      }

      const grouped = {};
      activityHistory.forEach(activity => {
        const dateKey = activity.timestamp.toISOString().split('T')[0];
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(activity);
      });

      const dates = Object.keys(grouped).sort().reverse();
      const mainDates = dates.slice(0, 2);
      const expandedDates = dates.slice(2);

      let mainHTML = '';
      mainDates.forEach(dateKey => {
        mainHTML += renderDayActivities(dateKey, grouped[dateKey]);
      });

      historyList.innerHTML = mainHTML || '<div class="empty-state"><p class="empty-description">ยังไม่มีประวัติกิจกรรม</p></div>';

      if (expandedDates.length > 0) {
        let expandedHTML = '';
        expandedDates.forEach(dateKey => {
          expandedHTML += renderDayActivities(dateKey, grouped[dateKey]);
        });
        historyExpandedEl.innerHTML = expandedHTML;
        document.querySelector('.history-toggle').style.display = 'flex';
      } else {
        document.querySelector('.history-toggle').style.display = 'none';
      }
    }

    function renderDayActivities(dateKey, activities) {
      const date = new Date(dateKey);
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

      let dateLabel;
      if (dateKey === today) dateLabel = 'วันนี้';
      else if (dateKey === yesterday) dateLabel = 'เมื่อวาน';
      else dateLabel = date.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' });

      let html = `<div class="history-day mb-4">
        <div class="history-day-header">${dateLabel}</div>`;

      activities.forEach((activity) => {
        const time = activity.timestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const activityIndex = activityHistory.findIndex(a => a.id === activity.id && a.table === activity.table);

        html += `
          <div class="history-item">
            <div class="history-icon ${activity.type}">${icon(activity.iconName)}</div>
            <div class="history-content">
              <div class="history-text">${activity.text}</div>
              <div class="history-time">${time}</div>
            </div>
            <div class="history-actions">
              <button class="history-action-btn edit" onclick="openEditModal(${activityIndex})">${icon('edit', 'lucide-sm')}</button>
              <button class="history-action-btn delete" onclick="openDeleteModal(${activityIndex})">${icon('trash', 'lucide-sm')}</button>
            </div>
          </div>`;
      });

      html += '</div>';
      return html;
    }

    function toggleHistory() {
      const expandedEl = document.getElementById('historyExpanded');
      const toggleBtn = document.querySelector('.history-toggle');
      const toggleText = document.getElementById('historyToggleText');

      historyExpanded = !historyExpanded;

      if (historyExpanded) {
        expandedEl.classList.remove('hidden');
        toggleBtn.classList.add('expanded');
        toggleText.textContent = 'ซ่อน';
      } else {
        expandedEl.classList.add('hidden');
        toggleBtn.classList.remove('expanded');
        toggleText.textContent = 'ดูเพิ่มเติม';
      }
    }

    // ============================================
    // CRUD FUNCTIONS
    // ============================================
    let currentEditIndex = null;

    function openEditModal(index) {
      const activity = activityHistory[index];
      if (!activity) return;

      currentEditIndex = index;

      document.getElementById('editActivityId').value = activity.id;
      document.getElementById('editActivityTable').value = activity.table;
      document.getElementById('editActivityType').value = activity.type;

      document.getElementById('editFormMedication').style.display = 'none';
      document.getElementById('editFormVitals').style.display = 'none';
      document.getElementById('editFormWater').style.display = 'none';
      document.getElementById('editFormSymptom').style.display = 'none';
      document.getElementById('editFormGeneric').style.display = 'none';

      const raw = activity.rawData;

      const typeLabels = {
        medication: 'แก้ไขการกินยา',
        water: 'แก้ไขการดื่มน้ำ',
        vitals: 'แก้ไขค่าสุขภาพ',
        symptom: 'แก้ไขอาการ',
        exercise: 'แก้ไขการออกกำลังกาย',
        walk: 'แก้ไขการเดิน',
        food: 'แก้ไขอาหาร'
      };
      document.getElementById('editModalTitle').textContent = typeLabels[activity.type] || 'แก้ไขกิจกรรม';

      if (activity.type === 'medication') {
        document.getElementById('editFormMedication').style.display = 'block';
        if (activity.table === 'medication_logs') {
          document.getElementById('editMedName').value = raw.medication_name || '';
          document.getElementById('editMedNotes').value = raw.note || '';
        } else {
          document.getElementById('editMedName').value = raw.metadata?.medication_name || raw.value || '';
          document.getElementById('editMedNotes').value = raw.notes || '';
        }
        document.getElementById('editMedTime').value = raw.metadata?.time_period || 'morning';

      } else if (activity.type === 'vitals' || activity.table === 'vitals_logs') {
        document.getElementById('editFormVitals').style.display = 'block';
        const systolic = raw.bp_systolic || raw.systolic;
        const diastolic = raw.bp_diastolic || raw.diastolic;
        const pulse = raw.heart_rate || raw.pulse;
        const glucose = raw.glucose || raw.blood_sugar;
        const temp = raw.temperature;

        if (systolic && diastolic) {
          document.getElementById('editVitalsBP').style.display = 'block';
          document.getElementById('editVitalsOther').style.display = 'none';
          document.getElementById('editBpSystolic').value = systolic;
          document.getElementById('editBpDiastolic').value = diastolic;
          document.getElementById('editPulse').value = pulse || '';
        } else if (glucose) {
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = 'น้ำตาลในเลือด (mg/dL)';
          document.getElementById('editVitalsOtherValue').value = glucose;
        } else if (temp) {
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = 'อุณหภูมิ (°C)';
          document.getElementById('editVitalsOtherValue').value = temp;
        } else if (pulse && !systolic) {
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = 'ชีพจร (ครั้ง/นาที)';
          document.getElementById('editVitalsOtherValue').value = pulse;
        }
        document.getElementById('editVitalsNotes').value = raw.notes || '';

      } else if (activity.type === 'water') {
        document.getElementById('editFormWater').style.display = 'block';
        if (activity.table === 'water_logs') {
          document.getElementById('editWaterAmount').value = raw.amount_ml || 0;
          document.getElementById('editWaterUnit').value = 'ml';
          document.getElementById('editWaterNotes').value = raw.note || '';
        } else {
          const amount = raw.metadata?.amount || raw.value || 0;
          document.getElementById('editWaterAmount').value = amount;
          document.getElementById('editWaterUnit').value = raw.metadata?.unit || 'ml';
          document.getElementById('editWaterNotes').value = raw.notes || '';
        }

      } else if (activity.type === 'symptom' || activity.table === 'symptoms') {
        document.getElementById('editFormSymptom').style.display = 'block';
        document.getElementById('editSymptomName').value = raw.symptom_name || raw.symptom || '';
        document.getElementById('editSymptomSeverity').value = raw.severity_1to5 || raw.severity || 3;
        document.getElementById('editSymptomLocation').value = raw.body_location || raw.location || '';
        document.getElementById('editSymptomNotes').value = raw.notes || raw.duration_text || '';

      } else {
        document.getElementById('editFormGeneric').style.display = 'block';
        const typeDisplayLabels = { exercise: 'ออกกำลังกาย', walk: 'เดิน', food: 'อาหาร', sleep: 'การนอน', mood: 'อารมณ์' };
        document.getElementById('editTypeDisplay').value = typeDisplayLabels[activity.type] || activity.type;

        if (activity.table === 'exercise_logs') {
          document.getElementById('editGenericLabel').textContent = 'ระยะเวลา (นาที)';
          document.getElementById('editGenericValue').value = raw.duration_minutes || '';
          document.getElementById('editGenericNotes').value = raw.notes || '';
        } else if (activity.table === 'sleep_logs') {
          document.getElementById('editGenericLabel').textContent = 'ชั่วโมงนอน';
          document.getElementById('editGenericValue').value = raw.sleep_hours || '';
          document.getElementById('editGenericNotes').value = raw.notes || '';
        } else if (activity.table === 'mood_logs') {
          document.getElementById('editGenericLabel').textContent = 'อารมณ์';
          document.getElementById('editGenericValue').value = raw.mood || '';
          document.getElementById('editGenericNotes').value = raw.note || '';
        } else {
          document.getElementById('editGenericLabel').textContent = activity.type === 'exercise' || activity.type === 'walk' ? 'ระยะเวลา (นาที)' : 'ค่า';
          document.getElementById('editGenericValue').value = raw.value || raw.metadata?.duration || '';
          document.getElementById('editGenericNotes').value = raw.notes || '';
        }
      }

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('editModal').classList.remove('show');
      currentEditIndex = null;
    }

    async function saveActivityEdit() {
      if (currentEditIndex === null) return;

      const activity = activityHistory[currentEditIndex];
      const id = document.getElementById('editActivityId').value;
      const table = document.getElementById('editActivityTable').value;
      const activityType = document.getElementById('editActivityType').value;
      const raw = activity.rawData;

      try {
        let updateData = {};

        if (activityType === 'medication') {
          const medName = document.getElementById('editMedName').value;
          const medNotes = document.getElementById('editMedNotes').value;

          if (table === 'medication_logs') {
            updateData.medication_name = medName;
            if (medNotes) updateData.note = medNotes;
          } else {
            const medTime = document.getElementById('editMedTime').value;
            updateData.metadata = { ...raw.metadata, medication_name: medName, time_period: medTime };
            updateData.value = medName;
            if (medNotes) updateData.notes = medNotes;
          }

        } else if (activityType === 'vitals' || table === 'vitals_logs') {
          const bpFormVisible = document.getElementById('editVitalsBP').style.display !== 'none';

          if (bpFormVisible) {
            const systolic = document.getElementById('editBpSystolic').value;
            const diastolic = document.getElementById('editBpDiastolic').value;
            const pulse = document.getElementById('editPulse').value;

            if (systolic) updateData.bp_systolic = parseInt(systolic);
            if (diastolic) updateData.bp_diastolic = parseInt(diastolic);
            if (pulse) updateData.heart_rate = parseInt(pulse);
          } else {
            const otherValue = document.getElementById('editVitalsOtherValue').value;
            const otherLabel = document.getElementById('editVitalsOtherLabel').textContent;

            if (otherLabel.includes('น้ำตาล')) updateData.glucose = parseFloat(otherValue);
            else if (otherLabel.includes('อุณหภูมิ')) updateData.temperature = parseFloat(otherValue);
            else if (otherLabel.includes('ชีพจร')) updateData.heart_rate = parseInt(otherValue);
          }

          const vitalsNotes = document.getElementById('editVitalsNotes').value;
          if (vitalsNotes) updateData.notes = vitalsNotes;

        } else if (activityType === 'water') {
          const waterAmount = document.getElementById('editWaterAmount').value;
          const waterUnit = document.getElementById('editWaterUnit').value;
          const waterNotes = document.getElementById('editWaterNotes').value;

          const amountMl = waterUnit === 'glass' ? parseInt(waterAmount) * 250 : parseInt(waterAmount);

          if (table === 'water_logs') {
            updateData.amount_ml = amountMl;
            updateData.glasses = Math.round(amountMl / 250);
            if (waterNotes) updateData.note = waterNotes;
          } else {
            updateData.metadata = { ...raw.metadata, amount: amountMl, unit: waterUnit };
            updateData.value = amountMl.toString();
            if (waterNotes) updateData.notes = waterNotes;
          }

        } else if (activityType === 'symptom' || table === 'symptoms') {
          const symptomName = document.getElementById('editSymptomName').value;
          const symptomSeverity = document.getElementById('editSymptomSeverity').value;
          const symptomLocation = document.getElementById('editSymptomLocation').value;
          const symptomNotes = document.getElementById('editSymptomNotes').value;

          updateData.symptom_name = symptomName;
          updateData.severity_1to5 = parseInt(symptomSeverity);
          if (symptomLocation) updateData.body_location = symptomLocation;
          if (symptomNotes) updateData.notes = symptomNotes;

        } else {
          const genericValue = document.getElementById('editGenericValue').value;
          const genericNotes = document.getElementById('editGenericNotes').value;

          if (table === 'exercise_logs') {
            updateData.duration_minutes = parseInt(genericValue) || null;
            if (genericNotes) updateData.notes = genericNotes;
          } else if (table === 'sleep_logs') {
            updateData.sleep_hours = parseFloat(genericValue) || null;
            if (genericNotes) updateData.notes = genericNotes;
          } else if (table === 'mood_logs') {
            updateData.mood = genericValue;
            if (genericNotes) updateData.note = genericNotes;
          } else if (activityType === 'exercise' || activityType === 'walk') {
            updateData.metadata = { ...raw.metadata, duration: parseInt(genericValue) };
            updateData.value = genericValue;
            if (genericNotes) updateData.notes = genericNotes;
          } else {
            updateData.value = genericValue;
            if (genericNotes) updateData.notes = genericNotes;
          }
        }

        const { error } = await supabaseClient.from(table).update(updateData).eq('id', id);

        if (error) throw error;

        showToast('บันทึกการแก้ไขเรียบร้อย', 'success');
        closeEditModal();
        await loadActivityHistory();

      } catch (error) {
        console.error('Error updating activity:', error);
        showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
      }
    }

    function openDeleteModal(index) {
      const activity = activityHistory[index];
      if (!activity) return;

      document.getElementById('deleteActivityId').value = activity.id;
      document.getElementById('deleteActivityTable').value = activity.table;
      document.getElementById('deleteActivityPreview').innerHTML = `
        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${icon(activity.iconName, 'lucide-xl')}</div>
        <div style="font-weight: 500;">${activity.text}</div>
        <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); margin-top: 0.25rem;">
          ${activity.timestamp.toLocaleDateString('th-TH')} ${activity.timestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
        </div>
      `;

      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('deleteModal').classList.remove('show');
    }

    async function confirmDelete() {
      const id = document.getElementById('deleteActivityId').value;
      const table = document.getElementById('deleteActivityTable').value;

      try {
        const { error } = await supabaseClient.from(table).delete().eq('id', id);

        if (error) throw error;

        showToast('ลบรายการเรียบร้อย', 'success');
        closeDeleteModal();
        await loadActivityHistory();
        await loadTodaySummary();

      } catch (error) {
        console.error('Error deleting activity:', error);
        showToast('เกิดข้อผิดพลาดในการลบ', 'error');
      }
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
