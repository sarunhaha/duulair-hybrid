<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FAF9F6">
  <title>ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - OONJAI</title>

  <!-- Phase 3.1: Preconnect to speed up external resources -->
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Preload critical scripts -->
  <link rel="preload" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Dashboard Header */
    .dashboard-header {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      color: white;
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .dashboard-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }

    .dashboard-date {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Today's Summary */
    .summary-section {
      margin-bottom: var(--spacing-lg);
    }

    .summary-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .summary-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .summary-icon.medication {
      background: #FEE2E2;
    }

    .summary-icon.water {
      background: #DBEAFE;
    }

    .summary-icon.vitals {
      background: #D1FAE5;
    }

    .summary-icon.symptom {
      background: #FEF3C7;
    }

    .summary-info {
      flex: 1;
      min-width: 0;
    }

    .summary-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .summary-value.incomplete {
      color: var(--warning);
    }

    .summary-value.complete {
      color: var(--success);
    }

    /* Category Grid */
    .category-section {
      margin-bottom: var(--spacing-lg);
    }

    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .category-btn {
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      text-decoration: none;
      display: block;
    }

    .category-btn:active {
      transform: scale(0.97);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }

    .category-icon {
      font-size: 36px;
      margin-bottom: var(--spacing-sm);
      display: block;
    }

    .category-label {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      display: block;
      margin-bottom: 4px;
    }

    .category-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Quick Actions */
    .quick-actions {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .quick-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .quick-btn-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .quick-btn {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }

    .quick-btn:active {
      background: var(--accent-light);
    }

    .quick-btn-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      background: var(--bg-card);
    }

    .quick-btn-text {
      flex: 1;
    }

    .quick-btn-text .label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      display: block;
    }

    .quick-btn-text .desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .quick-btn-arrow {
      color: var(--text-muted);
      font-size: 18px;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 24px;
      border-radius: var(--radius-md);
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
    }

    /* Activity History Section */
    .history-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .history-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .history-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: var(--accent-primary);
      font-size: 13px;
      cursor: pointer;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .history-toggle:active {
      background: var(--accent-light);
    }

    .history-toggle.expanded svg {
      transform: rotate(180deg);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .history-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: var(--spacing-md);
    }

    .history-empty {
      text-align: center;
      color: var(--text-secondary);
      padding: var(--spacing-lg);
    }

    .history-day {
      margin-bottom: var(--spacing-md);
    }

    .history-day:last-child {
      margin-bottom: 0;
    }

    .history-day-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      padding-bottom: var(--spacing-xs);
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .history-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xs);
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .history-icon.medication { background: #FEE2E2; }
    .history-icon.water { background: #DBEAFE; }
    .history-icon.vitals { background: #D1FAE5; }
    .history-icon.symptom { background: #FEF3C7; }
    .history-icon.exercise { background: #E0E7FF; }
    .history-icon.food { background: #FCE7F3; }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-text {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .history-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .history-expanded {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px dashed rgba(0,0,0,0.1);
    }

    /* History Item Actions */
    .history-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .history-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 14px;
    }

    .history-action-btn:active {
      transform: scale(0.95);
    }

    .history-action-btn.edit {
      color: var(--accent-primary);
    }

    .history-action-btn.edit:active {
      background: var(--accent-light);
    }

    .history-action-btn.delete {
      color: #EF4444;
    }

    .history-action-btn.delete:active {
      background: #FEE2E2;
    }

    /* Edit Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: var(--spacing-lg);
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: var(--radius-md);
      font-size: 16px;
      background: var(--bg-card);
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .modal-footer {
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid rgba(0,0,0,0.08);
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
    }

    .btn-cancel {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: 1px solid rgba(0,0,0,0.15);
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-size: 14px;
      cursor: pointer;
    }

    .btn-save {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: none;
      background: var(--accent-primary);
      color: white;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-delete {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: none;
      background: #EF4444;
      color: white;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    @media (max-width: 380px) {
      .category-icon {
        font-size: 28px;
      }

      .category-label {
        font-size: 14px;
      }

      .summary-value {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h1>ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h1>
        <div class="dashboard-date" id="currentDate"></div>
      </div>

      <!-- Today's Summary -->
      <div class="summary-section">
        <div class="summary-title">
          üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </div>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-icon medication">üíä</div>
            <div class="summary-info">
              <div class="summary-label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</div>
              <div class="summary-value" id="medSummary">-/-</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon water">üíß</div>
            <div class="summary-info">
              <div class="summary-label">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</div>
              <div class="summary-value" id="waterSummary">0 ml</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon vitals">üíâ</div>
            <div class="summary-info">
              <div class="summary-label">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
              <div class="summary-value" id="vitalsSummary">-</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon symptom">ü§í</div>
            <div class="summary-info">
              <div class="summary-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div>
              <div class="summary-value" id="symptomSummary">‡∏õ‡∏Å‡∏ï‡∏¥</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Grid -->
      <div class="category-section">
        <div class="category-title">
          üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </div>
        <div class="category-grid">
          <button class="category-btn" onclick="navigateTo('log-medication.html')">
            <span class="category-icon">üíä</span>
            <span class="category-label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</span>
            <span class="category-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</span>
          </button>
          <button class="category-btn" onclick="navigateTo('vitals-tracking.html')">
            <span class="category-icon">üíâ</span>
            <span class="category-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</span>
            <span class="category-desc">‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</span>
          </button>
          <button class="category-btn" onclick="navigateTo('water-tracking.html')">
            <span class="category-icon">üíß</span>
            <span class="category-label">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</span>
            <span class="category-desc">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</span>
          </button>
          <button class="category-btn" onclick="navigateTo('log-symptom.html')">
            <span class="category-icon">ü§í</span>
            <span class="category-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</span>
            <span class="category-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="quick-title">
          ‚ö° ‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î
        </div>
        <div class="quick-btn-group">
          <button class="quick-btn" onclick="quickLogMedication()">
            <div class="quick-btn-icon">‚úÖ</div>
            <div class="quick-btn-text">
              <span class="label">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
              <span class="desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
            <span class="quick-btn-arrow">‚Ä∫</span>
          </button>
          <button class="quick-btn" onclick="openMedications()">
            <div class="quick-btn-icon">üìã</div>
            <div class="quick-btn-text">
              <span class="label">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</span>
              <span class="desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</span>
            </div>
            <span class="quick-btn-arrow">‚Ä∫</span>
          </button>
        </div>
      </div>

      <!-- Activity History Section -->
      <div class="history-section">
        <div class="history-header">
          <div class="history-title">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
          <button class="history-toggle" onclick="toggleHistory()">
            <span id="historyToggleText">‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
            <svg id="historyArrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
        </div>
        <div id="historyList" class="history-list">
          <div class="history-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div id="historyExpanded" class="history-expanded hidden">
          <!-- More history items will be loaded here -->
        </div>
      </div>

      <button class="btn btn-secondary btn-block" onclick="closeLiff()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Edit Activity Modal -->
  <div id="editModal" class="modal-overlay" onclick="closeEditModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span id="editModalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editActivityId">
        <input type="hidden" id="editActivityTable">
        <input type="hidden" id="editActivityType">

        <!-- Medication Form -->
        <div id="editFormMedication" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label>üíä ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
            <input type="text" id="editMedName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
          </div>
          <div class="form-group">
            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏¥‡∏ô</label>
            <select id="editMedTime">
              <option value="morning">‡πÄ‡∏ä‡πâ‡∏≤</option>
              <option value="noon">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</option>
              <option value="evening">‡πÄ‡∏¢‡πá‡∏ô</option>
              <option value="night">‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô</option>
            </select>
          </div>
          <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editMedNotes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
          </div>
        </div>

        <!-- Vitals Form -->
        <div id="editFormVitals" class="edit-form-section" style="display: none;">
          <div id="editVitalsBP" style="display: none;">
            <div style="display: flex; gap: 10px;">
              <div class="form-group" style="flex: 1;">
                <label>üíâ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô (Systolic)</label>
                <input type="number" id="editBpSystolic" placeholder="120">
              </div>
              <div class="form-group" style="flex: 1;">
                <label>‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏á (Diastolic)</label>
                <input type="number" id="editBpDiastolic" placeholder="80">
              </div>
            </div>
            <div class="form-group">
              <label>‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ)</label>
              <input type="number" id="editPulse" placeholder="72">
            </div>
          </div>
          <div id="editVitalsOther" style="display: none;">
            <div class="form-group">
              <label id="editVitalsOtherLabel">‡∏Ñ‡πà‡∏≤</label>
              <input type="number" id="editVitalsOtherValue" step="0.1">
            </div>
          </div>
          <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editVitalsNotes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
          </div>
        </div>

        <!-- Water Form -->
        <div id="editFormWater" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label>üíß ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="number" id="editWaterAmount" placeholder="250" style="flex: 1;">
              <select id="editWaterUnit" style="width: 80px;">
                <option value="ml">ml</option>
                <option value="glass">‡πÅ‡∏Å‡πâ‡∏ß</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editWaterNotes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
          </div>
        </div>

        <!-- Symptom Form -->
        <div id="editFormSymptom" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label>ü§í ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
            <input type="text" id="editSymptomName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">
          </div>
          <div class="form-group">
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
            <select id="editSymptomSeverity">
              <option value="1">1 - ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="2">2 - ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢-‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
              <option value="3">3 - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
              <option value="4">4 - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á-‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</option>
              <option value="5">5 - ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</option>
            </select>
          </div>
          <div class="form-group">
            <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì</label>
            <input type="text" id="editSymptomLocation" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡πâ‡∏≠‡∏á, ‡∏´‡∏±‡∏ß, ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å">
          </div>
          <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editSymptomNotes" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
          </div>
        </div>

        <!-- Generic Form (for other types) -->
        <div id="editFormGeneric" class="edit-form-section" style="display: none;">
          <div class="form-group">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <input type="text" id="editTypeDisplay" readonly style="background: var(--bg-secondary);">
          </div>
          <div class="form-group">
            <label id="editGenericLabel">‡∏Ñ‡πà‡∏≤</label>
            <input type="text" id="editGenericValue" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤">
          </div>
          <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editGenericNotes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-save" onclick="saveActivityEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay" onclick="closeDeleteModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</span>
        <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteActivityId">
        <input type="hidden" id="deleteActivityTable">
        <p style="text-align: center; margin-bottom: var(--spacing-md);">
          ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
        </p>
        <div id="deleteActivityPreview" style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-delete" onclick="confirmDelete()">‡∏•‡∏ö</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // OPTIMIZED LIFF LOADING - All Phases
    // ============================================

    // API Base URL - inline for LIFF compatibility
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : 'https://duulair.vercel.app/api';

    const LIFF_ID = '2008278683-5k69jxNq';
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';

    let supabaseClient = null;
    if (window.supabase && window.supabase.createClient) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let patientId = null;
    let groupId = null;
    let medications = [];
    let todaySummary = {
      medicationsTaken: 0,
      medicationsTotal: 0,
      waterAmount: 0,
      latestVitals: null,
      symptoms: []
    };

    // ============================================
    // Phase 2.1 & 2.2: Show UI First with Cached Data
    // ============================================
    (function showUIImmediately() {
      // Set date immediately (no async needed)
      document.getElementById('currentDate').textContent = formatThaiDate(new Date());

      // Load cached summary from localStorage
      const today = new Date().toISOString().split('T')[0];
      const cachedSummary = localStorage.getItem(`health_summary_${today}`);
      if (cachedSummary) {
        try {
          todaySummary = JSON.parse(cachedSummary);
          updateSummaryUI();
        } catch (e) {}
      }

      // Load water & vitals from localStorage immediately
      const waterData = JSON.parse(localStorage.getItem(`water_${today}`) || '{"total": 0}');
      todaySummary.waterAmount = waterData.total || 0;

      const vitalsData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
      if (vitalsData.readings && vitalsData.readings.length > 0) {
        const latest = vitalsData.readings[0];
        todaySummary.latestVitals = `${latest.systolic}/${latest.diastolic}`;
      }

      updateSummaryUI();

      // Show UI immediately! Don't wait for LIFF
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Format Thai date
    function formatThaiDate(date) {
      const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
      ];
      const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      const dayName = thaiDays[date.getDay()];

      return `‡∏ß‡∏±‡∏ô${dayName}‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;
    }

    // ============================================
    // Phase 1.1: Cache LIFF Profile
    // ============================================
    async function getCachedProfile() {
      // Check cache first (valid for 1 hour)
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      // Fetch fresh profile
      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // ============================================
    // Phase 1.2: Skip Registration Check if Cached
    // ============================================
    async function checkUserRegistration(lineUserId) {
      // Check cache first
      const cached = sessionStorage.getItem('user_registered');
      if (cached === 'true') {
        return true; // Skip API call!
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (result.exists) {
          sessionStorage.setItem('user_registered', 'true');
          return true;
        } else {
          window.location.href = '/liff/index.html';
          return false;
        }
      } catch (error) {
        console.error('Error checking registration:', error);
        return true; // Don't block on error
      }
    }

    // ============================================
    // Phase 1.3: Parallel Loading with LIFF Init
    // ============================================
    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get context immediately (sync, no wait)
        const context = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = context.patientId;
        groupId = context.groupId;

        // Phase 1.3: Run profile fetch and data loading in parallel
        const [profile] = await Promise.all([
          getCachedProfile(),
          loadTodaySummary(), // Load real data in parallel
          loadActivityHistory() // Load activity history
        ]);

        // Check registration in background (don't await)
        checkUserRegistration(profile.userId).catch(e => console.error('Reg check:', e));

        // Cache summary for next visit
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(`health_summary_${today}`, JSON.stringify(todaySummary));

      } catch (error) {
        console.error('LIFF init error:', error);
        // UI is already shown, just log the error
      }
    }

    async function loadTodaySummary() {
      const today = new Date().toISOString().split('T')[0];

      // Load medications count
      if (patientId && supabaseClient) {
        try {
          const { data: meds, error } = await supabaseClient
            .from('medications')
            .select('id, times')
            .eq('patient_id', patientId)
            .eq('is_active', true);

          if (!error && meds) {
            // Count total expected medication doses for today
            let totalDoses = 0;
            meds.forEach(med => {
              const times = med.times || [];
              totalDoses += times.length;
            });
            todaySummary.medicationsTotal = totalDoses;
            medications = meds;
          }

          // Get today's medication logs
          const { data: logs, error: logsError } = await supabaseClient
            .from('activity_logs')
            .select('*')
            .eq('patient_id', patientId)
            .eq('task_type', 'medication')
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59');

          if (!logsError && logs) {
            todaySummary.medicationsTaken = logs.length;
          }

        } catch (error) {
          console.error('Error loading medications:', error);
        }
      }

      // Load water data from localStorage (fallback) and database
      const waterData = JSON.parse(localStorage.getItem(`water_${today}`) || '{"total": 0}');
      todaySummary.waterAmount = waterData.total || 0;

      // Also check water from activity_logs in database
      if (patientId && supabaseClient) {
        try {
          const { data: waterLogs, error: waterError } = await supabaseClient
            .from('activity_logs')
            .select('metadata, value')
            .eq('patient_id', patientId)
            .eq('task_type', 'water')
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59');

          if (!waterError && waterLogs && waterLogs.length > 0) {
            let totalWater = 0;
            waterLogs.forEach(log => {
              totalWater += parseInt(log.metadata?.amount || log.value || 0);
            });
            if (totalWater > todaySummary.waterAmount) {
              todaySummary.waterAmount = totalWater;
            }
          }
        } catch (e) {
          console.error('Error loading water from DB:', e);
        }
      }

      // Load vitals from database (not just localStorage)
      if (patientId && supabaseClient) {
        try {
          const { data: vitals, error: vitalsError } = await supabaseClient
            .from('vitals_logs')
            .select('bp_systolic, bp_diastolic, heart_rate, glucose, temperature, created_at')
            .eq('patient_id', patientId)
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59')
            .order('created_at', { ascending: false })
            .limit(1);

          if (!vitalsError && vitals && vitals.length > 0) {
            const latest = vitals[0];
            if (latest.bp_systolic && latest.bp_diastolic) {
              todaySummary.latestVitals = `${latest.bp_systolic}/${latest.bp_diastolic}`;
            } else if (latest.glucose) {
              todaySummary.latestVitals = `${latest.glucose} mg/dL`;
            } else if (latest.temperature) {
              todaySummary.latestVitals = `${latest.temperature}¬∞C`;
            }
          }
        } catch (e) {
          console.error('Error loading vitals from DB:', e);
        }
      }

      // Fallback to localStorage if no DB data
      if (!todaySummary.latestVitals) {
        const vitalsData = JSON.parse(localStorage.getItem(`vitals_${today}`) || '{"readings": []}');
        if (vitalsData.readings && vitalsData.readings.length > 0) {
          const latest = vitalsData.readings[0];
          todaySummary.latestVitals = `${latest.systolic}/${latest.diastolic}`;
        }
      }

      // Load symptoms from database
      if (patientId && supabaseClient) {
        try {
          const { data: symptoms, error: symptomsError } = await supabaseClient
            .from('symptoms')
            .select('id, symptom_name')
            .eq('patient_id', patientId)
            .gte('created_at', today + 'T00:00:00')
            .lt('created_at', today + 'T23:59:59');

          if (!symptomsError && symptoms) {
            todaySummary.symptoms = symptoms;
          }
        } catch (e) {
          console.error('Error loading symptoms from DB:', e);
        }
      }

      // Update UI
      updateSummaryUI();
    }

    function updateSummaryUI() {
      // Medication summary
      const medEl = document.getElementById('medSummary');
      if (todaySummary.medicationsTotal > 0) {
        medEl.textContent = `${todaySummary.medicationsTaken}/${todaySummary.medicationsTotal}`;
        if (todaySummary.medicationsTaken >= todaySummary.medicationsTotal) {
          medEl.classList.add('complete');
          medEl.classList.remove('incomplete');
        } else {
          medEl.classList.add('incomplete');
          medEl.classList.remove('complete');
        }
      } else {
        medEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤';
        medEl.style.fontSize = '14px';
      }

      // Water summary
      const waterEl = document.getElementById('waterSummary');
      waterEl.textContent = `${todaySummary.waterAmount} ml`;
      if (todaySummary.waterAmount >= 2000) {
        waterEl.classList.add('complete');
      }

      // Vitals summary
      const vitalsEl = document.getElementById('vitalsSummary');
      if (todaySummary.latestVitals) {
        vitalsEl.textContent = todaySummary.latestVitals;
      } else {
        vitalsEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡∏±‡∏î';
        vitalsEl.style.fontSize = '14px';
      }

      // Symptom summary
      const symptomEl = document.getElementById('symptomSummary');
      if (todaySummary.symptoms && todaySummary.symptoms.length > 0) {
        symptomEl.textContent = `${todaySummary.symptoms.length} ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£`;
        symptomEl.classList.add('incomplete');
      } else {
        symptomEl.textContent = '‡∏õ‡∏Å‡∏ï‡∏¥';
        symptomEl.classList.add('complete');
      }
    }

    // Quick log all medications
    async function quickLogMedication() {
      if (!patientId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      if (medications.length === 0) {
        showToast('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤', 'error');
        return;
      }

      // Determine current time period
      const hour = new Date().getHours();
      let currentPeriod = 'morning';
      if (hour >= 11 && hour < 14) currentPeriod = 'afternoon';
      else if (hour >= 16 && hour < 20) currentPeriod = 'evening';
      else if (hour >= 20 || hour < 6) currentPeriod = 'night';

      try {
        const medsForPeriod = medications.filter(med => {
          const times = med.times || [];
          return times.includes(currentPeriod);
        });

        if (medsForPeriod.length === 0) {
          showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ', 'error');
          return;
        }

        // Log each medication
        const logs = medsForPeriod.map(med => ({
          patient_id: patientId,
          task_type: 'medication',
          metadata: {
            medication_id: med.id,
            time_period: currentPeriod,
            logged_at: new Date().toISOString()
          }
        }));

        const { error } = await supabaseClient
          .from('activity_logs')
          .insert(logs);

        if (error) throw error;

        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ${medsForPeriod.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
        todaySummary.medicationsTaken += medsForPeriod.length;
        updateSummaryUI();

      } catch (error) {
        console.error('Error logging medications:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    // Navigate to sub-page within LIFF
    function navigateTo(page) {
      // Store current page as return destination
      sessionStorage.setItem('liff_return_to', 'health-log.html');
      // Navigate using proper path
      const basePath = window.location.pathname.replace(/[^/]*$/, '');
      window.location.href = basePath + page;
    }

    function openMedications() {
      navigateTo('medications.html');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function closeLiff() {
      liff.closeWindow();
    }

    // ============================================
    // Activity History Functions
    // ============================================
    let activityHistory = [];
    let historyExpanded = false;

    async function loadActivityHistory() {
      if (!patientId || !supabaseClient) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        return;
      }

      try {
        // Get activities from last 7 days
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const startDate = sevenDaysAgo.toISOString();

        const { data: logs, error } = await supabaseClient
          .from('activity_logs')
          .select('*')
          .eq('patient_id', patientId)
          .gte('created_at', startDate)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        // Also get vitals logs
        const { data: vitals, error: vitalsError } = await supabaseClient
          .from('vitals_logs')
          .select('*')
          .eq('patient_id', patientId)
          .gte('created_at', startDate)
          .order('created_at', { ascending: false })
          .limit(20);

        // Also get symptoms
        const { data: symptoms, error: symptomsError } = await supabaseClient
          .from('symptoms')
          .select('*')
          .eq('patient_id', patientId)
          .gte('created_at', startDate)
          .order('created_at', { ascending: false })
          .limit(20);

        // Combine and format all activities
        activityHistory = [];

        // Process activity logs
        if (logs) {
          logs.forEach(log => {
            activityHistory.push({
              id: log.id,
              table: 'activity_logs',
              type: log.task_type || 'activity',
              text: formatActivityText(log),
              timestamp: new Date(log.created_at),
              icon: getActivityIcon(log.task_type),
              rawData: log
            });
          });
        }

        // Process vitals
        if (vitals) {
          vitals.forEach(v => {
            let text = '';
            let valueDisplay = '';
            // Support both snake_case (database) and camelCase column names
            const systolic = v.bp_systolic || v.systolic;
            const diastolic = v.bp_diastolic || v.diastolic;
            const pulse = v.heart_rate || v.pulse;
            const bloodSugar = v.glucose || v.blood_sugar;
            const temp = v.temperature;
            const timestamp = v.created_at || v.measured_at;

            if (systolic && diastolic) {
              text = `‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ${systolic}/${diastolic} mmHg`;
              valueDisplay = `${systolic}/${diastolic}`;
              if (pulse) {
                text += ` ‡∏ä‡∏µ‡∏û‡∏à‡∏£ ${pulse}`;
                valueDisplay += ` ‡∏ä‡∏µ‡∏û‡∏à‡∏£ ${pulse}`;
              }
            } else if (pulse && !systolic) {
              text = `‡∏ä‡∏µ‡∏û‡∏à‡∏£ ${pulse} bpm`;
              valueDisplay = pulse;
            } else if (bloodSugar) {
              text = `‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ${bloodSugar} mg/dL`;
              valueDisplay = bloodSugar;
            } else if (temp) {
              text = `‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ${temp}¬∞C`;
              valueDisplay = temp;
            }
            if (text) {
              activityHistory.push({
                id: v.id,
                table: 'vitals_logs',
                type: 'vitals',
                text,
                valueDisplay,
                timestamp: new Date(timestamp),
                icon: 'üíâ',
                rawData: v
              });
            }
          });
        }

        // Process symptoms
        if (symptoms) {
          symptoms.forEach(s => {
            // Map severity_1to5 to text
            const severityText = s.severity_1to5 ?
              (s.severity_1to5 <= 2 ? '‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢' : s.severity_1to5 <= 3 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á') :
              '';
            const symptomName = s.symptom_name || s.symptom || '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£';
            activityHistory.push({
              id: s.id,
              table: 'symptoms',
              type: 'symptom',
              text: severityText ? `${symptomName} (${severityText})` : symptomName,
              valueDisplay: symptomName,
              timestamp: new Date(s.created_at),
              icon: 'ü§í',
              rawData: s
            });
          });
        }

        // Sort by timestamp descending
        activityHistory.sort((a, b) => b.timestamp - a.timestamp);

        // Render history
        renderActivityHistory();

      } catch (error) {
        console.error('Error loading activity history:', error);
        document.getElementById('historyList').innerHTML = '<div class="history-empty">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
      }
    }

    function formatActivityText(log) {
      const type = log.task_type;
      const meta = log.metadata || {};

      switch (type) {
        case 'medication':
          return meta.medication_name ? `‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ${meta.medication_name}` : '‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
        case 'water':
          const amount = meta.amount || log.value || 0;
          return `‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ ${amount} ml`;
        case 'exercise':
        case 'walk':
          const duration = meta.duration || log.value || 0;
          return `‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        case 'food':
          return meta.meal || '‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        default:
          return log.notes || type || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
      }
    }

    function getActivityIcon(type) {
      const icons = {
        medication: 'üíä',
        water: 'üíß',
        vitals: 'üíâ',
        symptom: 'ü§í',
        exercise: 'üö∂',
        walk: 'üö∂',
        food: 'üçΩÔ∏è'
      };
      return icons[type] || 'üìù';
    }

    function renderActivityHistory() {
      const historyList = document.getElementById('historyList');
      const historyExpandedEl = document.getElementById('historyExpanded');

      if (activityHistory.length === 0) {
        historyList.innerHTML = '<div class="history-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
        return;
      }

      // Group by date
      const grouped = {};
      activityHistory.forEach(activity => {
        const dateKey = activity.timestamp.toISOString().split('T')[0];
        if (!grouped[dateKey]) {
          grouped[dateKey] = [];
        }
        grouped[dateKey].push(activity);
      });

      // Render first 2 days in main list
      const dates = Object.keys(grouped).sort().reverse();
      const mainDates = dates.slice(0, 2);
      const expandedDates = dates.slice(2);

      let mainHTML = '';
      mainDates.forEach(dateKey => {
        mainHTML += renderDayActivities(dateKey, grouped[dateKey]);
      });

      historyList.innerHTML = mainHTML || '<div class="history-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';

      // Render expanded section
      if (expandedDates.length > 0) {
        let expandedHTML = '';
        expandedDates.forEach(dateKey => {
          expandedHTML += renderDayActivities(dateKey, grouped[dateKey]);
        });
        historyExpandedEl.innerHTML = expandedHTML;
        document.querySelector('.history-toggle').style.display = 'flex';
      } else {
        document.querySelector('.history-toggle').style.display = 'none';
      }
    }

    function renderDayActivities(dateKey, activities) {
      const date = new Date(dateKey);
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

      let dateLabel;
      if (dateKey === today) {
        dateLabel = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
      } else if (dateKey === yesterday) {
        dateLabel = '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
      } else {
        dateLabel = date.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' });
      }

      let html = `<div class="history-day">
        <div class="history-day-header">${dateLabel}</div>`;

      activities.forEach((activity, idx) => {
        const time = activity.timestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const activityIndex = activityHistory.findIndex(a => a.id === activity.id && a.table === activity.table);
        html += `
          <div class="history-item">
            <div class="history-icon ${activity.type}">${activity.icon}</div>
            <div class="history-content">
              <div class="history-text">${activity.text}</div>
              <div class="history-time">${time}</div>
            </div>
            <div class="history-actions">
              <button class="history-action-btn edit" onclick="openEditModal(${activityIndex})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="history-action-btn delete" onclick="openDeleteModal(${activityIndex})" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          </div>`;
      });

      html += '</div>';
      return html;
    }

    function toggleHistory() {
      const expandedEl = document.getElementById('historyExpanded');
      const toggleBtn = document.querySelector('.history-toggle');
      const toggleText = document.getElementById('historyToggleText');

      historyExpanded = !historyExpanded;

      if (historyExpanded) {
        expandedEl.classList.remove('hidden');
        toggleBtn.classList.add('expanded');
        toggleText.textContent = '‡∏ã‡πà‡∏≠‡∏ô';
      } else {
        expandedEl.classList.add('hidden');
        toggleBtn.classList.remove('expanded');
        toggleText.textContent = '‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
      }
    }

    // ============================================
    // CRUD Functions for Activity History
    // ============================================
    let currentEditIndex = null;

    function openEditModal(index) {
      const activity = activityHistory[index];
      if (!activity) return;

      currentEditIndex = index;

      document.getElementById('editActivityId').value = activity.id;
      document.getElementById('editActivityTable').value = activity.table;
      document.getElementById('editActivityType').value = activity.type;

      // Hide all form sections first
      document.getElementById('editFormMedication').style.display = 'none';
      document.getElementById('editFormVitals').style.display = 'none';
      document.getElementById('editFormWater').style.display = 'none';
      document.getElementById('editFormSymptom').style.display = 'none';
      document.getElementById('editFormGeneric').style.display = 'none';

      const raw = activity.rawData;

      // Set modal title based on type
      const typeLabels = {
        medication: 'üíä ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤',
        water: 'üíß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥',
        vitals: 'üíâ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
        symptom: 'ü§í ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏Å‡∏≤‡∏£',
        exercise: 'üö∂ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢',
        walk: 'üö∂ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô',
        food: 'üçΩÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏´‡∏≤‡∏£'
      };
      document.getElementById('editModalTitle').textContent = typeLabels[activity.type] || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';

      // Show appropriate form section and populate fields
      if (activity.type === 'medication' || (activity.table === 'activity_logs' && raw.task_type === 'medication')) {
        // Medication form
        document.getElementById('editFormMedication').style.display = 'block';
        document.getElementById('editMedName').value = raw.metadata?.medication_name || raw.value || '';
        document.getElementById('editMedTime').value = raw.metadata?.time_period || 'morning';
        document.getElementById('editMedNotes').value = raw.notes || '';

      } else if (activity.type === 'vitals' || activity.table === 'vitals_logs') {
        // Vitals form
        document.getElementById('editFormVitals').style.display = 'block';
        // Support both snake_case (database) and camelCase column names
        const systolic = raw.bp_systolic || raw.systolic;
        const diastolic = raw.bp_diastolic || raw.diastolic;
        const pulse = raw.heart_rate || raw.pulse;
        const glucose = raw.glucose || raw.blood_sugar;
        const temp = raw.temperature;

        if (systolic && diastolic) {
          // Blood pressure form
          document.getElementById('editVitalsBP').style.display = 'block';
          document.getElementById('editVitalsOther').style.display = 'none';
          document.getElementById('editBpSystolic').value = systolic;
          document.getElementById('editBpDiastolic').value = diastolic;
          document.getElementById('editPulse').value = pulse || '';
        } else if (glucose) {
          // Blood sugar
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = 'ü©∏ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (mg/dL)';
          document.getElementById('editVitalsOtherValue').value = glucose;
        } else if (temp) {
          // Temperature
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = 'üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)';
          document.getElementById('editVitalsOtherValue').value = temp;
        } else if (pulse && !systolic) {
          // Heart rate only
          document.getElementById('editVitalsBP').style.display = 'none';
          document.getElementById('editVitalsOther').style.display = 'block';
          document.getElementById('editVitalsOtherLabel').textContent = '‚ù§Ô∏è ‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ)';
          document.getElementById('editVitalsOtherValue').value = pulse;
        }
        document.getElementById('editVitalsNotes').value = raw.notes || '';

      } else if (activity.type === 'water' || (activity.table === 'activity_logs' && raw.task_type === 'water')) {
        // Water form
        document.getElementById('editFormWater').style.display = 'block';
        const amount = raw.metadata?.amount || raw.value || 0;
        document.getElementById('editWaterAmount').value = amount;
        document.getElementById('editWaterUnit').value = raw.metadata?.unit || 'ml';
        document.getElementById('editWaterNotes').value = raw.notes || '';

      } else if (activity.type === 'symptom' || activity.table === 'symptoms') {
        // Symptom form
        document.getElementById('editFormSymptom').style.display = 'block';
        document.getElementById('editSymptomName').value = raw.symptom_name || raw.symptom || '';
        document.getElementById('editSymptomSeverity').value = raw.severity_1to5 || raw.severity || 3;
        document.getElementById('editSymptomLocation').value = raw.body_location || raw.location || '';
        document.getElementById('editSymptomNotes').value = raw.notes || raw.duration_text || '';

      } else {
        // Generic form for other types
        document.getElementById('editFormGeneric').style.display = 'block';
        const typeDisplayLabels = {
          exercise: 'üö∂ ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢',
          walk: 'üö∂ ‡πÄ‡∏î‡∏¥‡∏ô',
          food: 'üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£'
        };
        document.getElementById('editTypeDisplay').value = typeDisplayLabels[activity.type] || activity.type;
        document.getElementById('editGenericLabel').textContent = activity.type === 'exercise' || activity.type === 'walk' ? '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)' : '‡∏Ñ‡πà‡∏≤';
        document.getElementById('editGenericValue').value = raw.value || raw.metadata?.duration || '';
        document.getElementById('editGenericNotes').value = raw.notes || '';
      }

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('editModal').classList.remove('show');
      currentEditIndex = null;
    }

    async function saveActivityEdit() {
      if (currentEditIndex === null) return;

      const activity = activityHistory[currentEditIndex];
      const id = document.getElementById('editActivityId').value;
      const table = document.getElementById('editActivityTable').value;
      const activityType = document.getElementById('editActivityType').value;
      const raw = activity.rawData;

      try {
        let updateData = {};

        // Build update data based on activity type and visible form
        if (activityType === 'medication' || (table === 'activity_logs' && raw.task_type === 'medication')) {
          // Medication form
          const medName = document.getElementById('editMedName').value;
          const medTime = document.getElementById('editMedTime').value;
          const medNotes = document.getElementById('editMedNotes').value;

          updateData.metadata = {
            ...raw.metadata,
            medication_name: medName,
            time_period: medTime
          };
          updateData.value = medName;
          if (medNotes) updateData.notes = medNotes;

        } else if (activityType === 'vitals' || table === 'vitals_logs') {
          // Vitals form - check which sub-form is visible
          const bpFormVisible = document.getElementById('editVitalsBP').style.display !== 'none';

          if (bpFormVisible) {
            // Blood pressure form
            const systolic = document.getElementById('editBpSystolic').value;
            const diastolic = document.getElementById('editBpDiastolic').value;
            const pulse = document.getElementById('editPulse').value;

            if (systolic) updateData.bp_systolic = parseInt(systolic);
            if (diastolic) updateData.bp_diastolic = parseInt(diastolic);
            if (pulse) updateData.heart_rate = parseInt(pulse);
          } else {
            // Other vitals form (blood sugar, temp, heart rate only)
            const otherValue = document.getElementById('editVitalsOtherValue').value;
            const otherLabel = document.getElementById('editVitalsOtherLabel').textContent;

            if (otherLabel.includes('‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•')) {
              updateData.glucose = parseFloat(otherValue);
            } else if (otherLabel.includes('‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥')) {
              updateData.temperature = parseFloat(otherValue);
            } else if (otherLabel.includes('‡∏ä‡∏µ‡∏û‡∏à‡∏£')) {
              updateData.heart_rate = parseInt(otherValue);
            }
          }

          const vitalsNotes = document.getElementById('editVitalsNotes').value;
          if (vitalsNotes) updateData.notes = vitalsNotes;

        } else if (activityType === 'water' || (table === 'activity_logs' && raw.task_type === 'water')) {
          // Water form
          const waterAmount = document.getElementById('editWaterAmount').value;
          const waterUnit = document.getElementById('editWaterUnit').value;
          const waterNotes = document.getElementById('editWaterNotes').value;

          // Convert to ml if unit is glass (1 glass ‚âà 250ml)
          const amountMl = waterUnit === 'glass' ? parseInt(waterAmount) * 250 : parseInt(waterAmount);

          updateData.metadata = {
            ...raw.metadata,
            amount: amountMl,
            unit: waterUnit
          };
          updateData.value = amountMl.toString();
          if (waterNotes) updateData.notes = waterNotes;

        } else if (activityType === 'symptom' || table === 'symptoms') {
          // Symptom form
          const symptomName = document.getElementById('editSymptomName').value;
          const symptomSeverity = document.getElementById('editSymptomSeverity').value;
          const symptomLocation = document.getElementById('editSymptomLocation').value;
          const symptomNotes = document.getElementById('editSymptomNotes').value;

          updateData.symptom_name = symptomName;
          updateData.severity_1to5 = parseInt(symptomSeverity);
          if (symptomLocation) updateData.body_location = symptomLocation;
          if (symptomNotes) updateData.notes = symptomNotes;

        } else {
          // Generic form for other types
          const genericValue = document.getElementById('editGenericValue').value;
          const genericNotes = document.getElementById('editGenericNotes').value;

          if (activityType === 'exercise' || activityType === 'walk') {
            updateData.metadata = {
              ...raw.metadata,
              duration: parseInt(genericValue)
            };
            updateData.value = genericValue;
          } else {
            updateData.value = genericValue;
          }
          if (genericNotes) updateData.notes = genericNotes;
        }

        const { error } = await supabaseClient
          .from(table)
          .update(updateData)
          .eq('id', id);

        if (error) throw error;

        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        closeEditModal();

        // Reload history
        await loadActivityHistory();

      } catch (error) {
        console.error('Error updating activity:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      }
    }

    function openDeleteModal(index) {
      const activity = activityHistory[index];
      if (!activity) return;

      document.getElementById('deleteActivityId').value = activity.id;
      document.getElementById('deleteActivityTable').value = activity.table;
      document.getElementById('deleteActivityPreview').innerHTML = `
        <div style="font-size: 24px; margin-bottom: 8px;">${activity.icon}</div>
        <div style="font-weight: 500;">${activity.text}</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
          ${activity.timestamp.toLocaleDateString('th-TH')} ${activity.timestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
        </div>
      `;

      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('deleteModal').classList.remove('show');
    }

    async function confirmDelete() {
      const id = document.getElementById('deleteActivityId').value;
      const table = document.getElementById('deleteActivityTable').value;

      try {
        const { error } = await supabaseClient
          .from(table)
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        closeDeleteModal();

        // Reload history
        await loadActivityHistory();
        // Also reload summary
        await loadTodaySummary();

      } catch (error) {
        console.error('Error deleting activity:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
      }
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
