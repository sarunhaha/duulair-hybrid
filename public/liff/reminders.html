<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>ตั้งเวลาเตือน - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <style>
    /* Reminder Section */
    .reminder-section {
      margin-bottom: 1.5rem;
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-xl);
      padding: 1.25rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 0.75rem;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .section-title .section-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .section-title .section-icon svg {
      width: 20px;
      height: 20px;
    }

    .section-title .section-icon.medication {
      background: hsl(280 60% 90%);
      color: hsl(280 60% 45%);
    }
    .section-title .section-icon.water {
      background: hsl(200 80% 90%);
      color: hsl(200 80% 45%);
    }
    .section-title .section-icon.vitals {
      background: hsl(350 80% 90%);
      color: hsl(350 80% 45%);
    }
    .section-title .section-icon.food {
      background: hsl(40 80% 90%);
      color: hsl(40 80% 45%);
    }
    .section-title .section-icon.exercise {
      background: hsl(142 60% 90%);
      color: hsl(142 60% 40%);
    }

    .dark .section-title .section-icon.medication {
      background: hsl(280 40% 25%);
      color: hsl(280 60% 65%);
    }
    .dark .section-title .section-icon.water {
      background: hsl(200 40% 25%);
      color: hsl(200 60% 65%);
    }
    .dark .section-title .section-icon.vitals {
      background: hsl(350 40% 25%);
      color: hsl(350 60% 65%);
    }
    .dark .section-title .section-icon.food {
      background: hsl(40 40% 25%);
      color: hsl(40 60% 65%);
    }
    .dark .section-title .section-icon.exercise {
      background: hsl(142 30% 25%);
      color: hsl(142 50% 60%);
    }

    .add-reminder-btn {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      background: hsl(var(--primary));
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .add-reminder-btn svg {
      width: 16px;
      height: 16px;
    }

    .add-reminder-btn:active {
      transform: scale(0.97);
    }

    /* Reminder List */
    .reminder-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .reminder-card {
      background: hsl(var(--muted));
      border-radius: var(--radius-lg);
      padding: 1rem;
      position: relative;
      transition: all 0.2s ease;
      border-left: 4px solid hsl(var(--primary));
    }

    .reminder-card.disabled {
      opacity: 0.5;
      border-left-color: hsl(var(--muted-foreground));
    }

    .reminder-main {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .reminder-info {
      flex: 1;
      min-width: 0;
    }

    .reminder-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
    }

    .reminder-time {
      font-size: 1.375rem;
      font-weight: 700;
      color: hsl(var(--primary));
    }

    .reminder-frequency {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
      margin-top: 0.25rem;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      background: hsl(var(--muted-foreground));
      border-radius: 26px;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }

    .toggle-switch.active {
      background: hsl(142 70% 45%);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 3px;
      left: 3px;
      transition: left 0.3s;
    }

    .toggle-switch.active::after {
      left: 25px;
    }

    /* Day Badges */
    .reminder-days {
      display: flex;
      gap: 0.375rem;
      margin: 0.5rem 0;
      flex-wrap: wrap;
    }

    .day-badge {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6875rem;
      font-weight: 600;
      background: hsl(var(--border));
      color: hsl(var(--muted-foreground));
    }

    .day-badge.active {
      background: hsl(var(--primary));
      color: white;
    }

    /* Reminder Actions */
    .reminder-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-btn svg {
      width: 14px;
      height: 14px;
    }

    .action-btn:active {
      transform: scale(0.97);
    }

    .action-btn.edit {
      background: hsl(210 100% 50%);
      color: white;
    }

    .action-btn.delete {
      background: hsl(0 84% 60%);
      color: white;
    }

    /* Empty State */
    .empty-reminder {
      text-align: center;
      padding: 1.5rem 0.5rem;
      color: hsl(var(--muted-foreground));
    }

    .empty-reminder svg {
      width: 32px;
      height: 32px;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    .empty-reminder p {
      font-size: 0.875rem;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: hsl(var(--card));
      padding: 1.5rem;
      border-radius: var(--radius-xl);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: hsl(var(--foreground));
    }

    .modal-header svg {
      width: 24px;
      height: 24px;
      color: hsl(var(--primary));
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
    }

    .form-group label .required {
      color: hsl(0 84% 60%);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      font-size: 0.9375rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: hsl(var(--primary));
    }

    /* Frequency Options */
    .frequency-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .frequency-option {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: hsl(var(--foreground));
    }

    .frequency-option.selected {
      background: hsl(var(--primary));
      color: white;
      border-color: hsl(var(--primary));
    }

    /* Days Selector */
    .days-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .day-checkbox {
      width: 44px;
      height: 44px;
      border: 2px solid hsl(var(--border));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      color: hsl(var(--foreground));
    }

    .day-checkbox.selected {
      background: hsl(var(--primary));
      color: white;
      border-color: hsl(var(--primary));
    }

    /* Modal Actions */
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    @media (max-width: 480px) {
      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .add-reminder-btn {
        width: 100%;
        justify-content: center;
      }

      .day-checkbox {
        width: 38px;
        height: 38px;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="closeLiff()" aria-label="ปิด" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Medication Reminders -->
      <div class="reminder-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon medication" id="medIcon"></span>
            <span>กินยา</span>
          </div>
          <button class="add-reminder-btn" onclick="openModal('medication')" id="addMedBtn"></button>
        </div>
        <div id="medication-list" class="reminder-list"></div>
      </div>

      <!-- Water Reminders -->
      <div class="reminder-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon water" id="waterIcon"></span>
            <span>ดื่มน้ำ</span>
          </div>
          <button class="add-reminder-btn" onclick="openModal('water')" id="addWaterBtn"></button>
        </div>
        <div id="water-list" class="reminder-list"></div>
      </div>

      <!-- Vitals Reminders -->
      <div class="reminder-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon vitals" id="vitalsIcon"></span>
            <span>วัดความดัน</span>
          </div>
          <button class="add-reminder-btn" onclick="openModal('vitals')" id="addVitalsBtn"></button>
        </div>
        <div id="vitals-list" class="reminder-list"></div>
      </div>

      <!-- Food Reminders -->
      <div class="reminder-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon food" id="foodIcon"></span>
            <span>ทานอาหาร</span>
          </div>
          <button class="add-reminder-btn" onclick="openModal('food')" id="addFoodBtn"></button>
        </div>
        <div id="food-list" class="reminder-list"></div>
      </div>

      <!-- Exercise Reminders -->
      <div class="reminder-section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-icon exercise" id="exerciseIcon"></span>
            <span>ออกกำลังกาย</span>
          </div>
          <button class="add-reminder-btn" onclick="openModal('exercise')" id="addExerciseBtn"></button>
        </div>
        <div id="exercise-list" class="reminder-list"></div>
      </div>

      <!-- Close Button -->
      <div style="padding-top: 0.5rem;">
        <button class="btn btn-secondary btn-block" onclick="closeLiff()">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Reminder Modal -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader"></div>

      <form id="reminderForm">
        <div class="form-group">
          <label>ชื่อเตือน <span class="required">*</span></label>
          <input type="text" id="reminderTitle" required placeholder="เช่น กินยาความดัน">
        </div>

        <div class="form-group">
          <label>เวลาเตือน (HH:MM) <span class="required">*</span></label>
          <input type="time" id="reminderTime" required>
        </div>

        <div class="form-group">
          <label>ความถี่</label>
          <div class="frequency-options">
            <div class="frequency-option selected" data-frequency="daily" onclick="selectFrequency('daily')">
              ทุกวัน
            </div>
            <div class="frequency-option" data-frequency="specific_days" onclick="selectFrequency('specific_days')">
              เลือกวัน
            </div>
          </div>
        </div>

        <div class="form-group" id="daysSelectorGroup" style="display: none;">
          <label>เลือกวันที่ต้องการเตือน</label>
          <div class="days-selector" id="daysSelector">
            <div class="day-checkbox" data-day="monday">จ</div>
            <div class="day-checkbox" data-day="tuesday">อ</div>
            <div class="day-checkbox" data-day="wednesday">พ</div>
            <div class="day-checkbox" data-day="thursday">พฤ</div>
            <div class="day-checkbox" data-day="friday">ศ</div>
            <div class="day-checkbox" data-day="saturday">ส</div>
            <div class="day-checkbox" data-day="sunday">อา</div>
          </div>
        </div>

        <div class="form-group">
          <label>หมายเหตุ (ถ้ามี)</label>
          <textarea id="reminderNote" placeholder="เพิ่มรายละเอียดเพิ่มเติม"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const LIFF_ID = '2008278683-5k69jxNq';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let patientId = null;
    let reminders = [];
    let editingReminderId = null;
    let selectedDays = new Set();
    let selectedFrequency = 'daily';
    let currentReminderType = null;
    let isGroupContext = false;

    const dayNames = {
      monday: 'จ',
      tuesday: 'อ',
      wednesday: 'พ',
      thursday: 'พฤ',
      friday: 'ศ',
      saturday: 'ส',
      sunday: 'อา'
    };

    const typeConfig = {
      medication: { icon: 'pill', name: 'กินยา' },
      water: { icon: 'droplet', name: 'ดื่มน้ำ' },
      vitals: { icon: 'heartPulse', name: 'วัดความดัน' },
      food: { icon: 'utensils', name: 'ทานอาหาร' },
      exercise: { icon: 'footprints', name: 'ออกกำลังกาย' }
    };

    // Initialize icons and UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('x');
      document.getElementById('headerTitle').innerHTML = icon('bell', 'inline-icon') + ' ตั้งเวลาเตือน';
      document.getElementById('themeBtn').innerHTML = icon('sun');

      // Section icons
      document.getElementById('medIcon').innerHTML = icon('pill');
      document.getElementById('waterIcon').innerHTML = icon('droplet');
      document.getElementById('vitalsIcon').innerHTML = icon('heartPulse');
      document.getElementById('foodIcon').innerHTML = icon('utensils');
      document.getElementById('exerciseIcon').innerHTML = icon('footprints');

      // Add buttons
      document.getElementById('addMedBtn').innerHTML = icon('plus') + ' เพิ่มเตือน';
      document.getElementById('addWaterBtn').innerHTML = icon('plus') + ' เพิ่มเตือน';
      document.getElementById('addVitalsBtn').innerHTML = icon('plus') + ' เพิ่มเตือน';
      document.getElementById('addFoodBtn').innerHTML = icon('plus') + ' เพิ่มเตือน';
      document.getElementById('addExerciseBtn').innerHTML = icon('plus') + ' เพิ่มเตือน';

      // Modal header
      document.getElementById('modalHeader').innerHTML = icon('bell') + ' เพิ่มการเตือน';

      // Show UI immediately!
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Update theme icon
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };

    setTimeout(updateThemeIcon, 100);

    // Cache LIFF profile
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Check registration
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await getCachedProfile();
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

        const context = liff.getContext();
        isGroupContext = context && context.type === 'group';

        if (isGroupContext) {
          const groupId = context.groupId;
          await loadGroupData(groupId);
        } else {
          await loadUserData();
        }
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        showToast('ไม่สามารถเชื่อมต่อ LINE ได้', 'error');
      }
    }

    // Load group data
    async function loadGroupData(groupId) {
      try {
        const { data: group, error: groupError } = await supabaseClient
          .from('caregiver_groups')
          .select('patient_id')
          .eq('line_group_id', groupId)
          .single();

        if (groupError) throw groupError;
        if (!group) {
          showToast('ไม่พบข้อมูลกลุ่ม กรุณาลงทะเบียนก่อน', 'error');
          return;
        }

        patientId = group.patient_id;
        await loadReminders();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        let contextData = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = contextData.patientId;

        if (!patientId) {
          const profile = await liff.getProfile();
          const response = await fetch(`${API_BASE_URL}/check-user/${profile.userId}`);
          const result = await response.json();

          if (result.exists && result.profile) {
            if (result.role === 'patient') {
              patientId = result.profile.profile_id;
              localStorage.setItem('oonjai_context', JSON.stringify({ patientId, role: 'patient' }));
            } else if (result.role === 'caregiver' && result.profile.linked_patient_id) {
              patientId = result.profile.linked_patient_id;
              localStorage.setItem('oonjai_context', JSON.stringify({
                caregiverId: result.profile.profile_id,
                patientId,
                role: 'caregiver'
              }));
            }
          }
        }

        if (!patientId) {
          showToast('ไม่พบข้อมูลผู้ใช้ กรุณาลงทะเบียนก่อน', 'error');
          return;
        }

        await loadReminders();
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
      }
    }

    // Load reminders
    async function loadReminders() {
      try {
        const { data, error } = await supabaseClient
          .from('reminders')
          .select('*')
          .eq('patient_id', patientId)
          .order('custom_time', { ascending: true });

        if (error) throw error;

        reminders = (data || []).map(reminder => ({
          ...reminder,
          days_of_week: reminder.days_of_week ? JSON.parse(reminder.days_of_week) : [],
          reminder_type: reminder.reminder_type || reminder.type || 'custom'
        }));

        renderAllReminders();
      } catch (error) {
        console.error('Error loading reminders:', error);
        showToast('ไม่สามารถโหลดการเตือนได้', 'error');
      }
    }

    // Render all reminder sections
    function renderAllReminders() {
      Object.keys(typeConfig).forEach(type => {
        renderRemindersByType(type);
      });
    }

    // Render reminders by type
    function renderRemindersByType(type) {
      const container = document.getElementById(`${type}-list`);
      const typeReminders = reminders.filter(r => r.reminder_type === type);

      if (typeReminders.length === 0) {
        container.innerHTML = `
          <div class="empty-reminder">
            ${icon(typeConfig[type].icon)}
            <p>ยังไม่มีการเตือน</p>
          </div>
        `;
        return;
      }

      container.innerHTML = typeReminders.map(reminder => {
        const days = reminder.days_of_week || [];
        const isActive = reminder.is_active !== false;
        const frequency = reminder.frequency || 'daily';

        let frequencyText = 'ทุกวัน';
        if (frequency === 'specific_days' && days.length > 0) {
          frequencyText = days.map(d => dayNames[d]).join(', ');
        }

        return `
          <div class="reminder-card ${isActive ? '' : 'disabled'}">
            <div class="reminder-main">
              <div class="reminder-info">
                <div class="reminder-title">${reminder.title}</div>
                <div class="reminder-time">${reminder.custom_time || reminder.time}</div>
                <div class="reminder-frequency">${frequencyText}</div>
                ${reminder.note ? `<div style="color: hsl(var(--muted-foreground)); font-size: 0.8125rem; margin-top: 0.25rem;">${reminder.note}</div>` : ''}
              </div>
              <div class="toggle-switch ${isActive ? 'active' : ''}"
                   onclick="toggleReminder('${reminder.id}', ${!isActive})"></div>
            </div>

            ${frequency === 'specific_days' && days.length > 0 ? `
              <div class="reminder-days">
                ${Object.keys(dayNames).map(day => `
                  <div class="day-badge ${days.includes(day) ? 'active' : ''}">${dayNames[day]}</div>
                `).join('')}
              </div>
            ` : ''}

            <div class="reminder-actions">
              <button class="action-btn edit" onclick="editReminder('${reminder.id}')">${icon('edit2')} แก้ไข</button>
              <button class="action-btn delete" onclick="deleteReminder('${reminder.id}')">${icon('trash2')} ลบ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open modal
    function openModal(type = null, reminderId = null) {
      editingReminderId = reminderId;
      currentReminderType = type;
      selectedDays.clear();
      selectedFrequency = 'daily';

      // Update modal header
      if (type) {
        document.getElementById('modalHeader').innerHTML = `${icon(typeConfig[type].icon)} เพิ่มเตือน${typeConfig[type].name}`;
      }

      if (reminderId) {
        const reminder = reminders.find(r => r.id === reminderId);
        if (reminder) {
          document.getElementById('reminderTitle').value = reminder.title;
          document.getElementById('reminderTime').value = reminder.custom_time || reminder.time;
          document.getElementById('reminderNote').value = reminder.note || '';

          selectedFrequency = reminder.frequency || 'daily';
          updateFrequencyUI();

          if (reminder.days_of_week && reminder.days_of_week.length > 0) {
            reminder.days_of_week.forEach(day => {
              selectedDays.add(day);
              const el = document.querySelector(`[data-day="${day}"]`);
              if (el) el.classList.add('selected');
            });
          }
        }
      } else {
        document.getElementById('reminderForm').reset();
        document.querySelectorAll('.day-checkbox').forEach(el => {
          el.classList.remove('selected');
        });
        selectedFrequency = 'daily';
        updateFrequencyUI();
      }

      document.getElementById('reminderModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('reminderModal').classList.remove('active');
      editingReminderId = null;
      currentReminderType = null;
      selectedDays.clear();
    }

    // Select frequency
    function selectFrequency(frequency) {
      selectedFrequency = frequency;
      updateFrequencyUI();
    }

    // Update frequency UI
    function updateFrequencyUI() {
      document.querySelectorAll('.frequency-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.frequency === selectedFrequency);
      });

      const daysSelectorGroup = document.getElementById('daysSelectorGroup');
      if (selectedFrequency === 'specific_days') {
        daysSelectorGroup.style.display = 'block';
      } else {
        daysSelectorGroup.style.display = 'none';
        selectedDays.clear();
        document.querySelectorAll('.day-checkbox').forEach(el => {
          el.classList.remove('selected');
        });
      }
    }

    // Day selector
    document.querySelectorAll('.day-checkbox').forEach(el => {
      el.addEventListener('click', () => {
        const day = el.dataset.day;
        if (selectedDays.has(day)) {
          selectedDays.delete(day);
          el.classList.remove('selected');
        } else {
          selectedDays.add(day);
          el.classList.add('selected');
        }
      });
    });

    // Form submission
    document.getElementById('reminderForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (selectedFrequency === 'specific_days' && selectedDays.size === 0) {
        showToast('กรุณาเลือกวันที่ต้องการเตือน', 'error');
        return;
      }

      const timeValue = document.getElementById('reminderTime').value.trim();
      if (!timeValue) {
        showToast('กรุณาระบุเวลาเตือน', 'error');
        return;
      }

      const reminderData = {
        patient_id: patientId,
        type: currentReminderType || (editingReminderId ? reminders.find(r => r.id === editingReminderId)?.type : 'custom'),
        title: document.getElementById('reminderTitle').value,
        time: timeValue,
        custom_time: timeValue,
        note: document.getElementById('reminderNote').value || null,
        frequency: selectedFrequency || 'daily',
        days_of_week: selectedFrequency === 'specific_days' ? JSON.stringify(Array.from(selectedDays)) : null,
        is_active: true
      };

      try {
        if (editingReminderId) {
          const { error } = await supabaseClient
            .from('reminders')
            .update(reminderData)
            .eq('id', editingReminderId);

          if (error) throw error;
          showToast('แก้ไขการเตือนเรียบร้อยแล้ว', 'success');
        } else {
          const { error } = await supabaseClient
            .from('reminders')
            .insert(reminderData);

          if (error) throw error;
          showToast('เพิ่มการเตือนเรียบร้อยแล้ว', 'success');
        }

        await loadReminders();
        closeModal();
      } catch (error) {
        console.error('Error saving reminder:', error);
        showToast('ไม่สามารถบันทึกการเตือนได้: ' + error.message, 'error');
      }
    });

    // Edit reminder
    function editReminder(id) {
      const reminder = reminders.find(r => r.id === id);
      if (reminder) {
        openModal(reminder.reminder_type, id);
      }
    }

    // Delete reminder
    async function deleteReminder(id) {
      if (!confirm('ต้องการลบการเตือนนี้หรือไม่?')) return;

      try {
        const { error } = await supabaseClient
          .from('reminders')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('ลบการเตือนเรียบร้อยแล้ว', 'success');
        await loadReminders();
      } catch (error) {
        console.error('Error deleting reminder:', error);
        showToast('ไม่สามารถลบการเตือนได้', 'error');
      }
    }

    // Toggle reminder
    async function toggleReminder(id, isActive) {
      try {
        const { error } = await supabaseClient
          .from('reminders')
          .update({ is_active: isActive })
          .eq('id', id);

        if (error) throw error;

        await loadReminders();
      } catch (error) {
        console.error('Error toggling reminder:', error);
        showToast('ไม่สามารถเปลี่ยนสถานะได้', 'error');
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Close LIFF
    function closeLiff() {
      liff.closeWindow();
    }

    // Initialize
    window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>
