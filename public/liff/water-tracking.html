<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ - Duulair</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .progress-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }

    .progress-bar-bg {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }

    .water-summary {
      background: #f8f9fa;
      padding: 20px;
      margin: 20px;
      border-radius: 15px;
      text-align: center;
    }

    .water-summary h3 {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 5px;
    }

    .water-summary p {
      color: #666;
      font-size: 14px;
    }

    .quick-add {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px;
    }

    .quick-btn {
      padding: 15px;
      background: white;
      border: 2px solid #667eea;
      border-radius: 10px;
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quick-btn:active {
      background: #667eea;
      color: white;
    }

    .custom-amount {
      margin: 20px;
    }

    .custom-amount input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .add-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .log-list {
      margin: 20px;
    }

    .log-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log-time {
      font-size: 14px;
      color: #999;
    }

    .log-amount {
      font-weight: 600;
      color: #667eea;
    }

    .settings-section {
      margin: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
    }

    .settings-section h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .toggle {
      width: 50px;
      height: 26px;
      background: #ccc;
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.active {
      background: #667eea;
    }

    .toggle::after {
      content: '';
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: left 0.3s;
    }

    .toggle.active::after {
      left: 27px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</h1>
      <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</p>
    </div>

    <!-- Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
        <span id="goalText">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 2000 ml</span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressBar" style="width: 0%">
          <span id="progressText">0%</span>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="water-summary">
      <h3 id="totalAmount">0</h3>
      <p>‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏•‡∏¥‡∏ï‡∏£ (<span id="glassCount">0</span> ‡πÅ‡∏Å‡πâ‡∏ß)</p>
      <p style="margin-top: 10px; color: #667eea; font-weight: 600;">
        <span id="remaining">2000 ml</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
      </p>
    </div>

    <!-- Quick Add -->
    <div class="quick-add">
      <button class="quick-btn" onclick="addWater(250)">250 ml<br>(1 ‡πÅ‡∏Å‡πâ‡∏ß)</button>
      <button class="quick-btn" onclick="addWater(500)">500 ml<br>(2 ‡πÅ‡∏Å‡πâ‡∏ß)</button>
      <button class="quick-btn" onclick="addWater(750)">750 ml<br>(3 ‡πÅ‡∏Å‡πâ‡∏ß)</button>
    </div>

    <!-- Custom Amount -->
    <div class="custom-amount">
      <input type="number" id="customAmount" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (ml)" min="1" max="5000">
      <button class="add-btn" onclick="addCustomWater()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>

    <!-- Today's Log -->
    <div class="log-list">
      <h3 style="margin-bottom: 15px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
      <div id="logContainer">
        <!-- Logs will be loaded here -->
      </div>
    </div>

    <!-- Settings -->
    <div class="settings-section">
      <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
      <div class="setting-item">
        <span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
        <input type="number" id="dailyGoal" value="2000" style="width: 100px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;" onchange="updateGoal()"> ml
      </div>
      <div class="setting-item">
        <span>‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</span>
        <div class="toggle" id="reminderToggle" onclick="toggleReminder()"></div>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = 'YOUR_LIFF_ID'; // Replace with actual LIFF ID
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let patientId = null;
    let groupId = null;
    let dailyGoal = 2000;
    let totalToday = 0;
    let todayLogs = [];

    async function initializeLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get user context (from localStorage or API)
        const context = JSON.parse(localStorage.getItem('duulair_context') || '{}');
        patientId = context.patientId;
        groupId = context.groupId;

        if (!patientId) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
          liff.closeWindow();
          return;
        }

        await loadData();
      } catch (error) {
        console.error('LIFF init error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }

    async function loadData() {
      await loadGoal();
      await loadTodayLogs();
      updateUI();
    }

    async function loadGoal() {
      const { data, error } = await supabase
        .from('water_intake_goals')
        .select('*')
        .eq('patient_id', patientId)
        .single();

      if (data) {
        dailyGoal = data.daily_goal_ml;
        document.getElementById('dailyGoal').value = dailyGoal;

        if (data.reminder_enabled) {
          document.getElementById('reminderToggle').classList.add('active');
        }
      }
    }

    async function loadTodayLogs() {
      const today = new Date().toISOString().split('T')[0];

      const { data, error } = await supabase
        .from('water_intake_logs')
        .select('*')
        .eq('patient_id', patientId)
        .gte('logged_at', `${today}T00:00:00`)
        .lt('logged_at', `${today}T23:59:59`)
        .order('logged_at', { ascending: false });

      if (data) {
        todayLogs = data;
        totalToday = data.reduce((sum, log) => sum + log.amount_ml, 0);
        renderLogs();
      }
    }

    function updateUI() {
      const progress = Math.min(100, Math.round((totalToday / dailyGoal) * 100));
      const remaining = Math.max(0, dailyGoal - totalToday);
      const glasses = Math.round(totalToday / 250);

      document.getElementById('totalAmount').textContent = totalToday;
      document.getElementById('glassCount').textContent = glasses;
      document.getElementById('goalText').textContent = `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${dailyGoal} ml`;
      document.getElementById('remaining').textContent = `${remaining} ml`;
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('progressText').textContent = progress + '%';
    }

    function renderLogs() {
      const container = document.getElementById('logContainer');

      if (todayLogs.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
        return;
      }

      container.innerHTML = todayLogs.map(log => {
        const time = new Date(log.logged_at).toLocaleTimeString('th-TH', {
          hour: '2-digit',
          minute: '2-digit'
        });
        const glasses = Math.round(log.amount_ml / 250);

        return `
          <div class="log-item">
            <div>
              <div class="log-amount">${log.amount_ml} ml (${glasses} ‡πÅ‡∏Å‡πâ‡∏ß)</div>
              <div class="log-time">${time}</div>
            </div>
            <button onclick="deleteLog('${log.id}')" style="background: #ff4444; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">‡∏•‡∏ö</button>
          </div>
        `;
      }).join('');
    }

    async function addWater(amount) {
      const profile = await liff.getProfile();

      const { error } = await supabase
        .from('water_intake_logs')
        .insert([{
          patient_id: patientId,
          group_id: groupId,
          amount_ml: amount,
          logged_by_line_user_id: profile.userId,
          logged_by_display_name: profile.displayName
        }]);

      if (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        return;
      }

      // Also log to activity_logs
      await supabase
        .from('activity_logs')
        .insert([{
          patient_id: patientId,
          group_id: groupId,
          task_type: 'water',
          value: amount.toString(),
          metadata: JSON.stringify({ amount_ml: amount, unit: 'ml' }),
          actor_line_user_id: profile.userId,
          actor_display_name: profile.displayName,
          source: groupId ? 'group' : '1:1'
        }]);

      await loadTodayLogs();
      updateUI();

      // Show success animation
      alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ${amount} ml`);
    }

    async function addCustomWater() {
      const amount = parseInt(document.getElementById('customAmount').value);

      if (!amount || amount <= 0 || amount > 5000) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-5000 ml');
        return;
      }

      await addWater(amount);
      document.getElementById('customAmount').value = '';
    }

    async function updateGoal() {
      const newGoal = parseInt(document.getElementById('dailyGoal').value);

      if (newGoal < 500 || newGoal > 10000) {
        alert('‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 500-10000 ml');
        return;
      }

      dailyGoal = newGoal;

      const { error } = await supabase
        .from('water_intake_goals')
        .upsert([{
          patient_id: patientId,
          daily_goal_ml: newGoal
        }], { onConflict: 'patient_id' });

      if (!error) {
        updateUI();
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      }
    }

    async function toggleReminder() {
      const toggle = document.getElementById('reminderToggle');
      const isActive = toggle.classList.toggle('active');

      const { error } = await supabase
        .from('water_intake_goals')
        .upsert([{
          patient_id: patientId,
          reminder_enabled: isActive
        }], { onConflict: 'patient_id' });

      if (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        toggle.classList.toggle('active');
      }
    }

    async function deleteLog(logId) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ?')) return;

      const { error } = await supabase
        .from('water_intake_logs')
        .delete()
        .eq('id', logId);

      if (!error) {
        await loadTodayLogs();
        updateUI();
      }
    }

    // Initialize
    initializeLIFF();
  </script>
</body>
</html>
