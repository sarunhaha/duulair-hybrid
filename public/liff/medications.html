<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E7B9C">
  <title>รายการยา - OONJAI</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://mqxklnzxfrupwwkwlwwc.supabase.co">

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/oonjai-theme.css">

  <style>
    /* Summary Card */
    .summary-card {
      background: linear-gradient(135deg, hsl(280 60% 50%) 0%, hsl(280 60% 40%) 100%);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 180px;
      height: 180px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .summary-content {
      position: relative;
      z-index: 1;
    }

    .summary-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
    }

    .summary-number {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .summary-unit {
      font-size: 1rem;
      font-weight: 400;
      opacity: 0.9;
    }

    /* Add Button */
    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 1rem;
      background: hsl(var(--primary));
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      margin-bottom: 1.5rem;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-md);
    }

    .add-btn:active {
      transform: scale(0.98);
    }

    .add-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Medication List */
    .medication-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .medication-card {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      transition: all 0.2s ease;
    }

    .medication-card:active {
      box-shadow: var(--shadow-md);
    }

    .medication-header {
      margin-bottom: 0.75rem;
    }

    .medication-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.25rem;
    }

    .medication-dosage {
      color: hsl(var(--muted-foreground));
      font-size: 0.9375rem;
    }

    .medication-schedule {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      color: hsl(var(--muted-foreground));
      font-size: 0.875rem;
    }

    .medication-schedule svg {
      width: 16px;
      height: 16px;
      color: hsl(var(--primary));
    }

    .medication-times {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .time-badge {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    .medication-note {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: hsl(var(--accent) / 0.1);
      border-left: 3px solid hsl(var(--accent));
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }

    .medication-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    .action-btn:active {
      transform: scale(0.97);
    }

    .action-btn.edit {
      background: hsl(210 100% 50%);
      color: white;
    }

    .action-btn.delete {
      background: hsl(0 84% 60%);
      color: white;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      background: hsl(var(--muted));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-icon svg {
      width: 40px;
      height: 40px;
      color: hsl(var(--muted-foreground));
    }

    .empty-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
    }

    .empty-desc {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: hsl(var(--card));
      padding: 1.5rem;
      border-radius: var(--radius-xl);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: hsl(var(--foreground));
    }

    .modal-header svg {
      width: 24px;
      height: 24px;
      color: hsl(var(--primary));
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
    }

    .form-group label .required {
      color: hsl(0 84% 60%);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      font-size: 0.9375rem;
      font-family: 'Kanit', sans-serif;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
      transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: hsl(var(--primary));
    }

    .form-group small {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    .dose-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    /* Frequency Options */
    .frequency-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .frequency-option {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      color: hsl(var(--foreground));
    }

    .frequency-option input[type="radio"] {
      margin-right: 0.75rem;
      width: 18px;
      height: 18px;
      accent-color: hsl(var(--primary));
    }

    .frequency-option.selected {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
    }

    /* Days Selector */
    .days-of-week {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-md);
    }

    .days-of-week.visible {
      display: block;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .day-checkbox {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      background: hsl(var(--card));
      color: hsl(var(--foreground));
    }

    .day-checkbox input {
      margin-right: 0.5rem;
      width: 16px;
      height: 16px;
      accent-color: hsl(var(--primary));
    }

    .day-checkbox.selected {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
    }

    /* Times Selector */
    .times-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .time-checkbox {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border: 2px solid hsl(var(--border));
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      color: hsl(var(--foreground));
    }

    .time-checkbox input {
      margin-right: 0.5rem;
      width: 18px;
      height: 18px;
      accent-color: hsl(var(--primary));
    }

    .time-checkbox.selected {
      background: hsl(var(--primary) / 0.1);
      border-color: hsl(var(--primary));
    }

    /* Reminder Toggle */
    .reminder-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: hsl(var(--muted));
      border-radius: var(--radius-md);
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: hsl(var(--muted-foreground));
      transition: 0.4s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: hsl(var(--primary));
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Modal Actions */
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    @media (max-width: 480px) {
      .times-selector,
      .days-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">กำลังโหลด...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <button class="btn-icon" onclick="goBack()" aria-label="กลับ" id="backBtn"></button>
        <h1 class="header-title" id="headerTitle"></h1>
        <button class="btn-icon" onclick="darkMode.toggle()" aria-label="สลับธีม" id="themeBtn"></button>
      </header>

      <!-- Summary Card -->
      <div class="summary-card">
        <div class="summary-content">
          <div class="summary-label">รายการยาทั้งหมด</div>
          <div class="summary-number" id="medicationCount">0 <span class="summary-unit">รายการ</span></div>
        </div>
      </div>

      <!-- Add Button -->
      <button class="add-btn" onclick="openModal()" id="addBtn">
        เพิ่มรายการยา
      </button>

      <!-- Medication List -->
      <div id="medicationList" class="medication-list"></div>

      <!-- Empty State -->
      <div id="emptyState" class="empty-state hidden">
        <div class="empty-icon" id="emptyIcon"></div>
        <p class="empty-title">ยังไม่มีรายการยา</p>
        <p class="empty-desc">กดปุ่มด้านบนเพื่อเพิ่มยา</p>
      </div>

      <!-- Close Button -->
      <div style="padding-top: 1rem;">
        <button class="btn btn-secondary btn-block" onclick="goBack()">กลับ</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Medication Modal -->
  <div id="medicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader"></div>

      <form id="medicationForm">
        <div class="form-group">
          <label>ชื่อยา <span class="required">*</span></label>
          <input type="text" id="medicationName" required placeholder="เช่น ยาลดความดัน">
        </div>

        <div class="form-group">
          <label>รูปแบบยา <span class="required">*</span></label>
          <select id="dosageForm" required>
            <option value="tablet">เม็ด (Tablet)</option>
            <option value="capsule">แคปซูล (Capsule)</option>
            <option value="liquid">น้ำ (Liquid)</option>
            <option value="injection">ฉีด (Injection)</option>
            <option value="topical">ทา (Topical)</option>
          </select>
        </div>

        <div class="form-group">
          <label>จำนวนยาต่อครั้ง <span class="required">*</span></label>
          <div class="dose-input-group">
            <select id="dosageAmount" required>
              <option value="0.25">1/4 เม็ด</option>
              <option value="0.5">1/2 เม็ด</option>
              <option value="0.75">3/4 เม็ด</option>
              <option value="1" selected>1 เม็ด</option>
              <option value="1.5">1.5 เม็ด</option>
              <option value="2">2 เม็ด</option>
              <option value="2.5">2.5 เม็ด</option>
              <option value="3">3 เม็ด</option>
            </select>
            <select id="dosageUnit">
              <option value="tablet">เม็ด</option>
              <option value="capsule">แคปซูล</option>
              <option value="ml">ml</option>
            </select>
          </div>
          <small>เลือกจำนวนยาที่ต้องทานต่อครั้ง</small>
        </div>

        <div class="form-group">
          <label>ความถี่</label>
          <div class="frequency-options">
            <label class="frequency-option">
              <input type="radio" name="frequency" value="daily" checked>
              <span>ทุกวัน (Daily)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="specific_days">
              <span>เลือกวัน (Specific Days)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="weekly">
              <span>สัปดาห์ละ X วัน (Weekly)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="as_needed">
              <span>เมื่อจำเป็น (As Needed)</span>
            </label>
          </div>
        </div>

        <div id="daysOfWeek" class="days-of-week">
          <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">เลือกวัน</label>
          <div class="days-grid">
            <label class="day-checkbox"><input type="checkbox" value="monday"><span>จันทร์</span></label>
            <label class="day-checkbox"><input type="checkbox" value="tuesday"><span>อังคาร</span></label>
            <label class="day-checkbox"><input type="checkbox" value="wednesday"><span>พุธ</span></label>
            <label class="day-checkbox"><input type="checkbox" value="thursday"><span>พฤหัสบดี</span></label>
            <label class="day-checkbox"><input type="checkbox" value="friday"><span>ศุกร์</span></label>
            <label class="day-checkbox"><input type="checkbox" value="saturday"><span>เสาร์</span></label>
            <label class="day-checkbox"><input type="checkbox" value="sunday"><span>อาทิตย์</span></label>
          </div>
        </div>

        <div class="form-group">
          <label>เวลาทานยา <span class="required">*</span></label>
          <div class="times-selector">
            <label class="time-checkbox"><input type="checkbox" value="morning"><span>เช้า (08:00)</span></label>
            <label class="time-checkbox"><input type="checkbox" value="afternoon"><span>กลางวัน (12:00)</span></label>
            <label class="time-checkbox"><input type="checkbox" value="evening"><span>เย็น (18:00)</span></label>
            <label class="time-checkbox"><input type="checkbox" value="night"><span>ก่อนนอน (21:00)</span></label>
          </div>
          <small>เลือกเวลาที่ต้องทานยา</small>
        </div>

        <div class="form-group">
          <label>วิธีรับประทาน</label>
          <select id="medicationInstructions">
            <option value="">เลือกวิธีรับประทาน</option>
            <option value="ก่อนอาหาร">ก่อนอาหาร</option>
            <option value="หลังอาหาร">หลังอาหาร</option>
            <option value="ระหว่างอาหาร">ระหว่างอาหาร</option>
            <option value="ห่างอาหาร">ห่างอาหาร</option>
          </select>
        </div>

        <div class="form-group">
          <label>หมายเหตุ</label>
          <textarea id="medicationNote" placeholder="เช่น ทานพร้อมน้ำมากๆ"></textarea>
        </div>

        <div class="form-group">
          <div class="reminder-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="reminderEnabled" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>เปิดการเตือน</span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lucide Icons -->
  <script src="js/lucide-icons.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const LIFF_ID = '2008278683-5k69jxNq';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let patientId = null;
    let medications = [];
    let editingMedicationId = null;
    let isGroupContext = false;

    // Time labels
    const timeLabels = {
      morning: 'เช้า',
      afternoon: 'กลางวัน',
      evening: 'เย็น',
      night: 'ก่อนนอน'
    };

    const thaiDays = {
      monday: 'จันทร์',
      tuesday: 'อังคาร',
      wednesday: 'พุธ',
      thursday: 'พฤหัสบดี',
      friday: 'ศุกร์',
      saturday: 'เสาร์',
      sunday: 'อาทิตย์'
    };

    // Initialize icons and UI immediately
    (function initUI() {
      // Initialize dark mode
      darkMode.init();

      // Set icons
      document.getElementById('backBtn').innerHTML = icon('arrowLeft');
      document.getElementById('headerTitle').innerHTML = icon('pill', 'inline-icon') + ' รายการยา';
      document.getElementById('themeBtn').innerHTML = icon('sun');
      document.getElementById('addBtn').innerHTML = icon('plus') + ' เพิ่มรายการยา';
      document.getElementById('emptyIcon').innerHTML = icon('pill');
      document.getElementById('modalHeader').innerHTML = icon('pill') + ' เพิ่ม/แก้ไขรายการยา';

      // Show UI immediately!
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    })();

    // Update theme icon
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('themeBtn').innerHTML = isDark ? icon('moon') : icon('sun');
    }

    const originalToggle = darkMode.toggle;
    darkMode.toggle = function() {
      originalToggle.call(darkMode);
      updateThemeIcon();
    };

    setTimeout(updateThemeIcon, 100);

    // Cache LIFF profile
    async function getCachedProfile() {
      const cached = sessionStorage.getItem('liff_profile');
      const cacheTime = sessionStorage.getItem('liff_profile_time');
      const ONE_HOUR = 60 * 60 * 1000;

      if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < ONE_HOUR) {
        return JSON.parse(cached);
      }

      const profile = await liff.getProfile();
      sessionStorage.setItem('liff_profile', JSON.stringify(profile));
      sessionStorage.setItem('liff_profile_time', Date.now().toString());
      return profile;
    }

    // Check registration
    async function checkUserRegistration(lineUserId) {
      if (sessionStorage.getItem('user_registered') === 'true') {
        return true;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/check-user/${lineUserId}`);
        const result = await response.json();

        if (!result.exists) {
          setTimeout(() => {
            window.location.href = '/liff/index.html';
          }, 1000);
          return false;
        }

        sessionStorage.setItem('user_registered', 'true');
        return true;
      } catch (error) {
        console.error('Error checking registration:', error);
        return true;
      }
    }

    // Format dosage
    function formatDosage(amount, unit, form) {
      if (form === 'tablet' || form === 'capsule') {
        if (amount === 0.25) return '1/4 เม็ด';
        if (amount === 0.5) return '1/2 เม็ด';
        if (amount === 0.75) return '3/4 เม็ด';
        if (amount === 1) return '1 เม็ด';
        if (amount === 1.5) return '1.5 เม็ด';
        return `${amount} เม็ด`;
      }
      if (form === 'liquid' && unit === 'ml') {
        return `${amount} ml`;
      }
      return `${amount} ${unit}`;
    }

    // Get schedule description
    function getScheduleDescription(med) {
      if (med.frequency === 'daily') return 'ทุกวัน';
      if (med.frequency === 'specific_days' && med.days_of_week) {
        const days = med.days_of_week.map(d => thaiDays[d]).join(', ');
        return days;
      }
      if (med.frequency === 'weekly' && med.days_of_week) {
        return `สัปดาห์ละ ${med.days_of_week.length} วัน`;
      }
      if (med.frequency === 'as_needed') return 'เมื่อจำเป็น';
      return 'ตามแพทย์สั่ง';
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await getCachedProfile();
        checkUserRegistration(profile.userId).catch(err => console.error('Registration check error:', err));

        const context = liff.getContext();
        isGroupContext = context && context.type === 'group';

        if (isGroupContext) {
          const groupId = context.groupId;
          await loadGroupData(groupId);
        } else {
          await loadUserData();
        }
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        showToast('ไม่สามารถเชื่อมต่อ LINE ได้', 'error');
      }
    }

    // Load group data
    async function loadGroupData(groupId) {
      try {
        const { data: group, error: groupError } = await supabaseClient
          .from('caregiver_groups')
          .select('patient_id')
          .eq('line_group_id', groupId)
          .single();

        if (groupError) throw groupError;
        if (!group) {
          showToast('ไม่พบข้อมูลกลุ่ม กรุณาลงทะเบียนก่อน', 'error');
          return;
        }

        patientId = group.patient_id;
        await loadMedications();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        let contextData = JSON.parse(localStorage.getItem('oonjai_context') || '{}');
        patientId = contextData.patientId;

        if (!patientId) {
          const profile = await liff.getProfile();
          const response = await fetch(`${API_BASE_URL}/check-user/${profile.userId}`);
          const result = await response.json();

          if (result.exists && result.profile) {
            if (result.role === 'patient') {
              patientId = result.profile.profile_id;
              localStorage.setItem('oonjai_context', JSON.stringify({ patientId, role: 'patient' }));
            } else if (result.role === 'caregiver' && result.profile.linked_patient_id) {
              patientId = result.profile.linked_patient_id;
              localStorage.setItem('oonjai_context', JSON.stringify({
                caregiverId: result.profile.profile_id,
                patientId,
                role: 'caregiver'
              }));
            }
          }
        }

        if (!patientId) {
          showToast('ไม่พบข้อมูลผู้ใช้ กรุณาลงทะเบียนก่อน', 'error');
          return;
        }

        await loadMedications();
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
      }
    }

    // Load medications
    async function loadMedications() {
      try {
        const { data, error } = await supabaseClient
          .from('medications')
          .select('*')
          .eq('patient_id', patientId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        medications = (data || []).map(med => ({
          ...med,
          days_of_week: med.days_of_week ? (typeof med.days_of_week === 'string' ? JSON.parse(med.days_of_week) : med.days_of_week) : undefined,
          times: med.times ? (typeof med.times === 'string' ? JSON.parse(med.times) : med.times) : []
        }));
        renderMedications();
      } catch (error) {
        console.error('Error loading medications:', error);
        showToast('ไม่สามารถโหลดรายการยาได้', 'error');
      }
    }

    // Render medications
    function renderMedications() {
      const container = document.getElementById('medicationList');
      const emptyState = document.getElementById('emptyState');
      const countEl = document.getElementById('medicationCount');

      countEl.innerHTML = `${medications.length} <span class="summary-unit">รายการ</span>`;

      if (medications.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.innerHTML = medications.map(med => {
        const times = med.times || [];
        const dosageDisplay = formatDosage(
          parseFloat(med.dosage_amount),
          med.dosage_unit || 'tablet',
          med.dosage_form || 'tablet'
        );
        const schedule = getScheduleDescription(med);

        return `
          <div class="medication-card">
            <div class="medication-header">
              <div class="medication-name">${med.name}</div>
              <div class="medication-dosage">${dosageDisplay}</div>
              <div class="medication-schedule">
                ${icon('calendar')} ${schedule}
              </div>
            </div>

            <div class="medication-times">
              ${times.map(time => `<span class="time-badge">${timeLabels[time]}</span>`).join('')}
            </div>

            ${med.instructions ? `<div style="margin-top: 0.5rem; color: hsl(var(--muted-foreground)); font-size: 0.875rem;">${icon('info', 'inline-icon')} ${med.instructions}</div>` : ''}

            ${med.note ? `<div class="medication-note">${icon('lightbulb', 'inline-icon')} ${med.note}</div>` : ''}

            <div class="medication-actions">
              <button class="action-btn edit" onclick="editMedication('${med.id}')">${icon('edit2')} แก้ไข</button>
              <button class="action-btn delete" onclick="deleteMedication('${med.id}')">${icon('trash2')} ลบ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open modal
    function openModal(medicationId = null) {
      editingMedicationId = medicationId;

      if (medicationId) {
        const medication = medications.find(m => m.id === medicationId);
        if (medication) {
          document.getElementById('medicationName').value = medication.name;
          document.getElementById('dosageForm').value = medication.dosage_form || 'tablet';
          document.getElementById('dosageAmount').value = medication.dosage_amount;
          document.getElementById('dosageUnit').value = medication.dosage_unit || 'tablet';
          document.getElementById('medicationInstructions').value = medication.instructions || '';
          document.getElementById('medicationNote').value = medication.note || '';
          document.getElementById('reminderEnabled').checked = medication.reminder_enabled !== false;

          const freqRadio = document.querySelector(`input[name="frequency"][value="${medication.frequency || 'daily'}"]`);
          if (freqRadio) {
            freqRadio.checked = true;
            updateFrequencySelection();
          }

          document.querySelectorAll('.days-grid input[type="checkbox"]').forEach(cb => {
            cb.checked = (medication.days_of_week || []).includes(cb.value);
            if (cb.checked) cb.parentElement.classList.add('selected');
          });

          document.querySelectorAll('.times-selector input[type="checkbox"]').forEach(cb => {
            cb.checked = (medication.times || []).includes(cb.value);
            if (cb.checked) cb.parentElement.classList.add('selected');
          });

          updateDosageDisplay();
        }
      } else {
        document.getElementById('medicationForm').reset();
        document.querySelectorAll('.times-selector input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          cb.parentElement.classList.remove('selected');
        });
        document.querySelectorAll('.days-grid input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          cb.parentElement.classList.remove('selected');
        });
        document.getElementById('reminderEnabled').checked = true;
        updateFrequencySelection();
        updateDosageDisplay();
      }

      document.getElementById('medicationModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('medicationModal').classList.remove('active');
      editingMedicationId = null;
    }

    // Update frequency selection
    function updateFrequencySelection() {
      const selected = document.querySelector('input[name="frequency"]:checked');
      const daysContainer = document.getElementById('daysOfWeek');

      document.querySelectorAll('.frequency-option').forEach(opt => {
        opt.classList.remove('selected');
      });

      if (selected) {
        selected.closest('.frequency-option').classList.add('selected');
        if (selected.value === 'specific_days' || selected.value === 'weekly') {
          daysContainer.classList.add('visible');
        } else {
          daysContainer.classList.remove('visible');
        }
      }
    }

    // Update dosage display
    function updateDosageDisplay() {
      const form = document.getElementById('dosageForm').value;
      const amountSelect = document.getElementById('dosageAmount');
      const unitSelect = document.getElementById('dosageUnit');

      if (form === 'liquid') {
        amountSelect.innerHTML = `
          <option value="2.5">2.5 ml</option>
          <option value="5">5 ml</option>
          <option value="7.5">7.5 ml</option>
          <option value="10">10 ml</option>
          <option value="15">15 ml</option>
          <option value="20">20 ml</option>
          <option value="30">30 ml</option>
        `;
        unitSelect.value = 'ml';
      } else {
        amountSelect.innerHTML = `
          <option value="0.25">1/4 เม็ด</option>
          <option value="0.5">1/2 เม็ด</option>
          <option value="0.75">3/4 เม็ด</option>
          <option value="1" selected>1 เม็ด</option>
          <option value="1.5">1.5 เม็ด</option>
          <option value="2">2 เม็ด</option>
          <option value="2.5">2.5 เม็ด</option>
          <option value="3">3 เม็ด</option>
        `;
        unitSelect.value = form === 'capsule' ? 'capsule' : 'tablet';
      }
    }

    // Event listeners for checkboxes
    document.querySelectorAll('.time-checkbox input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        e.target.parentElement.classList.toggle('selected', e.target.checked);
      });
    });

    document.querySelectorAll('.day-checkbox input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        e.target.parentElement.classList.toggle('selected', e.target.checked);
      });
    });

    document.querySelectorAll('input[name="frequency"]').forEach(radio => {
      radio.addEventListener('change', updateFrequencySelection);
    });

    document.getElementById('dosageForm').addEventListener('change', updateDosageDisplay);

    // Form submission
    document.getElementById('medicationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const frequency = document.querySelector('input[name="frequency"]:checked').value;
      const selectedTimes = Array.from(
        document.querySelectorAll('.times-selector input[type="checkbox"]:checked')
      ).map(cb => cb.value);

      if (selectedTimes.length === 0 && frequency !== 'as_needed') {
        showToast('กรุณาเลือกเวลาทานยาอย่างน้อย 1 เวลา', 'error');
        return;
      }

      const selectedDays = Array.from(
        document.querySelectorAll('.days-grid input[type="checkbox"]:checked')
      ).map(cb => cb.value);

      if ((frequency === 'specific_days' || frequency === 'weekly') && selectedDays.length === 0) {
        showToast('กรุณาเลือกวันอย่างน้อย 1 วัน', 'error');
        return;
      }

      const medicationData = {
        patient_id: patientId,
        name: document.getElementById('medicationName').value,
        dosage_amount: parseFloat(document.getElementById('dosageAmount').value),
        dosage_form: document.getElementById('dosageForm').value,
        dosage_unit: document.getElementById('dosageUnit').value,
        frequency: frequency,
        days_of_week: (frequency === 'specific_days' || frequency === 'weekly') ? selectedDays : null,
        times: selectedTimes,
        instructions: document.getElementById('medicationInstructions').value,
        note: document.getElementById('medicationNote').value,
        reminder_enabled: document.getElementById('reminderEnabled').checked
      };

      try {
        if (editingMedicationId) {
          const { error } = await supabaseClient
            .from('medications')
            .update(medicationData)
            .eq('id', editingMedicationId);

          if (error) throw error;
          showToast('แก้ไขรายการยาเรียบร้อยแล้ว', 'success');
        } else {
          const { error } = await supabaseClient
            .from('medications')
            .insert(medicationData);

          if (error) throw error;
          showToast('เพิ่มรายการยาเรียบร้อยแล้ว', 'success');
        }

        await loadMedications();
        closeModal();
      } catch (error) {
        console.error('Error saving medication:', error);
        showToast('ไม่สามารถบันทึกรายการยาได้: ' + error.message, 'error');
      }
    });

    // Edit medication
    function editMedication(id) {
      openModal(id);
    }

    // Delete medication
    async function deleteMedication(id) {
      if (!confirm('ต้องการลบรายการยานี้หรือไม่?')) return;

      try {
        const { error } = await supabaseClient
          .from('medications')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('ลบรายการยาเรียบร้อยแล้ว', 'success');
        await loadMedications();
      } catch (error) {
        console.error('Error deleting medication:', error);
        showToast('ไม่สามารถลบรายการยาได้', 'error');
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Go back
    function goBack() {
      const returnTo = sessionStorage.getItem('liff_return_to');
      if (returnTo) {
        sessionStorage.removeItem('liff_return_to');
        const basePath = window.location.pathname.replace(/[^/]*$/, '');
        window.location.href = basePath + returnTo;
      } else {
        liff.closeWindow();
      }
    }

    // Initialize
    window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>
