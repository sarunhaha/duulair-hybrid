<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FAF9F6">
  <title>üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ - Duulair</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/utils.js"></script>
  <link rel="stylesheet" href="css/minimal-theme.css">
  <style>
    /* Medications-specific styles */
    .summary-card {
      background: linear-gradient(135deg, #E8B4A8 0%, #D4A59A 100%);
      color: white;
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .summary-card h3 {
      font-size: 15px;
      opacity: 0.95;
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
    }

    .summary-card .number {
      font-size: 42px;
      font-weight: 700;
    }

    .add-medication-btn {
      width: 100%;
      padding: 15px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: var(--spacing-lg);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .add-medication-btn:active {
      transform: scale(0.98);
      box-shadow: var(--shadow-md);
    }

    .medication-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .medication-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }

    .medication-card:active {
      box-shadow: var(--shadow-md);
    }

    .medication-header {
      margin-bottom: var(--spacing-md);
    }

    .medication-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .medication-dosage {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .medication-schedule {
      margin-top: var(--spacing-sm);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .medication-times {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-top: var(--spacing-sm);
    }

    .time-badge {
      background: linear-gradient(135deg, #B4D4E8 0%, #A8D5BA 100%);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
    }

    .medication-note {
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: rgba(247, 197, 159, 0.2);
      border-left: 3px solid var(--warning);
      border-radius: var(--radius-sm);
      font-size: 14px;
      color: #B88A5F;
    }

    .medication-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .btn-icon {
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      flex: 1;
    }

    .btn-edit {
      background: var(--info);
      color: white;
    }

    .btn-edit:active {
      transform: scale(0.97);
    }

    .btn-delete {
      background: var(--error);
      color: white;
    }

    .btn-delete:active {
      transform: scale(0.97);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: var(--spacing-md);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }

    .label-with-tooltip {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      color: white;
      border-radius: var(--radius-full);
      font-size: 12px;
      cursor: help;
      position: relative;
    }

    .tooltip-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      white-space: nowrap;
      z-index: 1001;
    }

    .dose-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
    }

    .liquid-display {
      display: none;
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: rgba(180, 212, 232, 0.2);
      border-radius: var(--radius-sm);
      font-size: 14px;
      color: #5A8BA8;
    }

    .frequency-options {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .frequency-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .frequency-option input[type="radio"] {
      margin-right: var(--spacing-sm);
      width: 20px;
      height: 20px;
    }

    .frequency-option.selected {
      background: rgba(232, 180, 168, 0.15);
      border-color: var(--accent-primary);
    }

    .days-of-week {
      display: none;
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
    }

    .days-of-week.visible {
      display: block;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .day-checkbox {
      display: flex;
      align-items: center;
      padding: var(--spacing-sm);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-card);
    }

    .day-checkbox input {
      margin-right: var(--spacing-xs);
      width: 18px;
      height: 18px;
    }

    .day-checkbox.selected {
      background: rgba(232, 180, 168, 0.15);
      border-color: var(--accent-primary);
    }

    .times-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .time-checkbox {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-checkbox input {
      margin-right: var(--spacing-sm);
      width: 20px;
      height: 20px;
    }

    .time-checkbox.selected {
      background: rgba(232, 180, 168, 0.15);
      border-color: var(--accent-primary);
    }

    .reminder-toggle {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent-primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .modal-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
    }

    @media (max-width: 480px) {
      .summary-card .number {
        font-size: 36px;
      }

      .medication-name {
        font-size: 18px;
      }

      .times-selector,
      .days-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Error & Success Messages -->
    <div id="error" class="alert alert-error" style="display: none;"></div>
    <div id="success" class="alert alert-success" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="header">
        <h1>üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</h1>
        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</p>
      </div>

      <!-- Summary Card -->
      <div class="summary-card">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="number" id="medication-count">0</div>
      </div>

      <!-- Add Button -->
      <button class="add-medication-btn" onclick="openModal()">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤
      </button>

      <!-- Medication List -->
      <div id="medication-list" class="medication-list"></div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state hidden">
        <div class="icon">üíä</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</p>
        <p class="text-small text-muted mt-2">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</p>
      </div>

      <button class="btn btn-secondary btn-block mt-3" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Add/Edit Medication Modal -->
  <div id="medication-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>

      <form id="medication-form">
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ <span class="required">*</span></label>
          <input type="text" id="medicationName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô">
        </div>

        <div class="form-group">
          <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏¢‡∏≤ <span class="required">*</span></label>
          <select id="dosageForm" required>
            <option value="tablet">‡πÄ‡∏°‡πá‡∏î (Tablet)</option>
            <option value="capsule">‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏• (Capsule)</option>
            <option value="liquid">‡∏ô‡πâ‡∏≥ (Liquid)</option>
            <option value="injection">‡∏â‡∏µ‡∏î (Injection)</option>
            <option value="topical">‡∏ó‡∏≤ (Topical)</option>
          </select>
        </div>

        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á <span class="required">*</span></label>
          <div class="dose-input-group">
            <select id="dosageAmount" required>
              <option value="0.25">¬º ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="0.5">¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="0.75">¬æ ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="1" selected>1 ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="1.5">1¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="2">2 ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="2.5">2¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
              <option value="3">3 ‡πÄ‡∏°‡πá‡∏î</option>
            </select>
            <select id="dosageUnit">
              <option value="tablet">‡πÄ‡∏°‡πá‡∏î</option>
              <option value="capsule">‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏•</option>
              <option value="ml">ml</option>
            </select>
          </div>
          <div id="liquidDisplay" class="liquid-display"></div>
          <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small>
        </div>

        <div class="form-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <div class="frequency-options">
            <label class="frequency-option">
              <input type="radio" name="frequency" value="daily" checked>
              <span>‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (Daily)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="specific_days">
              <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (Specific Days)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="weekly">
              <span>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ X ‡∏ß‡∏±‡∏ô (Weekly)</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="frequency" value="as_needed">
              <span>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (As Needed)</span>
            </label>
          </div>
        </div>

        <div id="daysOfWeek" class="days-of-week">
          <label style="font-weight: 600; margin-bottom: 10px; display: block;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label>
          <div class="days-grid">
            <label class="day-checkbox">
              <input type="checkbox" value="monday">
              <span>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="tuesday">
              <span>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="wednesday">
              <span>‡∏û‡∏∏‡∏ò</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="thursday">
              <span>‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="friday">
              <span>‡∏®‡∏∏‡∏Å‡∏£‡πå</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="saturday">
              <span>‡πÄ‡∏™‡∏≤‡∏£‡πå</span>
            </label>
            <label class="day-checkbox">
              <input type="checkbox" value="sunday">
              <span>‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤ <span class="required">*</span></label>
          <div class="times-selector">
            <label class="time-checkbox">
              <input type="checkbox" value="morning">
              <span>üåÖ ‡πÄ‡∏ä‡πâ‡∏≤ (08:00)</span>
            </label>
            <label class="time-checkbox">
              <input type="checkbox" value="afternoon">
              <span>‚òÄÔ∏è ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (12:00)</span>
            </label>
            <label class="time-checkbox">
              <input type="checkbox" value="evening">
              <span>üåÜ ‡πÄ‡∏¢‡πá‡∏ô (18:00)</span>
            </label>
            <label class="time-checkbox">
              <input type="checkbox" value="night">
              <span>üåô ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô (21:00)</span>
            </label>
          </div>
          <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</small>
        </div>

        <div class="form-group">
          <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</label>
          <select id="medicationInstructions">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</option>
            <option value="‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option value="‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option value="‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option value="‡∏´‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏´‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          </select>
        </div>

        <div class="form-group">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea id="medicationNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å ‡πÜ"></textarea>
        </div>

        <div class="form-group">
          <div class="reminder-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="reminderEnabled" checked>
              <span class="toggle-slider"></span>
            </label>
            <div class="label-with-tooltip">
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
              <span class="tooltip-icon" data-tooltip="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î">?</span>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://mqxklnzxfrupwwkwlwwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeGtsbnp4ZnJ1cHd3a3dsd3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjcxMjYsImV4cCI6MjA3MjY0MzEyNn0.vPBkIGHdvrfotD3QMnFGrNRMTP3fFzn715XGwqKG-6Y';
    const LIFF_ID = '2008278683-5k69jxNq';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let liffId = null;
    let groupId = null;
    let patientId = null;
    let medications = [];
    let editingMedicationId = null;
    let isGroupContext = false;

    const timeLabels = {
      morning: 'üåÖ ‡πÄ‡∏ä‡πâ‡∏≤',
      afternoon: '‚òÄÔ∏è ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô',
      evening: 'üåÜ ‡πÄ‡∏¢‡πá‡∏ô',
      night: 'üåô ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'
    };

    const thaiDays = {
      monday: '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',
      tuesday: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',
      wednesday: '‡∏û‡∏∏‡∏ò',
      thursday: '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',
      friday: '‡∏®‡∏∏‡∏Å‡∏£‡πå',
      saturday: '‡πÄ‡∏™‡∏≤‡∏£‡πå',
      sunday: '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'
    };

    // Format dosage display
    function formatDosage(amount, unit, form) {
      if (form === 'tablet' || form === 'capsule') {
        if (amount === 0.25) return '¬º ‡πÄ‡∏°‡πá‡∏î';
        if (amount === 0.5) return '¬Ω ‡πÄ‡∏°‡πá‡∏î';
        if (amount === 0.75) return '¬æ ‡πÄ‡∏°‡πá‡∏î';
        if (amount === 1) return '1 ‡πÄ‡∏°‡πá‡∏î';
        if (amount === 1.5) return '1¬Ω ‡πÄ‡∏°‡πá‡∏î';
        return `${amount} ‡πÄ‡∏°‡πá‡∏î`;
      }

      if (form === 'liquid' && unit === 'ml') {
        const teaspoons = amount / 5;
        const tablespoons = amount / 15;

        if (amount === 5) return '5 ml (1 ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤)';
        if (amount === 15) return '15 ml (1 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞)';
        if (amount % 5 === 0 && teaspoons < 3) {
          return `${amount} ml (${teaspoons} ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤)`;
        }
        if (amount % 15 === 0) {
          return `${amount} ml (${tablespoons} ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞)`;
        }
        return `${amount} ml`;
      }

      return `${amount} ${unit}`;
    }

    // Get schedule description
    function getScheduleDescription(med) {
      if (med.frequency === 'daily') {
        return '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô';
      }
      if (med.frequency === 'specific_days' && med.days_of_week) {
        const days = med.days_of_week.map(d => thaiDays[d]).join(', ');
        return days;
      }
      if (med.frequency === 'weekly' && med.days_of_week) {
        return `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ ${med.days_of_week.length} ‡∏ß‡∏±‡∏ô`;
      }
      if (med.frequency === 'as_needed') {
        return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô';
      }
      return '‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á';
    }

    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // Get user profile
        const profile = await liff.getProfile();

        // Check if user is registered (first-time detection)
        const isRegistered = await checkUserRegistration(profile.userId);

        // If not registered, checkUserRegistration will redirect automatically
        if (!isRegistered) {
          return;
        }

        const context = liff.getContext();
        isGroupContext = context && context.type === 'group';

        if (isGroupContext) {
          groupId = context.groupId;
          await loadGroupData();
        } else {
          await loadUserData();
        }
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ');
      }
    }

    // Load group and medications data
    async function loadGroupData() {
      try {
        const { data: group, error: groupError } = await supabaseClient
          .from('caregiver_groups')
          .select('patient_id')
          .eq('line_group_id', groupId)
          .single();

        if (groupError) throw groupError;
        if (!group) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }

        patientId = group.patient_id;
        await loadMedications();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading data:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        const userData = JSON.parse(localStorage.getItem('duulair_user') || '{}');

        if (!userData.profile_id) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
          setTimeout(() => {
            window.location.href = '/liff/group-registration.html';
          }, 2000);
          return;
        }

        patientId = userData.profile_id;
        await loadMedications();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading user data:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
      }
    }

    // Load medications
    async function loadMedications() {
      try {
        const { data, error } = await supabaseClient
          .from('medications')
          .select('*')
          .eq('patient_id', patientId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        medications = (data || []).map(med => ({
          ...med,
          days_of_week: med.days_of_week ? (typeof med.days_of_week === 'string' ? JSON.parse(med.days_of_week) : med.days_of_week) : undefined,
          times: med.times ? (typeof med.times === 'string' ? JSON.parse(med.times) : med.times) : []
        }));
        renderMedications();
      } catch (error) {
        console.error('Error loading medications:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÑ‡∏î‡πâ');
      }
    }

    // Render medications list
    function renderMedications() {
      const container = document.getElementById('medication-list');
      const emptyState = document.getElementById('empty-state');
      const countEl = document.getElementById('medication-count');

      countEl.textContent = medications.length;

      if (medications.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.innerHTML = medications.map(med => {
        const times = med.times || [];
        const dosageDisplay = formatDosage(
          parseFloat(med.dosage_amount),
          med.dosage_unit || 'tablet',
          med.dosage_form || 'tablet'
        );
        const schedule = getScheduleDescription(med);

        return `
          <div class="medication-card">
            <div class="medication-header">
              <div>
                <div class="medication-name">${med.name}</div>
                <div class="medication-dosage">${dosageDisplay}</div>
                <div class="medication-schedule">üìÖ ${schedule}</div>
              </div>
            </div>

            <div class="medication-times">
              ${times.map(time => `<span class="time-badge">${timeLabels[time]}</span>`).join('')}
            </div>

            ${med.instructions ? `<div style="margin-top: 10px; color: var(--text-secondary); font-size: 14px;">üìù ${med.instructions}</div>` : ''}

            ${med.note ? `<div class="medication-note">üí° ${med.note}</div>` : ''}

            <div class="medication-actions">
              <button class="btn-icon btn-edit" onclick="editMedication('${med.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn-icon btn-delete" onclick="deleteMedication('${med.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open modal
    function openModal(medicationId = null) {
      editingMedicationId = medicationId;

      if (medicationId) {
        const medication = medications.find(m => m.id === medicationId);
        if (medication) {
          document.getElementById('medicationName').value = medication.name;
          document.getElementById('dosageForm').value = medication.dosage_form || 'tablet';
          document.getElementById('dosageAmount').value = medication.dosage_amount;
          document.getElementById('dosageUnit').value = medication.dosage_unit || 'tablet';
          document.getElementById('medicationInstructions').value = medication.instructions || '';
          document.getElementById('medicationNote').value = medication.note || '';
          document.getElementById('reminderEnabled').checked = medication.reminder_enabled !== false;

          // Set frequency
          const freqRadio = document.querySelector(`input[name="frequency"][value="${medication.frequency || 'daily'}"]`);
          if (freqRadio) {
            freqRadio.checked = true;
            updateFrequencySelection();
          }

          // Select days
          document.querySelectorAll('.days-grid input[type="checkbox"]').forEach(cb => {
            cb.checked = (medication.days_of_week || []).includes(cb.value);
            if (cb.checked) {
              cb.parentElement.classList.add('selected');
            }
          });

          // Select times
          document.querySelectorAll('.times-selector input[type="checkbox"]').forEach(cb => {
            cb.checked = (medication.times || []).includes(cb.value);
            if (cb.checked) {
              cb.parentElement.classList.add('selected');
            }
          });

          updateDosageDisplay();
        }
      } else {
        document.getElementById('medication-form').reset();
        document.querySelectorAll('.times-selector input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          cb.parentElement.classList.remove('selected');
        });
        document.querySelectorAll('.days-grid input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          cb.parentElement.classList.remove('selected');
        });
        document.getElementById('reminderEnabled').checked = true;
        updateFrequencySelection();
        updateDosageDisplay();
      }

      document.getElementById('medication-modal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('medication-modal').classList.remove('active');
      editingMedicationId = null;
    }

    // Update frequency selection UI
    function updateFrequencySelection() {
      const selected = document.querySelector('input[name="frequency"]:checked');
      const daysContainer = document.getElementById('daysOfWeek');

      document.querySelectorAll('.frequency-option').forEach(opt => {
        opt.classList.remove('selected');
      });

      if (selected) {
        selected.closest('.frequency-option').classList.add('selected');

        if (selected.value === 'specific_days' || selected.value === 'weekly') {
          daysContainer.classList.add('visible');
        } else {
          daysContainer.classList.remove('visible');
        }
      }
    }

    // Update dosage display for liquid
    function updateDosageDisplay() {
      const form = document.getElementById('dosageForm').value;
      const amount = parseFloat(document.getElementById('dosageAmount').value);
      const unit = document.getElementById('dosageUnit').value;
      const display = document.getElementById('liquidDisplay');
      const amountSelect = document.getElementById('dosageAmount');
      const unitSelect = document.getElementById('dosageUnit');

      // Update dosage amount options based on form
      if (form === 'liquid') {
        amountSelect.innerHTML = `
          <option value="2.5">2.5 ml</option>
          <option value="5">5 ml (¬Ω ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤)</option>
          <option value="7.5">7.5 ml (1¬Ω ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤)</option>
          <option value="10">10 ml (2 ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤)</option>
          <option value="15">15 ml (1 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞)</option>
          <option value="20">20 ml</option>
          <option value="30">30 ml (2 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞)</option>
        `;
        unitSelect.value = 'ml';

        // Show conversion
        const teaspoons = amount / 5;
        const tablespoons = amount / 15;
        let conversion = '';

        if (amount === 5) conversion = '1 ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤';
        else if (amount === 15) conversion = '1 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞';
        else if (amount % 5 === 0 && teaspoons < 3) conversion = `${teaspoons} ‡∏ä‡∏≠‡∏ô‡∏ä‡∏≤`;
        else if (amount % 15 === 0) conversion = `${tablespoons} ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞`;

        if (conversion) {
          display.textContent = `üíß ${amount} ml = ${conversion}`;
          display.style.display = 'block';
        } else {
          display.style.display = 'none';
        }
      } else {
        amountSelect.innerHTML = `
          <option value="0.25">¬º ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="0.5">¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="0.75">¬æ ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="1" selected>1 ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="1.5">1¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="2">2 ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="2.5">2¬Ω ‡πÄ‡∏°‡πá‡∏î</option>
          <option value="3">3 ‡πÄ‡∏°‡πá‡∏î</option>
        `;
        unitSelect.value = form === 'capsule' ? 'capsule' : 'tablet';
        display.style.display = 'none';
      }
    }

    // Handle checkbox selection styling
    document.querySelectorAll('.time-checkbox input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          e.target.parentElement.classList.add('selected');
        } else {
          e.target.parentElement.classList.remove('selected');
        }
      });
    });

    document.querySelectorAll('.day-checkbox input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          e.target.parentElement.classList.add('selected');
        } else {
          e.target.parentElement.classList.remove('selected');
        }
      });
    });

    // Handle frequency changes
    document.querySelectorAll('input[name="frequency"]').forEach(radio => {
      radio.addEventListener('change', updateFrequencySelection);
    });

    // Handle dosage form changes
    document.getElementById('dosageForm').addEventListener('change', updateDosageDisplay);
    document.getElementById('dosageAmount').addEventListener('change', updateDosageDisplay);

    // Form submission
    document.getElementById('medication-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const frequency = document.querySelector('input[name="frequency"]:checked').value;
      const selectedTimes = Array.from(
        document.querySelectorAll('.times-selector input[type="checkbox"]:checked')
      ).map(cb => cb.value);

      if (selectedTimes.length === 0 && frequency !== 'as_needed') {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏ß‡∏•‡∏≤');
        return;
      }

      const selectedDays = Array.from(
        document.querySelectorAll('.days-grid input[type="checkbox"]:checked')
      ).map(cb => cb.value);

      if ((frequency === 'specific_days' || frequency === 'weekly') && selectedDays.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô');
        return;
      }

      const medicationData = {
        patient_id: patientId,
        name: document.getElementById('medicationName').value,
        dosage_amount: parseFloat(document.getElementById('dosageAmount').value),
        dosage_form: document.getElementById('dosageForm').value,
        dosage_unit: document.getElementById('dosageUnit').value,
        frequency: frequency,
        days_of_week: (frequency === 'specific_days' || frequency === 'weekly') ? selectedDays : null,
        times: selectedTimes,
        instructions: document.getElementById('medicationInstructions').value,
        note: document.getElementById('medicationNote').value,
        reminder_enabled: document.getElementById('reminderEnabled').checked
      };

      try {
        if (editingMedicationId) {
          const { error } = await supabaseClient
            .from('medications')
            .update(medicationData)
            .eq('id', editingMedicationId);

          if (error) throw error;
          showSuccess('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } else {
          const { error } = await supabaseClient
            .from('medications')
            .insert(medicationData);

          if (error) throw error;
          showSuccess('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        await loadMedications();
        closeModal();
      } catch (error) {
        console.error('Error saving medication:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÑ‡∏î‡πâ: ' + error.message);
      }
    });

    // Edit medication
    function editMedication(id) {
      openModal(id);
    }

    // Delete medication
    async function deleteMedication(id) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

      try {
        const { error } = await supabaseClient
          .from('medications')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showSuccess('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        await loadMedications();
      } catch (error) {
        console.error('Error deleting medication:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÑ‡∏î‡πâ');
      }
    }

    // Alert helpers
    function showSuccess(message) {
      const alert = document.getElementById('success');
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }

    function showError(message) {
      const alert = document.getElementById('error');
      alert.textContent = message;
      alert.style.display = 'block';
      document.getElementById('loading').classList.add('hidden');
    }

    // Initialize on load
    window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>
