<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>OONJAI - ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>

  <!-- Preconnect to speed up external resources -->
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="preload" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">

  <link rel="stylesheet" href="css/style.css">

  <!-- Critical CSS for immediate display -->
  <style>
    .container { opacity: 1; }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top-color: #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè• OONJAI</h1>
    <p class="text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>

    <!-- Initial loading state - visible immediately -->
    <div id="initial-loading" style="text-align: center; padding: 20px;">
      <div class="loading-spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</p>
      <p id="debug-info" style="font-size: 12px; color: #999; margin-top: 20px;"></p>
    </div>
  </div>

  <!-- Phase 2.1: Show UI immediately -->
  <script>
    // IIFE to show loading UI immediately without waiting for external scripts
    (function showUIImmediately() {
      // Container is already visible via CSS
      // Loading spinner animation starts immediately
      console.log('‚úÖ UI shown immediately');
    })();
  </script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <!-- LIFF Helpers -->
  <script>
    const LIFF_ID = '2008278683-5k69jxNq';
    let liffProfile = null;

    function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
      const loading = document.getElementById('initial-loading');
      if (loading) {
        const p = loading.querySelector('p');
        if (p) p.textContent = message;
      }
    }

    function hideLoading() {
      const loading = document.getElementById('initial-loading');
      if (loading) loading.style.display = 'none';
    }

    function showError(message) {
      hideLoading();
      alert('Error: ' + message);
      console.error('Error:', message);
    }

    async function initLiff() {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
        await liff.init({ liffId: LIFF_ID });
        console.log('‚úÖ LIFF initialized');

        if (!liff.isLoggedIn()) {
          console.log('‚ùå Not logged in, redirecting...');
          liff.login();
          return null;
        }

        liffProfile = await liff.getProfile();
        console.log('‚úÖ LIFF Profile:', liffProfile);
        hideLoading();
        return liffProfile;

      } catch (error) {
        console.error('‚ùå LIFF init failed:', error);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        throw error;
      }
    }
  </script>

  <!-- App JavaScript -->

  <script>
    // ========================================
    // User Data Storage
    // ========================================
    function saveUserData(userData) {
      try {
        localStorage.setItem('oonjai_user', JSON.stringify(userData));
        console.log('‚úÖ User data saved:', userData);
      } catch (error) {
        console.error('‚ùå Failed to save user data:', error);
      }
    }

    function getUserData() {
      try {
        const data = localStorage.getItem('oonjai_user');
        return data ? JSON.parse(data) : null;
      } catch (error) {
        console.error('‚ùå Failed to get user data:', error);
        return null;
      }
    }

    // ========================================
    // Debug Helper
    // ========================================
    function updateDebugInfo(message) {
      const debugEl = document.getElementById('debug-info');
      if (debugEl) {
        debugEl.textContent = message;
      }
      console.log('üêõ DEBUG:', message);
    }

    // ========================================
    // Main Entry Point
    // ========================================

    async function init() {
      try {
        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF SDK...');

        // Check if LIFF is loaded
        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK not loaded');
        }

        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á initialize LIFF...');

        // Initialize LIFF
        const profile = await initLiff();
        if (!profile) {
          updateDebugInfo('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ login ‡πÑ‡∏î‡πâ');
          return;
        }

        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö context...');

        // Detect context: Group vs 1:1 (Hybrid Model - TASK-002 Option C)
        const context = liff.getContext();
        const isGroupContext = context && context.type === 'group';
        const groupId = isGroupContext ? context.groupId : null;

        console.log('üîç Context detected:', {
          type: context?.type,
          isGroup: isGroupContext,
          groupId: groupId
        });

        updateDebugInfo(isGroupContext ? 'Context: ‡∏Å‡∏•‡∏∏‡πà‡∏° LINE' : 'Context: 1:1 Chat');

        // Check registration based on context
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        let result;
        if (isGroupContext) {
          // Group context - check group registration
          updateDebugInfo('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°...');
          result = await api.post('/api/groups/check', { line_group_id: groupId });
        } else {
          // 1:1 context - check user registration
          updateDebugInfo('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
          result = await api.checkRegistration(profile.userId);
        }

        hideLoading();

        console.log('üîç Registration check result:', result);

        if (result.exists) {
          // Already registered
          console.log('‚úÖ User/Group is registered:', result);
          updateDebugInfo('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤...');

          if (isGroupContext) {
            // Group registered - go to group dashboard
            console.log('üë• Redirecting to group dashboard');
            setTimeout(() => {
              window.location.href = '/liff/group-dashboard.html';
            }, 500);
          } else {
            // User registered - go to user dashboard
            // ‚úÖ Validate profile exists
            if (!result.profile || !result.profile.id) {
              console.error('‚ùå Profile data missing:', result);
              updateDebugInfo('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
              showError('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
              return;
            }

            const userData = {
              role: result.role,
              profile_id: result.profile.id,
              line_user_id: profile.userId
            };

            // Save to localStorage
            saveUserData(userData);

            console.log('üë§ Redirecting to user dashboard');
            setTimeout(() => {
              window.location.href = '/liff/dashboard.html';
            }, 500);
          }

        } else {
          // Not registered
          console.log('‚ùå Not registered, redirecting to registration');
          updateDebugInfo('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤...');

          if (isGroupContext) {
            // Group not registered - go to group registration
            console.log('üë• Redirecting to group registration');
            setTimeout(() => {
              window.location.href = '/liff/group-registration.html';
            }, 500);
          } else {
            // User not registered - go to registration
            console.log('üë§ Redirecting to registration');
            setTimeout(() => {
              window.location.href = '/liff/registration.html';
            }, 500);
          }
        }

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        updateDebugInfo('Error: ' + error.message);
        hideLoading();

        // Show error in container
        const container = document.querySelector('.container');
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #ffebee; border: 1px solid #f44336; padding: 15px; border-radius: 8px; margin: 20px 0; color: #c62828;';
        errorDiv.innerHTML = `
          <strong>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</strong><br>
          <small>${error.message}</small>
        `;
        container.appendChild(errorDiv);

        // Retry button
        setTimeout(() => {
          const retryBtn = document.createElement('button');
          retryBtn.style.cssText = 'width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px;';
          retryBtn.textContent = 'üîÑ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          retryBtn.onclick = () => location.reload();
          container.appendChild(retryBtn);
        }, 1000);
      }
    }

    // Initial check
    updateDebugInfo('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
