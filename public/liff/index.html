<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>Duulair - ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>üè• Duulair</h1>
    <p class="text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>

    <!-- Initial loading state -->
    <div id="initial-loading" style="text-align: center; padding: 20px;">
      <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</p>
      <p id="debug-info" style="font-size: 12px; color: #999; margin-top: 20px;"></p>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- App JavaScript -->
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/liff-init.js"></script>

  <script>
    // ========================================
    // Debug Helper
    // ========================================
    function updateDebugInfo(message) {
      const debugEl = document.getElementById('debug-info');
      if (debugEl) {
        debugEl.textContent = message;
      }
      console.log('üêõ DEBUG:', message);
    }

    // ========================================
    // Main Entry Point
    // ========================================

    async function init() {
      try {
        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF SDK...');

        // Check if LIFF is loaded
        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK not loaded');
        }

        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á initialize LIFF...');

        // Initialize LIFF
        const profile = await initLiff();
        if (!profile) {
          updateDebugInfo('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ login ‡πÑ‡∏î‡πâ');
          return;
        }

        updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö context...');

        // Detect context: Group vs 1:1 (Hybrid Model - TASK-002 Option C)
        const context = liff.getContext();
        const isGroupContext = context && context.type === 'group';
        const groupId = isGroupContext ? context.groupId : null;

        console.log('üîç Context detected:', {
          type: context?.type,
          isGroup: isGroupContext,
          groupId: groupId
        });

        updateDebugInfo(isGroupContext ? 'Context: ‡∏Å‡∏•‡∏∏‡πà‡∏° LINE' : 'Context: 1:1 Chat');

        // Check registration based on context
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        let result;
        if (isGroupContext) {
          // Group context - check group registration
          updateDebugInfo('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°...');
          result = await api.post('/api/groups/check', { line_group_id: groupId });
        } else {
          // 1:1 context - check user registration
          updateDebugInfo('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
          result = await api.checkRegistration(profile.userId);
        }

        hideLoading();

        console.log('üîç Registration check result:', result);

        if (result.exists) {
          // Already registered
          console.log('‚úÖ User/Group is registered:', result);
          updateDebugInfo('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤...');

          if (isGroupContext) {
            // Group registered - go to group dashboard
            console.log('üë• Redirecting to group dashboard');
            setTimeout(() => {
              window.location.href = '/liff/group-dashboard.html';
            }, 500);
          } else {
            // User registered - go to user dashboard
            // ‚úÖ Validate profile exists
            if (!result.profile || !result.profile.id) {
              console.error('‚ùå Profile data missing:', result);
              updateDebugInfo('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
              showError('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
              return;
            }

            const userData = {
              role: result.role,
              profile_id: result.profile.id,
              line_user_id: profile.userId
            };

            // Save to localStorage
            saveUserData(userData);

            console.log('üë§ Redirecting to user dashboard');
            setTimeout(() => {
              window.location.href = '/liff/dashboard.html';
            }, 500);
          }

        } else {
          // Not registered
          console.log('‚ùå Not registered, redirecting to registration');
          updateDebugInfo('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤...');

          if (isGroupContext) {
            // Group not registered - go to group registration
            console.log('üë• Redirecting to group registration');
            setTimeout(() => {
              window.location.href = '/liff/group-registration.html';
            }, 500);
          } else {
            // User not registered - go to role selection (1:1 flow)
            console.log('üë§ Redirecting to role selection');
            setTimeout(() => {
              window.location.href = '/liff/role-selection.html';
            }, 500);
          }
        }

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        updateDebugInfo('Error: ' + error.message);
        hideLoading();

        // Show error in container
        const container = document.querySelector('.container');
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #ffebee; border: 1px solid #f44336; padding: 15px; border-radius: 8px; margin: 20px 0; color: #c62828;';
        errorDiv.innerHTML = `
          <strong>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</strong><br>
          <small>${error.message}</small>
        `;
        container.appendChild(errorDiv);

        // Retry button
        setTimeout(() => {
          const retryBtn = document.createElement('button');
          retryBtn.style.cssText = 'width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px;';
          retryBtn.textContent = 'üîÑ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          retryBtn.onclick = () => location.reload();
          container.appendChild(retryBtn);
        }, 1000);
      }
    }

    // Initial check
    updateDebugInfo('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
