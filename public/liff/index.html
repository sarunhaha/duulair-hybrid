<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>Duulair - ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>üè• Duulair</h1>
    <p class="text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>

    <!-- Loading will be injected by JavaScript -->
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- App JavaScript -->
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/liff-init.js"></script>

  <script>
    // ========================================
    // Main Entry Point
    // ========================================

    async function init() {
      try {
        // Initialize LIFF
        const profile = await initLiff();
        if (!profile) return;

        // Check if user is already registered
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        const result = await api.checkRegistration(profile.userId);

        hideLoading();

        console.log('üîç Registration check result:', result);

        if (result.exists) {
          // Already registered
          console.log('‚úÖ User is registered:', result);

          // ‚úÖ Validate profile exists
          if (!result.profile || !result.profile.id) {
            console.error('‚ùå Profile data missing:', result);
            showError('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
            return;
          }

          const userData = {
            role: result.role,
            profile_id: result.profile.id,
            line_user_id: profile.userId
          };

          // Save to localStorage
          saveUserData(userData);

          // Redirect to dashboard page for returning users
          console.log('üë§ Redirecting to dashboard for returning user');
          window.location.href = '/liff/dashboard.html';

        } else {
          // Not registered - go to role selection (use absolute path)
          console.log('‚ùå User not registered, redirecting to role selection');
          window.location.href = '/liff/role-selection.html';
        }

      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        hideLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');

        // Retry button
        setTimeout(() => {
          const container = document.querySelector('.container');
          const retryBtn = document.createElement('button');
          retryBtn.className = 'btn btn-block';
          retryBtn.textContent = '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          retryBtn.onclick = () => location.reload();
          container.appendChild(retryBtn);
        }, 1000);
      }
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
