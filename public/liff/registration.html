<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#FAF9F6">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - OONJAI (v2.1)</title>
  <link rel="stylesheet" href="css/minimal-theme.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header text-center">
      <h1>üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà OONJAI</h1>
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    </div>

    <form id="registrationForm">
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• -->
      <div class="card">
        <div class="card-header">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</div>
        <p class="text-small text-muted mb-3">
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </p>

        <div class="form-group">
          <label for="caregiverFirstName">‡∏ä‡∏∑‡πà‡∏≠ <span class="required">*</span></label>
          <input type="text" id="caregiverFirstName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>

        <div class="form-group">
          <label for="caregiverLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
          <input type="text" id="caregiverLastName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>

        <div class="form-group">
          <label for="caregiverPhoneNumber">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="tel" id="caregiverPhoneNumber" placeholder="0XX-XXX-XXXX">
        </div>

        <div class="form-group">
          <label for="relationshipToPatient">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
          <select id="relationshipToPatient" required>
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå --</option>
            <option value="child">‡∏•‡∏π‡∏Å</option>
            <option value="grandchild">‡∏´‡∏•‡∏≤‡∏ô</option>
            <option value="sibling">‡∏û‡∏µ‡πà/‡∏ô‡πâ‡∏≠‡∏á</option>
            <option value="spouse">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</option>
            <option value="nurse">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
      </div>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ -->
      <div class="card">
        <div class="card-header">üë¥ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</div>
        <p class="text-small text-muted mb-3">
          ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE
        </p>

        <div class="form-group">
          <label for="patientFirstName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
          <input type="text" id="patientFirstName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢">
        </div>

        <div class="form-group">
          <label for="patientLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
          <input type="text" id="patientLastName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢">
        </div>

        <div class="form-group">
          <label for="patientBirthDate">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
          <input type="date" id="patientBirthDate" required>
          <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏µ ‡∏û.‡∏®. 2496 = ‡∏Ñ.‡∏®. 1953)
          </small>
        </div>

        <div class="form-group">
          <label for="patientConditions">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <textarea id="patientConditions" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô" rows="3"></textarea>
          <small style="color: #666; font-size: 12px;">
            ‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
          </small>
        </div>

        <div class="alert alert-info">
          <strong>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
        </div>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <div class="mt-4">
        <button type="submit" id="submitBtn" class="btn btn-primary btn-block">
          ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </button>
      </div>

      <p class="text-center text-small text-muted mt-2">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ üîí
      </p>
    </form>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- API Client -->
  <script src="js/api.js"></script>

  <script>
    // LIFF Configuration
    const LIFF_ID = '2008278683-5k69jxNq';

    // Initialize LIFF
    async function initLiff() {
      try {
        console.log('üîÑ Initializing LIFF...', LIFF_ID);
        await liff.init({ liffId: LIFF_ID });
        console.log('‚úÖ LIFF initialized');

        if (!liff.isLoggedIn()) {
          console.log('‚ö†Ô∏è Not logged in, redirecting to login...');
          liff.login();
          return;
        }

        console.log('‚úÖ User is logged in');

        // Auto-fill caregiver name from LINE profile
        const profile = await liff.getProfile();
        console.log('‚úÖ Got profile for auto-fill:', profile.displayName);

        const displayName = profile.displayName || '';
        const nameParts = displayName.split(' ');

        if (nameParts.length >= 2) {
          document.getElementById('caregiverFirstName').value = nameParts[0];
          document.getElementById('caregiverLastName').value = nameParts.slice(1).join(' ');
        } else {
          document.getElementById('caregiverFirstName').value = displayName;
        }

        console.log('‚úÖ LIFF initialization complete');

      } catch (error) {
        console.error('‚ùå LIFF initialization failed:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF\n\nError: ' + error.message + '\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    }

    // Handle form submission
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        console.log('üöÄ Starting registration...');

        const profile = await liff.getProfile();
        console.log('‚úÖ Got LINE profile:', profile.userId);

        const contextType = liff.getContext()?.type || 'utou';
        const groupId = contextType === 'group' ? liff.getContext().groupId : null;
        console.log('üìç Context:', { contextType, groupId });

        // Prepare data
        const formData = {
          lineUserId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl,
          statusMessage: profile.statusMessage,
          contextType: contextType,
          groupId: groupId,
          caregiver: {
            firstName: document.getElementById('caregiverFirstName').value.trim(),
            lastName: document.getElementById('caregiverLastName').value.trim(),
            phoneNumber: document.getElementById('caregiverPhoneNumber').value.trim() || null,
            relationship: document.getElementById('relationshipToPatient').value
          },
          patient: {
            firstName: document.getElementById('patientFirstName').value.trim(),
            lastName: document.getElementById('patientLastName').value.trim(),
            birthDate: document.getElementById('patientBirthDate').value,
            conditions: document.getElementById('patientConditions').value.trim() || null
          }
        };

        console.log('üì§ Sending registration data:', {
          ...formData,
          lineUserId: formData.lineUserId.substring(0, 10) + '...',
          pictureUrl: formData.pictureUrl ? 'set' : 'null'
        });

        // Send to API
        const response = await fetch(`${API_BASE_URL}/quick-register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (!response.ok) {
          // Show detailed error from API
          throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }

        if (result.success) {
          // ‚úÖ Save context to localStorage for future access
          const contextData = {
            caregiverId: result.caregiverId,
            patientId: result.patientId,
            role: 'caregiver',
            profile_id: result.patientId, // ‚úÖ Use patientId for patient-profile pages
            groupId: groupId,
            contextType: contextType
          };

          console.log('üíæ Saving context to localStorage:', contextData);
          localStorage.setItem('oonjai_context', JSON.stringify(contextData));

          // ‚úÖ Save to oonjai_user - use caregiverId (CORRECTED 2025-01-17)
          const userData = {
            role: 'caregiver',
            profile_id: result.caregiverId, // ‚úÖ Caregiver ID (correct!)
            line_user_id: profile.userId
          };
          localStorage.setItem('oonjai_user', JSON.stringify(userData));

          console.log('‚úÖ Saved to localStorage!');
          console.log('Context:', localStorage.getItem('oonjai_context'));
          console.log('User:', localStorage.getItem('oonjai_user'));

          // Show detailed success message with data
          alert('‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! \n\nCaregiver ID: ' + result.caregiverId.substring(0, 8) + '...\nPatient ID: ' + result.patientId.substring(0, 8) + '...\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');

          // Close LIFF window or redirect
          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            window.location.href = '/liff/dashboard.html';
          }
        } else {
          throw new Error(result.error || '‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }

      } catch (error) {
        console.error('Registration failed:', error);
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      }
    });

    // Initialize on load
    initLiff();
  </script>
</body>
</html>
