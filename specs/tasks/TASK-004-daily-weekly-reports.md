# TASK-004: Daily/Weekly Reports

**Priority:** ðŸŸ¡ High
**Status:** ðŸ“‹ Ready to Start
**Owner:** Backend Developer / ReportAgent Specialist
**Estimated Time:** 4-5 hours
**Dependencies:** TASK-003 (Health Logging)

---

## ðŸ“ Overview

à¸žà¸±à¸’à¸™à¸²à¸£à¸°à¸šà¸šà¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´:
- ðŸ“… **à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¸§à¸±à¸™** (Daily Report)
- ðŸ“Š **à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ** (Weekly Report)
- ðŸ“ˆ **à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™** (Monthly Report - future)

à¸£à¸²à¸¢à¸‡à¸²à¸™à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸ªà¸¸à¸‚à¸ à¸²à¸ž, Insights, à¹à¸¥à¸° Alerts

---

## ðŸŽ¯ User Stories

### Story 1: à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™
**As a** à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢/à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥
**I want** à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸‚à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¹à¸¥à¸ªà¸¸à¸‚à¸ à¸²à¸ž
**So that** à¸—à¸£à¸²à¸šà¸§à¹ˆà¸²à¸—à¸³à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸„à¸£à¸šà¸«à¸£à¸·à¸­à¸¢à¸±à¸‡

**Acceptance Criteria:**
- âœ… à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰" â†’ à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰
- âœ… à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™" â†’ à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™
- âœ… à¸à¸” Rich Menu "à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™" â†’ Quick Reply à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ
- âœ… à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¸à¸´à¸ˆà¸à¸£à¸£à¸¡ (à¸¢à¸², à¸„à¸§à¸²à¸¡à¸”à¸±à¸™, à¸™à¹‰à¸³, à¸­à¸­à¸à¸à¸³à¸¥à¸±à¸‡à¸à¸²à¸¢, à¸­à¸²à¸«à¸²à¸£)
- âœ… à¹à¸ªà¸”à¸‡ % à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
- âœ… à¹à¸ªà¸”à¸‡ Insights à¸ˆà¸²à¸ AI
- âœ… à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸›à¹‡à¸™ Flex Message à¸ªà¸§à¸¢à¸‡à¸²à¸¡

### Story 2: à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ
**As a** à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢/à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥
**I want** à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸› 7 à¸§à¸±à¸™à¸—à¸µà¹ˆà¸œà¹ˆà¸²à¸™à¸¡à¸²
**So that** à¹€à¸«à¹‡à¸™ Trend à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸à¹‰à¸²à¸§à¸«à¸™à¹‰à¸²

**Acceptance Criteria:**
- âœ… à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰" â†’ à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™ 7 à¸§à¸±à¸™
- âœ… à¹à¸ªà¸”à¸‡ Trend Chart (à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ ASCII art)
- âœ… à¹à¸ªà¸”à¸‡ Average values
- âœ… à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸à¹ˆà¸­à¸™
- âœ… AI Insights à¸ªà¸³à¸«à¸£à¸±à¸š 7 à¸§à¸±à¸™

### Story 3: Auto-send à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™
**As a** à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥
**I want** à¹„à¸”à¹‰à¸£à¸±à¸šà¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
**So that** à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¹„à¸”à¹‰à¸—à¸¸à¸à¸§à¸±à¸™

**Acceptance Criteria:**
- âœ… à¸ªà¹ˆà¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸à¸§à¸±à¸™à¹€à¸§à¸¥à¸² 20:00
- âœ… à¸ªà¹ˆà¸‡à¸–à¸¶à¸‡à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢ + à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™
- âœ… à¸ªà¸£à¸¸à¸›à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸§à¸±à¸™à¸™à¸±à¹‰à¸™
- âœ… à¹„à¸®à¹„à¸¥à¸•à¹Œà¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¸ªà¸³à¸„à¸±à¸

---

## ðŸ›  Technical Implementation

### 1. Database Views

```sql
-- Daily Summary View
CREATE OR REPLACE VIEW daily_health_summary AS
SELECT
  patient_id,
  DATE(logged_at) as log_date,

  -- Medication count
  COUNT(CASE WHEN log_type = 'medication' THEN 1 END) as medication_count,

  -- Vitals (latest of the day)
  (SELECT log_data->>'systolic' FROM health_logs hl2
   WHERE hl2.patient_id = health_logs.patient_id
   AND hl2.log_type = 'vitals'
   AND DATE(hl2.logged_at) = DATE(health_logs.logged_at)
   ORDER BY hl2.logged_at DESC LIMIT 1)::int as latest_systolic,

  (SELECT log_data->>'diastolic' FROM health_logs hl2
   WHERE hl2.patient_id = health_logs.patient_id
   AND hl2.log_type = 'vitals'
   AND DATE(hl2.logged_at) = DATE(health_logs.logged_at)
   ORDER BY hl2.logged_at DESC LIMIT 1)::int as latest_diastolic,

  -- Water total
  SUM(CASE WHEN log_type = 'water' THEN (log_data->>'amount_ml')::int ELSE 0 END) as total_water_ml,

  -- Exercise total
  SUM(CASE WHEN log_type = 'exercise' THEN (log_data->>'duration_minutes')::int ELSE 0 END) as total_exercise_minutes,

  -- Food count
  COUNT(CASE WHEN log_type = 'food' THEN 1 END) as food_count

FROM health_logs
GROUP BY patient_id, DATE(logged_at);

-- Weekly Summary View
CREATE OR REPLACE VIEW weekly_health_summary AS
SELECT
  patient_id,
  DATE_TRUNC('week', logged_at) as week_start,

  -- Averages
  AVG(CASE WHEN log_type = 'vitals' THEN (log_data->>'systolic')::int END) as avg_systolic,
  AVG(CASE WHEN log_type = 'vitals' THEN (log_data->>'diastolic')::int END) as avg_diastolic,
  AVG(CASE WHEN log_type = 'water' THEN (log_data->>'amount_ml')::int END) as avg_water_per_log,

  -- Totals
  COUNT(CASE WHEN log_type = 'medication' THEN 1 END) as total_medications,
  SUM(CASE WHEN log_type = 'water' THEN (log_data->>'amount_ml')::int ELSE 0 END) as total_water_ml,
  SUM(CASE WHEN log_type = 'exercise' THEN (log_data->>'duration_minutes')::int ELSE 0 END) as total_exercise_minutes,
  COUNT(CASE WHEN log_type = 'food' THEN 1 END) as total_meals,

  -- Activity days
  COUNT(DISTINCT DATE(logged_at)) as active_days

FROM health_logs
GROUP BY patient_id, DATE_TRUNC('week', logged_at);
```

### 2. API Endpoints

**File:** `src/routes/report.routes.ts` (new file)

```typescript
import { Router } from 'express';
import { SupabaseService } from '../services/supabase.service';
import Anthropic from '@anthropic-ai/sdk';

const router = Router();
const supabase = new SupabaseService();
const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

// GET /api/reports/daily/:patient_id
router.get('/daily/:patient_id', async (req, res) => {
  try {
    const { patient_id } = req.params;
    const { date } = req.query; // Optional: YYYY-MM-DD

    const targetDate = date ? new Date(date as string) : new Date();
    const dateStr = targetDate.toISOString().split('T')[0];

    // Get daily summary
    const { data: summary, error } = await supabase.client
      .from('daily_health_summary')
      .select('*')
      .eq('patient_id', patient_id)
      .eq('log_date', dateStr)
      .single();

    if (error && error.code !== 'PGRST116') { // Not "not found" error
      throw error;
    }

    // Get patient goals
    const { data: patient } = await supabase.client
      .from('patients')
      .select('health_goals')
      .eq('id', patient_id)
      .single();

    const goals = patient?.health_goals || {
      medications_per_day: 3,
      water_ml_per_day: 2000,
      exercise_minutes_per_day: 30,
      meals_per_day: 3
    };

    // Calculate completion rates
    const report = {
      date: dateStr,
      summary: summary || {
        medication_count: 0,
        total_water_ml: 0,
        total_exercise_minutes: 0,
        food_count: 0
      },
      goals,
      completion: {
        medications: Math.min(100, Math.round((summary?.medication_count || 0) / goals.medications_per_day * 100)),
        water: Math.min(100, Math.round((summary?.total_water_ml || 0) / goals.water_ml_per_day * 100)),
        exercise: Math.min(100, Math.round((summary?.total_exercise_minutes || 0) / goals.exercise_minutes_per_day * 100)),
        meals: Math.min(100, Math.round((summary?.food_count || 0) / goals.meals_per_day * 100))
      },
      vitals: summary ? {
        systolic: summary.latest_systolic,
        diastolic: summary.latest_diastolic
      } : null
    };

    // Calculate overall completion
    const overallCompletion = Math.round(
      (report.completion.medications + report.completion.water +
       report.completion.exercise + report.completion.meals) / 4
    );

    res.json({
      success: true,
      data: { ...report, overallCompletion }
    });

  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// GET /api/reports/weekly/:patient_id
router.get('/weekly/:patient_id', async (req, res) => {
  try {
    const { patient_id } = req.params;
    const { week_start } = req.query; // Optional: YYYY-MM-DD

    const targetWeek = week_start ? new Date(week_start as string) : new Date();

    // Get start of week (Monday)
    const weekStart = new Date(targetWeek);
    weekStart.setDate(targetWeek.getDate() - targetWeek.getDay() + 1);
    const weekStartStr = weekStart.toISOString().split('T')[0];

    // Get weekly summary
    const { data: summary, error } = await supabase.client
      .from('weekly_health_summary')
      .select('*')
      .eq('patient_id', patient_id)
      .eq('week_start', weekStartStr)
      .single();

    if (error && error.code !== 'PGRST116') {
      throw error;
    }

    // Get daily breakdown for the week
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    const { data: dailyBreakdown } = await supabase.client
      .from('daily_health_summary')
      .select('*')
      .eq('patient_id', patient_id)
      .gte('log_date', weekStart.toISOString().split('T')[0])
      .lte('log_date', weekEnd.toISOString().split('T')[0])
      .order('log_date', { ascending: true });

    res.json({
      success: true,
      data: {
        week_start: weekStartStr,
        summary: summary || {},
        daily_breakdown: dailyBreakdown || [],
        active_days: summary?.active_days || 0,
        target_days: 7
      }
    });

  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// POST /api/reports/generate-insights
router.post('/generate-insights', async (req, res) => {
  try {
    const { patient_id, report_type, report_data } = req.body;

    // Get patient info
    const { data: patient } = await supabase.client
      .from('patients')
      .select('first_name, chronic_diseases')
      .eq('id', patient_id)
      .single();

    // Generate insights using Claude
    const systemPrompt = `You are a health assistant analyzing ${report_type} health data for a Thai elderly patient.

Patient: ${patient?.first_name}
Chronic conditions: ${patient?.chronic_diseases?.join(', ') || 'None'}

Data: ${JSON.stringify(report_data)}

Provide 2-3 brief insights in Thai (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢):
1. Positive feedback on what went well
2. Gentle suggestions for improvement
3. Health tips related to their data

Keep each insight under 30 words. Be supportive, not critical. Use polite Thai (à¸„à¹ˆà¸°/à¸„à¸£à¸±à¸š).`;

    const response = await anthropic.messages.create({
      model: 'claude-3-haiku-20240307',
      max_tokens: 300,
      temperature: 0.7,
      messages: [{
        role: 'user',
        content: 'Generate health insights from this data.'
      }],
      system: systemPrompt
    });

    const insights = response.content[0].type === 'text' ? response.content[0].text : '';

    res.json({ success: true, insights });

  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
```

### 3. Update ReportAgent

**File:** `src/agents/specialized/ReportAgent.ts`

```typescript
import { BaseAgent, Message, Response, Config } from '../core/BaseAgent';
import { FlexMessage } from '@line/bot-sdk';

export class ReportAgent extends BaseAgent {
  constructor(config?: Partial<Config>) {
    super({
      name: 'report',
      role: 'Generate health reports and insights',
      model: 'claude-3-haiku-20240307',
      temperature: 0.7,
      maxTokens: 500,
      ...config
    });
  }

  async initialize(): Promise<boolean> {
    this.log('info', 'Report Agent initialized');
    return true;
  }

  async process(message: Message): Promise<Response> {
    const startTime = Date.now();

    try {
      const userId = message.context.userId;
      const reportType = this.detectReportType(message.content);

      // Get patient
      const patient = await this.supabase.getPatientByLineId(userId);
      if (!patient) {
        return {
          success: true,
          data: {
            response: 'à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸à¹ˆà¸­à¸™à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¸„à¹ˆà¸°'
          },
          agentName: this.config.name,
          processingTime: Date.now() - startTime
        };
      }

      let reportData;

      if (reportType === 'daily') {
        reportData = await this.generateDailyReport(patient.id, message.content);
      } else if (reportType === 'weekly') {
        reportData = await this.generateWeeklyReport(patient.id);
      } else {
        return {
          success: true,
          data: {
            response: 'à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸›à¸£à¸°à¹€à¸ à¸—à¸£à¸²à¸¢à¸‡à¸²à¸™ à¹€à¸Šà¹ˆà¸™ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰" à¸«à¸£à¸·à¸­ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰" à¸„à¹ˆà¸°'
          },
          agentName: this.config.name,
          processingTime: Date.now() - startTime
        };
      }

      // Generate insights
      const insights = await this.generateInsights(patient.id, reportType, reportData);

      return {
        success: true,
        data: {
          reportType,
          reportData,
          insights,
          flexMessage: this.createReportFlexMessage(reportType, reportData, insights)
        },
        agentName: this.config.name,
        processingTime: Date.now() - startTime
      };

    } catch (error) {
      this.log('error', 'Report generation failed', error);
      return {
        success: false,
        error: error.message,
        agentName: this.config.name,
        processingTime: Date.now() - startTime
      };
    }
  }

  private detectReportType(content: string): string {
    if (/à¸§à¸±à¸™à¸™à¸µà¹‰|à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™|daily|today/i.test(content)) {
      return 'daily';
    }
    if (/à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™|yesterday/i.test(content)) {
      return 'daily_yesterday';
    }
    if (/à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ|à¸£à¸²à¸¢à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ|weekly|week/i.test(content)) {
      return 'weekly';
    }
    if (/à¹€à¸”à¸·à¸­à¸™|à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™|monthly|month/i.test(content)) {
      return 'monthly';
    }
    return 'unknown';
  }

  private async generateDailyReport(patientId: string, content: string) {
    // Determine date
    const isYesterday = /à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™|yesterday/i.test(content);
    const targetDate = new Date();
    if (isYesterday) {
      targetDate.setDate(targetDate.getDate() - 1);
    }
    const dateStr = targetDate.toISOString().split('T')[0];

    // Fetch from API
    const response = await fetch(`${process.env.API_BASE_URL || 'http://localhost:3000'}/api/reports/daily/${patientId}?date=${dateStr}`);
    const result = await response.json();

    return result.data;
  }

  private async generateWeeklyReport(patientId: string) {
    const response = await fetch(`${process.env.API_BASE_URL || 'http://localhost:3000'}/api/reports/weekly/${patientId}`);
    const result = await response.json();

    return result.data;
  }

  private async generateInsights(patientId: string, reportType: string, reportData: any) {
    const systemPrompt = `You are analyzing ${reportType} health report for a Thai elderly patient.

Report data: ${JSON.stringify(reportData)}

Provide 2-3 brief insights in Thai:
1. à¸Šà¸¡à¹€à¸Šà¸¢à¹ƒà¸™à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸”à¸µ
2. à¹à¸™à¸°à¸™à¸³à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸„à¸§à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ (à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™)
3. à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸šà¸ªà¸¸à¸‚à¸ à¸²à¸žà¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡

à¹à¸•à¹ˆà¸¥à¸°à¸‚à¹‰à¸­à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 30 à¸„à¸³ à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸ªà¸¸à¸ à¸²à¸ž`;

    const insights = await this.askClaude(
      'Generate insights',
      systemPrompt
    );

    return insights;
  }

  private createReportFlexMessage(reportType: string, reportData: any, insights: string): any {
    if (reportType === 'daily') {
      return this.createDailyReportFlex(reportData, insights);
    } else if (reportType === 'weekly') {
      return this.createWeeklyReportFlex(reportData, insights);
    }
  }

  private createDailyReportFlex(data: any, insights: string): any {
    const { date, summary, completion, overallCompletion, vitals } = data;

    return {
      type: 'flex',
      altText: `à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™ ${date}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'ðŸ“… à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™',
              weight: 'bold',
              size: 'xl',
              color: '#4CAF50'
            },
            {
              type: 'text',
              text: date,
              size: 'sm',
              color: '#999999'
            }
          ]
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            // Overall completion
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: `à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹‚à¸”à¸¢à¸£à¸§à¸¡: ${overallCompletion}%`,
                  weight: 'bold',
                  size: 'md',
                  color: overallCompletion >= 70 ? '#4CAF50' : '#FF9800'
                },
                {
                  type: 'text',
                  text: this.createProgressBar(overallCompletion),
                  wrap: true,
                  size: 'xs',
                  margin: 'sm'
                }
              ],
              margin: 'md'
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            // Medication
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'ðŸ’Š à¸¢à¸²',
                  size: 'sm',
                  flex: 2
                },
                {
                  type: 'text',
                  text: `${summary.medication_count || 0} à¸„à¸£à¸±à¹‰à¸‡`,
                  size: 'sm',
                  align: 'end',
                  flex: 1
                },
                {
                  type: 'text',
                  text: `${completion.medications}%`,
                  size: 'sm',
                  align: 'end',
                  color: completion.medications >= 70 ? '#4CAF50' : '#FF9800',
                  flex: 1
                }
              ],
              margin: 'lg'
            },
            // Water
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'ðŸ’§ à¸™à¹‰à¸³',
                  size: 'sm',
                  flex: 2
                },
                {
                  type: 'text',
                  text: `${summary.total_water_ml || 0} ml`,
                  size: 'sm',
                  align: 'end',
                  flex: 1
                },
                {
                  type: 'text',
                  text: `${completion.water}%`,
                  size: 'sm',
                  align: 'end',
                  color: completion.water >= 70 ? '#4CAF50' : '#FF9800',
                  flex: 1
                }
              ],
              margin: 'md'
            },
            // Exercise
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'ðŸš¶ à¸­à¸­à¸à¸à¸³à¸¥à¸±à¸‡à¸à¸²à¸¢',
                  size: 'sm',
                  flex: 2
                },
                {
                  type: 'text',
                  text: `${summary.total_exercise_minutes || 0} à¸™à¸²à¸—à¸µ`,
                  size: 'sm',
                  align: 'end',
                  flex: 1
                },
                {
                  type: 'text',
                  text: `${completion.exercise}%`,
                  size: 'sm',
                  align: 'end',
                  color: completion.exercise >= 70 ? '#4CAF50' : '#FF9800',
                  flex: 1
                }
              ],
              margin: 'md'
            },
            // Meals
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'ðŸš à¸­à¸²à¸«à¸²à¸£',
                  size: 'sm',
                  flex: 2
                },
                {
                  type: 'text',
                  text: `${summary.food_count || 0} à¸¡à¸·à¹‰à¸­`,
                  size: 'sm',
                  align: 'end',
                  flex: 1
                },
                {
                  type: 'text',
                  text: `${completion.meals}%`,
                  size: 'sm',
                  align: 'end',
                  color: completion.meals >= 70 ? '#4CAF50' : '#FF9800',
                  flex: 1
                }
              ],
              margin: 'md'
            },
            // Vitals
            ...(vitals && vitals.systolic ? [
              {
                type: 'separator',
                margin: 'lg'
              },
              {
                type: 'box',
                layout: 'horizontal',
                contents: [
                  {
                    type: 'text',
                    text: 'ðŸ©º à¸„à¸§à¸²à¸¡à¸”à¸±à¸™',
                    size: 'sm',
                    flex: 2
                  },
                  {
                    type: 'text',
                    text: `${vitals.systolic}/${vitals.diastolic}`,
                    size: 'sm',
                    align: 'end',
                    color: (vitals.systolic > 140 || vitals.diastolic > 90) ? '#F44336' : '#4CAF50'
                  }
                ],
                margin: 'lg'
              }
            ] : []),
            // Insights
            {
              type: 'separator',
              margin: 'xl'
            },
            {
              type: 'text',
              text: 'ðŸ’¡ à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¹à¸™à¸°',
              weight: 'bold',
              size: 'sm',
              margin: 'xl'
            },
            {
              type: 'text',
              text: insights,
              size: 'xs',
              color: '#666666',
              wrap: true,
              margin: 'sm'
            }
          ]
        }
      }
    };
  }

  private createWeeklyReportFlex(data: any, insights: string): any {
    const { week_start, summary, active_days, target_days } = data;

    return {
      type: 'flex',
      altText: `à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ ${week_start}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'ðŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸²à¸¢à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ',
              weight: 'bold',
              size: 'xl',
              color: '#4CAF50'
            },
            {
              type: 'text',
              text: `à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡ ${week_start}`,
              size: 'sm',
              color: '#999999'
            }
          ]
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            // Active days
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸à¸´à¸ˆà¸à¸£à¸£à¸¡',
                  size: 'sm'
                },
                {
                  type: 'text',
                  text: `${active_days}/${target_days} à¸§à¸±à¸™`,
                  size: 'sm',
                  align: 'end',
                  weight: 'bold',
                  color: active_days >= 5 ? '#4CAF50' : '#FF9800'
                }
              ],
              margin: 'md'
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            // Totals
            {
              type: 'text',
              text: 'ðŸ“ˆ à¸ªà¸£à¸¸à¸›à¸£à¸§à¸¡ 7 à¸§à¸±à¸™',
              weight: 'bold',
              size: 'sm',
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: `ðŸ’Š à¸¢à¸²: ${summary.total_medications || 0} à¸„à¸£à¸±à¹‰à¸‡`,
                  size: 'xs',
                  color: '#666666'
                },
                {
                  type: 'text',
                  text: `ðŸ’§ à¸™à¹‰à¸³: ${summary.total_water_ml || 0} ml`,
                  size: 'xs',
                  color: '#666666',
                  margin: 'sm'
                },
                {
                  type: 'text',
                  text: `ðŸš¶ à¸­à¸­à¸à¸à¸³à¸¥à¸±à¸‡à¸à¸²à¸¢: ${summary.total_exercise_minutes || 0} à¸™à¸²à¸—à¸µ`,
                  size: 'xs',
                  color: '#666666',
                  margin: 'sm'
                },
                {
                  type: 'text',
                  text: `ðŸš à¸­à¸²à¸«à¸²à¸£: ${summary.total_meals || 0} à¸¡à¸·à¹‰à¸­`,
                  size: 'xs',
                  color: '#666666',
                  margin: 'sm'
                }
              ],
              margin: 'sm'
            },
            // Averages
            ...(summary.avg_systolic ? [
              {
                type: 'separator',
                margin: 'lg'
              },
              {
                type: 'text',
                text: 'ðŸ“Š à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢',
                weight: 'bold',
                size: 'sm',
                margin: 'lg'
              },
              {
                type: 'text',
                text: `ðŸ©º à¸„à¸§à¸²à¸¡à¸”à¸±à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢: ${Math.round(summary.avg_systolic)}/${Math.round(summary.avg_diastolic)}`,
                size: 'xs',
                color: '#666666',
                margin: 'sm'
              }
            ] : []),
            // Insights
            {
              type: 'separator',
              margin: 'xl'
            },
            {
              type: 'text',
              text: 'ðŸ’¡ à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¹à¸™à¸°',
              weight: 'bold',
              size: 'sm',
              margin: 'xl'
            },
            {
              type: 'text',
              text: insights,
              size: 'xs',
              color: '#666666',
              wrap: true,
              margin: 'sm'
            }
          ]
        }
      }
    };
  }

  private createProgressBar(percentage: number): string {
    const filled = Math.round(percentage / 10);
    const empty = 10 - filled;
    return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty) + ` ${percentage}%`;
  }

  getCapabilities(): string[] {
    return [
      'daily-reports',
      'weekly-reports',
      'health-insights',
      'flex-message-generation'
    ];
  }
}
```

### 4. Update IntentAgent

**File:** `src/agents/specialized/IntentAgent.ts`

```typescript
private patterns = {
  // ... existing patterns
  report: [
    /à¸£à¸²à¸¢à¸‡à¸²à¸™/, /à¸ªà¸£à¸¸à¸›/, /report/, /summary/,
    /à¸§à¸±à¸™à¸™à¸µà¹‰/, /à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™/, /à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ/, /à¹€à¸”à¸·à¸­à¸™/,
    /today/, /yesterday/, /week/, /month/,
    /daily/, /weekly/, /monthly/
  ]
};
```

### 5. Update index.ts

**File:** `src/index.ts`

```typescript
import reportRoutes from './routes/report.routes';

// Add after health routes
app.use('/api/reports', reportRoutes);

// In handleTextMessage, check for report intent
const intent = result.metadata?.intent;

if (intent === 'report') {
  // ReportAgent already processed, get flex message from result
  const flexMessage = result.data?.flexMessage;
  if (flexMessage) {
    await lineClient.replyMessage(replyToken, flexMessage);
    return;
  }
}
```

---

## ðŸ“‚ Files to Create/Modify

### New Files:
1. `src/routes/report.routes.ts` - Report API endpoints
2. `database/migrations/004_report_views.sql` - Database views

### Modified Files:
1. `src/agents/specialized/ReportAgent.ts` - Complete implementation
2. `src/agents/specialized/IntentAgent.ts` - Add report patterns
3. `src/index.ts` - Register report routes, handle flex messages

---

## âœ… Testing Checklist

### API Tests
- [ ] GET /api/reports/daily/:patient_id
- [ ] GET /api/reports/daily/:patient_id?date=2024-01-01
- [ ] GET /api/reports/weekly/:patient_id
- [ ] POST /api/reports/generate-insights

### LINE Bot Tests
- [ ] à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰" â†’ à¹„à¸”à¹‰ Flex Message à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰
- [ ] à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™" â†’ à¹„à¸”à¹‰à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™
- [ ] à¸žà¸´à¸¡à¸žà¹Œ "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰" â†’ à¹„à¸”à¹‰à¸£à¸²à¸¢à¸‡à¸²à¸™ 7 à¸§à¸±à¸™
- [ ] Rich Menu "à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™" â†’ Quick Reply à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—
- [ ] Flex Message à¹à¸ªà¸”à¸‡à¸œà¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸šà¸™ iOS
- [ ] Flex Message à¹à¸ªà¸”à¸‡à¸œà¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸šà¸™ Android

### Data Accuracy
- [ ] % Completion à¸„à¸³à¸™à¸§à¸“à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
- [ ] à¸„à¸§à¸²à¸¡à¸”à¸±à¸™à¹à¸ªà¸”à¸‡à¸„à¹ˆà¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
- [ ] à¸™à¹‰à¸³à¸£à¸§à¸¡à¸¢à¸­à¸”à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
- [ ] Insights à¸¡à¸µà¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢ à¹„à¸¡à¹ˆ generic

---

## ðŸš€ Deployment

```bash
# Create migration
cat > database/migrations/004_report_views.sql << 'EOF'
-- (SQL code from above)
EOF

# Run migration
psql $SUPABASE_DB_URL -f database/migrations/004_report_views.sql

# Build and test
npm run build
npm test

# Commit
git add .
git commit -m "Add daily/weekly health reports with AI insights"
git push origin master
```

---

## ðŸ“Š Success Metrics

- âœ… à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸”à¹‰à¸ à¸²à¸¢à¹ƒà¸™ 3 à¸§à¸´à¸™à¸²à¸—à¸µ
- âœ… Insights à¸¡à¸µà¸„à¸¸à¸“à¸ à¸²à¸ž (user feedback)
- âœ… User à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸„à¸£à¸±à¹‰à¸‡/à¸§à¸±à¸™
- âœ… Flex Message à¹à¸ªà¸”à¸‡à¸œà¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ 100%

---

**Created:** 2025-10-25
**Last Updated:** 2025-10-25
**Version:** 1.0.0
