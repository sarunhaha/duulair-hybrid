# üîÑ N8N Integration Guide

> Automate workflows and integrate external services with Duulair Multi-Agent System

---

## üìã Table of Contents

1. [Overview](#overview)
2. [Use Cases](#use-cases)
3. [Setup N8N](#setup-n8n)
4. [Workflow Examples](#workflow-examples)
5. [API Endpoints](#api-endpoints)
6. [Best Practices](#best-practices)

---

## Overview

N8N ‡πÄ‡∏õ‡πá‡∏ô workflow automation tool ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Duulair ‡∏Å‡∏±‡∏ö external services ‡∏ú‡πà‡∏≤‡∏ô:

- üì® **Webhooks** - ‡∏£‡∏±‡∏ö/‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö real-time
- ‚è∞ **Scheduled Tasks** - ‡∏£‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° schedule
- üîó **External APIs** - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö services ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- üîÑ **Data Transformation** - ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ agents

---

## Use Cases

### 1. üìÖ Scheduled Medication Reminders

N8N ‡∏™‡πà‡∏á reminder ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î:

```
N8N Schedule (9:00 AM)
  ‚Üì
Query Supabase (patients + medication schedule)
  ‚Üì
Send to Duulair API (/test endpoint)
  ‚Üì
Dialog Agent responds
  ‚Üì
Send LINE message to patient
```

### 2. üîî External Alert Integration

‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Duulair ‡∏Å‡∏±‡∏ö external monitoring systems:

```
IoT Device (Blood Pressure Monitor)
  ‚Üì
N8N Webhook receives data
  ‚Üì
Transform to Duulair format
  ‚Üì
POST to /test endpoint
  ‚Üì
Health Agent logs + Alert Agent notifies
```

### 3. üìä Daily Report Generation

Auto-generate reports ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 8 PM:

```
N8N Schedule (8:00 PM)
  ‚Üì
Fetch patient data from Supabase
  ‚Üì
Send to Report Agent
  ‚Üì
Generate PDF report
  ‚Üì
Email to caregivers
```

### 4. üîó Third-Party Service Integration

‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Google Calendar, Notion, Slack, etc:

```
Google Calendar Event (Doctor Appointment)
  ‚Üì
N8N receives webhook
  ‚Üì
Send reminder to Duulair
  ‚Üì
Dialog Agent creates friendly message
  ‚Üì
Notify patient via LINE
```

---

## Setup N8N

### Option 1: N8N Cloud (Easiest)

1. Go to https://n8n.io
2. Sign up for N8N Cloud
3. Create new workflow

### Option 2: Self-Hosted (Free)

```bash
# Install N8N globally
npm install n8n -g

# Run N8N
n8n start

# Access at http://localhost:5678
```

### Option 3: Docker

```bash
docker run -it --rm \
  --name n8n \
  -p 5678:5678 \
  -v ~/.n8n:/home/node/.n8n \
  n8nio/n8n
```

---

## Workflow Examples

### Example 1: Daily Medication Reminder

**N8N Workflow:**

```json
{
  "nodes": [
    {
      "type": "n8n-nodes-base.schedule",
      "name": "Every day 9 AM",
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        },
        "hour": 9,
        "minute": 0
      }
    },
    {
      "type": "n8n-nodes-base.supabase",
      "name": "Get Patients",
      "parameters": {
        "operation": "getAll",
        "tableId": "patients",
        "returnAll": true
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Send to Duulair",
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/test",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersJson": "={\"message\": \"‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ô‡∏∞‡∏Ñ‡∏∞\", \"context\": {\"source\": \"n8n\", \"userId\": \"{{$json.line_user_id}}\", \"patientId\": \"{{$json.id}}\"}}"
      }
    }
  ]
}
```

**How it works:**
1. ‚è∞ Trigger at 9:00 AM daily
2. üìä Fetch all patients from Supabase
3. üîÑ Loop through each patient
4. üì® Send medication reminder to Duulair
5. üíä Health Agent logs + Dialog Agent responds
6. üì± LINE message sent to patient

---

### Example 2: IoT Blood Pressure Monitor

**N8N Workflow:**

```json
{
  "nodes": [
    {
      "type": "n8n-nodes-base.webhook",
      "name": "Webhook",
      "parameters": {
        "path": "bp-monitor",
        "responseMode": "responseNode"
      }
    },
    {
      "type": "n8n-nodes-base.function",
      "name": "Transform Data",
      "parameters": {
        "functionCode": "const data = items[0].json;\nreturn [{\n  json: {\n    message: `‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÑ‡∏î‡πâ ${data.systolic}/${data.diastolic}`,\n    context: {\n      source: 'n8n',\n      patientId: data.patientId,\n      userId: data.userId\n    },\n    metadata: {\n      device: 'IoT BP Monitor',\n      systolic: data.systolic,\n      diastolic: data.diastolic,\n      heartRate: data.heartRate\n    }\n  }\n}];"
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Send to Duulair",
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/test",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersJson": "={{$json}}"
      }
    },
    {
      "type": "n8n-nodes-base.respondToWebhook",
      "name": "Respond",
      "parameters": {
        "responseBody": "={{$json}}"
      }
    }
  ]
}
```

**How it works:**
1. üì° IoT device sends BP reading to N8N webhook
2. üîÑ Transform device data to Duulair format
3. üì® POST to Duulair `/test` endpoint
4. üíä Health Agent validates and logs vitals
5. üö® Alert Agent checks for abnormal values
6. ‚úÖ Respond to IoT device

---

### Example 3: Weekly Report Generation

**N8N Workflow:**

```json
{
  "nodes": [
    {
      "type": "n8n-nodes-base.schedule",
      "name": "Every Sunday 8 PM",
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "weeksInterval": 1
            }
          ]
        },
        "dayOfWeek": 0,
        "hour": 20,
        "minute": 0
      }
    },
    {
      "type": "n8n-nodes-base.supabase",
      "name": "Get Patients",
      "parameters": {
        "operation": "getAll",
        "tableId": "patients"
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Generate Report",
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/test",
        "bodyParametersJson": "={\"message\": \"‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ\", \"context\": {\"source\": \"n8n\", \"patientId\": \"{{$json.id}}\"}, \"metadata\": {\"reportType\": \"weekly\"}}"
      }
    },
    {
      "type": "n8n-nodes-base.emailSend",
      "name": "Email Report",
      "parameters": {
        "fromEmail": "reports@duulair.com",
        "toEmail": "={{$json.caregiver_email}}",
        "subject": "Weekly Health Report - {{$json.patient_name}}",
        "html": "={{$json.response}}"
      }
    }
  ]
}
```

---

### Example 4: Google Calendar Integration

**Scenario:** ‡∏™‡πà‡∏á reminder ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô Google Calendar

```json
{
  "nodes": [
    {
      "type": "n8n-nodes-base.googleCalendar",
      "name": "Get Upcoming Events",
      "parameters": {
        "operation": "getAll",
        "calendarId": "primary",
        "timeMin": "={{$now}}",
        "timeMax": "={{$now.plus({hours: 24})}}"
      }
    },
    {
      "type": "n8n-nodes-base.filter",
      "name": "Filter Doctor Appointments",
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.summary}}",
              "operation": "contains",
              "value2": "‡∏´‡∏°‡∏≠"
            }
          ]
        }
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Send Reminder",
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/test",
        "bodyParametersJson": "={\"message\": \"‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢{{$json.summary}} ‡πÄ‡∏ß‡∏•‡∏≤ {{$json.start.dateTime}}\", \"context\": {\"source\": \"n8n\"}}"
      }
    }
  ]
}
```

---

## API Endpoints

### POST /test

Use this endpoint for N8N integrations:

```bash
curl -X POST http://localhost:3000/test \
  -H "Content-Type: application/json" \
  -d '{
    "message": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å N8N",
    "context": {
      "source": "n8n",
      "userId": "U123456",
      "patientId": "P789"
    },
    "metadata": {
      "workflow": "medication-reminder",
      "timestamp": "2024-01-01T09:00:00Z"
    }
  }'
```

**Request Body:**

```typescript
{
  message: string;           // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Agent ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
  context: {
    source: "n8n";          // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å N8N
    userId?: string;         // LINE User ID (optional)
    patientId?: string;      // Patient ID from Supabase
    sessionId?: string;      // Session tracking (optional)
  };
  metadata?: {               // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (optional)
    workflow?: string;       // N8N workflow name
    [key: string]: any;      // Custom fields
  };
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "results": [...],
    "combined": {
      "response": "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Agent",
      "intent": "medication"
    }
  },
  "agentName": "orchestrator",
  "processingTime": 3000,
  "metadata": {
    "intent": "medication",
    "confidence": 0.95,
    "agentsInvolved": ["intent", "health"]
  }
}
```

---

### POST /webhook (for LINE)

N8N can also trigger LINE webhook processing:

```bash
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "events": [{
      "type": "message",
      "message": {
        "id": "12345",
        "text": "‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß"
      },
      "source": {
        "userId": "U123456"
      }
    }]
  }'
```

---

## Best Practices

### 1. ‚úÖ Error Handling

Always add error handling in N8N workflows:

```javascript
// N8N Function Node
try {
  const response = await $http.post('http://localhost:3000/test', {
    message: items[0].json.message,
    context: { source: 'n8n' }
  });
  return [{ json: response }];
} catch (error) {
  // Log error
  console.error('Duulair API Error:', error);

  // Send alert
  await $http.post('https://your-alert-webhook.com', {
    error: error.message,
    workflow: 'medication-reminder'
  });

  return [{ json: { error: error.message } }];
}
```

### 2. üîÑ Rate Limiting

Avoid overwhelming the API:

```javascript
// N8N Function Node - Add delay between requests
const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

for (const patient of items) {
  await processPatient(patient);
  await delay(1000); // 1 second delay
}
```

### 3. üìä Logging

Track N8N executions in metadata:

```json
{
  "message": "...",
  "metadata": {
    "source": "n8n",
    "workflow_id": "{{$workflow.id}}",
    "execution_id": "{{$execution.id}}",
    "timestamp": "{{$now}}"
  }
}
```

### 4. üîê Security

Use environment variables for sensitive data:

```javascript
// N8N Credentials
const DUULAIR_API_URL = $env.DUULAIR_API_URL;
const API_KEY = $env.DUULAIR_API_KEY; // If needed

$http.post(DUULAIR_API_URL + '/test', {
  headers: {
    'Authorization': `Bearer ${API_KEY}`
  },
  ...
});
```

### 5. ‚úÖ Validation

Validate data before sending:

```javascript
// N8N Function Node
const validateMessage = (data) => {
  if (!data.message) {
    throw new Error('Message is required');
  }
  if (!data.context?.source) {
    data.context = { ...data.context, source: 'n8n' };
  }
  return data;
};

return items.map(item => ({
  json: validateMessage(item.json)
}));
```

---

## Advanced Examples

### Example: Multi-Agent Coordination via N8N

```javascript
// N8N Code Node
const orchestrate = async (patientId) => {
  // Step 1: Get health data
  const healthData = await $http.post('http://localhost:3000/test', {
    message: '‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÑ‡∏î‡πâ 140/90',
    context: { source: 'n8n', patientId }
  });

  // Step 2: If abnormal, generate report
  if (healthData.metadata.alert) {
    const report = await $http.post('http://localhost:3000/test', {
      message: '‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡πà‡∏ß‡∏ô',
      context: { source: 'n8n', patientId },
      metadata: { trigger: 'abnormal_vitals' }
    });

    // Step 3: Send to caregivers
    await sendLineMessage(report.data.combined.response);
  }

  return healthData;
};
```

---

## Monitoring

### N8N Execution Logs

Track N8N workflow execution in Supabase:

```sql
-- Add to database-schema.sql
CREATE TABLE n8n_executions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workflow_id VARCHAR(255),
  execution_id VARCHAR(255),
  status VARCHAR(50),
  input JSONB,
  output JSONB,
  error TEXT,
  duration INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Webhook for Monitoring

```javascript
// N8N Function Node - Log execution
await $http.post('http://localhost:3000/n8n/log', {
  workflow_id: $workflow.id,
  execution_id: $execution.id,
  status: 'success',
  duration: $execution.duration
});
```

---

## Troubleshooting

### Issue: N8N can't connect to Duulair

**Solution:**
1. Check Duulair is running: `npm run dev`
2. Verify URL is correct (use http://localhost:3000 for local)
3. Check firewall/network settings
4. Use ngrok for local testing: `ngrok http 3000`

### Issue: Webhook not triggering

**Solution:**
1. Verify webhook URL is accessible
2. Check N8N webhook path matches
3. Test with curl first
4. Check N8N execution logs

### Issue: Data transformation errors

**Solution:**
1. Use N8N's "Execute Node" to test transformations
2. Add console.log() in Function nodes
3. Check JSON structure matches Duulair API

---

## Resources

- **N8N Documentation**: https://docs.n8n.io/
- **N8N Community**: https://community.n8n.io/
- **Duulair API**: See [docs/SETUP.md](SETUP.md)
- **Workflow Templates**: https://n8n.io/workflows/

---

**Ready to automate! üöÄ**
