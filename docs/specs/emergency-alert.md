# Emergency Alert System

> Critical emergency response and escalation system

---

## Feature Name
Emergency Alert & Response System

## Overview
‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö keywords ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ç‡∏≤‡∏ï‡∏¥/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö escalation ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö

## User Story
**As a** ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
**I want** ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
**So that** ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

## Requirements

### Functional Requirements
- [ ] FR-1: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö emergency keywords (‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô, ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢, ‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å, ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å)
- [ ] FR-2: ‡∏™‡πà‡∏á alert ‡πÑ‡∏õ LINE ‡∏ç‡∏≤‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (within 5 seconds)
- [ ] FR-3: ‡πÇ‡∏ó‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô critical keywords
- [ ] FR-4: ‡∏õ‡∏∏‡πà‡∏° SOS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
- [ ] FR-5: ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° alert
- [ ] FR-6: Escalation: ‡∏ñ‡πâ‡∏≤‡∏ç‡∏≤‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÇ‡∏ó‡∏£ / SMS
- [ ] FR-7: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å emergency event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- [ ] FR-8: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö no-response timeout (‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 8 ‡∏ä‡∏° ‚Üí alert)
- [ ] FR-9: Auto-call 1669 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö critical cases
- [ ] FR-10: False alarm handling (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

### Technical Requirements
- [ ] TR-1: Real-time notification (<5 seconds)
- [ ] TR-2: Multiple notification channels (LINE, SMS, Phone call)
- [ ] TR-3: Geolocation tracking
- [ ] TR-4: 99.9% uptime requirement
- [ ] TR-5: Redundancy (backup notification methods)

## Data Model

### Database Schema
```sql
CREATE TABLE emergency_alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  patient_id UUID REFERENCES patients(id) NOT NULL,
  alert_type VARCHAR(50) NOT NULL, -- 'medical', 'fall', 'panic', 'no_response', 'manual'
  severity VARCHAR(20) CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  message TEXT NOT NULL,
  location JSONB, -- {address, lat, lng}
  trigger_keywords TEXT[],
  status VARCHAR(20) CHECK (status IN ('active', 'acknowledged', 'resolved', 'false_alarm')),
  triggered_at TIMESTAMP DEFAULT NOW(),
  acknowledged_at TIMESTAMP,
  acknowledged_by UUID REFERENCES users(id),
  resolved_at TIMESTAMP,
  resolution_notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE emergency_contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  patient_id UUID REFERENCES patients(id) NOT NULL,
  contact_user_id UUID REFERENCES users(id) NOT NULL,
  relationship VARCHAR(50), -- 'spouse', 'child', 'sibling', 'caregiver'
  priority INTEGER DEFAULT 1, -- 1 = primary, 2 = secondary
  phone_number VARCHAR(20),
  line_user_id VARCHAR(100),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE emergency_responses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  alert_id UUID REFERENCES emergency_alerts(id) NOT NULL,
  contact_id UUID REFERENCES emergency_contacts(id) NOT NULL,
  notification_channel VARCHAR(20), -- 'line', 'sms', 'call'
  sent_at TIMESTAMP DEFAULT NOW(),
  delivered_at TIMESTAMP,
  read_at TIMESTAMP,
  responded_at TIMESTAMP,
  response_action VARCHAR(50), -- 'acknowledged', 'on_the_way', 'false_alarm'
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_alerts_patient_status ON emergency_alerts(patient_id, status, triggered_at DESC);
CREATE INDEX idx_contacts_patient_priority ON emergency_contacts(patient_id, priority);
```

### TypeScript Types
```typescript
interface EmergencyAlert {
  id: string;
  patientId: string;
  alertType: 'medical' | 'fall' | 'panic' | 'no_response' | 'manual';
  severity: 'low' | 'medium' | 'high' | 'critical';
  message: string;
  location?: {
    address: string;
    lat: number;
    lng: number;
  };
  triggerKeywords?: string[];
  status: 'active' | 'acknowledged' | 'resolved' | 'false_alarm';
  triggeredAt: Date;
  acknowledgedAt?: Date;
  acknowledgedBy?: string;
  resolvedAt?: Date;
  resolutionNotes?: string;
}

interface EmergencyContact {
  id: string;
  patientId: string;
  contactUserId: string;
  relationship: string;
  priority: number;
  phoneNumber?: string;
  lineUserId?: string;
  isActive: boolean;
}

// Emergency keywords by severity
const EMERGENCY_KEYWORDS = {
  critical: ['‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å', '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å', '‡∏ä‡πá‡∏≠‡∏Å', '‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏°', '‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏±‡∏ß'],
  high: ['‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', '‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢', '‡∏´‡∏Å‡∏•‡πâ‡∏°', '‡πÄ‡∏à‡πá‡∏ö‡∏°‡∏≤‡∏Å'],
  medium: ['‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢', '‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß', '‡∏ß‡∏¥‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô', '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ'],
  low: ['‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢', '‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢']
};
```

## API Design

```typescript
class EmergencyAgent extends BaseAgent {
  /**
   * Trigger emergency alert
   */
  async triggerAlert(params: {
    patientId: string;
    message: string;
    alertType: string;
    severity?: string;
    location?: Location;
  }): Promise<EmergencyAlert>

  /**
   * Detect emergency from message
   */
  async detectEmergency(message: string): Promise<{
    isEmergency: boolean;
    severity: string;
    keywords: string[];
    confidence: number;
  }>

  /**
   * Notify all emergency contacts
   */
  async notifyContacts(alertId: string): Promise<{
    sent: number;
    failed: number;
  }>

  /**
   * Escalate alert if no response
   */
  async escalateAlert(alertId: string): Promise<void>

  /**
   * Acknowledge alert
   */
  async acknowledgeAlert(params: {
    alertId: string;
    userId: string;
    action: string;
  }): Promise<EmergencyAlert>

  /**
   * Cancel false alarm
   */
  async cancelAlert(params: {
    alertId: string;
    reason: string;
  }): Promise<EmergencyAlert>

  /**
   * Check for no-response timeout
   */
  async checkNoResponse(patientId: string): Promise<boolean>
}
```

## Escalation Matrix

```typescript
const ESCALATION_STEPS = [
  {
    delay: 0, // immediate
    channels: ['line'],
    targets: 'all_contacts'
  },
  {
    delay: 120, // 2 minutes
    channels: ['sms', 'call'],
    targets: 'primary_contacts'
  },
  {
    delay: 300, // 5 minutes
    channels: ['call'],
    targets: 'all_contacts'
  },
  {
    delay: 600, // 10 minutes (critical only)
    channels: ['emergency_services'],
    targets: '1669'
  }
];
```

## Testing Strategy

### Test Scenarios
1. **Critical**: "‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å" ‚Üí Immediate alert to all + call primary
2. **High**: "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢" ‚Üí Alert to all contacts
3. **SOS Button**: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° SOS ‚Üí Alert with location
4. **No Response**: ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 8 ‡∏ä‡∏° ‚Üí Alert to caregivers
5. **False Alarm**: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
6. **Escalation**: ‡∏ç‡∏≤‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí SMS + Call
7. **Acknowledged**: ‡∏ç‡∏≤‡∏ï‡∏¥‡∏Å‡∏î "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö" ‚Üí ‡∏´‡∏¢‡∏∏‡∏î escalation

## Timeline

**Estimated**: 16 hours (2 days)
- Core alert system: 8 hours
- Escalation logic: 4 hours
- Testing & safety checks: 4 hours

## Examples

### Input
```
"‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å"
[SOS Button Pressed]
[No message for 8 hours]
```

### Output - Alert to Caregivers
```json
{
  "type": "flex",
  "altText": "üö® EMERGENCY ALERT",
  "contents": {
    "type": "bubble",
    "header": {
      "type": "box",
      "backgroundColor": "#FF0000",
      "contents": [{
        "type": "text",
        "text": "üö® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô",
        "color": "#FFFFFF",
        "size": "xl",
        "weight": "bold"
      }]
    },
    "body": {
      "type": "box",
      "contents": [
        { "type": "text", "text": "üë§ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ (‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏π‡πà)", "weight": "bold" },
        { "type": "text", "text": "üí¨ '‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢'", "color": "#FF0000" },
        { "type": "text", "text": "‚è∞ 14:32 ‡∏ô.", "color": "#999999" },
        { "type": "text", "text": "üìç 123 ‡∏ñ.‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø" }
      ]
    },
    "footer": {
      "type": "box",
      "contents": [
        {
          "type": "button",
          "action": { "type": "uri", "label": "üìû ‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ", "uri": "tel:0812345678" },
          "style": "primary",
          "color": "#FF0000"
        },
        {
          "type": "button",
          "action": { "type": "message", "label": "‚úÖ ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ", "text": "acknowledged" },
          "style": "secondary"
        },
        {
          "type": "button",
          "action": { "type": "uri", "label": "üó∫Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", "uri": "https://maps.google.com/?q=..." }
        }
      ]
    }
  }
}
```

## Safety Considerations

### Critical Requirements
- **Zero Tolerance for Failure**: Emergency system must work 24/7
- **Redundancy**: Multiple notification channels
- **Fast Response**: <5 seconds for critical alerts
- **Clear Escalation**: Well-defined steps
- **False Alarm Protection**: Easy cancellation within 30 seconds
- **Privacy**: Location data encrypted
- **Testing**: Regular drills and tests

### Fail-safes
- Backup notification server
- Fallback to SMS if LINE fails
- Auto-retry on failed sends
- Manual override for caregivers
- Logging all alert events

---

**Created**: 2024-01-16
**Priority**: CRITICAL (Life-saving feature)
**Status**: Ready for implementation
**Note**: Requires thorough testing and monitoring
